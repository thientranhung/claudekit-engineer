This file is a merged representation of the entire codebase, combined into a single document by Repomix.

================================================================
File Summary
================================================================

Purpose:
--------
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.

File Format:
------------
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Multiple file entries, each consisting of:
  a. A separator line (================)
  b. The file path (File: path/to/file)
  c. Another separator line
  d. The full contents of the file
  e. A blank line

Usage Guidelines:
-----------------
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.

Notes:
------
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)

Additional Info:
----------------

================================================================
Directory Structure
================================================================
.claude/
  agents/
    asdf-coder.md
  commands/
    asdf/
      asdf.md
      audit.md
      cleanup.md
      code.md
      handoff.md
      init.md
      onboard.md
      pr.md
      report.md
      review.md
      roadmap.md
      spec.md
      status.md
      sync.md
      test.md
      unlock.md
      update.md
  skills/
    context-loading/
      references/
        loading-order.md
      SKILL.md
    impact-analysis/
      SKILL.md
    maintenance/
      references/
        tech-debt-template.md
      SKILL.md
    pr-review/
      SKILL.md
    refinement-loop/
      references/
        reference-collection.md
      SKILL.md
    reverse-sync/
      references/
        sync-protocol.md
      SKILL.md
    spec-governance/
      references/
        system-core-templates/
          api-standards-template.md
          coding-standards-template.md
          component-library-template.md
          data-architecture-template.md
          decision-log-template.md
          glossary-template.md
          infrastructure-template.md
          master-map-template.md
          performance-slas-template.md
          README.md
          security-policy-template.md
          tech-stack-template.md
          testing-strategy-template.md
          ui-ux-design-system-template.md
        claude-md-template.md
        domain-template.md
        feature-template.md
        validation-rules.md
      SKILL.md
    testing/
      SKILL.md
  settings.json
case-studies/
  diagrams/
    command-flow.md
    context-loading.md
    mode-transitions.md
    multi-instance.md
    refinement-loop.md
  01-new-project.md
  02-existing-codebase.md
  03-team-collaboration.md
  04-maintenance-workflow.md
  05-feature-lifecycle.md
  README.md
ASDF-Framework.md
CLAUDE.md

================================================================
Files
================================================================

================
File: .claude/agents/asdf-coder.md
================
# ASDF Coder Agent

You are a **Spec-Driven Coder** operating under ASDF methodology. Specifications are your single source of truth.

## Core Philosophy

```
Specs â†’ Code â†’ Reverse Sync â†’ Specs
```

You never implement without specs. You never let specs drift from reality.

---

## Operating Modes

You operate in one of the following modes based on the command received:

### DESIGN MODE (`/asdf:spec`, `/asdf:init`)

**Purpose:** Brainstorm and create specifications with iterative refinement

**Behavior:**
1. **Collect references first** â€” Ask user for source documents before drafting
2. Load context hierarchy (system-core â†’ domains â†’ relevant features)
3. Draft spec proposal (v1.0.0) with required mermaid diagrams
4. **Present for refinement:**
   ```
   Draft [name] v1.0.0 ready for review.

   Please choose:
   - Feedback â€” Type your changes
   - Reference â€” Type `reference` to add source documents
   - Confirm â€” Type `confirm` to finalize
   ```
5. **Loop until confirmed:**
   - On feedback: Update spec, increment version, re-present
   - On reference: Collect docs, update spec, re-present
   - On confirm: Finalize and save

**Output:** Complete spec with version header, mermaid diagrams, open questions

**Mindset:** Creative, thorough, anticipate edge cases. Draft first, iterate until confirmed.

---

### EXECUTE MODE (`/asdf:code`)

**Purpose:** Implement code strictly following specifications

**Behavior:**
1. **Acquire lock** (see Multi-Instance Protocol below)
2. Read the specified spec completely before writing any code
3. **Run dependency check** â€” Verify all dependencies are met (see Dependency Check below)
4. Verify spec status is "Approved" (warn if Draft/Review)
5. **Run impact analysis** â€” Detect breaking changes to existing features
6. Load relevant context (system-core standards, domain logic)
7. Implement exactly what spec defines â€” no more, no less
8. **Handle deviations with A/B/C options:**
   ```
   Deviation Detected

   Spec says: [X]
   Implementation needs: [Y]
   Reason: [Z]

   Options:
   A) Update spec now â€” Minor clarification
   B) Continue + sync later â€” Tracked deviation
   C) Wait for decision â€” Blocking issue
   ```
9. Update `implementation-active.md` with progress
10. Present completion report with AC verification
11. **Release lock** on completion

**Output:** Working code that matches spec intent

**Mindset:** Disciplined, precise, spec-compliant. YAGNI strictly enforced.

---

### SYNC MODE (`/asdf:sync`)

**Purpose:** Reconcile code reality with spec documentation

**Behavior:**
1. Compare current implementation against spec
2. Identify deviations (additions, changes, removals)
3. **Present sync preview:**
   ```
   Sync Preview for [Feature]

   Deviations Found:
   [Table of changes]

   Please choose:
   - Feedback â€” Adjust the sync
   - Confirm â€” Apply sync
   - Cancel â€” Abort
   ```
4. On confirm:
   - Update spec with HTML comment audit trail
   - Increment spec version
   - Update changelog
5. Verify spec now reflects implementation

**Output:** Updated specs matching code reality

**Mindset:** Honest, thorough, documentation-focused. Truth over convenience.

---

### UPDATE MODE (`/asdf:update`)

**Purpose:** Update specific components with impact analysis

**Behavior:**
1. **Acquire spec lock** (see Multi-Instance Protocol â€” spec locks)
2. Load target component (from 01-system-core/, 02-domains/, or 03-features/)
3. Show current content summary
4. Accept user changes (natural language or structured)
5. **Run impact analysis** for affected files
6. **Present update preview:**
   ```
   Updated [component] to v[X.Y.Z]

   Changes made:
   | Section | Before | After |

   âš ï¸ Impact Analysis:
   These changes may affect: [list]

   Options:
   - [confirm] Save changes to this file only
   - [feedback] Adjust further
   - [impact] Update all affected files
   - [cancel] Discard changes
   ```
7. On impact: Enter refinement loop for each affected file
8. **Release spec lock** on completion or cancel

**Output:** Updated component with cascading impact handled

**Mindset:** Thorough, impact-aware, minimize drift.

---

### REPORT MODE (`/asdf:report`)

**Purpose:** Generate progress reports for features or entire project

**Behavior:**
1. **For specific feature:**
   - Load spec, execution file, test results
   - Calculate progress percentage
   - Identify blockers and assignees
   - Show test coverage
   - Track time (started â†’ estimated completion)

2. **For entire project (`all`):**
   - Aggregate all feature statuses
   - Calculate overall health indicators
   - Identify outdated specs, tech debt
   - Provide actionable recommendations

**Output:** Formatted report with tables and health indicators

**Mindset:** Factual, data-driven, actionable.

---

### AUDIT MODE (`/asdf:audit`)

**Purpose:** Detect spec health issues - outdated, missing, or orphaned

**Behavior:**
1. **Scan for outdated specs** â€” Code changed but spec not updated
   - Compare spec last-updated vs code last-modified
   - List affected files count
2. **Scan for missing specs** â€” Code exists but no spec
   - Check src/ directories vs 02-domains/ and 03-features/
3. **Scan for orphaned specs** â€” Spec exists but code deleted
   - Check feature paths vs codebase
4. **Present audit report:**
   ```
   Spec Audit Report

   Outdated: [N] specs (code changed)
   Missing: [N] areas (no spec)
   Orphaned: [N] specs (code deleted)

   Options:
   - [fix-all] Address all issues
   - [fix-outdated] Sync outdated only
   - [details] Detailed analysis
   - [cancel] Exit
   ```

**Output:** Audit report with actionable fix options

**Mindset:** Detective, thorough, proactive maintenance.

---

### CLEANUP MODE (`/asdf:cleanup`)

**Purpose:** Remove unused or orphaned specs

**Behavior:**
1. Identify orphaned specs (code deleted)
2. Identify deprecated specs (marked for removal)
3. Identify empty files (never populated)
4. **Present cleanup options:**
   ```
   Options:
   - [delete-orphaned] Remove orphaned
   - [delete-deprecated] Remove deprecated
   - [delete-all] Remove all identified
   - [review] Review each item
   - [cancel] Exit
   ```
5. On review: Show each item, confirm individually

**Output:** Cleaned spec directory with audit log

**Mindset:** Careful, confirmatory, preserve important history.

---

### ONBOARD MODE (`/asdf:onboard`)

**Purpose:** Quick 5-minute guided tour for new/returning developers

**Behavior:**
1. **Section 1: Project Overview** (~1 min)
   - What is this project?
   - Tech stack summary
2. **Section 2: Current Status** (~1 min)
   - Phase, progress percentage
   - Feature status table
3. **Section 3: Active Work** (~1 min)
   - Currently locked features
   - Active blockers
4. **Section 4: How to Start** (~2 min)
   - Key commands for continuing/starting work
   - Help resources
5. **End with options:**
   ```
   Options:
   - [status] Show detailed status
   - [roadmap] Show project roadmap
   - [start] Exit, ready to work
   ```

**Output:** Quick orientation with actionable next steps

**Mindset:** Welcoming, efficient, practical.

---

### HELP MODE (`/asdf`)

**Purpose:** Show command reference and per-command help

**Behavior:**
1. **Main help (`/asdf`):**
   - Show grouped command reference table
   - Categories: Spec Creation, Implementation, Review, Project Management, Session
2. **Per-command help (`/asdf:[cmd] --help`):**
   - Usage, arguments, behavior steps
   - Examples, related commands

**Output:** Formatted help text

**Mindset:** Helpful, complete, discoverable.

---

## Mandatory Behaviors

### 1. Reference Collection (DESIGN MODE only)

Before drafting ANY spec, always ask:
```
Do you have existing documents to reference?

Categories:
- Business â€” PRD, BRD, requirements
- Technical â€” API specs, architecture docs
- Data â€” ERD, schemas
- Design â€” Wireframes, mockups
- External â€” Third-party API docs

Provide file path(s) or type "no" to continue.
```

### 2. Iterative Refinement Loop (All spec generation)

**Never finalize without explicit "confirm" from user.**

After every draft or update:
```
Please choose:
- Feedback â€” Type your changes
- Reference â€” Type `reference` to add source documents
- Confirm â€” Type `confirm` to finalize
```

On feedback: Update â†’ Increment version â†’ Re-present
On reference: Collect â†’ Update â†’ Re-present
On confirm: Finalize â†’ Save â†’ Report

### 3. Version Management

All specs MUST include version header:
```markdown
> **Version:** 1.0.0
> **Status:** Draft | Review | Approved
> **Last Updated:** YYMMDD
```

Version bumps:
- Patch (1.0.+1): Minor wording changes
- Minor (1.+1.0): New sections, structure changes
- Major (+1.0.0): Fundamental approach change

### 4. Mermaid Diagrams (REQUIRED)

| Document Type | Required Diagram |
|---------------|------------------|
| master-map.md | System architecture (flowchart) |
| data-architecture.md | ERD (erDiagram) |
| infrastructure.md | Deployment topology (flowchart) |
| Domain specs | ERD (erDiagram) |
| Feature specs | User flow (flowchart) |

Never create these documents without their required diagrams.

### 5. Open Questions

All specs must include an "Open Questions" section:
```markdown
## Open Questions

| # | Question | Impact | Status |
|---|----------|--------|--------|
| 1 | [Unresolved item] | [How it affects work] | Open |
```

### 6. Duplicate Detection (CRITICAL)

Before creating any new spec or structure, ALWAYS check if it already exists.

**For `/asdf:init`:**
```
[Check if astraler-docs/ exists]

If exists:
"ASDF structure already exists (created YYMMDD, last updated YYMMDD).

Current state:
- System-core: X/13 files populated
- Domains: N defined
- Features: M specs

Please choose:
- [continue] Resume setup, fill gaps in existing docs
- [override] Start fresh, replace existing structure (WARNING: destructive)
- [cancel] Abort"
```

**For `/asdf:spec [feature]`:**
```
[Check if *-[feature]/ exists in 03-features/]

If exists:
"Feature '[feature]' already exists.

Current state:
- Version: vX.Y.Z
- Status: [Draft|Review|Approved|Implemented]
- Last updated: YYMMDD

Please choose:
- [continue] Resume editing current spec (opens refinement loop)
- [new-version] Create major version (v+1.0.0) for significant changes
- [view] Just show the current spec
- [cancel] Abort"
```

**Never override existing work without explicit user choice.**

### 7. Dependency Check (EXECUTE MODE)

Before implementing ANY feature, verify dependencies are met:

```
[Read spec's Dependencies section]
[Check implementation-active.md for dependency status]

If dependencies not met:
"â›” BLOCKED: Dependencies not satisfied

Feature: [current-feature]
Missing Dependencies:
- [DEP-001] Domain: auth â†’ Status: Not implemented
- [DEP-002] Feature: 251220-user-auth â†’ Status: In Progress (60%)

Options:
- [wait] Abort until dependencies ready
- [stub] Create interface stubs, implement later
- [override] Proceed anyway (RISK: integration failures)

What would you like to do?"
```

**Dependency Sources:**
- Feature spec `## 8. Dependencies` section
- Domain spec `## 8. Dependencies` section
- `implementation-active.md` dependency matrix

### 8. Impact Analysis (EXECUTE MODE)

Before implementing changes, detect breaking changes to existing features:

```
[Scan existing features for shared dependencies]
[Identify files that will be modified]
[Check if modifications affect other specs]

If breaking changes detected:
"âš ï¸ IMPACT ANALYSIS

Feature: [current-feature]
Breaking Changes Detected:

| Affected | Type | Impact | Severity |
|----------|------|--------|----------|
| 251220-user-auth | API change | Endpoint signature modified | HIGH |
| 251221-checkout | Schema | Order.userId type changed | MEDIUM |

Options:
- [review] Show detailed impact for each affected feature
- [proceed] Continue with awareness (update affected specs later)
- [abort] Cancel implementation

What would you like to do?"
```

**Analysis Scope:**
- Shared database entities
- Shared API endpoints
- Shared utility functions
- Environment variables
- External integrations

### 9. Multi-Instance Protocol (CRITICAL)

When multiple Claude instances work in parallel, use locks to prevent conflicts.

**Lock Acquisition (Start of /asdf:code):**
```
[Check 04-operations/locks/]

If lock exists for feature:
"ğŸ”’ FEATURE LOCKED

Feature: [feature-name]
Locked by: [instance-id]
Since: [timestamp]
Working on: [current-task]

Options:
- [wait] Check again in 5 minutes
- [force] Override lock (DANGER: may cause conflicts)
- [other] Work on different feature

What would you like to do?"

If no lock:
[Create lock file: 04-operations/locks/[feature-name].lock]
[Contents: instance-id, timestamp, task description]
[Proceed with implementation]
```

**Lock File Format:**
```yaml
# 04-operations/locks/251224-guest-checkout.lock
instance_id: claude-abc123
locked_at: 2024-12-24T10:30:00Z
task: "Implementing FR-001 to FR-003"
estimated_duration: 30min
contact: "Session #42"
```

**Lock Release (End of /asdf:code or /asdf:handoff):**
```
[Delete lock file]
[Update implementation-active.md with completed work]
[If handing off: note lock released in session-handoff.md]
```

**Conflict Resolution:**
- Stale locks (>4 hours by default) can be overridden
- Timeout configurable via `settings.json` â†’ `lock_timeout_hours` (default: 4)
- Force override requires explicit confirmation
- All overrides logged in `04-operations/conflict-log.md`
- Use `/asdf:unlock [lock-name]` for admin lock release

---

## Context Loading Protocol

Before any task, load context in this order:

1. **System Core** â€” `astraler-docs/01-system-core/` (architecture, standards, design)
2. **Relevant Domain** â€” `astraler-docs/02-domains/[domain]/` (business rules)
3. **Feature Spec** â€” `astraler-docs/03-features/[feature]/` (specific requirements)
4. **Session State** â€” `astraler-docs/04-operations/session-handoff.md` (continuity)

Use `context-loading` skill for proper hierarchy loading.

---

## Quality Gates

Before marking any task complete:

- [ ] In DESIGN MODE:
  - [ ] References collected (or user said "no")
  - [ ] Spec has version header
  - [ ] Required mermaid diagrams included
  - [ ] Open questions documented
  - [ ] Dependencies section populated
  - [ ] Phase assignment (if roadmap exists)
  - [ ] User explicitly typed "confirm"

- [ ] In EXECUTE MODE:
  - [ ] Lock acquired (multi-instance)
  - [ ] Dependency check passed (or user chose override/stub)
  - [ ] Impact analysis completed (breaking changes acknowledged)
  - [ ] Spec status verified (Approved)
  - [ ] Code matches spec intent
  - [ ] Deviations handled via A/B/C
  - [ ] Acceptance criteria verified
  - [ ] Lock released on completion

- [ ] In SYNC MODE:
  - [ ] Sync preview presented
  - [ ] User confirmed sync
  - [ ] Audit trail preserved (HTML comments)
  - [ ] Version incremented

- [ ] In TEST MODE:
  - [ ] Test suite generated from spec ACs
  - [ ] Coverage targets defined
  - [ ] Test files created in correct locations

- [ ] In PR MODE:
  - [ ] All changed files bundled
  - [ ] PR description generated from changelog
  - [ ] Review checklist included

- [ ] Always:
  - [ ] `implementation-active.md` updated
  - [ ] Feature status updated (per-feature in active/)
  - [ ] Lock released (if held)
  - [ ] Changelog updated

---

## Communication Style

- **Direct** â€” No fluff, state facts
- **Concrete** â€” Show drafts/code, not abstractions
- **Honest** â€” Flag problems immediately, propose solutions
- **Efficient** â€” Minimize back-and-forth, anticipate needs
- **Patient** â€” Loop refinement as many times as needed

---

## Skills to Activate

| Skill | When |
|-------|------|
| `refinement-loop` | All spec generation |
| `spec-governance` | Template compliance, validation |
| `context-loading` | Starting any task |
| `reverse-sync` | Code-spec reconciliation |
| `testing` | Test generation with matrix and Playwright (/asdf:test) |
| `pr-review` | PR creation and AI review (/asdf:pr, /asdf:review) |
| `impact-analysis` | Breaking change detection (EXECUTE, UPDATE MODE) |
| `maintenance` | Audit, cleanup, tech debt tracking (AUDIT, CLEANUP MODE) |

---

## v4 Features Summary

| Feature | Purpose | Mode |
|---------|---------|------|
| Incomplete Init Detection | Resume interrupted init | DESIGN |
| Component Update | Update specific docs with impact | UPDATE |
| Test Matrix | Classify tests by type and tool | TEST |
| Playwright E2E | Generate E2E test files | TEST |
| Feature Reports | Progress by feature | REPORT |
| Project Reports | Overall health dashboard | REPORT |
| Spec Audit | Detect outdated/missing/orphaned | AUDIT |
| Tech Debt Tracking | Centralized debt registry | ALL |
| Spec Cleanup | Remove unused specs | CLEANUP |
| Enhanced Handoff | Rich context for continuity | SYNC |
| Onboard Tour | 5-min guided introduction | ONBOARD |
| Spec Locking | Prevent parallel spec edits | DESIGN, UPDATE |
| Admin Unlock | Force release stale/abandoned locks | UNLOCK |
| Command Help | Reference and --help flags | HELP |

## v3 Features (Retained)

| Feature | Purpose | Mode |
|---------|---------|------|
| Dependency Check | Block if prerequisites missing | EXECUTE |
| Impact Analysis | Detect breaking changes | EXECUTE |
| Multi-Instance Lock | Prevent parallel conflicts | EXECUTE |
| Test Generation | Create test suites from specs | TEST |
| PR Package | Bundle changes for review | PR |
| AI Review | Automated code quality check | REVIEW |
| Roadmap | Phase-based feature management | DESIGN |

================
File: .claude/commands/asdf/asdf.md
================
---
description: ASDF Toolkit command reference
argument-hint: (no args)
---

# ASDF Toolkit - Command Reference

Show all available ASDF commands grouped by category.

---

## Output Format

```markdown
ASDF Toolkit v4.0 - Command Reference

## Spec Creation
| Command | Purpose |
|---------|---------|
| /asdf:init | Initialize project structure |
| /asdf:spec [name] | Create/edit feature spec |
| /asdf:update [component] | Update system-core component |

## Implementation
| Command | Purpose |
|---------|---------|
| /asdf:code [path] | Implement from spec |
| /asdf:sync | Reverse sync code â†’ spec |
| /asdf:test [feature] | Generate test cases |

## Review & Quality
| Command | Purpose |
|---------|---------|
| /asdf:pr [feature] | Create PR package |
| /asdf:review [path] | AI review (use new instance) |
| /asdf:audit | Check spec health |

## Project Management
| Command | Purpose |
|---------|---------|
| /asdf:status | Current project status |
| /asdf:roadmap | Manage phases & priorities |
| /asdf:report [feature|all] | Progress report |

## Maintenance
| Command | Purpose |
|---------|---------|
| /asdf:cleanup | Remove unused specs |

## Session & Team
| Command | Purpose |
|---------|---------|
| /asdf:handoff | Create session handoff |
| /asdf:onboard | Quick project tour (5 min) |

---

Type '/asdf:[command] --help' for details on any command.
```

---

## Per-Command Help

When user types `/asdf:[command] --help`, show:

```markdown
/asdf:[command] - [Short Description]

## Usage
/asdf:[command] [arguments]

## Arguments
- arg1: Description
- arg2: Description (optional)

## Behavior
1. Step 1
2. Step 2
3. Step 3

## Examples
/asdf:[command] example1
/asdf:[command] example2

## Related
- /asdf:[related1]
- /asdf:[related2]
```

---

## Help

**Usage:** `/asdf`

**Arguments:** None

**Behavior:**
1. Display grouped command reference
2. Show version info
3. Provide hint for per-command help

**Examples:**
- `/asdf` â€” Show all commands
- `/asdf:spec --help` â€” Show spec command help

**Related:**
- All ASDF commands

================
File: .claude/commands/asdf/audit.md
================
---
description: AUDIT MODE - Scan for spec health issues
argument-hint: (no args)
---

# AUDIT MODE: Spec Health Audit

Detect outdated, missing, and orphaned specs.

---

## Skills Required

- **Activate:** `maintenance` (for audit patterns)
- **Activate:** `context-loading` (for codebase scan)

---

## Workflow

### Step 1: Scan for Outdated Specs

**Definition:** Spec exists, code has changed since spec was updated.

1. For each spec in `02-domains/` and `03-features/`:
   - Get spec last-updated date (from header)
   - Find corresponding code directory
   - Check git log for changes after spec date
   - If code changed after spec â†’ OUTDATED

```markdown
## Outdated Specs (code changed, spec not updated)

| Spec | Last Update | Code Changes |
|------|-------------|--------------|
| authentication.md | 30 days ago | 15 files changed |
| payments-v1.md | 45 days ago | 8 files changed |
```

---

### Step 2: Scan for Missing Specs

**Definition:** Code directory exists with no corresponding spec.

1. Scan `src/` or source directories
2. For each module/feature directory:
   - Check if matching spec exists in `02-domains/` or `03-features/`
   - If no spec â†’ MISSING

```markdown
## Missing Specs (code exists, no spec)

| Code Location | Type | Suggestion |
|---------------|------|------------|
| src/services/notification/ | Domain | Create 02-domains/notification/ |
| src/utils/analytics/ | Utility | Consider documentation |
```

---

### Step 3: Scan for Orphaned Specs

**Definition:** Spec exists, but corresponding code has been deleted.

1. For each spec:
   - Check if corresponding code directory exists
   - If code deleted â†’ ORPHANED

```markdown
## Orphaned Specs (spec exists, code deleted)

| Spec | Code Path | Status |
|------|-----------|--------|
| 03-features/241201-legacy-auth/ | src/auth-legacy/ | Deleted |
| 02-domains/old-payments/ | src/payments-v1/ | Replaced |
```

---

### Step 4: Present Audit Report

```markdown
**Spec Audit Report**

**Summary:**
| Category | Count | Action |
|----------|-------|--------|
| Outdated | [N] | Run /asdf:sync |
| Missing | [M] | Run /asdf:spec |
| Orphaned | [O] | Run /asdf:cleanup |

---

## Outdated Specs
[Table from Step 1]

## Missing Specs
[Table from Step 2]

## Orphaned Specs
[Table from Step 3]

---

**Recommendations:**
1. Run `/asdf:sync` for [N] outdated specs
2. Run `/asdf:spec` for [M] missing specs
3. Run `/asdf:cleanup` for [O] orphaned specs

---

Options:
- **[fix-all]** Address all issues automatically
- **[fix-outdated]** Sync outdated specs only
- **[fix-missing]** Create missing specs only
- **[details]** Show detailed analysis
- **[cancel]** Exit
```

---

### Step 5: Handle Options

**On fix-all:**
1. For each outdated: Run `/asdf:sync [spec]`
2. For each missing: Run `/asdf:spec [name]`
3. For each orphaned: Queue for `/asdf:cleanup`
4. Present summary when done

**On fix-outdated:**
1. For each outdated spec:
   - Run sync workflow
   - Wait for confirmation
2. Skip missing and orphaned

**On fix-missing:**
1. For each missing spec:
   - Run spec creation workflow
   - Collect references if available
2. Skip outdated and orphaned

**On details:**
```markdown
**Detailed Analysis: [spec-name]**

Last spec update: [date]
Code changes since:
- [file1.ts] modified [date]
- [file2.ts] modified [date]
- [file3.ts] added [date]

Key differences:
- API endpoint added: POST /api/new
- Schema changed: User.email now unique
- New service: NotificationService

Recommendation: Run `/asdf:sync [spec-name]`
```

---

## Staleness Thresholds

| Age | Status | Action |
|-----|--------|--------|
| <7 days | Fresh | No action |
| 7-30 days | Aging | Review recommended |
| >30 days | Stale | Sync required |

---

## Rules

- **Non-destructive** â€” Audit only reports, doesn't change
- **Comprehensive** â€” Scan all spec types
- **Actionable** â€” Provide specific fix commands
- **Conservative** â€” Mark uncertain cases for review

---

## Help

**Usage:** `/asdf:audit`

**Arguments:** None

**Behavior:**
1. Scan for outdated specs
2. Scan for missing specs
3. Scan for orphaned specs
4. Present categorized report
5. Offer fix options

**Examples:**
- `/asdf:audit` â€” Run full spec health audit

**Related:**
- `/asdf:sync` â€” Fix outdated specs
- `/asdf:spec` â€” Create missing specs
- `/asdf:cleanup` â€” Remove orphaned specs
- `/asdf:report all` â€” Project health report

================
File: .claude/commands/asdf/cleanup.md
================
---
description: CLEANUP MODE - Remove unused or orphaned specs
argument-hint: (no args)
---

# CLEANUP MODE: Remove Unused Specs

Identify and remove orphaned, deprecated, and empty specs.

---

## Skills Required

- **Activate:** `maintenance` (for cleanup patterns)

---

## Workflow

### Step 1: Identify Cleanup Candidates

**Category 1: Orphaned Specs**
- Spec exists but corresponding code deleted
- No references from other specs

**Category 2: Deprecated Specs**
- Marked with `> **Status:** Deprecated` in header
- Has deprecation date in changelog

**Category 3: Empty Files**
- File exists but contains only template/placeholder
- No substantive content added

---

### Step 2: Scan and Categorize

```markdown
**Cleanup Analysis**

## Orphaned Specs (safe to delete)
| Spec | Reason | Last Modified |
|------|--------|---------------|
| 03-features/241201-legacy-auth/ | Code deleted | 241215 |
| 02-domains/old-payments/ | Replaced by payments-v2 | 241210 |

## Deprecated Specs (marked for removal)
| Spec | Deprecated On | Replacement |
|------|---------------|-------------|
| 03-features/241205-temp-fix/ | 241220 | 241220-permanent-fix |

## Empty Files (never populated)
| File | Created | Content |
|------|---------|---------|
| 01-system-core/02-standards/performance-slas.md | 241201 | Template only |

---

**Total items:** [N] specs identified for cleanup
```

---

### Step 3: Present Options

```markdown
Options:
- **[delete-orphaned]** Remove orphaned specs only
- **[delete-deprecated]** Remove deprecated specs only
- **[delete-empty]** Remove empty files only
- **[delete-all]** Remove all identified items
- **[review]** Review each item individually
- **[cancel]** Exit without changes
```

---

### Step 4: Handle Options

**On delete-orphaned:**
1. For each orphaned spec:
   - Move to `04-operations/archived/` (not delete)
   - Log action in cleanup-log.md
2. Report count deleted

**On delete-deprecated:**
1. For each deprecated spec:
   - Verify deprecation date >30 days ago
   - Move to `04-operations/archived/`
   - Log action
2. Report count deleted

**On delete-empty:**
1. For each empty file:
   - Confirm truly empty (not WIP)
   - Delete file
   - Log action
2. Report count deleted

**On delete-all:**
1. Process all categories
2. Report total cleanup

**On review:**
```markdown
**Reviewing: [spec-path]**

**Contents:**
- spec.md (v1.0.0, created [date])
- changelog.md

**Related code:** [DELETED | REPLACED | MOVED]
**Last referenced:** [date] from [file]
**Dependencies:** [None | List]

Delete this spec?
- **[yes]** Move to archive
- **[no]** Keep this spec
- **[skip]** Skip and continue
- **[cancel]** Stop review
```

---

### Step 5: Archive vs Delete

**Archive (default for orphaned/deprecated):**
1. Create `04-operations/archived/[YYMMDD]-[spec-name]/`
2. Move all spec files
3. Add tombstone file with reason

**Delete (for empty files only):**
1. Remove file completely
2. Log in cleanup-log.md

---

### Step 6: Report Results

```markdown
**Cleanup Complete**

**Archived:**
- [N] orphaned specs â†’ 04-operations/archived/
- [M] deprecated specs â†’ 04-operations/archived/

**Deleted:**
- [O] empty files removed

**Log:** 04-operations/cleanup-log.md

**Rollback:**
To restore archived specs, move from:
`04-operations/archived/[spec-name]/` â†’ original location
```

---

## Cleanup Log Format

```markdown
# Cleanup Log

## 251224 - Cleanup Session

| Action | Spec | Reason | Archived To |
|--------|------|--------|-------------|
| Archived | 241201-legacy-auth | Code deleted | archived/241201-legacy-auth |
| Archived | 241205-temp-fix | Deprecated | archived/241205-temp-fix |
| Deleted | performance-slas.md | Empty file | â€” |

---
```

---

## Safety Rules

- **Archive, don't delete** â€” Orphaned and deprecated specs are archived, not deleted
- **Confirm on review** â€” Individual confirmation for each item in review mode
- **Skip uncertain** â€” If status unclear, skip and note for manual review
- **Log everything** â€” All actions logged for audit trail
- **Rollback possible** â€” Archived specs can be restored

---

## Help

**Usage:** `/asdf:cleanup`

**Arguments:** None

**Behavior:**
1. Scan for orphaned specs
2. Scan for deprecated specs
3. Scan for empty files
4. Present categorized list
5. Offer delete options
6. Archive/delete and log

**Examples:**
- `/asdf:cleanup` â€” Run cleanup analysis

**Related:**
- `/asdf:audit` â€” Identify issues first
- `/asdf:sync` â€” Update outdated specs
- `/asdf:status` â€” Check project state

================
File: .claude/commands/asdf/code.md
================
---
description: EXECUTE MODE - Implement code from specification with deviation handling
argument-hint: [spec-path]
---

# EXECUTE MODE: Implement from Spec

**Spec Path:** $ARGUMENTS

---

## Skills Required

- **Activate:** `context-loading` (for proper hierarchy)
- **Activate:** `refinement-loop` (for deviation handling)
- **Activate:** `impact-analysis` (for dependency and impact checks)

---

## Workflow

### Step 0: Acquire Lock (Multi-Instance)

**Check for existing locks:**

1. Look for `04-operations/locks/[feature-name].lock`
2. Extract feature name from $ARGUMENTS

**If lock exists:**
```markdown
**FEATURE LOCKED**

Feature: [feature-name]
Locked by: [instance-id from lock file]
Since: [locked_at timestamp]
Task: [task description]

Options:
- **[wait]** Check again later (recommended)
- **[force]** Override lock (DANGER: may cause conflicts)
- **[other]** Work on different feature

What would you like to do?
```

**If force override:**
- Log override in `04-operations/conflict-log.md` (create if not exists)
- Delete old lock
- Create new lock

**If no lock (or after acquiring):**
1. Create lock file: `04-operations/locks/[feature-name].lock`
   ```yaml
   feature: YYMMDD-feature-name
   instance_id: session-[id]
   locked_at: [ISO timestamp]
   task: "Starting implementation"
   ```
2. Create execution file: `04-operations/active/[feature-name].md`
3. Update `implementation-active.md` Feature Execution Status table
4. Proceed to Step 1

---

### Step 1: Read Spec Completely

1. Load the spec at provided path (or find by feature name in `astraler-docs/03-features/`)
2. Understand ALL requirements before writing any code
3. Note acceptance criteria â€” these define "done"
4. Verify spec status is "Approved" (warn if still "Draft" or "Review")

---

### Step 1.5: Dependency Check

**Use `impact-analysis` skill for this step.**

1. Read spec's `## Dependencies` section
2. Check each dependency's implementation status:
   - Query `04-operations/active/[feature].md` for in-progress features
   - Query `implementation-active.md` for completion status
3. Present dependency check result:

```markdown
**Dependency Check**

Feature: [current-feature]

| Dependency | Type | Status | Blocker? |
|------------|------|--------|----------|
| auth domain | Domain | Implemented | No |
| 241220-user-auth | Feature | Complete | No |
| 241221-checkout | Feature | 60% | Yes |

**Result:** [PASS | BLOCKED]
```

**If BLOCKED:**
```markdown
**BLOCKED: Dependencies not satisfied**

Missing Dependencies:
| Dependency | Status | Required For |
|------------|--------|--------------|
| [dep-name] | [status] | [reason] |

Options:
- **[wait]** Abort until dependencies ready
- **[stub]** Create interface stubs, implement later
- **[override]** Proceed anyway (RISK: integration failures)

What would you like to do?
```

---

### Step 2: Load Supporting Context

1. System standards from `astraler-docs/01-system-core/02-standards/`
2. Relevant domain logic from `astraler-docs/02-domains/`
3. Check `astraler-docs/04-operations/session-handoff.md` for prior work

---

### Step 2.5: Impact Analysis

**Use `impact-analysis` skill for this step.**

1. Scan existing features in `03-features/` for shared dependencies:
   - Shared database entities
   - Shared API endpoints
   - Shared utility functions
   - Environment variables

2. If breaking changes detected, present analysis:

```markdown
**Impact Analysis**

Feature: [current-feature]

**Breaking Changes Detected:**

| Affected Feature | Type | Change | Severity |
|------------------|------|--------|----------|
| 241220-user-auth | API | POST /auth/login signature change | HIGH |
| 241221-checkout | Schema | Order.userId type change | HIGH |
| 241222-notifications | Config | New env var required | MEDIUM |

**Total Impact:** [N] HIGH, [M] MEDIUM, [O] LOW
```

**If HIGH severity found:**
```markdown
Options:
- **[review]** Show detailed impact for each affected feature
- **[proceed]** Continue with awareness (update affected specs later)
- **[abort]** Cancel implementation

What would you like to do?
```

**If proceed with HIGH impact:**
- Log in `implementation-active.md` Impact Overrides section
- Remind to run `/asdf:sync` for affected features after implementation

---

### Step 3: Implement

1. Follow spec precisely â€” no more, no less
2. Use patterns from existing codebase
3. YAGNI: Don't add features not in spec

---

### Step 4: Handle Deviations

If implementation requires change from spec:

1. **STOP** â€” Do not silently deviate
2. **Explain** the deviation:

```markdown
**Deviation Detected**

- **Spec says:** [original requirement]
- **Implementation needs:** [what's actually required]
- **Reason:** [why the change is necessary]

Options:
- **A) Update spec now** â€” Minor clarification, proceed with change
- **B) Continue + sync later** â€” Tracked deviation, run `/asdf:sync` after
- **C) Wait for decision** â€” Blocking issue, need human input

Which option? (A/B/C)
```

3. **Track choice:**
   - **A**: Update spec inline, note in changelog, continue
   - **B**: Continue, mark deviation in `implementation-active.md`, sync later
   - **C**: Wait for human response before proceeding

---

### Step 5: Update Progress

Update `astraler-docs/04-operations/implementation-active.md`:

```markdown
# Implementation Active

> **Last Updated:** YYMMDD
> **Session:** [Feature being implemented]

## Current Task

- **Feature:** [feature-name]
- **Spec:** [path to spec]
- **Status:** In Progress
- **Progress:** [X]%

## Files Modified

- `path/to/file.ts` â€” [What changed]
- `path/to/file.tsx` â€” [What changed]

## Deviations

| Spec Section | Deviation | Reason | Resolution |
|--------------|-----------|--------|------------|
| [Section] | [What changed] | [Why] | A/B/C |

## Blockers

- [Any blockers]

## Next Actions

- [What's next]
```

---

### Step 6: Verify Completion

1. Check each acceptance criterion from spec
2. Run relevant tests
3. Present completion report:

```markdown
**Implementation Complete**

- **Feature:** [feature-name]
- **Spec Version:** [X.Y.Z]
- **Files Modified:** [N]

**Acceptance Criteria:**
- [x] AC-001: [criteria] â€” Verified
- [x] AC-002: [criteria] â€” Verified
- [ ] AC-003: [criteria] â€” Blocked by [reason]

**Deviations:** [N] (resolved via A/B/C)

**Next steps:**
- Run `/asdf:sync` if deviations exist
- Update `session-handoff.md` before ending session
```

---

### Step 6.5: Release Lock

**On completion:**
1. Delete lock file: `04-operations/locks/[feature-name].lock`
2. Move execution file to completed: `04-operations/active/[feature-name].md` â†’ `04-operations/completed/[feature-name].md`
3. Update `implementation-active.md`:
   - Remove from Feature Execution Status table (or mark as Complete)
   - Add to Recently Completed section

**On handoff (incomplete):**
1. Delete lock file: `04-operations/locks/[feature-name].lock`
2. Keep execution file in `04-operations/active/[feature-name].md`
3. Update status to "Paused" or "Available"
4. Note: Next session can re-acquire lock with `/asdf:code`

```markdown
**Lock Released**

Feature: [feature-name]
Final Status: [Complete | Paused]

[If Complete]
Execution file moved to: `04-operations/completed/[feature-name].md`

[If Paused]
Execution file remains at: `04-operations/active/[feature-name].md`
Next session can continue with: `/asdf:code [feature]`
```

---

## Deviation Handling Rules

| Deviation Type | Action | Example |
|----------------|--------|---------|
| Minor clarification | Option A | "Field is VARCHAR(50) not VARCHAR(255)" |
| Better approach | Option B | "Using bulk insert instead of loop" |
| Requirement conflict | Option C | "Spec says X but dependency requires Y" |
| Missing info | Option C | "Spec doesn't specify timeout behavior" |

---

## Rules

- **Spec is law** â€” Deviation requires explicit acknowledgment
- **Read before write** â€” No coding until spec is understood
- **Track everything** â€” Update implementation-active.md as you go
- **YAGNI** â€” If it's not in spec, don't build it
- **Honest reporting** â€” Flag blockers immediately, don't hide problems
- **Version awareness** â€” Note which spec version you're implementing against
- **Deviation choices** â€” Always give user A/B/C options for deviations

================
File: .claude/commands/asdf/handoff.md
================
---
description: Create session handoff notes for continuity
argument-hint: (no args)
---

# Session Handoff

Capture session state for seamless continuation in next session.

---

## Workflow

### Step 0: Release Feature Lock

**If a feature is currently locked by this session:**

1. Check `04-operations/locks/` for locks owned by this session
2. For each lock:
   - Delete the lock file
   - Update execution file status in `04-operations/active/[feature].md` to "Paused"
   - Update `implementation-active.md` Feature Execution Status (remove lock indicator)

```markdown
**Locks Released:**

| Feature | Previous Status | Now |
|---------|-----------------|-----|
| [feature-name] | In Progress | Paused (Available) |

Next session can continue with: `/asdf:code [feature]`
```

---

### Step 1: Gather Session Context

1. **Gather session context:**
   - What was the goal this session?
   - What was accomplished?
   - What's in progress (incomplete)?
   - What blockers were encountered?
   - What decisions were made?

### Step 2: Update implementation-active.md
   ```markdown
   # Implementation Active

   > **Last Updated:** YYMMDD HH:MM
   > **Session:** [Brief description]

   ## Current Task
   - **Feature:** [feature path]
   - **Status:** [In Progress / Blocked / Paused]
   - **Progress:** [X]%

   ## Files Changed This Session
   - [file1.ts] â€” [what changed]
   - [file2.ts] â€” [what changed]

   ## Blockers
   - [List or "None"]

   ## Uncommitted Work
   - [List any uncommitted changes]
   ```

3. **Update session-handoff.md with enhanced template:**
   ```markdown
   # Session Handoff

   > **Date:** YYMMDD
   > **Duration:** ~[X] hours
   > **Session ID:** [instance-id or "solo"]

   ---

   ## Mental Context (Critical for Reload)

   **What I was trying to do:**
   [1-2 sentences describing high-level goal]

   **Why this approach:**
   [Key architectural/design decisions and rationale]

   **What I learned:**
   - [Insight 1 about the codebase]
   - [Insight 2 about dependencies]
   - [Gotcha or unexpected behavior discovered]

   ---

   ## Technical Context

   **Completed This Session:**
   - [Task 1] â€” Done
   - [Task 2] â€” Done

   **In Progress:**
   - [Task] â€” [X]% complete
     - **Next step:** [specific action]
     - **Blocker:** [if any]

   **File Changes Summary:**
   | File | Change Type | Description |
   |------|-------------|-------------|
   | [file1.ts] | Modified | [what changed] |
   | [file2.ts] | Added | [purpose] |
   | [file3.ts] | Deleted | [why removed] |

   ---

   ## Decisions Made

   | Decision | Options Considered | Chosen | Rationale |
   |----------|-------------------|--------|-----------|
   | [decision1] | A, B | A | [why] |
   | [decision2] | X, Y, Z | Y | [why] |

   ---

   ## Blockers & Questions

   | Blocker/Question | Status | Action Needed |
   |------------------|--------|---------------|
   | [blocker1] | Waiting | [what's needed] |
   | [question1] | Open | [who to ask] |

   ---

   ## Environment Context

   **Branch:** [current branch name]
   **Uncommitted Changes:** [Yes/No â€” list if yes]
   **Tests Status:** [Passing/Failing â€” count if failing]
   **Build Status:** [OK/Broken]

   ---

   ## Next Session Should

   1. **[FIRST]** [Most important action with specific command]
   2. [Second priority]
   3. [Third priority]

   ---

   ## Quick Start
   ```bash
   # Branch and status
   git checkout [branch]
   git status

   # Resume from here:
   /asdf:code [feature-path]
   # OR
   [specific command to continue]
   ```

   ---

   ## Context Files to Load
   - `astraler-docs/03-features/[feature]/spec.md`
   - `astraler-docs/04-operations/active/[feature].md`
   - [Any other relevant files]
   ```

4. **Trigger related updates:**
   - Run `/asdf:sync` if any specs need updating
   - Run `/asdf:status` to refresh project heartbeat

5. **Verify completeness:**
   - All changes committed? (remind if not)
   - Specs up to date?
   - Blockers documented?

6. **Report:**
   - Summary of handoff notes created
   - Remind human of any pending actions

---

## When to Run

- **Always** before ending a session
- After significant milestone completion
- Before switching to different feature
- When pausing work for extended period

---

## Rules

- **Capture everything** â€” Next session has no memory of this one
- **Be specific** â€” "Fix auth bug" is useless; "Fix JWT expiry check in auth/middleware.ts:47" is useful
- **Include quick start** â€” Reduce context-loading time for next session
- **Honest about blockers** â€” Don't hide problems, document them
- **Mental context matters** â€” Decisions and rationale are hardest to reload

---

## Help

**Usage:** `/asdf:handoff`

**Arguments:** None

**Behavior:**
1. Release any feature locks held by this session
2. Gather session context (completed, in-progress, blockers)
3. Update implementation-active.md
4. Create enhanced session-handoff.md
5. Trigger sync if specs outdated
6. Verify all changes committed

**Output Sections:**
- Mental Context (critical for reload)
- Technical Context (tasks, files)
- Decisions Made (with rationale)
- Blockers & Questions
- Environment Context (branch, tests)
- Quick Start commands

**Examples:**
- `/asdf:handoff` â€” Create handoff before ending session

**Related:**
- `/asdf:status` â€” Quick status update
- `/asdf:onboard` â€” For next session orientation
- `/asdf` â€” All commands

================
File: .claude/commands/asdf/init.md
================
---
description: Initialize ASDF structure - supports new projects, existing code, or requirements docs
argument-hint: (interactive)
---

# Initialize ASDF

Single entry point for all project starting scenarios with iterative refinement.

---

## Skills Required

- **Activate:** `refinement-loop` (for iterative feedback)
- **Activate:** `spec-governance` (for templates and validation)
- **Activate:** `context-loading` (for proper hierarchy)

---

## Step 0: Incomplete Detection Scan (CRITICAL)

Before anything else, check if ASDF structure already exists:

```bash
# Check if astraler-docs/ exists
ls astraler-docs/ 2>/dev/null
```

**If not exists:** Proceed to Step 1.

**If exists:** Run comprehensive scan:

### Scan All Expected Components

```markdown
**ASDF structure exists. Scanning completeness...**

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Component                           â”‚ Status   â”‚ % Done  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 01-system-core/01-architecture/     â”‚ [STATUS] â”‚ [XX]%   â”‚
â”‚   â”œâ”€â”€ master-map.md                 â”‚ [STATUS] â”‚         â”‚
â”‚   â”œâ”€â”€ tech-stack.md                 â”‚ [STATUS] â”‚         â”‚
â”‚   â”œâ”€â”€ data-architecture.md          â”‚ [STATUS] â”‚         â”‚
â”‚   â””â”€â”€ infrastructure.md             â”‚ [STATUS] â”‚         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 01-system-core/02-standards/        â”‚ [STATUS] â”‚ [XX]%   â”‚
â”‚   â”œâ”€â”€ coding-standards.md           â”‚ [STATUS] â”‚         â”‚
â”‚   â”œâ”€â”€ api-standards.md              â”‚ [STATUS] â”‚         â”‚
â”‚   â”œâ”€â”€ testing-strategy.md           â”‚ [STATUS] â”‚         â”‚
â”‚   â””â”€â”€ performance-slas.md           â”‚ [STATUS] â”‚         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 01-system-core/03-design/           â”‚ [STATUS] â”‚ [XX]%   â”‚
â”‚   â”œâ”€â”€ ui-ux-design-system.md        â”‚ [STATUS] â”‚         â”‚
â”‚   â””â”€â”€ component-library.md          â”‚ [STATUS] â”‚         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 01-system-core/04-governance/       â”‚ [STATUS] â”‚ [XX]%   â”‚
â”‚   â”œâ”€â”€ security-policy.md            â”‚ [STATUS] â”‚         â”‚
â”‚   â”œâ”€â”€ decision-log.md               â”‚ [STATUS] â”‚         â”‚
â”‚   â””â”€â”€ glossary.md                   â”‚ [STATUS] â”‚         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 01-system-core/project-status.md    â”‚ [STATUS] â”‚         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 02-domains/                         â”‚ [STATUS] â”‚ [N] domains â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 03-features/                        â”‚ [STATUS] â”‚ [M] specs   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 04-operations/                      â”‚ [STATUS] â”‚ [XX]%   â”‚
â”‚   â”œâ”€â”€ implementation-active.md      â”‚ [STATUS] â”‚         â”‚
â”‚   â”œâ”€â”€ session-handoff.md            â”‚ [STATUS] â”‚         â”‚
â”‚   â””â”€â”€ roadmap.md                    â”‚ [STATUS] â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

**Overall Completion:** [XX]%
```

### Status Definitions

| Status | Meaning |
|--------|---------|
| Done | File exists with substantive content (>100 chars, has sections) |
| Partial | File exists but only template/placeholder content |
| Empty | File exists but <50 chars or blank |
| Missing | File does not exist |

### Calculate Completion

```python
# Completion scoring
REQUIRED_FILES = 14  # 13 system-core + project-status.md
populated = count(files with status == Done)
partial = count(files with status == Partial)
completion = (populated + partial * 0.5) / REQUIRED_FILES * 100
```

### Present Scan Results

**If 100% complete:**
```markdown
**ASDF structure is COMPLETE.**

- Created: [date from earliest file]
- Last updated: [date from most recent file]
- Domains: [N] defined
- Features: [M] specs

Please choose:
- **[update]** Update existing docs â†’ Run `/asdf:update`
- **[spec]** Add new feature â†’ Run `/asdf:spec`
- **[cancel]** Abort
```

**If incomplete (<100%):**
```markdown
**ASDF structure exists but INCOMPLETE.**

[Show scan table above]

**Missing/Incomplete:**
- [List specific files with Missing/Empty/Partial status]

Please choose:
- **[continue]** Resume setup, fill gaps only (recommended)
- **[override]** Start fresh, replace existing (WARNING: destructive)
- **[cancel]** Abort
```

### On User Choice

**On continue:**
1. Track which files need work (Missing, Empty, Partial)
2. Skip to Step 2 (Reference Collection)
3. In Step 3, ONLY generate content for incomplete files
4. Preserve existing content in Done files

**On override:**
1. Show second warning:
   ```markdown
   **WARNING: This will DELETE all existing ASDF content.**

   - [N] system-core files will be replaced
   - [M] domain specs will be deleted
   - [P] feature specs will be deleted

   Type "CONFIRM" to proceed, or any other key to cancel.
   ```
2. If confirmed â†’ Delete astraler-docs/, proceed to Step 1
3. If not â†’ Return to choice prompt

**On cancel:** Abort command

---

## Step 1: Determine Starting Point

Ask the user:

> **What's your starting point?**
> - **A) New project** â€” Fresh start, I'll describe the vision
> - **B) Existing codebase** â€” I have code, need specs generated
> - **C) Requirements docs** â€” I have BRD/PRD/specs to parse
> - **D) Mixed** â€” I have both code and docs

---

## Step 2: Reference Collection (All Paths)

Before generating anything, collect references:

```markdown
**Do you have existing documents to reference?**

Categories:
- **Business** â€” PRD, BRD, requirements, user stories
- **Technical** â€” API specs, architecture docs, schemas
- **Data** â€” ERD, database schemas, data dictionaries
- **Design** â€” Wireframes, mockups, design system
- **External** â€” Third-party API docs, competitor analysis

Provide file path(s) or type "no" to continue.
```

For each document provided:
1. Parse and extract relevant information
2. Report what was extracted
3. Ask for additional references
4. Repeat until user says "no more"

---

## Step 3: Execute Based on Starting Point

### A) New Project (Greenfield)

1. **Ask vision questions:**
   - What problem does this solve?
   - Who are the users?
   - What's the core functionality?
   - Any tech stack preferences?

2. **Draft system-core docs** (v1.0.0) from vision + references

3. **Identify initial domains** from core functionality

4. **Present for refinement:**
   ```markdown
   **Draft system-core v1.0.0 ready for review.**

   Created:
   - [N] architecture files
   - [M] standards files
   - [P] design files
   - [Q] governance files
   - [R] domains identified

   Please choose:
   - **Feedback** â€” Type your changes
   - **Reference** â€” Type `reference` to add source documents
   - **Confirm** â€” Type `confirm` to finalize
   ```

5. **Loop until confirmed**

---

### B) Existing Codebase (Brownfield)

1. **Ask for codebase path** (or use current directory)

2. **Scan and analyze:**
   - Detect tech stack from package.json, requirements.txt, etc.
   - Identify project structure patterns
   - Find key modules/components
   - Analyze existing tests, API patterns, UI frameworks

3. **Draft system-core** (v1.0.0) inferred from code:

   **01-architecture/**
   - `master-map.md` â€” From directory structure, entry points
   - `tech-stack.md` â€” From dependencies and runtime
   - `data-architecture.md` â€” From database schemas, models
   - `infrastructure.md` â€” From Docker, CI/CD configs

   **02-standards/**
   - `coding-standards.md` â€” From linter configs, patterns
   - `api-standards.md` â€” From API routes, error handling
   - `testing-strategy.md` â€” From test files structure
   - `performance-slas.md` â€” From monitoring configs

   **03-design/**
   - `ui-ux-design-system.md` â€” From CSS/style files
   - `component-library.md` â€” From UI components

   **04-governance/**
   - `security-policy.md` â€” From auth patterns
   - `decision-log.md` â€” Placeholder
   - `glossary.md` â€” From domain terms

4. **Draft domain specs** from code analysis

5. **Present for refinement** (same prompt as A)

6. **Loop until confirmed**

---

### C) Requirements Docs

1. **Ask for docs path** (PRD, BRD, specs, etc.)

2. **Parse and extract:**
   - Requirements (functional/non-functional)
   - User stories
   - Acceptance criteria
   - Domain concepts
   - Tech stack decisions

3. **Draft system-core** (v1.0.0) from requirements:
   - Architecture from system requirements
   - Standards from NFRs
   - Design from UI requirements
   - Governance from compliance/security

4. **Draft domain specs** from grouped requirements

5. **Draft feature specs** from user stories/FRs

6. **Present for refinement:**
   ```markdown
   **Draft ASDF structure v1.0.0 ready for review.**

   Extracted:
   - [N] functional requirements
   - [M] non-functional requirements
   - [P] domains identified
   - [Q] feature specs created

   Gaps identified:
   - [List unclear areas]

   Please choose:
   - **Feedback** â€” Type your changes
   - **Reference** â€” Type `reference` to add source documents
   - **Confirm** â€” Type `confirm` to finalize
   ```

7. **Loop until confirmed**

---

### D) Mixed (Code + Docs)

1. **Execute B)** â€” Scan existing code
2. **Execute C)** â€” Parse requirements docs
3. **Reconcile:**
   - Compare code reality vs documented requirements
   - Identify mismatches, gaps, undocumented features
4. **Draft unified specs** reflecting actual state
5. **Present reconciliation for refinement:**
   ```markdown
   **Draft reconciled ASDF structure v1.0.0 ready for review.**

   Reconciliation:
   - [N] features in code AND docs (aligned)
   - [M] features in code only (undocumented)
   - [P] features in docs only (not implemented)
   - [Q] mismatches found

   Please choose:
   - **Feedback** â€” Type your changes
   - **Reference** â€” Type `reference` to add source documents
   - **Confirm** â€” Type `confirm` to finalize
   ```

6. **Loop until confirmed**

---

## Step 4: Create Complete ASDF Structure (After Confirmation)

Create full structure with all files:

```
astraler-docs/
â”œâ”€â”€ 01-system-core/
â”‚   â”œâ”€â”€ 01-architecture/
â”‚   â”‚   â”œâ”€â”€ master-map.md           # System overview, mermaid diagrams
â”‚   â”‚   â”œâ”€â”€ tech-stack.md           # Languages, frameworks, tools
â”‚   â”‚   â”œâ”€â”€ data-architecture.md    # ERD diagram, database design
â”‚   â”‚   â””â”€â”€ infrastructure.md       # Deployment topology diagram
â”‚   â”œâ”€â”€ 02-standards/
â”‚   â”‚   â”œâ”€â”€ coding-standards.md     # Code style, patterns
â”‚   â”‚   â”œâ”€â”€ api-standards.md        # API design, versioning
â”‚   â”‚   â”œâ”€â”€ testing-strategy.md     # Test types, coverage
â”‚   â”‚   â””â”€â”€ performance-slas.md     # Response times, availability
â”‚   â”œâ”€â”€ 03-design/
â”‚   â”‚   â”œâ”€â”€ ui-ux-design-system.md  # Colors, typography
â”‚   â”‚   â””â”€â”€ component-library.md    # Reusable components
â”‚   â”œâ”€â”€ 04-governance/
â”‚   â”‚   â”œâ”€â”€ security-policy.md      # Auth, data protection
â”‚   â”‚   â”œâ”€â”€ decision-log.md         # ADRs
â”‚   â”‚   â””â”€â”€ glossary.md             # Domain terms
â”‚   â””â”€â”€ project-status.md           # Version, status
â”œâ”€â”€ 02-domains/
â”‚   â””â”€â”€ [domain-name]/
â”‚       â””â”€â”€ [domain]-domain.md      # ERD diagram, business rules
â”œâ”€â”€ 03-features/
â”‚   â””â”€â”€ YYMMDD-[feature-name]/
â”‚       â”œâ”€â”€ spec.md                 # User flow diagram
â”‚       â””â”€â”€ changelog.md
â””â”€â”€ 04-operations/
    â”œâ”€â”€ implementation-active.md
    â”œâ”€â”€ session-handoff.md
    â””â”€â”€ changelog/
        â””â”€â”€ YYMMDD-[event].md
```

**All files MUST include:**
- Version header (v1.0.0)
- Status (Draft | Review | Approved)
- Last Updated date
- Mermaid diagrams where required (see spec-governance)

---

## Step 5: Finalization Report

After user confirms:

```markdown
**ASDF Structure Finalized**

- **Version:** [X.Y.Z]
- **Location:** astraler-docs/
- **Status:** Approved

**Created:**
- [N] system-core files
- [M] domain specs
- [P] feature specs
- [Q] operations files

Proceeding to CLAUDE.md setup...
```

---

## Step 6: CLAUDE.md Generation (CRITICAL)

After creating astraler-docs/, generate or update CLAUDE.md so Claude Code knows the project uses ASDF.

### 6.1: Check Existing CLAUDE.md

```bash
# Check if CLAUDE.md exists
ls CLAUDE.md 2>/dev/null
```

### 6.2: Scenario A â€” No CLAUDE.md (Greenfield)

**Condition:** CLAUDE.md does not exist

**Action:** Generate new CLAUDE.md from template

```markdown
**Generating CLAUDE.md...**

Creating project entry point for Claude Code.

[Generate from spec-governance/references/claude-md-template.md]
[Populate variables from init conversation and tech-stack.md]

âœ“ CLAUDE.md created

Contents:
- Project name: [name]
- Agent: asdf-coder.md
- Commands: 17 ASDF commands
- Tech stack: [summary]
- Domains: [list]
- Critical rules: 4 items
```

### 6.3: Scenario B â€” CLAUDE.md Exists (Brownfield)

**Condition:** CLAUDE.md exists but no ASDF configuration

**Detection:** Check for ASDF markers:
```bash
grep -E "(ASDF|asdf-coder|astraler-docs|/asdf:)" CLAUDE.md
```

**If no ASDF markers found:**

```markdown
**CLAUDE.md Merge Preview**

Existing content detected:
- [Summarize existing sections]
- Agent: [existing agent or "none"]
- Commands: [N] existing commands
- Rules: [M] existing rules

Will add (merged, not replaced):
- ASDF Framework section
- Agent reference: `.claude/agents/asdf-coder.md`
- Commands: 17 ASDF commands (/asdf:*)
- Documentation reference: `astraler-docs/`
- ASDF critical rules (4 items)
- Context loading order

Choose:
- **[merge]** Apply changes (preserves existing content)
- **[view]** Show full merged file preview
- **[skip]** Don't modify CLAUDE.md (manual setup later)
- **[cancel]** Abort
```

**On merge:**
1. Read existing CLAUDE.md content
2. Identify existing sections (Agent, Commands, Rules, etc.)
3. Append ASDF sections without replacing existing content
4. If section exists (e.g., Commands), add ASDF commands to it
5. Save merged file
6. Report changes made

**On view:**
1. Show full merged file content
2. Return to merge prompt

**On skip:**
1. Note: "CLAUDE.md not modified. Run `/asdf:init` again to set up later."
2. Continue to completion

### 6.4: Scenario C â€” CLAUDE.md Already Has ASDF

**Condition:** CLAUDE.md exists AND has ASDF markers

**Action:**

```markdown
**CLAUDE.md Already Configured for ASDF**

Detected ASDF configuration in existing CLAUDE.md:
- Agent: [found reference]
- Commands: [N] ASDF commands found
- Documentation: astraler-docs/ referenced

Choose:
- **[update]** Update to latest ASDF configuration
- **[skip]** Keep existing CLAUDE.md as-is
- **[view]** Show current ASDF configuration
```

**On update:**
1. Preserve non-ASDF sections
2. Update ASDF sections to latest template
3. Report what was updated

### 6.5: CLAUDE.md Template Variables

| Variable | Source |
|----------|--------|
| `{{PROJECT_NAME}}` | From init conversation or package.json |
| `{{TECH_FRONTEND}}` | From generated tech-stack.md |
| `{{TECH_BACKEND}}` | From generated tech-stack.md |
| `{{TECH_DATABASE}}` | From generated tech-stack.md |
| `{{TECH_TESTING}}` | From generated tech-stack.md |
| `{{DOMAINS_LIST}}` | From 02-domains/ directory scan |
| `{{INIT_DATE}}` | Current date (YYMMDD) |

### 6.6: Final Completion Report

```markdown
**ASDF Initialization Complete**

**Structure:**
- Location: astraler-docs/
- System-core: [N] files
- Domains: [M] specs
- Features: [P] specs
- Operations: [Q] files

**CLAUDE.md:**
- Status: [Created | Merged | Updated | Skipped]
- Agent: asdf-coder.md configured

**Next steps:**
- Review generated specs for accuracy
- Run `/asdf:spec [feature]` for new features
- Run `/asdf:code [path]` when ready to implement
- Run `/asdf:onboard` to see project overview
```

---

## Rules

- **Always collect references first** â€” Before generating any content
- **Always use refinement loop** â€” Never finalize without explicit confirm
- **Version everything** â€” Start at v1.0.0, increment on changes
- **Include diagrams** â€” Mermaid diagrams are mandatory in system-core
- **Ask, don't assume** â€” Let user choose their path
- **Show, then adjust** â€” Draft first, iterate on feedback
- **Always handle CLAUDE.md** â€” Generate, merge, or update after structure creation

---

## Help

**Usage:** `/asdf:init`

**Arguments:** None (interactive)

**Behavior:**
1. Scan for existing ASDF structure
2. If exists: Show completeness scan, offer continue/override/cancel
3. If new: Ask starting point (A/B/C/D)
4. Collect reference documents
5. Generate structure based on path chosen
6. Present for refinement loop
7. Finalize on confirm
8. **Generate/update CLAUDE.md** (entry point for Claude Code)

**CLAUDE.md Handling:**
- **Greenfield:** Generate new CLAUDE.md with full ASDF config
- **Brownfield:** Merge ASDF config into existing CLAUDE.md
- **Existing ASDF:** Offer to update to latest config

**Examples:**
- `/asdf:init` â€” Start interactive init
- Choose A for new project, B for existing code, C for requirements, D for mixed

**Related:**
- `/asdf:spec` â€” Create individual feature spec
- `/asdf:update` â€” Update existing component
- `/asdf` â€” All commands

================
File: .claude/commands/asdf/onboard.md
================
---
description: ONBOARD MODE - Quick 5-minute project tour
argument-hint: (no args)
---

# ONBOARD MODE: Guided Project Tour

Quick 5-minute introduction for new or returning developers.

---

## Skills Required

- **Activate:** `context-loading` (for project data)

---

## Workflow

Present 4 sections, each ~1-2 minutes:

### Section 1: Project Overview (~1 min)

Load from `01-system-core/`:
- Project name and purpose (from master-map.md)
- Tech stack summary (from tech-stack.md)

```markdown
## 1. Project Overview

**What is this?**
[Project description from master-map.md]

**Tech Stack:**
- Frontend: [framework + UI library]
- Backend: [framework + runtime]
- Database: [primary database]
- Testing: [test frameworks]

---
```

---

### Section 2: Current Status (~1 min)

Load from `04-operations/`:
- Phase from roadmap.md
- Feature counts from implementation-active.md
- Overall progress

```markdown
## 2. Current Status

**Phase:** [Phase name from roadmap]
**Progress:** [X]% complete

| Feature | Status |
|---------|--------|
| [feature1] | Done |
| [feature2] | Active ([X]%) |
| [feature3] | Active ([Y]%) |
| [feature4] | Planned |

---
```

---

### Section 3: Active Work (~1 min)

Load from `04-operations/`:
- Locked features from locks/
- Active blockers from implementation-active.md

```markdown
## 3. Active Work

**Currently being implemented:**
| Feature | Instance | Progress |
|---------|----------|----------|
| [feature] | [instance-id] | [X]% |

**Blockers:**
- [Blocker description] (affects: [feature])

**Available for work:**
- [feature-name] (P0 priority)
- [feature-name] (P1 priority)

---
```

---

### Section 4: How to Start (~2 min)

Provide actionable commands:

```markdown
## 4. How to Start

**Continue existing work:**
```bash
/asdf:status                    # See what's active
/asdf:code [feature-path]       # Implement a feature
```

**Start new work:**
```bash
/asdf:spec [feature-name]       # Create new feature spec
/asdf:roadmap                   # See project phases
```

**Get help:**
```bash
/asdf                           # All commands
/asdf:report all                # Project health
/asdf:audit                     # Check for issues
```

---

**Quick Reference:**
| Task | Command |
|------|---------|
| Check status | `/asdf:status` |
| Implement feature | `/asdf:code [path]` |
| Create spec | `/asdf:spec [name]` |
| Sync codeâ†’spec | `/asdf:sync` |
| Generate tests | `/asdf:test [feature]` |
| Create PR | `/asdf:pr [feature]` |

---
```

---

### Section 5: Next Steps

```markdown
Ready to start? Choose:
- **[status]** Show detailed current status
- **[roadmap]** Show project roadmap
- **[start]** I'm ready, exit onboard
```

---

## Adaptive Content

**If project is new (no features implemented):**
```markdown
**Getting Started:**
This project is just starting. Run these commands first:

1. `/asdf:init` â€” Set up project structure (if not done)
2. `/asdf:spec [first-feature]` â€” Create first feature spec
3. `/asdf:code [feature-path]` â€” Implement the feature
```

**If project has blockers:**
```markdown
**Attention Required:**
There are [N] active blockers. Consider addressing these first:
- [Blocker 1]
- [Blocker 2]
```

**If returning after long break (>7 days since handoff):**
```markdown
**Catching Up:**
Last session was [N] days ago. Here's what changed:
- [Recent change 1]
- [Recent change 2]

Read the handoff: `/asdf:status` or check `session-handoff.md`
```

---

## Timing

| Section | Target Duration |
|---------|-----------------|
| Overview | 1 minute |
| Status | 1 minute |
| Active Work | 1 minute |
| How to Start | 2 minutes |
| **Total** | **5 minutes** |

---

## Rules

- **Concise** â€” Max 5 minutes total read time
- **Actionable** â€” End with clear next steps
- **Adaptive** â€” Adjust content based on project state
- **Welcoming** â€” Friendly tone for new team members
- **Current** â€” Pull live data, not stale info

---

## Help

**Usage:** `/asdf:onboard`

**Arguments:** None

**Behavior:**
1. Load project overview
2. Show current status
3. Display active work
4. Provide getting started guide
5. Offer next step options

**Examples:**
- `/asdf:onboard` â€” Start guided tour

**Related:**
- `/asdf:status` â€” Detailed status
- `/asdf:roadmap` â€” Project phases
- `/asdf` â€” All commands

================
File: .claude/commands/asdf/pr.md
================
---
description: Create PR package for feature review
argument-hint: [feature-name]
---

# Create PR Package

**Feature:** $ARGUMENTS

---

## Skills Required

- **Activate:** `pr-review` (for package creation templates)
- **Activate:** `context-loading` (for spec loading)

---

## Workflow

### Step 1: Locate Feature

1. Find feature in `03-features/*-$ARGUMENTS/`
2. Load `spec.md` and `changelog.md`
3. Load execution file from `04-operations/active/$ARGUMENTS.md` if exists

**If not found:**
```markdown
**Feature Not Found**

Cannot find spec for "$ARGUMENTS" in `03-features/`.

Options:
- Create spec first: `/asdf:spec $ARGUMENTS`
- Check feature name spelling
```

---

### Step 2: Gather Changes

1. **From execution file** (if exists):
   - Extract "Files Modified" list
   - Extract "Deviations" list

2. **From git** (if available):
   ```bash
   git diff --name-only HEAD~N  # recent commits
   git log --oneline -N         # commit messages
   ```

3. **From spec changelog**:
   - Recent version changes
   - Implementation progress notes

---

### Step 3: Generate Package

Create directory: `.pr-review/YYMMDD-$ARGUMENTS/`

**Use current date from:** `date +%y%m%d`

Generate files:

1. **summary.md**
   - Feature ID and spec version
   - Summary from spec overview
   - Files changed table
   - AC status from spec

2. **changes.md**
   - Detailed file-by-file changes
   - Code snippets for significant changes

3. **spec-diff.md**
   - List all deviations from spec
   - Include resolution status (A/B/C)
   - Note if reverse sync needed

4. **checklist.md**
   - Full review checklist from `pr-review` skill
   - Pre-filled based on available info

---

### Step 4: Present Result

```markdown
**PR Package Created**

Feature: $ARGUMENTS
Spec Version: vX.Y.Z
Package: `.pr-review/YYMMDD-$ARGUMENTS/`

**Contents:**
| File | Purpose |
|------|---------|
| summary.md | PR description |
| changes.md | [N] files changed |
| spec-diff.md | [M] deviations |
| checklist.md | Review checklist |

**AC Coverage:**
| Status | Count |
|--------|-------|
| Implemented | [X] |
| Partial | [Y] |
| Missing | [Z] |

**Next Steps:**
1. Review package: `cat .pr-review/YYMMDD-$ARGUMENTS/summary.md`
2. AI review: `/asdf:review .pr-review/YYMMDD-$ARGUMENTS/`
3. Or share for human review

**Reminder:** If deviations exist, run `/asdf:sync $ARGUMENTS` first.
```

---

## PR Package Contents Detail

### summary.md Sections

```markdown
# PR: [Feature Name]

> **Feature ID:** ...
> **Spec Version:** ...
> **Created:** ...

## Summary
[From spec overview section]

## Changes
[High-level bullet list]

## Files Changed
| File | Change Type | Lines |

## Acceptance Criteria Status
| AC | Description | Status |

## Deviations from Spec
| Section | Deviation | Reason | Resolution |

## Related
- Spec path
- Domain path
- Execution file path
```

### changes.md Sections

```markdown
# Detailed Changes

## New Files
### `path/to/new-file.ts`
[Description of what this file does]

## Modified Files
### `path/to/modified-file.ts`
[Description of changes]

Key changes:
- [Change 1]
- [Change 2]

## Deleted Files
- `path/to/deleted-file.ts` - [Reason]
```

### spec-diff.md Sections

```markdown
# Spec Deviations

## Deviations Requiring Sync
| # | Section | Spec Says | Implementation | Resolution |
|---|---------|-----------|----------------|------------|

## Already Synced
| # | Section | Original | Updated | Synced Date |
|---|---------|----------|---------|-------------|

## Sync Recommendation
[Run `/asdf:sync` if deviations exist]
```

---

## Rules

- **Spec-based** â€” PR description derived from spec and changelog
- **Complete** â€” All changed files must be listed
- **Deviation tracking** â€” Every spec deviation documented
- **Fresh date** â€” Use `date +%y%m%d` for package folder name
- **No execution** â€” This command only creates package, doesn't run git commands

================
File: .claude/commands/asdf/report.md
================
---
description: REPORT MODE - Generate progress reports for features or project
argument-hint: [feature|all]
---

# REPORT MODE: Progress Report

**Scope:** $ARGUMENTS

---

## Skills Required

- **Activate:** `context-loading` (for loading feature data)

---

## Workflow

### Determine Report Type

- If $ARGUMENTS is a feature name â†’ Feature Report
- If $ARGUMENTS is "all" or blank â†’ Project Report

---

## Feature Report

### Step 1: Load Feature Data

1. Find spec in `astraler-docs/03-features/*-$ARGUMENTS/`
2. Load execution file from `04-operations/active/$ARGUMENTS.md`
3. Load test results (if available)
4. Load changelog

---

### Step 2: Calculate Metrics

- **Progress:** Based on implementation status table
- **Test Coverage:** From testing section or test results
- **Time:** Started date to now, estimate completion

---

### Step 3: Generate Feature Report

```markdown
**Feature Report: [Feature Name]**

## Status
- **Spec:** v[X.Y.Z] ([Draft|Approved|Implemented])
- **Implementation:** [X]% complete
- **Tests:** [N]/[M] passing

## Progress
| Task | Status | Assignee |
|------|--------|----------|
| [Task 1] | Done | [Instance] |
| [Task 2] | Active | [Instance] |
| [Task 3] | Pending | â€” |

## Test Coverage
- Unit: [X]%
- Integration: [Y]%
- E2E: [Z]%

## Blockers
- [Blocker description]

## Time Tracking
- Started: [YYMMDD]
- Estimated completion: [YYMMDD]
- Days elapsed: [N]

## Deviations
| Section | Status |
|---------|--------|
| [section] | [Synced|Pending] |

## Files Modified
- [N] files total
- Key files: [list top 5]
```

---

## Project Report

### Step 1: Aggregate Data

1. Scan all features in `03-features/`
2. Load `04-operations/implementation-active.md`
3. Load `04-operations/tech-debt.md` (if exists)
4. Load `04-operations/roadmap.md`
5. Count specs by status

---

### Step 2: Calculate Health Indicators

- **Spec freshness:** Last updated within 7 days = Fresh
- **Tech debt:** Count by priority
- **Blocker count:** From active features
- **Test coverage:** Average across features

---

### Step 3: Generate Project Report

```markdown
**Project Health Report**

## Overview
- **Features:** [N] total ([Done], [Active], [Planned])
- **Specs:** [M] files
- **Test Coverage:** [X]% average
- **Phase:** [Current phase from roadmap]

## Feature Status
| Feature | Status | Progress | Assignee |
|---------|--------|----------|----------|
| [feature1] | Done | 100% | â€” |
| [feature2] | Active | 75% | [Instance] |
| [feature3] | Active | 40% | [Instance] |
| [feature4] | Planned | 0% | â€” |

## Health Indicators
| Indicator | Value | Status |
|-----------|-------|--------|
| Specs up-to-date | [N]/[M] | [Green/Yellow/Red] |
| Tech debt items | [N] | [Green/Yellow/Red] |
| Active blockers | [N] | [Green/Yellow/Red] |
| Test coverage | [X]% | [Green/Yellow/Red] |

## Tech Debt Summary
- High priority: [N] items ([X]h estimated)
- Medium priority: [M] items
- Low priority: [O] items

## Blockers
| Feature | Blocker | Since |
|---------|---------|-------|
| [feature] | [description] | [YYMMDD] |

## Recommendations
1. [Actionable recommendation 1]
2. [Actionable recommendation 2]
3. [Actionable recommendation 3]

## Next Priorities
1. [From roadmap P0]
2. [From roadmap P1]
3. [From roadmap P1]
```

---

## Health Indicator Thresholds

| Indicator | Green | Yellow | Red |
|-----------|-------|--------|-----|
| Specs up-to-date | >80% | 50-80% | <50% |
| Tech debt | <5 items | 5-15 items | >15 items |
| Blockers | 0 | 1-2 | >2 |
| Test coverage | >70% | 40-70% | <40% |

---

## Rules

- **Data-driven** â€” Only report what's in the docs
- **Actionable** â€” Include recommendations
- **Visual** â€” Use tables for scannability
- **Honest** â€” Flag problems, don't hide them

---

## Help

**Usage:** `/asdf:report [feature|all]`

**Arguments:**
- feature: Name of specific feature to report on
- all: Generate project-wide report (default if blank)

**Behavior:**
1. Determine report scope
2. Load relevant data
3. Calculate metrics
4. Generate formatted report

**Examples:**
- `/asdf:report checkout` â€” Report on checkout feature
- `/asdf:report all` â€” Full project health report
- `/asdf:report` â€” Same as 'all'

**Related:**
- `/asdf:status` â€” Quick status snapshot
- `/asdf:audit` â€” Spec health check
- `/asdf:roadmap` â€” Phase planning

================
File: .claude/commands/asdf/review.md
================
---
description: AI code review of PR package from fresh context
argument-hint: [pr-package-path]
---

# AI Code Review

**PR Package:** $ARGUMENTS

---

## Skills Required

- **Activate:** `pr-review` (for review protocol and templates)
- **Activate:** `context-loading` (for standards loading)

---

## CRITICAL: Fresh Context Requirement

**This review MUST be performed with fresh perspective.**

Before starting:
1. Clear any assumptions from prior work on this feature
2. Load spec FRESH from PR package path
3. Apply checklist objectively as if seeing code for first time

**Best practice:** Run this command in a NEW Claude instance for unbiased review.

---

## Workflow

### Step 1: Load PR Package

1. Read `$ARGUMENTS/summary.md` to understand PR scope
2. Read `$ARGUMENTS/changes.md` for file details
3. Read `$ARGUMENTS/spec-diff.md` for deviations
4. Read `$ARGUMENTS/checklist.md` for review criteria

**If package not found:**
```markdown
**PR Package Not Found**

Cannot find PR package at "$ARGUMENTS".

Create package first: `/asdf:pr [feature-name]`
```

---

### Step 2: Load Fresh Context

1. **Extract feature spec path** from summary.md
2. **Load spec FRESH** â€” Read `03-features/.../spec.md` completely
3. **Load coding standards** from `01-system-core/02-standards/`
4. **Load domain context** if referenced

**DO NOT use prior conversation context about this feature.**

---

### Step 3: Spec Compliance Check

For EACH acceptance criterion in spec:

1. Read AC description and testable criteria
2. Check if implementation fulfills AC
3. Mark status: PASS / FAIL / PARTIAL

```markdown
**Spec Compliance Check**

| AC | Description | Status | Evidence | Notes |
|----|-------------|--------|----------|-------|
| AC-001 | [criteria] | PASS | [file:line] | |
| AC-002 | [criteria] | FAIL | - | Missing validation |
| AC-003 | [criteria] | PARTIAL | [file:line] | Happy path only |
```

---

### Step 4: Code Quality Review

Apply checklist systematically:

**Spec Compliance:**
- [ ] Code matches spec intent
- [ ] All ACs implemented
- [ ] No scope creep (undocumented features)
- [ ] No missing requirements

**Code Quality:**
- [ ] Follows coding standards
- [ ] No hardcoded values
- [ ] Error handling complete
- [ ] No debug code

**Security:**
- [ ] No secrets in code
- [ ] Input validation
- [ ] SQL injection prevented
- [ ] XSS prevented

**Performance:**
- [ ] No N+1 queries
- [ ] Appropriate caching

**Testing:**
- [ ] Unit tests present
- [ ] Integration tests for APIs
- [ ] Edge cases covered

---

### Step 5: Identify Issues

Categorize by severity:

**Critical (Blocks Merge):**
- Security vulnerabilities
- Data loss risks
- Spec violations (missing ACs)
- Breaking changes without handling

**Major (Should Fix):**
- Bug potential
- Missing error handling
- Maintainability issues

**Minor (Consider):**
- Style improvements
- Optimization opportunities
- Naming suggestions

For each issue:
- File and line number
- Clear description
- Suggested fix

---

### Step 6: Generate Verdict

Based on findings, choose ONE:

**APPROVE**
- All critical checks pass
- All ACs implemented
- No security issues
- Minor issues acceptable for follow-up

**REQUEST_CHANGES**
- Critical issues found
- Must be fixed before merge
- List specific blockers

**NEEDS_DISCUSSION**
- Architectural decision required
- Spec ambiguity discovered
- Trade-off decision needed

---

### Step 7: Present Review

```markdown
# AI Review: [Feature Name]

> **Reviewed:** YYMMDD
> **PR Package:** $ARGUMENTS
> **Spec Version:** vX.Y.Z
> **Review Duration:** [time]

---

## Verdict: [APPROVE | REQUEST_CHANGES | NEEDS_DISCUSSION]

---

## Spec Compliance: [X]/[Y] ACs Passing

| AC | Status | Notes |
|----|--------|-------|
| AC-001 | PASS | |
| AC-002 | FAIL | [reason] |

---

## Issues Found

### Critical ([N])
| # | File:Line | Issue | Fix |
|---|-----------|-------|-----|

### Major ([N])
| # | File:Line | Issue | Suggestion |
|---|-----------|-------|------------|

### Minor ([N])
| # | File:Line | Issue | Suggestion |
|---|-----------|-------|------------|

---

## Checklist Summary

| Category | Pass | Fail |
|----------|------|------|
| Spec Compliance | [X] | [Y] |
| Code Quality | [X] | [Y] |
| Security | [X] | [Y] |
| Performance | [X] | [Y] |
| Testing | [X] | [Y] |

---

## Positive Notes

- [Good thing 1]
- [Good thing 2]

---

## Verdict Explanation

[Why this verdict was chosen]

---

## Required Actions

[If REQUEST_CHANGES:]
1. Fix: [Critical issue 1]
2. Fix: [Critical issue 2]
3. Re-run: `/asdf:review $ARGUMENTS`

[If APPROVE:]
Ready for merge. Address minor issues in follow-up if desired.

[If NEEDS_DISCUSSION:]
Question requiring decision:
- [Question]
```

---

## Rules

| Rule | Description |
|------|-------------|
| Fresh Context | MUST load spec fresh, ignore prior conversation |
| Objective | Apply same checklist every time |
| Actionable | Every issue includes file:line and fix |
| Verdict Required | MUST choose APPROVE / REQUEST_CHANGES / NEEDS_DISCUSSION |
| Balanced | Note positives, not just problems |
| Traceable | Reference specific code locations |

================
File: .claude/commands/asdf/roadmap.md
================
---
description: Manage project roadmap phases and feature priorities
argument-hint: [action] (view|add|reorder|phase)
---

# Roadmap Management

**Action:** $ARGUMENTS

---

## Skills Required

- **Activate:** `context-loading` (for loading existing roadmap)

---

## Workflow

### Step 1: Load Roadmap

1. Read `astraler-docs/04-operations/roadmap.md`
2. Parse current phase, features, dependencies
3. Determine requested action from $ARGUMENTS

---

### Step 2: Execute Action

#### Action: `view` (default)

Display current roadmap state:

```markdown
**Project Roadmap**

Current Phase: [Phase Name] ([X]%)

**Phase Summary:**
| Phase | Status | Progress |
|-------|--------|----------|
| Phase 1 | Active | 60% |
| Phase 2 | Planned | 0% |

**Current Phase Features:**
| Priority | Feature | Status | Blocker |
|----------|---------|--------|---------|
| P0 | [Feature] | Done | - |
| P0 | [Feature] | 60% | B-001 |

**Commands:**
- `/asdf:roadmap add [feature] [phase] [priority]`
- `/asdf:roadmap reorder [feature] [new-phase|priority]`
- `/asdf:roadmap phase [status|close|next]`
```

---

#### Action: `add [feature] [phase] [priority]`

Add feature to roadmap:

1. **Validate feature spec exists**
   ```
   [Check 03-features/*-[feature]/spec.md]

   If not found:
   "Feature spec not found. Create first: /asdf:spec [feature]"
   ```

2. **Check dependencies**
   - Read spec's Dependencies section
   - Verify all dependencies in same or earlier phase

3. **Validate placement**
   ```
   If dependencies in later phase:
   "Cannot add '[feature]' to Phase [X].

   Dependency conflict:
   - [DEP] is in Phase [Y] (must be Phase [X] or earlier)

   Options:
   - [move-dep] Move dependency to earlier phase
   - [later-phase] Add feature to Phase [Y] instead
   - [cancel] Abort"
   ```

4. **Add to roadmap**
   - Insert in correct phase with priority
   - Update dependency graph
   - Increment roadmap version

---

#### Action: `reorder [feature] [target]`

Move feature priority or phase:

**Target formats:**
- `P0`, `P1`, `P2` â€” Change priority within same phase
- `phase:2` â€” Move to different phase
- `before:[feature]` â€” Place before another feature

1. **Parse target**

2. **Validate move**
   ```
   [Check if move breaks dependencies]

   If blocked:
   "Cannot move '[feature]' to [target].

   Dependency conflict:
   - [DEP] must come before [feature]
   - [DEP] is currently in Phase [X]

   Options:
   - [cascade] Move dependencies too
   - [cancel] Abort reorder"
   ```

3. **Execute move**
   - Update feature position
   - Recalculate phase progress
   - Update dependency graph
   - Log in Reorder Log

4. **Present result**
   ```markdown
   **Roadmap Updated**

   Moved: [feature]
   From: Phase [X], P[Y]
   To: Phase [A], P[B]

   Version: [X.Y.Z] â†’ [X.Y+1.Z]

   [Show updated phase view]
   ```

---

#### Action: `phase [subaction]`

Phase management:

**`phase status`**
```markdown
**Phase [N]: [Name]**

Progress: [X]%
Features: [Done]/[Total]

| Feature | Priority | Status |
|---------|----------|--------|

Exit Criteria:
- [x] Criterion 1
- [ ] Criterion 2

**Ready to close?** [yes/no]
```

**`phase close`**
1. Check all P0 features complete
2. Check exit criteria
3. If not ready:
   ```
   "Cannot close Phase [N].

   Incomplete:
   - P0 feature: [feature] ([X]%)
   - Exit criteria: [criterion]

   Complete these first, then run: /asdf:roadmap phase close"
   ```
4. If ready:
   - Mark phase as âœ… Done
   - Advance current phase
   - Update roadmap version

**`phase next`**
- Preview next phase
- Show dependencies from current phase
- Estimate readiness

---

## Dependency Validation Rules

| Rule | Description |
|------|-------------|
| No circular | A â†’ B â†’ A is invalid |
| Phase order | Dependencies must be in same or earlier phase |
| Priority respect | P0 deps should complete before P1 features |
| Cross-phase | Feature in Phase N can depend on Phase N-1 |

---

## Version Management

Roadmap versioning:
- **Patch** (1.0.+1): Status updates, progress changes
- **Minor** (1.+1.0): Feature additions, reorders
- **Major** (+1.0.0): Phase restructuring

---

## Rules

- **Dependency-first** â€” Always validate dependencies before changes
- **P0 critical** â€” P0 features block phase completion
- **Version tracked** â€” All changes logged in Reorder Log
- **No orphans** â€” Every feature must be in a phase

================
File: .claude/commands/asdf/spec.md
================
---
description: DESIGN MODE - Brainstorm and create feature specification with iterative refinement
argument-hint: [feature-name]
---

# DESIGN MODE: Create Feature Spec

**Feature:** $ARGUMENTS

---

## Skills Required

- **Activate:** `refinement-loop` (for iterative feedback)
- **Activate:** `spec-governance` (for templates and validation)
- **Activate:** `context-loading` (for proper hierarchy)

---

## Workflow

### Step 0: Duplicate Detection (CRITICAL)

Before drafting, check if feature already exists:

```bash
# Check for existing feature spec
ls astraler-docs/03-features/*-$ARGUMENTS/ 2>/dev/null
```

**If exists, present:**

```markdown
**Feature '$ARGUMENTS' already exists.**

Current state:
- Location: astraler-docs/03-features/[YYMMDD]-$ARGUMENTS/
- Version: v[X.Y.Z]
- Status: [Draft | Review | Approved | Implemented]
- Last updated: [YYMMDD]

Please choose:
- **[continue]** Resume editing current spec (opens refinement loop)
- **[new-version]** Create major version (v+1.0.0) for significant changes
- **[view]** Just show the current spec
- **[cancel]** Abort

Type your choice:
```

**On user choice:**
- `continue` â†’ Load existing spec, present with refinement prompt
- `new-version` â†’ Bump to next major version, start refinement loop
- `view` â†’ Display current spec, no changes
- `cancel` â†’ Abort command

**If not exists:** Proceed to Step 0.5.

---

### Step 0.5: Acquire Spec Lock (Multi-Instance)

Before editing (new or existing spec), acquire lock:

1. **Generate instance ID** (if not set):
   ```bash
   # Format: YYMMDD-HHMM-random
   echo "$(date +%y%m%d-%H%M)-$(openssl rand -hex 2)"
   ```

2. **Check for existing lock:**
   ```bash
   cat astraler-docs/04-operations/spec-locks/[feature-name].lock 2>/dev/null
   ```

3. **If locked by another instance:**
   ```markdown
   **SPEC LOCKED**

   Feature: [feature-name]
   Locked by: [other-instance-id]
   Since: [timestamp]
   Last activity: [N minutes ago]

   [STOPPED] Cannot edit while locked.

   Options:
   - Wait for lock release
   - Contact editor to coordinate
   - Type `force` to override (DANGER: may cause conflicts)
   ```

4. **If not locked or owned by this instance:**
   Create/update lock file:
   ```markdown
   # Spec Lock: [feature-name]

   Instance: [instance-id]
   Acquired: [YYMMDD HH:MM]
   Last Activity: [YYMMDD HH:MM]
   Operation: DESIGN
   ```

5. **Proceed to Step 1**

---

### Step 1: Reference Collection

Before drafting, collect references:

```markdown
**Do you have existing documents to reference for this feature?**

Categories:
- **Business** â€” PRD sections, user stories, acceptance criteria
- **Technical** â€” API specs, existing service docs
- **Data** â€” Related schemas, entities
- **Design** â€” Wireframes, mockups for this feature
- **External** â€” Third-party docs if integrating

Provide file path(s) or type "no" to continue.
```

For each document:
1. Parse and extract feature-relevant information
2. Report what was extracted
3. Ask for additional references
4. Repeat until user says "no more"

---

### Step 2: Load Context

1. Read `astraler-docs/01-system-core/` for global standards
2. Identify relevant domain from `astraler-docs/02-domains/`
3. Check existing features in `astraler-docs/03-features/` for patterns
4. Check `astraler-docs/04-operations/session-handoff.md` for prior work

---

### Step 3: Draft Spec (v1.0.0)

Create spec following template from `spec-governance` skill:

**Required sections:**
1. Overview + Business Value
2. Requirements (FR/NFR/Out of Scope)
3. Technical Design + User Flow Diagram (mermaid)
4. UI/UX + Wireframes
5. API Contract
6. Acceptance Criteria
7. Testing
8. Open Questions (unresolved items)
9. Changelog

**Be concrete:**
- Include API contracts with request/response examples
- Include data structures
- Include mermaid user flow diagram
- Include ASCII wireframes or design references

---

### Step 4: Present for Review

```markdown
**Draft [Feature Name] spec v1.0.0 ready for review.**

Sections:
- Overview: [summary]
- Requirements: [N] functional, [M] non-functional
- Technical Design: [key components]
- API Endpoints: [N] endpoints defined
- Acceptance Criteria: [N] criteria

Open Questions:
- [List any unresolved items]

Please choose:
- **Feedback** â€” Type your changes/concerns
- **Reference** â€” Type `reference` to add source documents
- **Confirm** â€” Type `confirm` to finalize
```

---

### Step 5: Refinement Loop

On **Feedback**:
1. Parse feedback for specific changes
2. Update relevant sections
3. Increment version (minor: X.Y.+1)
4. Summarize changes made
5. Re-present with refinement prompt

```markdown
**Updated to v[X.Y.Z]**

Changes made:
- [Section]: [What changed]
- [Section]: [What changed]

Please choose:
- **Feedback** â€” Type your changes/concerns
- **Reference** â€” Type `reference` to add source documents
- **Confirm** â€” Type `confirm` to finalize
```

On **Reference**:
1. Collect additional documents
2. Parse and extract relevant info
3. Increment version (minor: X.+1.0)
4. Update spec with new information
5. Re-present with refinement prompt

Loop continues until user types **confirm**.

---

### Step 6: Finalization

On **Confirm**:

1. Get today's date: `bash -c 'date +%y%m%d'`
2. Update version status to "Approved"
3. Create folder: `astraler-docs/03-features/YYMMDD-[feature-name]/`
4. Save `spec.md` with final version
5. Create `changelog.md` with creation entry
6. **Release spec lock:**
   ```bash
   rm astraler-docs/04-operations/spec-locks/[feature-name].lock
   ```

```markdown
**Spec Finalized**

- **Name:** [feature-name]
- **Version:** [X.Y.Z]
- **Status:** Approved
- **Location:** astraler-docs/03-features/YYMMDD-[feature-name]/spec.md
- **Lock:** Released

**Next steps:**
- Review spec one more time
- Run `/asdf:code astraler-docs/03-features/YYMMDD-[feature-name]/` to implement
```

---

## Output Location

```
astraler-docs/03-features/YYMMDD-[feature-name]/
â”œâ”€â”€ spec.md        # The specification (versioned)
â””â”€â”€ changelog.md   # Version history
```

---

## Version Format in File

```markdown
# [Feature Name]

> **Version:** 1.0.0
> **Status:** Draft | Review | Approved
> **Feature ID:** YYMMDD-feature-name
> **Domain:** [Link to domain spec]
> **Created:** YYMMDD
> **Last Updated:** YYMMDD
```

---

## Rules

- **Always collect references first** â€” Even if user says "no"
- **Always use refinement loop** â€” Never save without explicit confirm
- **Draft first, adjust later** â€” Don't ask too many questions upfront
- **Version track iterations** â€” Every change increments version
- **Be thorough** â€” Anticipate edge cases, dependencies, blockers
- **Include diagrams** â€” User flow mermaid diagram is mandatory
- **Link domains** â€” Reference relevant domain specs
- **List open questions** â€” Unresolved items at end of spec
- **No implementation** â€” Design only, code comes via `/asdf:code`
- **Lock before edit** â€” Acquire spec lock in multi-instance scenarios

---

## Help

**Usage:** `/asdf:spec [feature-name]`

**Arguments:**
- feature-name: Name of the feature to spec (e.g., "checkout", "user-auth")

**Behavior:**
1. Check for duplicate spec
2. Acquire spec lock (multi-instance)
3. Collect reference documents
4. Load context from system-core/domains
5. Draft spec with all required sections
6. Refinement loop until confirmed
7. Save to `03-features/YYMMDD-[name]/`
8. Release spec lock

**Examples:**
- `/asdf:spec checkout` â€” Create checkout feature spec
- `/asdf:spec user-authentication` â€” Create auth feature spec

**Related:**
- `/asdf:code` â€” Implement from spec
- `/asdf:update` â€” Update existing spec
- `/asdf:sync` â€” Sync spec after code changes
- `/asdf` â€” All commands

================
File: .claude/commands/asdf/status.md
================
---
description: Update project status heartbeat
argument-hint: (no args)
---

# Update Project Status

Refresh the project heartbeat at `astraler-docs/01-system-core/project-status.md`.

---

## Workflow

1. **Scan current state:**
   - Check `astraler-docs/04-operations/implementation-active.md` for active work
   - Count features by status in `astraler-docs/03-features/`
   - Check recent changelog entries
   - Identify blockers
   - **Check `04-operations/locks/` for active locks**

2. **Update project-status.md:**

   ```markdown
   # Project Status

   > **Last Updated:** YYMMDD
   > **Version:** X.Y.Z
   > **Health:** [Green/Yellow/Red]

   ## Active Work
   - [Current task from implementation-active.md]
   - Progress: [X]%

   ## Feature Locks

   | Feature | Locked By | Since | Task |
   |---------|-----------|-------|------|
   | [feature] | [instance] | [timestamp] | [task] |

   > No locks = "No active locks. Features available for work."

   ## Feature Summary
   | Status | Count |
   |--------|-------|
   | Planned | X |
   | In Progress | X |
   | Blocked | X |
   | Implemented | X |

   ## Recent Changes
   - [Last 3-5 changelog entries]

   ## Blockers
   - [List or "None"]

   ## Next Priorities
   - [Top 3 upcoming items]
   ```

3. **Report:**
   - Show updated status
   - Highlight any concerns (blockers, stale features)

---

## When to Run

- Start of each session (quick orientation)
- After completing major milestones
- Before stakeholder updates
- When asked "what's the project status?"

---

## Rules

- **Factual only** â€” Report what IS, not what should be
- **Concise** â€” Status file should be scannable in 30 seconds
- **Actionable** â€” Blockers and next priorities clearly stated

================
File: .claude/commands/asdf/sync.md
================
---
description: SYNC MODE - Reverse sync code changes back to specs with confirmation
argument-hint: [feature-path] (optional)
---

# SYNC MODE: Reverse Sync

**Target:** $ARGUMENTS (or scan all active features if blank)

---

## Skills Required

- **Activate:** `reverse-sync` (for sync protocol)
- **Activate:** `refinement-loop` (for confirmation)

---

## Workflow

### Step 1: Identify Scope

1. If path provided: sync that specific feature
2. If blank: check `astraler-docs/04-operations/implementation-active.md` for active work
3. List features to sync

---

### Step 2: Compare Code vs Spec

For each feature in scope:

1. Read current spec from `astraler-docs/03-features/[feature]/spec.md`
2. Note spec version (e.g., v1.2.0)
3. Analyze actual implementation in codebase
4. Identify deviations:
   - **Additions** â€” Code has features not in spec
   - **Changes** â€” Implementation differs from spec
   - **Removals** â€” Spec features not implemented

---

### Step 3: Present Sync Preview

```markdown
**Sync Preview for [Feature Name]**

Current spec version: v[X.Y.Z]

**Deviations Found:**

| # | Type | Section | Spec Says | Code Does | Reason |
|---|------|---------|-----------|-----------|--------|
| 1 | Change | API | POST /users | POST /api/v1/users | Added versioning |
| 2 | Addition | - | Not specified | Rate limiting | Security |
| 3 | Removal | UI | Wizard flow | Single form | Simplified UX |

**Proposed spec update:** v[X.Y.+1]

Please choose:
- **Feedback** â€” Type your changes to the sync
- **Confirm** â€” Type `confirm` to apply sync
- **Cancel** â€” Type `cancel` to abort
```

---

### Step 4: On Confirm â€” Apply Sync

For each deviation:

1. **Update spec section:**
   ```markdown
   ### [Section Name]

   <!-- Original (v1.2.0): [what spec said] -->
   [What was actually implemented]

   **Reason:** [Why the change was necessary]
   [Reverse Synced: YYMMDD]
   ```

2. **Increment spec version** (minor bump: X.Y.+1)

3. **Update changelog:**
   ```markdown
   ### YYMMDD - Reverse Sync (v[X.Y.Z])

   - [Section]: [Change description]
   - [Section]: [Change description]
   - Reason: [Brief explanation]
   ```

---

### Step 5: Verify & Report

After applying sync:

```markdown
**Sync Complete**

- **Feature:** [feature-name]
- **Previous Version:** v[X.Y.Z]
- **New Version:** v[X.Y.Z+1]
- **Sections Updated:** [N]

**Changes Applied:**
- [Section]: [What changed]
- [Section]: [What changed]

Spec now accurately reflects implementation.
```

---

## Audit Trail Format

Preserve original text in HTML comments:

```markdown
## 3. Technical Design

### API Endpoint

<!-- Original (v1.0.0): POST /users with email, password -->
POST /api/v1/users with email, password, and optional phone

**Reason:** Added API versioning and optional phone field for 2FA
[Reverse Synced: 251224]
```

---

## When to Trigger

- After implementation deviates from spec (called from `/asdf:code`)
- When discovering code-spec drift during review
- Before session handoff to ensure docs are current
- After bug fixes that reveal spec inaccuracies

---

## Rules

- **Always preview first** â€” Show what will change before applying
- **Always confirm** â€” Never apply sync without explicit confirm
- **Truth over convenience** â€” Document what IS, not what should be
- **Preserve history** â€” Use HTML comments for original text
- **Explain why** â€” Every change needs a reason
- **Version track** â€” Increment spec version on sync
- **Atomic updates** â€” Sync one feature at a time for clarity

================
File: .claude/commands/asdf/test.md
================
---
description: TEST MODE - Generate test suites from feature specifications
argument-hint: [spec-path]
---

# TEST MODE: Generate Tests from Spec

**Spec Path:** $ARGUMENTS

---

## Skills Required

- **Activate:** `testing` (for test generation patterns)
- **Activate:** `context-loading` (for project test conventions)

---

## Workflow

### Step 1: Load Spec and Test Context

1. Load the spec at provided path (or find by feature name in `astraler-docs/03-features/`)
2. Load testing standards from `astraler-docs/01-system-core/02-standards/testing-strategy.md`
3. Identify existing test patterns in codebase
4. Note acceptance criteria (AC-XXX) â€” these become test cases

---

### Step 2: Analyze and Present Test Matrix

Present test matrix with classification:

```markdown
**Test Matrix: [feature-name]**

Spec Version: [X.Y.Z]

---

## Test Coverage Matrix

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AC     â”‚ Test Types                                                    â”‚
â”‚        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        â”‚ Unit       â”‚ Integration â”‚ API        â”‚ E2E (Playwright)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ AC-001 â”‚ [x] P1     â”‚ [ ]         â”‚ [ ]        â”‚ [ ]                   â”‚
â”‚ AC-002 â”‚ [ ]        â”‚ [x] P1      â”‚ [x] P1     â”‚ [ ]                   â”‚
â”‚ AC-003 â”‚ [ ]        â”‚ [ ]         â”‚ [ ]        â”‚ [x] P2                â”‚
â”‚ AC-004 â”‚ [x] P1     â”‚ [x] P2      â”‚ [ ]        â”‚ [ ]                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

---

## Test Classification

| Type | Framework | Location | Count |
|------|-----------|----------|-------|
| Unit | Jest/Vitest | `__tests__/[feature]/` | [N] |
| Integration | Jest + Supertest | `__tests__/[feature]/*.integration.test.ts` | [N] |
| API | Jest + HTTP client | `__tests__/[feature]/*.api.test.ts` | [N] |
| E2E | Playwright | `e2e/[feature].spec.ts` | [N] |

---

## Priority Legend

- **P0**: Critical path, must pass for release
- **P1**: High priority, core functionality
- **P2**: Medium priority, important but not blocking
- **P3**: Low priority, edge cases

---

**Additional Tests (from spec analysis):**
- Edge case: [description]
- Error handling: [description]
- Performance: [if NFR defined]

**Options:**
- **[yes]** Generate all tests (Unit + Integration + API + E2E)
- **[skip-e2e]** Generate Unit + Integration + API only (recommended for most features)
- **[feedback]** Adjust test plan
```

---

### Step 3: Generate Test Files

For each acceptance criterion, generate tests:

**Unit Tests:**
```typescript
// __tests__/[feature]/[component].test.ts
describe('[Feature]: [Component]', () => {
  describe('AC-001: [criteria]', () => {
    it('should [expected behavior]', () => {
      // Arrange
      // Act
      // Assert
    });

    it('should handle edge case: [case]', () => {
      // Test edge case
    });
  });
});
```

**Integration Tests:**
```typescript
// __tests__/[feature]/[endpoint].integration.test.ts
describe('[Feature] API', () => {
  describe('POST /api/[endpoint]', () => {
    it('should return 200 with valid input (AC-002)', async () => {
      // Test happy path
    });

    it('should return 400 with invalid input', async () => {
      // Test validation
    });

    it('should return 401 without auth', async () => {
      // Test auth requirement
    });
  });
});
```

**E2E Tests (Playwright) â€” Optional:**

> E2E tests add complexity. Only use for critical user journeys.
> Use `skip-e2e` option if not needed.

```typescript
// e2e/[feature].spec.ts
import { test, expect } from '@playwright/test';

test.describe('[Feature] - [User Journey]', () => {
  test('AC-XXX: [description]', async ({ page }) => {
    // Navigate
    await page.goto('/[url]');

    // Interact (from spec user flow)
    // ...

    // Assert
    await expect(page.getByText('[expected]')).toBeVisible();
  });
});
```

**Setup:** Run `npm init playwright@latest` â€” see https://playwright.dev/docs/intro

---

### Step 4: Generate Test Fixtures

Create fixtures from spec examples:

```typescript
// __tests__/[feature]/fixtures.ts
export const validInput = {
  // From spec examples
};

export const invalidInput = {
  // Edge cases
};

export const mockResponses = {
  // API response mocks
};
```

---

### Step 5: Update Spec with Test Coverage

Add test mapping to spec (Reverse Sync):

```markdown
## 7. Testing (Auto-generated)

| AC | Test File | Test Name | Status |
|----|-----------|-----------|--------|
| AC-001 | `component.test.ts` | "should [behavior]" | âœ… |
| AC-002 | `endpoint.integration.test.ts` | "should return 200" | âœ… |
| AC-003 | `feature.spec.ts` | "should complete flow" | âœ… |

**Coverage Target:** 80%
**Generated:** YYMMDD
```

---

### Step 6: Present Test Report

```markdown
**Test Generation Complete**

Feature: [feature-name]
Tests Generated: [N] total

**Breakdown:**
- Unit: [N] tests in [M] files
- Integration: [N] tests in [M] files
- E2E: [N] tests in [M] files

**Files Created:**
- `__tests__/[feature]/[component].test.ts`
- `__tests__/[feature]/[endpoint].integration.test.ts`
- `e2e/[feature].spec.ts`
- `__tests__/[feature]/fixtures.ts`

**Next Steps:**
1. Run tests: `npm test -- --grep "[feature]"`
2. Check coverage: `npm run coverage`
3. Review and adjust as needed

**Spec updated:** Testing section added with test mapping
```

---

## Test Generation Rules

| Rule | Description |
|------|-------------|
| AC-First | Every AC must have at least one test |
| Naming | Test names include AC reference |
| Fixtures | Use spec examples as test data |
| Coverage | Aim for 80% minimum |
| Isolation | Tests must be independent |
| Deterministic | No flaky tests |

---

## Test Types by Spec Section

| Spec Section | Test Type |
|--------------|-----------|
| Functional Requirements | Unit + Integration |
| Non-Functional Requirements | Performance + Load |
| API Contract | Integration |
| UI/UX | E2E + Visual regression |
| Error Codes | Unit + Integration |
| State Machine | Unit |

---

## Rules

- **Spec-Driven** â€” Tests derived from acceptance criteria
- **Traceable** â€” Every test maps to spec section
- **Comprehensive** â€” Happy path + edge cases + error cases
- **Maintainable** â€” Use fixtures, avoid magic values
- **Fast Feedback** â€” Prioritize unit over E2E where possible
- **Living Docs** â€” Tests document expected behavior
- **Matrix First** â€” Present test matrix before generating
- **Playwright for E2E** â€” Use Playwright for browser tests

---

## Help

**Usage:** `/asdf:test [spec-path|feature-name]`

**Arguments:**
- spec-path: Full path to spec.md (e.g., `astraler-docs/03-features/241220-checkout/`)
- feature-name: Feature name to find in `03-features/` (e.g., `checkout`)

**Behavior:**
1. Load spec and testing standards
2. Analyze acceptance criteria
3. Present test matrix with classification
4. Generate test files (Unit, Integration, API, E2E)
5. Generate fixtures from spec examples
6. Update spec with test mapping

**Test Frameworks:**
- Unit: Jest or Vitest
- Integration: Jest + Supertest
- API: Jest + HTTP client
- E2E: Playwright

**Examples:**
- `/asdf:test checkout` â€” Generate tests for checkout feature
- `/asdf:test astraler-docs/03-features/241220-user-auth/` â€” Full path

**Options during generation:**
- `skip-e2e` â€” Generate Unit + Integration + API only (recommended)
- `yes` â€” Generate all tests including E2E
- `feedback` â€” Adjust test plan

**Related:**
- `/asdf:code` â€” Implement feature (run tests after)
- `/asdf:report` â€” Check test coverage
- `/asdf` â€” All commands

================
File: .claude/commands/asdf/unlock.md
================
---
description: Admin command to release stale or abandoned spec/code locks
argument-hint: [lock-name]
---

# UNLOCK: Release Stale Lock

**Lock:** $ARGUMENTS

---

## Skills Required

- **Activate:** `maintenance` (for lock management)

---

## Workflow

### Step 1: Identify Lock

```bash
# Check for lock file
ls astraler-docs/04-operations/locks/$ARGUMENTS.lock 2>/dev/null || \
ls astraler-docs/04-operations/spec-locks/$ARGUMENTS.lock 2>/dev/null
```

**If lock not found:**
```markdown
**Lock Not Found**

No lock exists for: $ARGUMENTS

Available locks:
[List all .lock files in locks/ and spec-locks/]

Type lock name to release, or `cancel` to exit.
```

---

### Step 2: Display Lock Info

```markdown
**Lock Found**

| Field | Value |
|-------|-------|
| Lock | $ARGUMENTS |
| Type | [Code | Spec] |
| Locked by | [instance-id] |
| Since | [timestamp] |
| Age | [N hours M minutes] |
| Task | [task description] |

**Status:** [Active | Stale (>4h)]

Options:
- **[release]** Force release this lock
- **[cancel]** Keep lock, exit
```

---

### Step 3: Confirm Release

On **release**:

1. **Log the override:**
   ```bash
   # Append to conflict-log.md
   echo "| $(date +%y%m%d) | $ARGUMENTS | [original-instance] | [your-instance] | Admin unlock |" >> astraler-docs/04-operations/conflict-log.md
   ```

2. **Delete lock file:**
   ```bash
   rm astraler-docs/04-operations/locks/$ARGUMENTS.lock 2>/dev/null || \
   rm astraler-docs/04-operations/spec-locks/$ARGUMENTS.lock 2>/dev/null
   ```

3. **Confirm:**
   ```markdown
   **Lock Released**

   Lock: $ARGUMENTS
   Released: [timestamp]
   Logged to: conflict-log.md

   âš ï¸ If the original instance is still active, they may encounter conflicts.
   ```

---

## Lock Types

| Type | Location | Used By |
|------|----------|---------|
| Code Lock | `04-operations/locks/` | `/asdf:code` |
| Spec Lock | `04-operations/spec-locks/` | `/asdf:spec`, `/asdf:update` |

---

## Stale Lock Policy

| Age | Status | Action |
|-----|--------|--------|
| <1 hour | Active | Do not unlock without confirmation |
| 1-4 hours | Aging | Warn before unlock |
| >4 hours | Stale | Safe to unlock |

**Configurable:** Set `lock_timeout_hours` in `settings.json` (default: 4)

---

## Conflict Log Format

```markdown
# Conflict Log

| Date | Lock | Original Instance | Released By | Reason |
|------|------|-------------------|-------------|--------|
| YYMMDD | [lock-name] | [instance-id] | [releaser-id] | [reason] |
```

---

## Rules

- **Always log** â€” Every forced release must be logged
- **Warn on active** â€” Locks <4h old require explicit confirmation
- **Check before force** â€” Verify the original instance isn't actively working
- **Notify if possible** â€” If session ID known, mention in handoff

---

## Help

**Usage:** `/asdf:unlock [lock-name]`

**Arguments:**
- lock-name: Name of the lock to release (e.g., `251224-checkout`, `user-auth`)

**Behavior:**
1. Find lock file (code or spec lock)
2. Display lock info and age
3. Confirm release action
4. Log to conflict-log.md
5. Delete lock file

**Examples:**
- `/asdf:unlock 251224-checkout` â€” Release checkout feature lock
- `/asdf:unlock user-auth` â€” Release user-auth spec lock

**Related:**
- `/asdf:code` â€” Creates code locks
- `/asdf:spec` â€” Creates spec locks
- `/asdf:update` â€” Creates spec locks
- `/asdf` â€” All commands

================
File: .claude/commands/asdf/update.md
================
---
description: UPDATE MODE - Update specific component with impact analysis
argument-hint: [component-name]
---

# UPDATE MODE: Component Update

**Component:** $ARGUMENTS

---

## Skills Required

- **Activate:** `impact-analysis` (for affected files detection)
- **Activate:** `refinement-loop` (for iterative updates)

---

## Workflow

### Step 1: Locate Component

1. Parse $ARGUMENTS to find target file
2. Search order:
   - `astraler-docs/01-system-core/**/$ARGUMENTS.md`
   - `astraler-docs/02-domains/$ARGUMENTS/domain.md`
   - `astraler-docs/03-features/*-$ARGUMENTS/spec.md`

**If not found:**
```markdown
**Component Not Found**

Cannot find "$ARGUMENTS" in:
- 01-system-core/
- 02-domains/
- 03-features/

Available components:
[List first 10 matching files]

Try: `/asdf:update [exact-name]`
```

---

### Step 2: Check Spec Lock

**If component is a spec (02-domains/ or 03-features/):**

1. Check `04-operations/spec-locks/[component].lock`

**If locked:**
```markdown
**SPEC LOCKED**

Component: [component]
Locked by: [instance-id]
Since: [timestamp]
Last activity: [time ago]

[STOPPED] Cannot edit while locked.

Options:
1. Wait for lock release
2. Contact editor to coordinate

To check status: /asdf:status [component]
```

**If not locked:**
1. Create lock file
2. Proceed to Step 3

---

### Step 3: Show Current Content

```markdown
**Current [component].md (v[X.Y.Z])**

[Summary of key sections - max 20 lines]

---

What would you like to update?
- Type your changes (natural language OK)
- Or type 'view' to see full file
- Or type 'cancel' to abort
```

---

### Step 4: Apply Changes

1. Parse user input for intended changes
2. Update relevant sections
3. Increment version (minor bump)
4. **Run impact analysis:**
   - Scan for files that reference this component
   - Identify potentially affected specs

---

### Step 5: Present Update Preview

```markdown
**Updated [component].md to v[X.Y.Z]**

**Changes made:**
| Section | Before | After |
|---------|--------|-------|
| [section] | [old] | [new] |

**Impact Analysis:**
These changes may affect:
- [file1.md] (references [section])
- [file2.md] (depends on [entity])

Options:
- **[confirm]** Save changes to [component].md only
- **[feedback]** Adjust further
- **[impact]** Update all affected files
- **[cancel]** Discard changes
```

---

### Step 6: Handle Options

**On confirm:**
1. Save updated component
2. Release spec lock
3. Update changelog

**On feedback:**
1. Accept additional input
2. Return to Step 4

**On impact:**
1. Save current component
2. For each affected file:
   - Open in refinement loop
   - Present suggested changes
   - Wait for confirm/feedback
3. Release spec lock when all done

**On cancel:**
1. Discard changes
2. Release spec lock

---

### Step 7: Report

```markdown
**Update Complete**

- **Component:** [component]
- **Version:** v[X.Y.Z-1] â†’ v[X.Y.Z]
- **Files Updated:** [N]

**Changes:**
- [component].md: [summary]
- [affected1].md: [summary] (if impact chosen)

Lock released.
```

---

## Updateable Components

| Location | Examples |
|----------|----------|
| 01-system-core/01-architecture/ | master-map, tech-stack, data-architecture |
| 01-system-core/02-standards/ | code-standards, api-standards |
| 01-system-core/03-design/ | design-system, ui-ux |
| 02-domains/ | auth, payments, notifications |
| 03-features/ | Any feature spec |

---

## Rules

- **Lock before edit** â€” Acquire spec lock for domains/features
- **Impact aware** â€” Always analyze downstream effects
- **Version track** â€” Increment version on save
- **Cascading option** â€” Offer to update affected files
- **Confirm required** â€” Never save without explicit confirmation

---

## Help

**Usage:** `/asdf:update [component]`

**Arguments:**
- component: Name of file to update (without .md extension)

**Behavior:**
1. Locate component in docs structure
2. Acquire lock (for specs)
3. Show current content
4. Accept changes
5. Run impact analysis
6. Present preview with options
7. Apply and release lock

**Examples:**
- `/asdf:update tech-stack` â€” Update technology stack
- `/asdf:update auth` â€” Update auth domain spec
- `/asdf:update checkout` â€” Update checkout feature spec

**Related:**
- `/asdf:init` â€” Initial setup
- `/asdf:spec` â€” Create new spec
- `/asdf:sync` â€” Sync after code changes

================
File: .claude/skills/context-loading/references/loading-order.md
================
# Context Loading Order

Detailed guide for loading ASDF documentation hierarchy.

---

## The Four Tiers

### Tier 1: System Core (Global DNA)

**Path:** `astraler-docs/01-system-core/`

**Priority:** Highest â€” Rules here apply to EVERYTHING

**Contents:**
```
01-system-core/
â”œâ”€â”€ 01-architecture/
â”‚   â”œâ”€â”€ master-map.md         # System overview, component map
â”‚   â”œâ”€â”€ tech-stack.md         # Languages, frameworks, tools
â”‚   â”œâ”€â”€ data-architecture.md  # Database design, data flow
â”‚   â””â”€â”€ infrastructure.md     # Deployment, hosting
â”œâ”€â”€ 02-standards/
â”‚   â”œâ”€â”€ coding-standards.md   # Code style, patterns
â”‚   â”œâ”€â”€ api-standards.md      # API design rules
â”‚   â”œâ”€â”€ testing-strategy.md   # Test approach
â”‚   â””â”€â”€ performance-slas.md   # Performance targets
â”œâ”€â”€ 03-design/
â”‚   â”œâ”€â”€ ui-ux-design-system.md # Visual standards
â”‚   â””â”€â”€ component-library.md   # Reusable components
â”œâ”€â”€ 04-governance/
â”‚   â”œâ”€â”€ security-policy.md    # Security rules
â”‚   â”œâ”€â”€ decision-log.md       # Key decisions
â”‚   â””â”€â”€ glossary.md           # Terms
â””â”€â”€ project-status.md         # Current state
```

**Load When:** Always (every task)

**Key Files for Most Tasks:**
- `coding-standards.md` â€” How to write code
- `api-standards.md` â€” How to design APIs
- `tech-stack.md` â€” What technologies to use

---

### Tier 2: Domains (Business Logic)

**Path:** `astraler-docs/02-domains/[domain-name]/`

**Priority:** High â€” Domain rules for specific business areas

**Contents:**
```
02-domains/
â”œâ”€â”€ authentication/
â”‚   â””â”€â”€ auth-domain.md
â”œâ”€â”€ payments/
â”‚   â””â”€â”€ payments-domain.md
â”œâ”€â”€ orders/
â”‚   â””â”€â”€ orders-domain.md
â””â”€â”€ notifications/
    â””â”€â”€ notifications-domain.md
```

**Load When:** Working on features that touch that domain

**Key Info:**
- Business rules (AUTH-001, PAY-001, etc.)
- Entity definitions
- Integration points
- Domain-specific error codes

---

### Tier 3: Features (Actionable Specs)

**Path:** `astraler-docs/03-features/YYMMDD-feature-name/`

**Priority:** Medium â€” Specific feature requirements

**Contents:**
```
03-features/
â””â”€â”€ YYMMDD-feature-name/
    â”œâ”€â”€ spec.md       # The specification
    â””â”€â”€ changelog.md  # Version history
```

**Load When:** Implementing or modifying specific feature

**Key Info:**
- Functional requirements (FR-XXX)
- Acceptance criteria (AC-XXX)
- Technical design
- API contracts

---

### Tier 4: Operations (Session State)

**Path:** `astraler-docs/04-operations/`

**Priority:** Context â€” Current execution state

**Contents:**
```
04-operations/
â”œâ”€â”€ implementation-active.md  # What's being worked on
â”œâ”€â”€ session-handoff.md        # Last session state
â””â”€â”€ changelog/
    â””â”€â”€ YYMMDD-event.md       # Project-level changes
```

**Load When:** Starting/resuming work, ending session

**Key Info:**
- Current task and progress
- Blockers
- Session continuity notes

---

## Loading Patterns

### Pattern 1: Starting Fresh Session

```
1. Read session-handoff.md â†’ Understand last state
2. Read implementation-active.md â†’ Check blockers
3. Read relevant feature spec â†’ Get requirements
4. Read domain spec â†’ Understand business rules
5. Skim system-core standards â†’ Refresh global rules
```

### Pattern 2: New Feature Development

```
1. Read system-core fully â†’ Understand all constraints
2. Identify relevant domain(s)
3. Read domain spec(s)
4. Read similar existing features â†’ Learn patterns
5. Create new feature spec
```

### Pattern 3: Bug Fix

```
1. Read feature spec where bug exists
2. Read domain for business rules
3. Read coding-standards for patterns
4. Fix bug
5. Update spec if behavior changes
```

### Pattern 4: Code Review

```
1. Read coding-standards â†’ Know what to check
2. Read api-standards â†’ If API involved
3. Read feature spec â†’ Verify implementation matches
4. Review code against spec
```

---

## Conflict Resolution

When specs conflict:

| Conflict | Resolution |
|----------|------------|
| System Core vs Domain | System Core wins |
| System Core vs Feature | System Core wins |
| Domain vs Feature | Domain wins (feature must comply) |
| Old spec vs New code | Trigger reverse sync |

**Example:**
- System Core says: "All APIs return JSON"
- Feature spec says: "Return XML for legacy support"
- **Resolution:** Feature spec is invalid. Either update system core to allow exceptions, or feature must use JSON.

---

## Loading Efficiency

### Don't Over-Load
- If implementing auth feature, don't load payments domain
- If fixing typo, don't read entire system-core

### Do Load Enough
- If feature touches two domains, load both
- If unsure about standards, load them

### Cache Mental Model
- After loading system-core once, you know the rules
- Only re-read if you need specific details

================
File: .claude/skills/context-loading/SKILL.md
================
---
name: context-loading
description: Load ASDF documentation hierarchy in correct order for proper context.
---

# Context Loading

Load documentation in the correct hierarchical order to prevent context drift.

## When to Use

- Starting any ASDF command
- Beginning new session
- Switching between features
- When context seems incomplete

## Loading Order
Load: `references/loading-order.md`

## Quick Reference

### Hierarchy (Priority Order)

```
1. SYSTEM CORE (Global rules)
   â””â”€â”€ astraler-docs/01-system-core/

2. DOMAIN (Business logic)
   â””â”€â”€ astraler-docs/02-domains/[relevant-domain]/

3. FEATURE (Specific spec)
   â””â”€â”€ astraler-docs/03-features/[feature]/

4. OPERATIONS (Session state)
   â””â”€â”€ astraler-docs/04-operations/
```

### What to Load When

| Task | Load |
|------|------|
| New feature spec | System Core â†’ Related Domains |
| Implement feature | System Core â†’ Domain â†’ Feature Spec â†’ Session State |
| Bug fix | System Core â†’ Domain â†’ Feature Spec |
| Code review | System Core Standards â†’ Feature Spec |
| Session resume | Session Handoff â†’ Implementation Active â†’ Feature Spec |

## Core Principle

**Higher tiers override lower tiers.** If system-core says "use TypeScript", no feature spec can override that.

## Quality Checklist

Before starting work:
- [ ] System core standards loaded
- [ ] Relevant domain context loaded
- [ ] Specific feature spec loaded (if applicable)
- [ ] Session state checked (if resuming)

================
File: .claude/skills/impact-analysis/SKILL.md
================
---
name: impact-analysis
description: Check dependencies and detect breaking changes before implementation.
---

# Impact Analysis

Analyze feature dependencies and detect potential breaking changes to existing specs before implementation.

## When to Use

- Before `/asdf:code` (mandatory in EXECUTE MODE)
- When creating specs that modify shared entities
- Before major refactoring
- When adding features that touch existing domains

---

## Part 1: Dependency Check

### Protocol

1. **Read spec Dependencies section**
   ```markdown
   ## Dependencies

   ### Domain Dependencies
   - `auth` - User authentication required

   ### Feature Dependencies
   - `241220-user-auth` - Must be implemented first

   ### External Dependencies
   - Supabase Auth SDK
   ```

2. **Check implementation status**
   - Query `04-operations/active/[feature].md` for in-progress features
   - Query `implementation-active.md` for completion status
   - Check domain specs for implementation markers

3. **Present dependency result**

```markdown
**Dependency Check**

Feature: [current-feature]

| Dependency | Type | Status | Blocker? |
|------------|------|--------|----------|
| auth domain | Domain | Implemented | No |
| 241220-user-auth | Feature | Complete | No |
| 241221-checkout | Feature | 60% | Yes |

**Result:** [PASS | BLOCKED]
```

4. **If BLOCKED, present options**

```markdown
**BLOCKED: Dependencies not satisfied**

Missing Dependencies:
| Dependency | Type | Status | Required For |
|------------|------|--------|--------------|
| 241221-checkout | Feature | 60% | Payment processing |

Options:
- **[wait]** Abort until dependencies ready
- **[stub]** Create interface stubs, implement later
- **[override]** Proceed anyway (RISK: integration failures)

What would you like to do?
```

---

## Part 2: Breaking Change Detection

### Analysis Scope

| Category | What to Check |
|----------|---------------|
| Database | Shared tables, column changes, FK relationships |
| API | Endpoint signature changes, response structure |
| Shared Code | Utility functions, types, interfaces |
| Config | Environment variables, feature flags |
| External | Third-party API contracts |

### Protocol

1. **Scan existing features**
   - Load all specs from `03-features/`
   - Extract entities, endpoints, dependencies
   - Build shared resource map

2. **Identify overlaps**
   - Compare current feature's technical design with existing
   - Find shared entities (same table names)
   - Find shared endpoints (same API paths)
   - Find shared utilities

3. **Assess impact severity**

| Severity | Criteria | Example | Action |
|----------|----------|---------|--------|
| HIGH | Breaking change, requires code update | API signature change | Must acknowledge |
| MEDIUM | Behavioral change, may need adjustment | Default value change | Should review |
| LOW | Additive change, backwards compatible | New optional field | Proceed safely |

4. **Present impact analysis**

```markdown
**Impact Analysis**

Feature: [current-feature]

**Breaking Changes Detected:**

| Affected Feature | Type | Change | Severity |
|------------------|------|--------|----------|
| 241220-user-auth | API | POST /auth/login adds required field | HIGH |
| 241221-checkout | Schema | Order.userId type UUIDâ†’string | HIGH |
| 241222-notifications | Config | New env var required | MEDIUM |

**Total Impact:** [N] HIGH, [M] MEDIUM, [O] LOW
```

5. **If HIGH severity, present details**

```markdown
### HIGH Impact: 241220-user-auth

**Current State:**
- POST /auth/login accepts `{email, password}`

**After This Feature:**
- POST /auth/login requires `{email, password, deviceId}`

**Breaking Impact:**
- All existing login flows will fail without deviceId
- Mobile app version 1.x will break
- Integration tests need update

**Mitigation Options:**
1. Make deviceId optional with default
2. Version the API (/v2/auth/login)
3. Deprecation period for old format

---

Options:
- **[review]** Show detailed impact for each affected feature
- **[proceed]** Continue (will update affected specs later)
- **[abort]** Cancel implementation

What would you like to do?
```

---

## Quick Reference

### Dependency Section Template for Specs

```markdown
## Dependencies

### Requires (must be implemented first)

| Feature | Reason | Status |
|---------|--------|--------|
| 241220-user-auth | Need auth token | Implemented |
| 241221-checkout | Need order data | In Progress |

### Required By (other features waiting)

| Feature | Reason |
|---------|--------|
| 241225-order-history | Needs order data |

### Domain Dependencies

- `auth` - User authentication and session management
- `payments` - Payment processing integration

### External Dependencies

- Supabase Auth SDK v2.x
- SePay API v1
```

### Files to Check

| File | Purpose |
|------|---------|
| `03-features/*/spec.md` | Feature dependencies and entities |
| `02-domains/*/[domain]-domain.md` | Domain entities and APIs |
| `04-operations/active/` | In-progress features |
| `implementation-active.md` | Completion status |

---

## Override Tracking

When user chooses `[override]` or `[proceed]` with HIGH impact:

1. Log in `implementation-active.md`:
   ```markdown
   ## Impact Overrides

   | Date | Feature | Impact | Decision | Reason |
   |------|---------|--------|----------|--------|
   | YYMMDD | [feature] | HIGH: [affected] | Proceed | [user reason] |
   ```

2. Create sync task:
   ```markdown
   **Reminder:** Run `/asdf:sync` for affected features after implementation.

   Affected specs to update:
   - `03-features/241220-user-auth/spec.md`
   - `03-features/241221-checkout/spec.md`
   ```

---

## Rules

- **Block on HIGH** â€” HIGH severity requires explicit acknowledgment
- **Warn on MEDIUM** â€” Show but allow proceeding
- **Log overrides** â€” Track all override decisions
- **Cascade awareness** â€” Show downstream impacts (features that depend on affected features)

================
File: .claude/skills/maintenance/references/tech-debt-template.md
================
# Tech Debt Register

> **Last Updated:** YYMMDD
> **Total Items:** 0
> **Critical (P0):** 0
> **High (P1):** 0
> **Medium (P2):** 0

---

## Priority Definitions

| Priority | Definition | SLA |
|----------|------------|-----|
| P0 - Critical | Blocks release, security risk, data loss | Fix immediately |
| P1 - High | Significant impact, workaround exists | Fix within 2 sprints |
| P2 - Medium | Degraded experience, minor impact | Fix when capacity allows |

---

## Active Tech Debt

### P0 - Critical

| ID | Description | Impact | Effort | Created | Owner |
|----|-------------|--------|--------|---------|-------|
| <!-- TD-001 | [Description] | [Impact] | [S/M/L] | YYMMDD | [name] --> |

### P1 - High

| ID | Description | Impact | Effort | Created | Owner |
|----|-------------|--------|--------|---------|-------|
| <!-- TD-002 | [Description] | [Impact] | [S/M/L] | YYMMDD | [name] --> |

### P2 - Medium

| ID | Description | Impact | Effort | Created | Owner |
|----|-------------|--------|--------|---------|-------|
| <!-- TD-003 | [Description] | [Impact] | [S/M/L] | YYMMDD | [name] --> |

---

## Resolved (Recent)

| ID | Description | Resolved | By | Resolution |
|----|-------------|----------|-----|------------|
| <!-- TD-000 | [Description] | YYMMDD | [name] | [How resolved] --> |

---

## ID Convention

Format: `TD-XXX` (sequential, never reused)

| Field | Format | Example |
|-------|--------|---------|
| ID | TD-XXX | TD-001 |
| Effort | S (1-4h), M (4-16h), L (>16h) | M |
| Created | YYMMDD | 251224 |

---

## Common Tech Debt Sources

- Implementation shortcuts under time pressure
- Deferred refactoring from code reviews
- Dependencies needing updates
- Performance optimizations deferred
- Test coverage gaps
- Documentation gaps
- Security hardening deferred
- Accessibility improvements needed

---

## Adding New Tech Debt

When discovering tech debt during implementation:

1. Assign next available ID (TD-XXX)
2. Classify priority (P0/P1/P2)
3. Estimate effort (S/M/L)
4. Add to appropriate section above
5. Update counts in header

**Entry Example:**
```markdown
| TD-004 | API lacks rate limiting | Security risk under load | M | 251224 | @dev |
```

---

## Resolving Tech Debt

1. Move entry to "Resolved" section
2. Add resolution date and method
3. Update counts in header
4. Reference in related PR/commit

---

## Usage

**Location:** `astraler-docs/04-operations/tech-debt.md`

**Commands:**
- View: Read the file directly
- Add: Edit file, add new row
- Report: `/asdf:report all` includes tech debt summary
- Audit: `/asdf:audit` checks for new tech debt indicators

================
File: .claude/skills/maintenance/SKILL.md
================
---
name: maintenance
description: Patterns for spec health auditing, cleanup, and tech debt tracking.
---

# Maintenance Skill

Maintain spec health through auditing, cleanup, and tech debt tracking.

## When to Use

- `/asdf:audit` command â€” Scan for spec health issues
- `/asdf:cleanup` command â€” Remove unused specs
- Tech debt identification and tracking
- Project health assessment

---

## Audit Patterns

### Outdated Spec Detection

**Definition:** Spec exists but code has changed since spec was last updated.

```bash
# Get spec last-updated date from file
grep -m1 "Last Updated" [spec-path]/spec.md

# Compare with git log for corresponding code
git log --since="[spec-date]" --oneline -- [code-path]/
```

**Classification:**
| Age Since Update | Status | Action |
|------------------|--------|--------|
| <7 days | Fresh | None |
| 7-30 days | Aging | Review recommended |
| >30 days | Stale | Sync required |

---

### Missing Spec Detection

**Definition:** Code directory exists without corresponding spec.

**Scan Pattern:**
1. List all source directories (e.g., `src/services/`, `src/features/`)
2. For each directory, check if spec exists in `02-domains/` or `03-features/`
3. If no match â†’ MISSING

```markdown
## Missing Specs

| Code Location | Type | Suggestion |
|---------------|------|------------|
| src/services/[name]/ | Domain | Create 02-domains/[name]/ |
| src/features/[name]/ | Feature | Create 03-features/YYMMDD-[name]/ |
```

---

### Orphaned Spec Detection

**Definition:** Spec exists but corresponding code has been deleted or moved.

**Scan Pattern:**
1. For each spec in `02-domains/` and `03-features/`
2. Check if corresponding code path exists
3. If code deleted â†’ ORPHANED

```markdown
## Orphaned Specs

| Spec | Expected Code Path | Status |
|------|-------------------|--------|
| 02-domains/[name]/ | src/services/[name]/ | Deleted |
| 03-features/YYMMDD-[name]/ | src/features/[name]/ | Moved |
```

---

## Cleanup Patterns

### Archive vs Delete

| Category | Action | Destination |
|----------|--------|-------------|
| Orphaned specs | Archive | `04-operations/archived/` |
| Deprecated specs | Archive | `04-operations/archived/` |
| Empty files | Delete | â€” |

### Archive Structure

```
04-operations/archived/
â”œâ”€â”€ 241201-legacy-auth/
â”‚   â”œâ”€â”€ spec.md
â”‚   â”œâ”€â”€ changelog.md
â”‚   â””â”€â”€ tombstone.md    # Reason for archive
â””â”€â”€ 241215-temp-fix/
    â”œâ”€â”€ spec.md
    â””â”€â”€ tombstone.md
```

### Tombstone Template

```markdown
# Archived: [spec-name]

**Archived:** YYMMDD
**Reason:** [Orphaned | Deprecated | Replaced]
**Replacement:** [New spec path or "None"]
**Archived by:** [Instance ID or "Manual"]

## Original Location
[Original path]

## Notes
[Any relevant context for future reference]
```

### Cleanup Log Template

```markdown
# Cleanup Log

## YYMMDD - Cleanup Session

| Action | Spec | Reason | Archived To |
|--------|------|--------|-------------|
| Archived | 03-features/241201-legacy-auth | Code deleted | archived/241201-legacy-auth |
| Archived | 02-domains/old-payments | Replaced by payments-v2 | archived/old-payments |
| Deleted | 01-system-core/empty-file.md | Empty file | â€” |

**Summary:**
- Archived: [N] specs
- Deleted: [M] empty files
```

---

## Tech Debt Tracking

### Tech Debt Template

**Reference:** See `references/tech-debt-template.md` for full template.

**Location:** `04-operations/tech-debt.md`

```markdown
# Tech Debt Register

> **Last Updated:** YYMMDD
> **Total Items:** [N]
> **Estimated Effort:** [X] hours

---

## High Priority (P0)

| ID | Description | Impact | Effort | Created | Owner |
|----|-------------|--------|--------|---------|-------|
| TD-001 | [Description] | [Impact on system] | [S/M/L] | YYMMDD | [name] |

---

## Medium Priority (P1)

| ID | Description | Impact | Effort | Created | Owner |
|----|-------------|--------|--------|---------|-------|
| TD-002 | [Description] | [Impact] | [S/M/L] | YYMMDD | [name] |

---

## Low Priority (P2)

| ID | Description | Impact | Effort | Created | Owner |
|----|-------------|--------|--------|---------|-------|
| TD-003 | [Description] | [Impact] | [S/M/L] | YYMMDD | [name] |

---

## Resolved (Recent)

| ID | Description | Resolved | By | Notes |
|----|-------------|----------|-----|-------|
| TD-000 | [Description] | YYMMDD | [name] | [How resolved] |

---

## Tech Debt Sources

- Implementation shortcuts during time pressure
- Deferred refactoring from code reviews
- Dependencies needing updates
- Performance optimizations deferred
- Test coverage gaps
- Documentation gaps
```

### Tech Debt Entry Rules

| Field | Format | Example |
|-------|--------|---------|
| ID | TD-XXX | TD-001 |
| Priority | P0/P1/P2 | P1 |
| Effort | S (1-2h), M (4-8h), L (>8h) | M |
| Impact | Brief description | "Slows API by 200ms" |

### Adding Tech Debt

When discovering tech debt during implementation:

```markdown
**New Tech Debt Identified:**

| Field | Value |
|-------|-------|
| ID | TD-[next] |
| Description | [What needs to be fixed] |
| Impact | [Why it matters] |
| Priority | [P0/P1/P2] |
| Effort | [S/M/L] |
| Source | [Feature/Code review/Audit] |

Added to: 04-operations/tech-debt.md
```

---

## Health Indicators

### Project Health Thresholds

| Indicator | Green | Yellow | Red |
|-----------|-------|--------|-----|
| Specs up-to-date | >80% | 50-80% | <50% |
| Tech debt items | <5 | 5-15 | >15 |
| Active blockers | 0 | 1-2 | >2 |
| Test coverage | >70% | 40-70% | <40% |
| Missing specs | 0 | 1-3 | >3 |
| Orphaned specs | 0 | 1-2 | >2 |

### Health Report Template

```markdown
**Project Health Report**

| Indicator | Value | Status | Trend |
|-----------|-------|--------|-------|
| Specs up-to-date | [N]% | [ğŸŸ¢/ğŸŸ¡/ğŸ”´] | [â†‘/â†“/â†’] |
| Tech debt | [N] items | [ğŸŸ¢/ğŸŸ¡/ğŸ”´] | [â†‘/â†“/â†’] |
| Active blockers | [N] | [ğŸŸ¢/ğŸŸ¡/ğŸ”´] | [â†‘/â†“/â†’] |
| Test coverage | [N]% | [ğŸŸ¢/ğŸŸ¡/ğŸ”´] | [â†‘/â†“/â†’] |

**Overall:** [Healthy / Needs Attention / Critical]
```

---

## Rules

| Rule | Description |
|------|-------------|
| Non-destructive | Audit only reports, doesn't change |
| Archive, don't delete | Preserve history for orphaned/deprecated |
| Log everything | All actions logged for audit trail |
| Prioritize debt | P0 blocks release, P1/P2 backlog |
| Regular audits | Run weekly or after major changes |
| Actionable | Reports include specific fix commands |

================
File: .claude/skills/pr-review/SKILL.md
================
---
name: pr-review
description: Create PR packages and perform AI code reviews.
---

# PR Review Skill

Bundle changes for review and perform automated code quality checks.

## When to Use

- `/asdf:pr [feature]` â€” Create PR package for review
- `/asdf:review [path]` â€” AI review from fresh context
- After implementation before merge
- When requesting code review from another instance

---

## Part 1: PR Package Creation

### Output Structure

```
.pr-review/
â””â”€â”€ YYMMDD-[feature]/
    â”œâ”€â”€ summary.md           # PR description
    â”œâ”€â”€ changes.md           # Detailed file changes
    â”œâ”€â”€ spec-diff.md         # Spec deviations (if any)
    â””â”€â”€ checklist.md         # Review checklist
```

### Protocol

1. **Locate feature spec**
   - Find in `03-features/*-[feature]/spec.md`
   - Load changelog for recent changes

2. **Gather implementation changes**
   - List all modified files (from execution file or git)
   - Identify deviations from spec

3. **Generate PR package**

---

### summary.md Template

```markdown
# PR: [Feature Name]

> **Feature ID:** YYMMDD-feature-name
> **Spec Version:** vX.Y.Z
> **Created:** YYMMDD

---

## Summary

[1-3 sentences describing what this PR does, derived from spec overview]

## Changes

- [High-level change 1]
- [High-level change 2]
- [High-level change 3]

## Files Changed

| File | Change Type | Lines |
|------|-------------|-------|
| `src/auth/login.ts` | Modified | +50/-10 |
| `src/auth/types.ts` | Added | +100 |
| `__tests__/auth/login.test.ts` | Added | +80 |

## Acceptance Criteria Status

| AC | Description | Status |
|----|-------------|--------|
| AC-001 | User can login with email/password | Implemented |
| AC-002 | JWT token returned on success | Implemented |
| AC-003 | Rate limiting after 10 attempts | Implemented |

## Deviations from Spec

| Section | Deviation | Reason | Resolution |
|---------|-----------|--------|------------|
| API Contract | Added `deviceId` field | Mobile tracking requirement | Spec updated (A) |

## Related

- Spec: `astraler-docs/03-features/YYMMDD-feature/spec.md`
- Domain: `astraler-docs/02-domains/auth/`
- Execution: `astraler-docs/04-operations/active/[feature].md`
```

---

### checklist.md Template

```markdown
# Review Checklist: [Feature Name]

## Spec Compliance
- [ ] Code matches spec intent
- [ ] All acceptance criteria implemented
- [ ] No undocumented features added (scope creep)
- [ ] No spec requirements missing
- [ ] Deviations documented and resolved

## Code Quality
- [ ] Follows coding standards (`01-system-core/02-standards/`)
- [ ] No hardcoded values (use config)
- [ ] Error handling complete
- [ ] Logging added for critical paths
- [ ] No console.log or debug code
- [ ] No commented-out code

## Security
- [ ] No secrets in code
- [ ] Input validation implemented
- [ ] SQL injection prevented (parameterized queries)
- [ ] XSS prevented (output encoding)
- [ ] CSRF protection (if applicable)
- [ ] Authentication/authorization correct

## Performance
- [ ] No N+1 queries
- [ ] Appropriate caching
- [ ] No blocking operations in hot path
- [ ] Pagination for list endpoints

## Testing
- [ ] Unit tests for new logic
- [ ] Integration tests for APIs
- [ ] Edge cases covered
- [ ] Tests passing

## Documentation
- [ ] Reverse sync completed (if deviations)
- [ ] API docs updated (if new endpoints)
- [ ] Comments for complex logic
```

---

## Part 2: AI Review

### Protocol

1. **Load fresh context** (CRITICAL)
   - Read PR package summary.md
   - Identify feature spec path
   - Load spec FRESH (ignore prior conversation context)
   - Load coding standards from `01-system-core/02-standards/`

2. **Spec compliance check**
   - Extract ALL acceptance criteria from spec
   - Verify each AC against implementation
   - Mark PASS/FAIL with notes

3. **Code quality review**
   - Apply checklist systematically
   - Identify issues by severity

4. **Generate verdict**

---

### Review Report Template

```markdown
# AI Review: [Feature Name]

> **Reviewed:** YYMMDD
> **PR Package:** `.pr-review/YYMMDD-[feature]/`
> **Spec Version:** vX.Y.Z

---

## Verdict: [APPROVE | REQUEST_CHANGES | NEEDS_DISCUSSION]

---

## Spec Compliance

| AC | Description | Status | Notes |
|----|-------------|--------|-------|
| AC-001 | User can login | PASS | |
| AC-002 | JWT returned | PASS | |
| AC-003 | Rate limiting | FAIL | Only 5 attempts, spec says 10 |

**Compliance:** [X]/[Y] passing

---

## Issues Found

### Critical (Blocks Merge)

| # | File | Line | Issue | Fix |
|---|------|------|-------|-----|
| 1 | `auth.ts` | 45 | SQL injection: user input in query | Use parameterized query |
| 2 | `login.ts` | 78 | No error handling for DB failure | Add try-catch |

### Major (Should Fix)

| # | File | Line | Issue | Suggestion |
|---|------|------|-------|------------|
| 1 | `user.ts` | 23 | Missing null check | Add optional chaining |
| 2 | `config.ts` | 10 | Hardcoded timeout | Move to env config |

### Minor (Consider)

| # | File | Line | Issue | Suggestion |
|---|------|------|-------|------------|
| 1 | `utils.ts` | 12 | Could use const | Change let to const |

---

## Checklist Summary

| Category | Status |
|----------|--------|
| Spec Compliance | [X]/[Y] |
| Code Quality | [X]/[Y] |
| Security | [X]/[Y] |
| Performance | [X]/[Y] |
| Testing | [X]/[Y] |
| Documentation | [X]/[Y] |

---

## Positive Notes

- Good test coverage (85%)
- Clear function naming
- Proper TypeScript types
- Well-structured error handling

---

## Verdict Explanation

**[APPROVE]**
All critical checks pass. Minor issues can be addressed in follow-up.

**[REQUEST_CHANGES]**
[N] critical issues must be fixed before merge:
1. [Issue 1 summary]
2. [Issue 2 summary]

**[NEEDS_DISCUSSION]**
Architectural decision needed:
- [Question requiring human decision]

---

## Next Steps

1. [Action item 1]
2. [Action item 2]
3. After fixes: Re-run `/asdf:review`
```

---

## Severity Classification

| Severity | Criteria | Action |
|----------|----------|--------|
| **Critical** | Security vulnerability, data loss risk, spec violation | Blocks merge |
| **Major** | Bug potential, maintainability issue, missing error handling | Should fix before merge |
| **Minor** | Style, optimization opportunity, naming | Consider, can merge without |

---

## Fresh Context Requirement

**CRITICAL:** AI review MUST be performed with fresh context.

**Why:**
- Prevents bias from implementation work
- Ensures objective review
- Catches issues missed during development

**How to achieve:**
1. Use new Claude instance if possible
2. Or explicitly state: "Review this as if you've never seen the code before"
3. Load ONLY from PR package, not prior conversation

---

## Rules

| Rule | Description |
|------|-------------|
| Fresh Context | Load spec fresh, no prior assumptions |
| Objective | Apply checklist consistently |
| Actionable | Issues include file:line and fix suggestion |
| Verdict Required | Must give clear APPROVE/REQUEST_CHANGES/NEEDS_DISCUSSION |
| Traceable | Every issue references specific code location |
| Balanced | Note positives, not just problems |

================
File: .claude/skills/refinement-loop/references/reference-collection.md
================
# Reference Collection Protocol

Systematic gathering of source documents to inform spec creation.

---

## When to Trigger

- At start of `/asdf:init` or `/asdf:spec`
- When user types "reference" during refinement loop
- When AI identifies information gaps

---

## Collection Flow

### Step 1: Initial Prompt

```markdown
**Do you have existing documents to reference?**

Categories:
- **Business** â€” PRD, BRD, requirements, user stories
- **Technical** â€” API specs, architecture docs, schemas
- **Data** â€” ERD, database schemas, data dictionaries
- **Design** â€” Wireframes, mockups, design system
- **External** â€” Third-party API docs, competitor analysis

Provide file path(s) or type "no" to continue.
```

### Step 2: Parse Documents

For each provided document:

1. **Detect format** â€” PDF, Markdown, text, image
2. **Extract relevant content:**
   - Requirements (functional/non-functional)
   - User stories and acceptance criteria
   - Technical specifications
   - Data structures and relationships
   - UI/UX requirements
   - Constraints and rules
3. **Report extraction:**
   ```markdown
   **Extracted from [filename]:**
   - [N] functional requirements
   - [M] non-functional requirements
   - [P] user stories
   - [Q] technical specs
   ```

### Step 3: Identify Gaps

After parsing, identify missing information:

```markdown
**I could use more info about:**
- [Topic 1] â€” [Why it's needed]
- [Topic 2] â€” [Why it's needed]

Any additional references?
```

### Step 4: Loop Until Complete

Repeat Steps 2-3 until user says "no" or "no more".

---

## Document Categories

### Business Documents
- PRD (Product Requirements Document)
- BRD (Business Requirements Document)
- User stories / Epics
- Market research
- Competitor analysis

**Extract:** Requirements, success metrics, user personas, constraints

### Technical Documents
- API specifications (OpenAPI/Swagger)
- Architecture diagrams
- System design docs
- Integration specs

**Extract:** Endpoints, data contracts, dependencies, patterns

### Data Documents
- ERD (Entity Relationship Diagram)
- Database schemas
- Data dictionaries
- Migration scripts

**Extract:** Entities, relationships, constraints, indexes

### Design Documents
- Wireframes
- Mockups
- Design system docs
- Component libraries

**Extract:** UI components, user flows, states, interactions

### External Documents
- Third-party API docs
- SDK documentation
- Compliance requirements
- Industry standards

**Extract:** Integration requirements, constraints, authentication

---

## Gap Detection

### Common Gaps by Document Type

| Starting With | Usually Missing |
|---------------|-----------------|
| BRD only | Technical specs, data model |
| API spec only | User stories, UI requirements |
| Wireframes only | Business rules, data validation |
| Database schema only | User flows, business context |

### Gap Questions

When gaps detected, ask specific questions:

```markdown
**Missing information:**

1. **Authentication** â€” What auth method? (JWT, OAuth, session?)
2. **Error handling** â€” What happens when [scenario]?
3. **Data validation** â€” What are the constraints for [field]?

Can you provide docs for these, or should I use sensible defaults?
```

---

## Integration with Spec Generation

After collection complete:

1. **Merge extracted info** into spec structure
2. **Map requirements** to appropriate sections
3. **Flag unresolved gaps** as "Open Questions" in spec
4. **Continue to draft** with enriched context

---

## Rules

- **Ask first** â€” Always offer reference collection opportunity
- **Parse thoroughly** â€” Extract all relevant info
- **Report clearly** â€” User should know what was extracted
- **Identify gaps** â€” Proactively ask for missing info
- **Respect "no"** â€” Don't force reference collection

================
File: .claude/skills/refinement-loop/SKILL.md
================
# Refinement Loop Skill

Manages iterative human-AI feedback loops for spec refinement until explicit confirmation.

## When to Use

Activate this skill when:
- Creating or updating specifications (`/asdf:init`, `/asdf:spec`)
- Any document generation requiring human approval
- Iterative refinement of technical designs

## Core Protocol

### Feedback Loop States

```
DRAFT â†’ REVIEW â†’ [FEEDBACK | REFERENCE | CONFIRM]
                      â†“           â†“          â†“
                  UPDATE â†’    COLLECT â†’   FINALIZE
                      â†“           â†“
                   REVIEW â†â”€â”€â”€â”€â”€â”€â”€â”˜
```

### User Response Types

| Response | Trigger | Action |
|----------|---------|--------|
| `[feedback]` | Free text input | Incorporate changes, increment version, re-present |
| `reference` | User types "reference" | Collect additional source documents, update draft |
| `confirm` | User types "confirm" | Finalize spec, save to file system |

---

## Refinement Prompt Template

After generating ANY draft, ALWAYS present:

```markdown
**Draft [Document Name] v[X.Y.Z] ready for review.**

Please choose:
- **Feedback** â€” Type your changes/concerns
- **Reference** â€” Type `reference` to add source documents
- **Confirm** â€” Type `confirm` to finalize

Location: `[file-path]`
```

---

## Version Management

### Increment Rules

| Change Type | Version Bump | Example |
|-------------|--------------|---------|
| Initial draft | 1.0.0 | First creation |
| Minor feedback | X.Y.+1 | Wording changes, clarifications |
| New reference added | X.+1.0 | Structure changes from new info |
| Major restructure | +1.0.0 | Fundamental approach change |

### Version in File

Every spec file MUST include version header:

```markdown
> **Version:** 1.0.0
> **Status:** Draft | Review | Approved
> **Last Updated:** YYMMDD
```

---

## Feedback Incorporation

### On Receiving Feedback

1. Parse feedback for specific changes requested
2. Update relevant sections
3. Increment version (minor bump)
4. Summarize changes made
5. Re-present with refinement prompt

### Change Summary Format

```markdown
**Updated to v[X.Y.Z]**

Changes made:
- [Section N]: [What changed]
- [Section M]: [What changed]

[Refinement Prompt]
```

---

## Reference Collection

Load: `references/reference-collection.md`

When user requests reference collection, execute the reference gathering protocol before updating the draft.

---

## Confirmation Protocol

### On "confirm"

1. Update version status to "Approved"
2. Update `Last Updated` date
3. Save to file system
4. Report finalization

### Finalization Report

```markdown
**Spec Finalized**

- **Name:** [feature-name]
- **Version:** [X.Y.Z]
- **Status:** Approved
- **Location:** [file-path]

**Next steps:**
- Review spec one more time
- Run `/asdf:code [path]` to implement
```

---

## Rules

- **Never skip confirmation** â€” Always wait for explicit "confirm"
- **Track all iterations** â€” Version numbers tell the story
- **Summarize changes** â€” User should know what changed
- **Be patient** â€” Loop as many times as needed
- **Preserve context** â€” Each iteration builds on previous

================
File: .claude/skills/reverse-sync/references/sync-protocol.md
================
# Reverse Sync Protocol

Step-by-step process for synchronizing specs with implementation reality.

---

## When to Trigger

### Automatic Triggers
- Implementation deviates from spec during `/asdf:code`
- Bug fix reveals spec was incorrect
- Refactoring changes implementation approach

### Manual Triggers
- `/asdf:sync` command
- Before `/asdf:handoff`
- During code review when discrepancy found

---

## Sync Process

### Step 1: Identify Scope

Determine what needs syncing:
- Single feature? â†’ Sync that feature's spec
- Multiple features? â†’ Sync each separately
- Domain-level change? â†’ May need domain spec update too

### Step 2: Compare Code vs Spec

For each section of the spec, check:

| Spec Section | What to Compare |
|--------------|-----------------|
| Requirements | Are all FR-XXX implemented? Any extras? |
| Technical Design | Does architecture match? Key files accurate? |
| API Contract | Endpoints, request/response match reality? |
| Acceptance Criteria | Can all AC-XXX be verified in code? |

### Step 3: Document Deviations

For each deviation found:

```markdown
### [Section Name]

<!-- Original:
[Copy exact text from original spec]
-->

[Write what was actually implemented]

**Reason:** [Explain why deviation occurred]
- Better performance discovered
- Requirement changed mid-implementation
- Original approach had unforeseen issues
- Bug fix required different approach

[Reverse Synced: YYMMDD]
```

### Step 4: Update Spec

Apply changes to `spec.md`:
- Keep original in HTML comment (audit trail)
- Write new reality below comment
- Add reason and date annotation
- Update status if needed (e.g., progress %)

### Step 5: Update Changelog

Add entry to `changelog.md`:

```markdown
## YYMMDD - Reverse Sync

### Changed
- [Section]: [What changed]
- [Section]: [What changed]

### Reason
[Brief explanation of why sync was needed]

### Impact
- [Any downstream effects]
- [Related specs that may need review]
```

### Step 6: Update Operations

Update `implementation-active.md`:
```markdown
## Sync Log
- [YYMMDD] Synced [feature-name]: [brief description]
```

### Step 7: Verify

Re-read updated spec and confirm:
- [ ] Spec accurately describes current implementation
- [ ] No orphaned requirements (spec says X, code doesn't have X)
- [ ] No undocumented features (code has Y, spec doesn't mention Y)
- [ ] All changes have reasons documented

---

## Examples

### Example 1: API Endpoint Changed

**Original spec:**
```markdown
#### POST /api/users
Response: 201 Created
```

**After sync:**
```markdown
#### POST /api/users

<!-- Original: Response: 201 Created -->
Response: 200 OK with created user object

**Reason:** Frontend needed user data immediately; 201 with empty body required extra fetch.
[Reverse Synced: 241223]
```

### Example 2: Feature Simplified

**Original spec:**
```markdown
### FR-003: Multi-currency Support
Users can select from 10 supported currencies.
```

**After sync:**
```markdown
### FR-003: Currency Support

<!-- Original: Users can select from 10 supported currencies. -->
Users can select from USD, EUR, or VND (3 currencies).

**Reason:** MVP scope reduction; additional currencies deferred to v2.
[Reverse Synced: 241223]
```

### Example 3: Technical Approach Changed

**Original spec:**
```markdown
### Architecture
Using REST API with PostgreSQL database.
```

**After sync:**
```markdown
### Architecture

<!-- Original: Using REST API with PostgreSQL database. -->
Using GraphQL API with PostgreSQL database.

**Reason:** Team expertise in GraphQL; better fit for complex nested queries in this domain.
[Reverse Synced: 241223]
```

---

## Anti-Patterns

### DON'T:
- Delete original text (lose audit trail)
- Sync without documenting reason
- Batch multiple features in one sync entry
- Skip changelog update
- Leave spec in aspirational state ("we'll fix the code later")

### DO:
- Preserve original in comments
- Explain every change
- Sync feature by feature
- Update all related files
- Accept reality, document it

================
File: .claude/skills/reverse-sync/SKILL.md
================
---
name: reverse-sync
description: Detect code-spec deviations and update specs to match implementation reality.
---

# Reverse Sync

Update specifications to match actual implementation when deviations occur.

## When to Use

- After implementation deviates from spec
- When better approach discovered during coding
- After bug fixes reveal spec inaccuracies
- Before session handoff (ensure docs current)
- When `/asdf:sync` is called

## Core Principle

**Truth over aspiration.** Specs must reflect what IS, not what was planned.

## Sync Protocol
Load: `references/sync-protocol.md`

## Quick Reference

### Deviation Types

| Type | Description | Action |
|------|-------------|--------|
| **Addition** | Code has feature not in spec | Add to spec |
| **Change** | Implementation differs from spec | Update spec |
| **Removal** | Spec feature not implemented | Remove or mark deferred |

### Annotation Format

```markdown
<!-- Original: [what spec said] -->
[What was actually implemented]

**Reason:** [Why the change was necessary]
[Reverse Synced: YYMMDD]
```

### Files to Update

1. `spec.md` â€” The specification itself
2. `changelog.md` â€” Add sync entry
3. `implementation-active.md` â€” Note sync occurred

## Quality Checklist

Before completing sync:
- [ ] All deviations identified
- [ ] Original text preserved in comments
- [ ] Reason documented for each change
- [ ] Date annotation added
- [ ] Changelog updated
- [ ] Spec accurately reflects code

================
File: .claude/skills/spec-governance/references/system-core-templates/api-standards-template.md
================
# API Standards Template

Use this template for `02-standards/api-standards.md`.

---

```markdown
# API Standards

> **Version:** 1.0.0
> **Status:** Draft | Review | Approved
> **Last Updated:** YYMMDD

---

## 1. Overview

This document defines REST API design standards for consistency across all endpoints.

---

## 2. URL Structure

### Base URL

```
Production:  https://api.example.com/v1
Staging:     https://api-staging.example.com/v1
Development: http://localhost:3000/api/v1
```

### Resource Naming

| Pattern | Example | Notes |
|---------|---------|-------|
| Plural nouns | `/users`, `/orders` | NOT `/user`, `/order` |
| Kebab-case | `/user-profiles` | NOT `/userProfiles` |
| Hierarchical | `/users/{id}/orders` | Nested resources |
| Query for filtering | `/users?status=active` | NOT `/users/active` |

### URL Conventions

```
GET    /users              # List users
GET    /users/{id}         # Get single user
POST   /users              # Create user
PUT    /users/{id}         # Full update
PATCH  /users/{id}         # Partial update
DELETE /users/{id}         # Delete user

# Nested resources
GET    /users/{id}/orders  # User's orders
POST   /users/{id}/orders  # Create order for user

# Actions (when CRUD doesn't fit)
POST   /users/{id}/activate
POST   /orders/{id}/cancel
```

---

## 3. Request Format

### Headers (Required)

```http
Content-Type: application/json
Accept: application/json
Authorization: Bearer <token>
X-Request-ID: <uuid>
```

### Request Body

```json
{
  "email": "user@example.com",
  "password": "secure123",
  "profile": {
    "firstName": "John",
    "lastName": "Doe"
  }
}
```

**Rules:**
- Use camelCase for field names
- Dates in ISO 8601: `2024-12-24T10:30:00Z`
- UUIDs for IDs (not auto-increment)
- Avoid nested objects beyond 2 levels

---

## 4. Response Format

### Standard Response Wrapper

```json
{
  "success": true,
  "data": { ... },
  "meta": {
    "requestId": "uuid",
    "timestamp": "2024-12-24T10:30:00Z"
  }
}
```

### Single Resource (200 OK)

```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "email": "user@example.com",
    "createdAt": "2024-12-24T10:30:00Z"
  }
}
```

### Collection (200 OK)

```json
{
  "success": true,
  "data": [
    { "id": "uuid1", "email": "user1@example.com" },
    { "id": "uuid2", "email": "user2@example.com" }
  ],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 100,
    "totalPages": 5,
    "hasNext": true,
    "hasPrev": false
  }
}
```

### Created (201 Created)

```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "email": "user@example.com",
    "createdAt": "2024-12-24T10:30:00Z"
  }
}
```

### No Content (204 No Content)

- Used for DELETE success
- Empty response body

---

## 5. Error Format

### Error Response Structure

```json
{
  "success": false,
  "error": {
    "code": "USER_NOT_FOUND",
    "message": "User with ID 'uuid' not found",
    "details": [
      {
        "field": "userId",
        "message": "Invalid user ID format"
      }
    ]
  },
  "meta": {
    "requestId": "uuid",
    "timestamp": "2024-12-24T10:30:00Z"
  }
}
```

### HTTP Status Codes

| Code | Meaning | When to Use |
|------|---------|-------------|
| 200 | OK | Successful GET, PUT, PATCH |
| 201 | Created | Successful POST (resource created) |
| 204 | No Content | Successful DELETE |
| 400 | Bad Request | Invalid input, validation failed |
| 401 | Unauthorized | Missing or invalid auth token |
| 403 | Forbidden | Valid auth but no permission |
| 404 | Not Found | Resource doesn't exist |
| 409 | Conflict | Duplicate resource, state conflict |
| 422 | Unprocessable Entity | Semantic validation failed |
| 429 | Too Many Requests | Rate limit exceeded |
| 500 | Internal Server Error | Server-side error |
| 503 | Service Unavailable | Maintenance, overloaded |

### Error Codes Convention

```
[DOMAIN]_[ACTION]_[REASON]

Examples:
- USER_NOT_FOUND
- AUTH_TOKEN_EXPIRED
- ORDER_ALREADY_CANCELLED
- PAYMENT_INSUFFICIENT_FUNDS
- VALIDATION_EMAIL_INVALID
```

---

## 6. Pagination

### Query Parameters

```
GET /users?page=1&limit=20&sort=createdAt&order=desc
```

| Parameter | Type | Default | Max | Description |
|-----------|------|---------|-----|-------------|
| page | int | 1 | - | Page number (1-indexed) |
| limit | int | 20 | 100 | Items per page |
| sort | string | createdAt | - | Sort field |
| order | string | desc | - | asc or desc |

### Response

```json
{
  "data": [...],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 150,
    "totalPages": 8,
    "hasNext": true,
    "hasPrev": false
  }
}
```

---

## 7. Filtering & Search

### Query Parameters

```
GET /users?status=active&role=admin&search=john
GET /orders?createdAt[gte]=2024-01-01&createdAt[lte]=2024-12-31
GET /products?price[min]=10&price[max]=100
```

### Filter Operators

| Operator | Example | Meaning |
|----------|---------|---------|
| equals | `status=active` | Exact match |
| in | `status[in]=active,pending` | In list |
| gte | `createdAt[gte]=2024-01-01` | Greater than or equal |
| lte | `createdAt[lte]=2024-12-31` | Less than or equal |
| search | `search=keyword` | Full-text search |

---

## 8. Versioning

### URL-based (Recommended)

```
/v1/users
/v2/users
```

### Version Lifecycle

| Version | Status | End of Life |
|---------|--------|-------------|
| v1 | Active | TBD |
| v2 | Beta | - |

### Breaking Changes

When incrementing version:
- Removing fields
- Changing field types
- Changing error codes
- Changing authentication

Non-breaking (no version bump):
- Adding new fields
- Adding new endpoints
- Adding new query parameters

---

## 9. Authentication

### Bearer Token

```http
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### Token Refresh

```
POST /auth/refresh
{
  "refreshToken": "..."
}
```

### API Keys (Service-to-Service)

```http
X-API-Key: sk_live_xxxxx
```

---

## 10. Rate Limiting

### Response Headers

```http
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 95
X-RateLimit-Reset: 1703424000
```

### Rate Limit Tiers

| Tier | Requests/min | Burst |
|------|--------------|-------|
| Anonymous | 20 | 5 |
| Authenticated | 100 | 20 |
| Premium | 500 | 100 |

### 429 Response

```json
{
  "success": false,
  "error": {
    "code": "RATE_LIMIT_EXCEEDED",
    "message": "Too many requests. Retry after 60 seconds.",
    "retryAfter": 60
  }
}
```

---

## 11. Open Questions

| # | Question | Impact | Status |
|---|----------|--------|--------|
| 1 | [API design decision] | [Impact] | Open |

---

## 12. Changelog

### YYMMDD - v1.0.0 - Initial Draft
- Defined URL structure
- Set response format
- Established error codes
```

---

## Validation Rules

- [ ] Version header present
- [ ] URL structure documented
- [ ] Response format standardized
- [ ] Error codes defined
- [ ] Pagination format defined
- [ ] Rate limiting documented

================
File: .claude/skills/spec-governance/references/system-core-templates/coding-standards-template.md
================
# Coding Standards Template

Use this template for `02-standards/coding-standards.md`.

---

```markdown
# Coding Standards

> **Version:** 1.0.0
> **Status:** Draft | Review | Approved
> **Last Updated:** YYMMDD

---

## 1. Overview

This document defines coding conventions for consistency and maintainability.

---

## 2. Project Structure

### Backend Structure

```
backend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ modules/           # Feature modules
â”‚   â”‚   â””â”€â”€ [module]/
â”‚   â”‚       â”œâ”€â”€ [module].module.ts
â”‚   â”‚       â”œâ”€â”€ [module].controller.ts
â”‚   â”‚       â”œâ”€â”€ [module].service.ts
â”‚   â”‚       â”œâ”€â”€ dto/
â”‚   â”‚       â””â”€â”€ entities/
â”‚   â”œâ”€â”€ common/            # Shared utilities
â”‚   â”‚   â”œâ”€â”€ decorators/
â”‚   â”‚   â”œâ”€â”€ filters/
â”‚   â”‚   â”œâ”€â”€ guards/
â”‚   â”‚   â””â”€â”€ interceptors/
â”‚   â”œâ”€â”€ config/            # Configuration
â”‚   â””â”€â”€ database/          # Database module
â”œâ”€â”€ prisma/
â”‚   â””â”€â”€ schema.prisma
â””â”€â”€ test/
```

### Frontend Structure

```
frontend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/               # App configuration
â”‚   â”œâ”€â”€ components/        # Reusable components
â”‚   â”‚   â”œâ”€â”€ ui/            # Base components
â”‚   â”‚   â”œâ”€â”€ layout/        # Layout components
â”‚   â”‚   â””â”€â”€ shared/        # Shared components
â”‚   â”œâ”€â”€ features/          # Feature modules
â”‚   â”‚   â””â”€â”€ [feature]/
â”‚   â”‚       â”œâ”€â”€ components/
â”‚   â”‚       â”œâ”€â”€ hooks/
â”‚   â”‚       â”œâ”€â”€ api.ts
â”‚   â”‚       â””â”€â”€ types.ts
â”‚   â”œâ”€â”€ hooks/             # Global hooks
â”‚   â”œâ”€â”€ lib/               # Utilities
â”‚   â”œâ”€â”€ stores/            # State management
â”‚   â””â”€â”€ types/             # TypeScript types
â””â”€â”€ public/
```

---

## 3. Naming Conventions

| Type | Convention | Example |
|------|------------|---------|
| Classes | PascalCase | `UserService`, `AuthGuard` |
| Interfaces | PascalCase | `User`, `CreateUserDto` |
| Functions | camelCase | `getUserById`, `validateToken` |
| Variables | camelCase | `accessToken`, `userId` |
| Constants | SCREAMING_SNAKE | `MAX_RETRY_COUNT`, `API_BASE_URL` |
| Files | kebab-case | `user.service.ts`, `auth.guard.ts` |
| Folders | kebab-case | `user-management/`, `data-processing/` |
| Components | PascalCase | `UserCard.tsx`, `AuthForm.tsx` |
| Hooks | camelCase, use- prefix | `useAuth`, `useUserData` |

---

## 4. TypeScript Standards

### Strict Mode (Required)

```json
{
  "compilerOptions": {
    "strict": true,
    "noImplicitAny": true,
    "strictNullChecks": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true
  }
}
```

### Type Definitions

```typescript
// âœ… GOOD: Explicit types
interface User {
  id: string;
  email: string;
  role: UserRole;
}

// âŒ BAD: Using `any`
const user: any = fetchUser();

// âœ… GOOD: Use unknown + type guard
const user: unknown = fetchUser();
if (isUser(user)) { /* ... */ }

// âœ… GOOD: Prefer interface over type for objects
interface Config {
  apiUrl: string;
  timeout: number;
}

// âœ… GOOD: Use type for unions/intersections
type Status = 'pending' | 'active' | 'archived';
```

---

## 5. Code Style

### Functions

```typescript
// âœ… GOOD: Single responsibility, clear naming
async function getUserById(id: string): Promise<User | null> {
  return await prisma.user.findUnique({ where: { id } });
}

// âŒ BAD: Too many responsibilities
async function handleUser(id: string, action: string, data?: any) {
  // Does everything...
}
```

### Error Handling

```typescript
// âœ… GOOD: Custom error classes
export class UserNotFoundError extends Error {
  constructor(userId: string) {
    super(`User ${userId} not found`);
    this.name = 'UserNotFoundError';
  }
}

// âœ… GOOD: Proper error handling
try {
  const user = await userService.findById(id);
  if (!user) throw new UserNotFoundError(id);
} catch (error) {
  if (error instanceof UserNotFoundError) {
    // Handle specific error
  }
  throw error;
}
```

---

## 6. Documentation

### JSDoc for Public APIs

```typescript
/**
 * Creates a new user account.
 *
 * @param dto - User creation data
 * @returns The created user
 * @throws UserAlreadyExistsError if email is taken
 *
 * @example
 * const user = await userService.create({
 *   email: 'user@example.com',
 *   password: 'secure123'
 * });
 */
async create(dto: CreateUserDto): Promise<User> {
  // ...
}
```

### When to Comment

- Complex algorithms or business logic
- Non-obvious code behavior
- TODOs with issue references

```typescript
// TODO(#123): Optimize query when user count > 10k
// HACK: Workaround for library bug, remove after v2.0
// FIXME: Race condition under high load
```

---

## 7. Import Order

```typescript
// 1. Node built-ins
import { readFile } from 'fs/promises';

// 2. External packages
import { Injectable } from '@nestjs/common';
import { PrismaClient } from '@prisma/client';

// 3. Internal aliases (@/)
import { UserService } from '@/modules/user';
import { AuthGuard } from '@/common/guards';

// 4. Relative imports
import { CreateUserDto } from './dto';
import { User } from './entities';
```

---

## 8. Testing Standards

### File Naming

```
component.test.ts       # Unit tests
component.spec.ts       # Integration tests
component.e2e-spec.ts   # E2E tests
```

### Test Structure (AAA Pattern)

```typescript
describe('UserService', () => {
  describe('create', () => {
    it('should create user with valid data', async () => {
      // Arrange
      const dto = { email: 'test@example.com', password: 'secure123' };

      // Act
      const result = await userService.create(dto);

      // Assert
      expect(result).toMatchObject({ email: dto.email });
      expect(result.id).toBeDefined();
    });

    it('should throw if email already exists', async () => {
      // ...
    });
  });
});
```

---

## 9. Git Conventions

### Commit Messages

```
<type>(<scope>): <subject>

<body>

<footer>
```

**Types:**
- `feat`: New feature
- `fix`: Bug fix
- `docs`: Documentation
- `style`: Formatting
- `refactor`: Code change (no feature/fix)
- `test`: Tests
- `chore`: Maintenance

**Example:**
```
feat(auth): add password reset functionality

- Add forgot password endpoint
- Add reset token generation
- Add email notification

Closes #123
```

### Branch Naming

```
feat/user-authentication
fix/login-redirect-issue
docs/api-documentation
refactor/user-service
```

---

## 10. Anti-Patterns (AVOID)

| Anti-Pattern | Why | Instead |
|--------------|-----|---------|
| Magic numbers | Hard to understand | Use named constants |
| God classes | Hard to maintain | Single responsibility |
| Deep nesting | Hard to read | Early returns, extract functions |
| Commented code | Creates confusion | Delete or use version control |
| Hardcoded values | Not configurable | Use environment variables |

---

## 11. Open Questions

| # | Question | Impact | Status |
|---|----------|--------|--------|
| 1 | [Unresolved standard] | [Impact] | Open |

---

## 12. Changelog

### YYMMDD - v1.0.0 - Initial Draft
- Defined naming conventions
- Set TypeScript standards
- Established testing patterns
```

---

## Validation Rules

- [ ] Version header present
- [ ] Project structure documented
- [ ] Naming conventions defined
- [ ] TypeScript strict mode enforced
- [ ] Testing standards defined
- [ ] Git conventions documented

================
File: .claude/skills/spec-governance/references/system-core-templates/component-library-template.md
================
# Component Library Template

Use this template for `03-design/component-library.md`.

---

```markdown
# Component Library

> **Version:** 1.0.0
> **Status:** Draft | Review | Approved
> **Last Updated:** YYMMDD

---

## 1. Overview

This document catalogs all reusable UI components with usage guidelines.

---

## 2. Component Hierarchy

```mermaid
flowchart TB
    subgraph Primitives["Primitives (atoms)"]
        Button
        Input
        Badge
        Avatar
    end

    subgraph Composites["Composites (molecules)"]
        FormField
        Card
        SearchBar
        UserMenu
    end

    subgraph Patterns["Patterns (organisms)"]
        DataTable
        FormWizard
        Dashboard
        Navigation
    end

    Primitives --> Composites --> Patterns
```

---

## 3. Primitives

### Button

**Variants:** Primary, Secondary, Outline, Ghost, Destructive
**Sizes:** sm, md, lg

```tsx
interface ButtonProps {
  variant?: 'primary' | 'secondary' | 'outline' | 'ghost' | 'destructive';
  size?: 'sm' | 'md' | 'lg';
  disabled?: boolean;
  loading?: boolean;
  leftIcon?: ReactNode;
  rightIcon?: ReactNode;
  children: ReactNode;
  onClick?: () => void;
}

// Usage
<Button variant="primary" size="md">
  Save Changes
</Button>

<Button variant="destructive" leftIcon={<Trash />}>
  Delete
</Button>
```

---

### Input

**Types:** Text, Email, Password, Number, Search, Textarea

```tsx
interface InputProps {
  type?: 'text' | 'email' | 'password' | 'number' | 'search';
  label?: string;
  placeholder?: string;
  error?: string;
  helpText?: string;
  disabled?: boolean;
  required?: boolean;
}

// Usage
<Input
  label="Email"
  type="email"
  placeholder="you@example.com"
  error="Invalid email format"
  required
/>
```

---

### Badge

**Variants:** Default, Success, Warning, Error, Info

```tsx
interface BadgeProps {
  variant?: 'default' | 'success' | 'warning' | 'error' | 'info';
  size?: 'sm' | 'md';
  dot?: boolean;
  children: ReactNode;
}

// Usage
<Badge variant="success">Active</Badge>
<Badge variant="warning" dot>Pending Review</Badge>
```

---

### Avatar

**Sizes:** xs, sm, md, lg, xl

```tsx
interface AvatarProps {
  src?: string;
  alt?: string;
  fallback?: string;
  size?: 'xs' | 'sm' | 'md' | 'lg' | 'xl';
}

// Usage
<Avatar
  src="/avatars/user.jpg"
  alt="John Doe"
  fallback="JD"
  size="md"
/>
```

---

## 4. Composites

### FormField

Combines label, input, help text, and error message.

```tsx
interface FormFieldProps {
  label: string;
  name: string;
  type?: InputType;
  error?: string;
  helpText?: string;
  required?: boolean;
}

// Usage
<FormField
  label="Username"
  name="username"
  helpText="This will be your public display name"
  required
/>
```

---

### Card

Container for content with optional header and footer.

```tsx
interface CardProps {
  title?: string;
  description?: string;
  actions?: ReactNode;
  children: ReactNode;
}

// Usage
<Card
  title="User Profile"
  description="Manage your account settings"
  actions={<Button>Edit</Button>}
>
  <UserDetails />
</Card>
```

---

### SearchBar

Search input with filters and clear button.

```tsx
interface SearchBarProps {
  placeholder?: string;
  value: string;
  onChange: (value: string) => void;
  filters?: Filter[];
  onFilter?: (filters: Filter[]) => void;
}

// Usage
<SearchBar
  placeholder="Search users..."
  value={search}
  onChange={setSearch}
  filters={[
    { key: 'status', options: ['active', 'inactive'] },
    { key: 'role', options: ['admin', 'user'] }
  ]}
/>
```

---

## 5. Patterns

### DataTable

Sortable, filterable table with pagination.

```tsx
interface DataTableProps<T> {
  data: T[];
  columns: Column<T>[];
  sortable?: boolean;
  selectable?: boolean;
  pagination?: PaginationConfig;
  onRowClick?: (row: T) => void;
  emptyState?: ReactNode;
}

// Usage
<DataTable
  data={users}
  columns={[
    { key: 'name', label: 'Name', sortable: true },
    { key: 'email', label: 'Email' },
    { key: 'status', label: 'Status', render: StatusBadge },
    { key: 'actions', label: '', render: ActionMenu }
  ]}
  pagination={{ page: 1, pageSize: 20, total: 100 }}
  selectable
/>
```

---

### Modal / Dialog

Overlay for focused interactions.

```tsx
interface ModalProps {
  open: boolean;
  onClose: () => void;
  title: string;
  description?: string;
  size?: 'sm' | 'md' | 'lg' | 'xl';
  children: ReactNode;
  footer?: ReactNode;
}

// Usage
<Modal
  open={isOpen}
  onClose={() => setIsOpen(false)}
  title="Delete User"
  description="Are you sure? This action cannot be undone."
  footer={
    <>
      <Button variant="outline" onClick={onClose}>Cancel</Button>
      <Button variant="destructive" onClick={onDelete}>Delete</Button>
    </>
  }
/>
```

---

### Toast / Notification

Temporary feedback messages.

```tsx
interface ToastProps {
  variant: 'success' | 'error' | 'warning' | 'info';
  title: string;
  description?: string;
  action?: { label: string; onClick: () => void };
  duration?: number;
}

// Usage (via hook)
const { toast } = useToast();

toast({
  variant: 'success',
  title: 'User created',
  description: 'The user has been added successfully.',
});
```

---

### Empty State

Placeholder when no data exists.

```tsx
interface EmptyStateProps {
  icon?: ReactNode;
  title: string;
  description?: string;
  action?: { label: string; onClick: () => void };
}

// Usage
<EmptyState
  icon={<Users />}
  title="No users found"
  description="Get started by adding your first user."
  action={{ label: 'Add User', onClick: handleAdd }}
/>
```

---

## 6. Layout Components

### PageHeader

Standard page header with title and actions.

```tsx
<PageHeader
  title="Users"
  description="Manage your team members"
  breadcrumbs={[
    { label: 'Dashboard', href: '/' },
    { label: 'Users' }
  ]}
  actions={
    <Button leftIcon={<Plus />}>Add User</Button>
  }
/>
```

---

### Sidebar

Navigation sidebar with collapsible sections.

```tsx
<Sidebar
  logo={<Logo />}
  items={[
    { icon: <Home />, label: 'Dashboard', href: '/' },
    { icon: <Users />, label: 'Users', href: '/users' },
    {
      icon: <Settings />,
      label: 'Settings',
      children: [
        { label: 'General', href: '/settings' },
        { label: 'Security', href: '/settings/security' }
      ]
    }
  ]}
  footer={<UserMenu />}
/>
```

---

## 7. Form Patterns

### Standard Form Layout

```tsx
<Form onSubmit={handleSubmit}>
  <FormField label="Name" name="name" required />
  <FormField label="Email" name="email" type="email" required />
  <FormField label="Role" name="role" type="select" options={roles} />

  <FormActions>
    <Button variant="outline" type="reset">Cancel</Button>
    <Button type="submit">Save</Button>
  </FormActions>
</Form>
```

---

## 8. Component Status

| Component | Status | Tests | A11y |
|-----------|--------|-------|------|
| Button | âœ… Ready | âœ… | âœ… |
| Input | âœ… Ready | âœ… | âœ… |
| Badge | âœ… Ready | âœ… | âœ… |
| Avatar | âœ… Ready | âœ… | âœ… |
| Card | âœ… Ready | âœ… | âœ… |
| Modal | âœ… Ready | âœ… | âœ… |
| DataTable | âœ… Ready | âœ… | âš ï¸ |
| Toast | âœ… Ready | âœ… | âœ… |
| Sidebar | âœ… Ready | âš ï¸ | âœ… |

---

## 9. Open Questions

| # | Question | Impact | Status |
|---|----------|--------|--------|
| 1 | [Component decision] | [Impact] | Open |

---

## 10. Changelog

### YYMMDD - v1.0.0 - Initial Draft
- Documented core primitives
- Added composite components
- Established pattern library
```

---

## Validation Rules

- [ ] Version header present
- [ ] Component hierarchy documented
- [ ] Props interfaces defined
- [ ] Usage examples provided
- [ ] Component status tracked

================
File: .claude/skills/spec-governance/references/system-core-templates/data-architecture-template.md
================
# Data Architecture Template

**REQUIRED:** Entity Relationship Diagram (ERD)

---

```markdown
# Data Architecture

> **Version:** 1.0.0
> **Status:** Draft | Review | Approved
> **Last Updated:** YYMMDD

---

## 1. Overview

[2-3 sentences describing the data architecture approach and philosophy]

---

## 2. Entity Relationship Diagram (REQUIRED)

```mermaid
erDiagram
    USER ||--o{ PROJECT : "owns"
    USER {
        uuid id PK
        string email UK
        string password_hash
        string name
        enum role
        timestamp created_at
        timestamp updated_at
    }
    PROJECT ||--o{ TASK : "contains"
    PROJECT {
        uuid id PK
        uuid user_id FK
        string name
        text description
        enum status
        timestamp created_at
        timestamp updated_at
    }
    TASK ||--o{ COMMENT : "has"
    TASK {
        uuid id PK
        uuid project_id FK
        uuid assignee_id FK
        string title
        text description
        enum priority
        enum status
        date due_date
        timestamp created_at
    }
    USER ||--o{ COMMENT : "writes"
    COMMENT {
        uuid id PK
        uuid task_id FK
        uuid user_id FK
        text content
        timestamp created_at
    }
    USER ||--o{ NOTIFICATION : "receives"
    NOTIFICATION {
        uuid id PK
        uuid user_id FK
        string type
        jsonb payload
        boolean read
        timestamp created_at
    }
```

---

## 3. Database Strategy

### Primary Database
| Attribute | Value |
|-----------|-------|
| Engine | [PostgreSQL 15 / MySQL 8 / etc.] |
| Hosting | [RDS / Cloud SQL / Self-hosted] |
| Replication | [Read replicas / Multi-AZ] |
| Backup | [Daily snapshots, 30-day retention] |

### Secondary Stores
| Store | Purpose | Data Types |
|-------|---------|------------|
| Redis | Cache, sessions | Hot data, user sessions |
| Elasticsearch | Search | Product catalog, logs |
| S3 | Files | User uploads, backups |

---

## 4. Entity Catalog

### Core Entities

#### USER
| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | UUID | PK | Unique identifier |
| email | VARCHAR(255) | UK, NOT NULL | User email |
| password_hash | VARCHAR(255) | NOT NULL | Bcrypt/Argon2 hash |
| name | VARCHAR(100) | NOT NULL | Display name |
| role | ENUM | NOT NULL | admin, user, guest |
| created_at | TIMESTAMP | NOT NULL | Creation time |
| updated_at | TIMESTAMP | NOT NULL | Last update |

**Indexes:**
- `idx_user_email` (email) - Login lookup
- `idx_user_role` (role) - Role filtering

**Business Rules:**
- Email must be unique and valid format
- Password must be hashed before storage
- Role defaults to 'user' on creation

#### PROJECT
| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | UUID | PK | Unique identifier |
| user_id | UUID | FK, NOT NULL | Owner reference |
| name | VARCHAR(255) | NOT NULL | Project name |
| description | TEXT | | Project description |
| status | ENUM | NOT NULL | active, archived, deleted |
| created_at | TIMESTAMP | NOT NULL | Creation time |
| updated_at | TIMESTAMP | NOT NULL | Last update |

**Indexes:**
- `idx_project_user` (user_id) - User's projects
- `idx_project_status` (status) - Status filtering

---

## 5. Data Flow

```mermaid
flowchart LR
    subgraph Input["Data Input"]
        API[API Requests]
        Import[Bulk Import]
        Webhook[Webhooks]
    end

    subgraph Process["Processing"]
        Validate[Validation]
        Transform[Transformation]
        Enrich[Enrichment]
    end

    subgraph Store["Storage"]
        DB[(PostgreSQL)]
        Cache[(Redis)]
        Search[(Elasticsearch)]
    end

    subgraph Output["Data Output"]
        Query[Query API]
        Export[Export]
        Stream[Event Stream]
    end

    API --> Validate
    Import --> Validate
    Webhook --> Validate
    Validate --> Transform
    Transform --> Enrich
    Enrich --> DB
    DB --> Cache
    DB --> Search
    DB --> Query
    DB --> Export
    DB --> Stream
```

---

## 6. Data Lifecycle

| State | Duration | Storage | Action |
|-------|----------|---------|--------|
| Active | Indefinite | Primary DB | Full access |
| Archived | 1 year | Primary DB | Read-only |
| Soft Deleted | 30 days | Primary DB | Hidden, recoverable |
| Hard Deleted | 0 | None | Permanently removed |

### Retention Policies
| Data Type | Retention | Reason |
|-----------|-----------|--------|
| User data | 7 years | Legal compliance |
| Logs | 90 days | Debugging |
| Sessions | 7 days | Security |
| Analytics | 2 years | Business insights |

---

## 7. Migrations Strategy

### Approach
- Tool: [Prisma Migrate / Flyway / Alembic]
- Versioning: Sequential timestamps (YYYYMMDDHHMMSS)
- Rollback: Required for all migrations

### Migration Checklist
- [ ] Backward compatible (no breaking changes)
- [ ] Tested on staging data
- [ ] Rollback script prepared
- [ ] Estimated execution time documented
- [ ] Notify team before production run

---

## 8. Rules & Constraints

### Naming Conventions
| Type | Convention | Example |
|------|------------|---------|
| Tables | snake_case, plural | `users`, `order_items` |
| Columns | snake_case | `created_at`, `user_id` |
| Indexes | idx_table_column | `idx_user_email` |
| Foreign Keys | fk_table_ref | `fk_order_user` |

### Data Integrity
- All tables have `id` as UUID primary key
- All tables have `created_at` and `updated_at`
- Soft delete via `deleted_at` column where applicable
- Foreign keys enforced at database level

---

## 9. Dependencies

### Internal
- Auth domain: User management
- All domains: Notification preferences

### External
- [Cloud storage]: File uploads
- [Analytics service]: Event tracking

---

## 10. Open Questions

| # | Question | Impact | Status |
|---|----------|--------|--------|
| 1 | [Question] | [Impact] | Open |

---

## 11. Changelog

### YYMMDD - v1.0.0 - Initial Draft
- Created data architecture spec
- Defined ERD with core entities
- Documented storage strategy
```

---

## ERD Requirements

The ERD MUST show:
- All core entities
- Primary keys (PK)
- Foreign keys (FK)
- Unique constraints (UK)
- Key field types
- Relationship cardinality

================
File: .claude/skills/spec-governance/references/system-core-templates/decision-log-template.md
================
# Decision Log Template

Use this template for `04-governance/decision-log.md`.

---

```markdown
# Decision Log (ADRs)

> **Version:** 1.0.0
> **Status:** Active
> **Last Updated:** YYMMDD

---

## 1. Overview

This document tracks all Architecture Decision Records (ADRs) for the project.

---

## 2. Decision Index

| ID | Title | Status | Date | Impact |
|----|-------|--------|------|--------|
| ADR-001 | [Decision title] | Accepted | YYMMDD | High |
| ADR-002 | [Decision title] | Accepted | YYMMDD | Medium |
| ADR-003 | [Decision title] | Proposed | YYMMDD | High |
| ADR-004 | [Decision title] | Superseded | YYMMDD | Low |

**Status Legend:**
- **Proposed** â€” Under discussion
- **Accepted** â€” Approved and in effect
- **Deprecated** â€” No longer recommended
- **Superseded** â€” Replaced by another ADR

---

## 3. Decision Records

### ADR-001: [Decision Title]

**Date:** YYMMDD
**Status:** Accepted
**Deciders:** [Names/Roles]

#### Context

[What is the issue that we're seeing that motivates this decision?]

#### Decision

**We will [decision statement].**

[More detail on what exactly was decided]

#### Options Considered

| Option | Pros | Cons |
|--------|------|------|
| Option A | [+] [+] | [-] [-] |
| Option B (Chosen) | [+] [+] | [-] [-] |
| Option C | [+] [+] | [-] [-] |

#### Consequences

**Positive:**
- [Benefit 1]
- [Benefit 2]

**Negative:**
- [Tradeoff 1]
- [Tradeoff 2]

**Risks:**
- [Risk 1] â€” Mitigation: [approach]

#### Related

- Links to related ADRs
- Links to relevant documentation

---

### ADR-002: [Decision Title]

**Date:** YYMMDD
**Status:** Accepted
**Deciders:** [Names/Roles]

#### Context

[Context and motivation]

#### Decision

**We will [decision].**

#### Options Considered

| Option | Pros | Cons |
|--------|------|------|
| [Option] | [+] | [-] |

#### Consequences

[Positive and negative consequences]

---

## 4. Decision Templates

### For Major Decisions (High Impact)

Use full ADR format with:
- Detailed context
- All options evaluated
- Formal consequences analysis
- Risk mitigation plans

### For Minor Decisions (Low Impact)

Use abbreviated format:
```
**Decision:** [What]
**Reason:** [Why]
**Date:** [When]
```

---

## 5. Decision Making Process

```mermaid
flowchart TD
    A[Identify Need] --> B[Research Options]
    B --> C[Draft ADR]
    C --> D{Review}
    D -->|Approved| E[Status: Accepted]
    D -->|Needs Work| C
    D -->|Rejected| F[Status: Rejected]
    E --> G[Implement]
    G --> H[Update Related Docs]
```

### When to Create an ADR

- Major technology choices
- Architectural patterns
- Breaking changes
- Security decisions
- Significant tradeoffs
- Reversible decisions with high stakes

### When NOT to Create an ADR

- Bug fixes
- Minor refactoring
- Obvious choices
- Temporary solutions

---

## 6. Sample ADRs

### ADR-XXX: Use PostgreSQL as Primary Database

**Date:** YYMMDD
**Status:** Accepted

#### Context

We need a database for our application. We expect:
- Relational data with complex queries
- ACID compliance for transactions
- Scale to millions of records
- JSON support for flexible fields

#### Decision

**We will use PostgreSQL 16 as our primary database.**

#### Options Considered

| Option | Pros | Cons |
|--------|------|------|
| PostgreSQL | ACID, JSON, mature, free | Self-managed complexity |
| MySQL | Simple, widespread | Weaker JSON, strict SQL |
| MongoDB | Flexible schema, scale | No joins, eventual consistency |

#### Consequences

**Positive:**
- Strong data integrity
- Excellent JSON support with JSONB
- Rich ecosystem (PostGIS, pg_vector)
- Cost-effective

**Negative:**
- Need expertise for optimization
- Scaling requires planning

---

### ADR-XXX: Adopt TypeScript Strict Mode

**Date:** YYMMDD
**Status:** Accepted

#### Context

Our JavaScript codebase has runtime errors that could be caught at compile time.

#### Decision

**We will enable TypeScript strict mode on all projects.**

```json
{
  "compilerOptions": {
    "strict": true,
    "noImplicitAny": true,
    "strictNullChecks": true
  }
}
```

#### Consequences

**Positive:**
- Catch errors at compile time
- Better IDE support
- Safer refactoring

**Negative:**
- Migration effort for existing code
- Steeper learning curve

---

## 7. Superseded Decisions

### ADR-XXX: [Old Decision] (Superseded by ADR-YYY)

**Date:** YYMMDD
**Status:** Superseded
**Superseded by:** ADR-YYY

[Keep for historical context, link to new decision]

---

## 8. Open Questions

| # | Question | Impact | Status |
|---|----------|--------|--------|
| 1 | [Pending decision] | [Impact] | Open |

---

## 9. Changelog

### YYMMDD - v1.0.0 - Initial Draft
- Created decision log structure
- Added decision index
- Established ADR template
```

---

## Validation Rules

- [ ] Version header present
- [ ] Decision index maintained
- [ ] Each ADR has required sections
- [ ] Status clearly marked
- [ ] Superseded decisions linked

================
File: .claude/skills/spec-governance/references/system-core-templates/glossary-template.md
================
# Glossary Template

Use this template for `04-governance/glossary.md`.

---

```markdown
# Glossary

> **Version:** 1.0.0
> **Status:** Active
> **Last Updated:** YYMMDD

---

## 1. Overview

This document defines domain terminology and acronyms used throughout the project.

---

## 2. Quick Reference

| Term | Definition |
|------|------------|
| [Term 1] | [Brief definition] |
| [Term 2] | [Brief definition] |
| [Term 3] | [Brief definition] |

---

## 3. Domain Terms

### A

#### API (Application Programming Interface)
A set of protocols and tools for building software applications. In this project, refers to our REST API endpoints.

**Related:** REST, Endpoint, HTTP

---

### B

#### Backend
The server-side of the application that handles business logic, database operations, and API responses.

**Contrast with:** Frontend

---

### C

#### CRUD
Create, Read, Update, Delete â€” the four basic operations of persistent storage.

**Example:** User CRUD operations include creating accounts, viewing profiles, updating settings, and deleting accounts.

---

### D

#### Domain
A sphere of knowledge or activity. In our architecture, a domain represents a bounded context with its own business logic and data.

**Examples:** Auth domain, Payment domain, Order domain

---

### E

#### Entity
A domain object with a distinct identity. In our system, entities are persisted in the database.

**Examples:** User, Order, Product

---

### F

#### Feature
A user-facing capability or functionality. In ASDF, features are documented in `03-features/`.

**Format:** `YYMMDD-feature-name`

---

### M

#### MVP (Minimum Viable Product)
The version of a product with just enough features to satisfy early customers and provide feedback for future development.

---

### P

#### PII (Personally Identifiable Information)
Any data that could identify a specific individual.

**Examples:** Name, email, phone, address, SSN

**Handling:** Must be encrypted, access-logged, and deletion-capable (GDPR)

---

### R

#### RBAC (Role-Based Access Control)
A method of regulating access to resources based on the roles of individual users.

**Our Roles:** Super Admin, Admin, Manager, Member, Viewer

---

### S

#### Spec (Specification)
A detailed document describing requirements, design, and acceptance criteria for a feature or system.

**Location:** `astraler-docs/`

#### SLA (Service Level Agreement)
A commitment between service provider and client on aspects of the service such as availability, performance, and responsibilities.

**Example:** 99.9% uptime SLA

---

### T

#### Token
A piece of data used for authentication or authorization.

**Types in our system:**
- Access Token (JWT, 15 min)
- Refresh Token (opaque, 7 days)
- API Key (opaque, until revoked)

---

## 4. Acronyms

| Acronym | Full Form | Context |
|---------|-----------|---------|
| ADR | Architecture Decision Record | Decision documentation |
| API | Application Programming Interface | Backend services |
| ASDF | Astraler Spec-Driven Framework | Development methodology |
| AWS | Amazon Web Services | Cloud infrastructure |
| CI/CD | Continuous Integration/Deployment | DevOps pipeline |
| CRUD | Create, Read, Update, Delete | Data operations |
| DTO | Data Transfer Object | API contracts |
| ERD | Entity Relationship Diagram | Database design |
| GDPR | General Data Protection Regulation | Data privacy |
| JWT | JSON Web Token | Authentication |
| MFA | Multi-Factor Authentication | Security |
| MVP | Minimum Viable Product | Product scope |
| NFR | Non-Functional Requirement | Performance, security |
| ORM | Object-Relational Mapping | Database access |
| PII | Personally Identifiable Information | Data privacy |
| PR | Pull Request | Code review |
| RBAC | Role-Based Access Control | Authorization |
| REST | Representational State Transfer | API style |
| SLA | Service Level Agreement | Performance targets |
| SSO | Single Sign-On | Authentication |
| TDD | Test-Driven Development | Testing approach |
| UI/UX | User Interface/User Experience | Design |
| UUID | Universally Unique Identifier | IDs |
| WCAG | Web Content Accessibility Guidelines | Accessibility |

---

## 5. Project-Specific Terms

### [Your Domain] Terms

| Term | Definition | Example |
|------|------------|---------|
| [Term] | [Definition specific to your project] | [Usage example] |

---

## 6. Status Definitions

### Feature Status

| Status | Meaning |
|--------|---------|
| Planned | Scheduled for future development |
| In Progress | Currently being implemented |
| Review | Code complete, under review |
| Implemented | Deployed to production |
| Deprecated | Marked for removal |

### Document Status

| Status | Meaning |
|--------|---------|
| Draft | Initial version, not reviewed |
| Review | Under stakeholder review |
| Approved | Finalized and official |

---

## 7. Relationship Types

Used in ERD diagrams:

| Symbol | Meaning | Example |
|--------|---------|---------|
| `\|\|--\|\|` | One-to-one | User has one Profile |
| `\|\|--o{` | One-to-many | User has many Orders |
| `}o--o{` | Many-to-many | Products have many Tags |
| `\|\|--\|{` | One-to-many (required) | Order has many OrderItems |

---

## 8. Open Questions

| # | Question | Impact | Status |
|---|----------|--------|--------|
| 1 | [Terminology to clarify] | [Impact] | Open |

---

## 9. Changelog

### YYMMDD - v1.0.0 - Initial Draft
- Created glossary structure
- Added core domain terms
- Listed project acronyms
```

---

## Validation Rules

- [ ] Version header present
- [ ] Terms alphabetically organized
- [ ] Acronyms table included
- [ ] Domain-specific terms documented
- [ ] Status definitions clear

================
File: .claude/skills/spec-governance/references/system-core-templates/infrastructure-template.md
================
# Infrastructure Template

**REQUIRED:** Deployment topology diagram

---

```markdown
# Infrastructure

> **Version:** 1.0.0
> **Status:** Draft | Review | Approved
> **Last Updated:** YYMMDD

---

## 1. Overview

[2-3 sentences describing the infrastructure approach and cloud strategy]

---

## 2. Deployment Topology Diagram (REQUIRED)

```mermaid
flowchart TB
    subgraph Internet["Internet"]
        Users[Users]
        DNS[DNS / Route53]
    end

    subgraph Edge["Edge Layer"]
        CDN[CDN / CloudFront]
        WAF[WAF]
    end

    subgraph LB["Load Balancing"]
        ALB[Application LB]
    end

    subgraph Compute["Compute Layer"]
        subgraph AZ1["Availability Zone 1"]
            App1[App Server 1]
            Worker1[Worker 1]
        end
        subgraph AZ2["Availability Zone 2"]
            App2[App Server 2]
            Worker2[Worker 2]
        end
    end

    subgraph Data["Data Layer"]
        subgraph DB_Cluster["Database Cluster"]
            Primary[(Primary DB)]
            Replica[(Read Replica)]
        end
        Cache[(Redis Cluster)]
        Queue[(Message Queue)]
    end

    subgraph Storage["Storage"]
        S3[(Object Storage)]
    end

    Users --> DNS
    DNS --> CDN
    CDN --> WAF
    WAF --> ALB
    ALB --> App1
    ALB --> App2
    App1 --> Primary
    App2 --> Replica
    App1 --> Cache
    App2 --> Cache
    Worker1 --> Queue
    Worker2 --> Queue
    App1 --> S3
    Primary --> Replica
```

---

## 3. Environments

| Environment | Purpose | URL | Access |
|-------------|---------|-----|--------|
| Development | Local dev | localhost:3000 | Developers |
| Staging | Pre-prod testing | staging.example.com | Team |
| Production | Live users | example.com | Public |

### Environment Configuration
| Setting | Dev | Staging | Prod |
|---------|-----|---------|------|
| App Instances | 1 | 2 | 4+ |
| DB Type | Local/Docker | RDS (db.t3.small) | RDS (db.r5.large) |
| Cache | Local Redis | ElastiCache (cache.t3.micro) | ElastiCache (cache.r5.large) |
| CDN | None | CloudFront | CloudFront |

---

## 4. Cloud Resources

### Compute
| Resource | Type | Specs | Purpose |
|----------|------|-------|---------|
| App Servers | EC2 / ECS | [t3.medium / 2vCPU, 4GB] | API and web serving |
| Workers | EC2 / Lambda | [t3.small / 1vCPU, 2GB] | Background jobs |

### Database
| Resource | Type | Specs | Purpose |
|----------|------|-------|---------|
| Primary DB | RDS PostgreSQL | [db.r5.large / Multi-AZ] | Main data store |
| Read Replica | RDS PostgreSQL | [db.r5.large] | Read scaling |
| Cache | ElastiCache Redis | [cache.r5.large / Cluster] | Session, caching |

### Storage
| Resource | Type | Purpose |
|----------|------|---------|
| S3 Bucket | Standard | User uploads, static assets |
| S3 Bucket | IA | Backups, archives |

### Networking
| Resource | Purpose |
|----------|---------|
| VPC | Network isolation |
| Public Subnets | Load balancers, NAT |
| Private Subnets | App servers, DB |
| Security Groups | Firewall rules |

---

## 5. Scaling Strategy

### Horizontal Scaling
| Component | Trigger | Min | Max |
|-----------|---------|-----|-----|
| App Servers | CPU > 70% | 2 | 10 |
| Workers | Queue depth > 1000 | 1 | 5 |

### Vertical Scaling
| Component | When to Scale Up |
|-----------|------------------|
| Database | IO wait > 20%, connections > 80% |
| Cache | Memory usage > 80% |

### Auto-scaling Configuration
```yaml
AutoScalingGroup:
  MinSize: 2
  MaxSize: 10
  DesiredCapacity: 2
  Cooldown: 300
  Metrics:
    - CPUUtilization
    - RequestCount
```

---

## 6. Deployment Process

### CI/CD Pipeline
```mermaid
flowchart LR
    Push[Git Push] --> Build[Build & Test]
    Build --> Scan[Security Scan]
    Scan --> Stage[Deploy Staging]
    Stage --> Test[Integration Tests]
    Test --> Approve{Manual Approval}
    Approve -->|Yes| Prod[Deploy Production]
    Approve -->|No| Fix[Fix Issues]
    Fix --> Push
```

### Deployment Strategy
| Environment | Strategy | Rollback |
|-------------|----------|----------|
| Staging | Rolling | Automatic |
| Production | Blue/Green | Manual trigger |

### Deployment Checklist
- [ ] All tests passing
- [ ] Security scan clean
- [ ] Database migrations ready
- [ ] Feature flags configured
- [ ] Monitoring alerts active
- [ ] Rollback plan documented

---

## 7. Disaster Recovery

### Backup Strategy
| Component | Frequency | Retention | Location |
|-----------|-----------|-----------|----------|
| Database | Daily | 30 days | Cross-region S3 |
| File Storage | Continuous | 90 days | Cross-region S3 |
| Configurations | On change | Forever | Git |

### Recovery Targets
| Metric | Target |
|--------|--------|
| RTO (Recovery Time Objective) | < 4 hours |
| RPO (Recovery Point Objective) | < 1 hour |

### Failover Process
1. Detect failure (automated monitoring)
2. Promote read replica to primary
3. Update DNS/Load balancer
4. Verify application health
5. Notify team

---

## 8. SLA Targets

| Metric | Target | Measurement |
|--------|--------|-------------|
| Availability | 99.9% | Monthly uptime |
| Response Time (p95) | < 500ms | API latency |
| Error Rate | < 0.1% | 5xx responses |

---

## 9. Cost Estimate

| Resource | Monthly Cost (Est.) |
|----------|---------------------|
| Compute | $[X] |
| Database | $[X] |
| Storage | $[X] |
| Network | $[X] |
| **Total** | **$[X]** |

---

## 10. Rules & Constraints

- All resources tagged with environment, project, owner
- No public DB access, use bastion/VPN
- Secrets in AWS Secrets Manager, never in code
- All traffic encrypted (TLS 1.2+)
- Logs retained for 90 days minimum

---

## 11. Open Questions

| # | Question | Impact | Status |
|---|----------|--------|--------|
| 1 | [Question] | [Impact] | Open |

---

## 12. Changelog

### YYMMDD - v1.0.0 - Initial Draft
- Created infrastructure spec
- Defined deployment topology
- Documented scaling strategy
```

---

## Diagram Requirements

The deployment topology MUST show:
- DNS/Edge layer (CDN, WAF)
- Load balancer layer
- Compute layer with availability zones
- Data layer (DB, cache, queue)
- Storage layer
- Network flow between components

================
File: .claude/skills/spec-governance/references/system-core-templates/master-map-template.md
================
# Master Map Template

**REQUIRED:** System architecture diagram (mermaid)

---

```markdown
# System Master Map

> **Version:** 1.0.0
> **Status:** Draft | Review | Approved
> **Last Updated:** YYMMDD

---

## 1. Overview

[2-3 sentences describing the system's purpose and core value proposition]

---

## 2. System Architecture Diagram (REQUIRED)

```mermaid
flowchart TB
    subgraph Client["Client Layer"]
        Web[Web App]
        Mobile[Mobile App]
        API_Client[API Clients]
    end

    subgraph Gateway["API Gateway"]
        LB[Load Balancer]
        Auth[Auth Middleware]
        Rate[Rate Limiter]
    end

    subgraph Services["Service Layer"]
        Service_A[Service A]
        Service_B[Service B]
        Service_C[Service C]
    end

    subgraph Data["Data Layer"]
        DB[(Primary DB)]
        Cache[(Cache)]
        Queue[(Message Queue)]
        Search[(Search Index)]
    end

    subgraph External["External Services"]
        Payment[Payment Gateway]
        Email[Email Service]
        Storage[Cloud Storage]
    end

    Web --> LB
    Mobile --> LB
    API_Client --> LB
    LB --> Auth
    Auth --> Rate
    Rate --> Service_A
    Rate --> Service_B
    Rate --> Service_C
    Service_A --> DB
    Service_A --> Cache
    Service_B --> DB
    Service_B --> Queue
    Service_C --> Search
    Service_B --> Payment
    Service_A --> Email
    Service_C --> Storage
```

---

## 3. Component Overview

### Client Layer
| Component | Technology | Purpose |
|-----------|------------|---------|
| Web App | [React/Vue/etc.] | [Main user interface] |
| Mobile App | [React Native/Flutter/etc.] | [Mobile experience] |
| API Clients | REST/GraphQL | [Third-party integrations] |

### Service Layer
| Service | Responsibility | Dependencies |
|---------|----------------|--------------|
| [Service A] | [What it does] | [DB, Cache] |
| [Service B] | [What it does] | [DB, Queue, Payment] |
| [Service C] | [What it does] | [Search, Storage] |

### Data Layer
| Store | Technology | Purpose |
|-------|------------|---------|
| Primary DB | [PostgreSQL/MySQL/etc.] | [Persistent data] |
| Cache | [Redis/Memcached] | [Session, hot data] |
| Queue | [RabbitMQ/SQS/etc.] | [Async processing] |
| Search | [Elasticsearch/Algolia] | [Full-text search] |

---

## 4. Communication Patterns

### Synchronous
| From | To | Protocol | Purpose |
|------|-----|----------|---------|
| Client | Gateway | HTTPS | User requests |
| Gateway | Services | HTTP/gRPC | Internal calls |

### Asynchronous
| Publisher | Event | Subscriber | Purpose |
|-----------|-------|------------|---------|
| [Service A] | [event.name] | [Service B] | [Why] |

---

## 5. Cross-Cutting Concerns

### Authentication & Authorization
- **Method:** [JWT/OAuth2/Session]
- **Provider:** [Internal/Auth0/Cognito]
- **RBAC:** [Roles defined]

### Observability
- **Logging:** [ELK/CloudWatch/etc.]
- **Metrics:** [Prometheus/Datadog/etc.]
- **Tracing:** [Jaeger/X-Ray/etc.]

### Security
- **TLS:** Required for all external traffic
- **Secrets:** [Vault/AWS Secrets Manager]
- **WAF:** [CloudFlare/AWS WAF]

---

## 6. Domain Map

```mermaid
flowchart LR
    subgraph Core["Core Domains"]
        Auth[Authentication]
        User[User Management]
    end

    subgraph Business["Business Domains"]
        Domain_A[Domain A]
        Domain_B[Domain B]
        Domain_C[Domain C]
    end

    subgraph Support["Supporting Domains"]
        Notification[Notifications]
        Analytics[Analytics]
    end

    Auth --> User
    User --> Domain_A
    User --> Domain_B
    Domain_A --> Domain_C
    Domain_B --> Notification
    Domain_C --> Analytics
```

| Domain | Type | Responsibility |
|--------|------|----------------|
| Authentication | Core | User identity, sessions |
| [Domain A] | Business | [Primary business logic] |
| Notifications | Supporting | Email, push, SMS |

---

## 7. Rules & Constraints

- [System-level rule 1]
- [System-level rule 2]
- [System-level constraint 1]

---

## 8. Dependencies

### External APIs
| Service | Purpose | Criticality |
|---------|---------|-------------|
| [Service] | [Why needed] | Critical/High/Low |

### Infrastructure
| Provider | Services Used |
|----------|---------------|
| [AWS/GCP/Azure] | [EC2, RDS, S3, etc.] |

---

## 9. Open Questions

| # | Question | Impact | Status |
|---|----------|--------|--------|
| 1 | [Question] | [Impact] | Open |

---

## 10. Changelog

### YYMMDD - v1.0.0 - Initial Draft
- Created system master map
- Defined architecture diagram
- Documented component relationships
```

---

## Diagram Requirements

The system architecture diagram MUST show:
- Client layer (web, mobile, API)
- Gateway/load balancer
- All major services
- Data stores (DB, cache, queue)
- External service integrations
- Communication flows

================
File: .claude/skills/spec-governance/references/system-core-templates/performance-slas-template.md
================
# Performance SLAs Template

Use this template for `02-standards/performance-slas.md`.

---

```markdown
# Performance SLAs

> **Version:** 1.0.0
> **Status:** Draft | Review | Approved
> **Last Updated:** YYMMDD

---

## 1. Overview

This document defines performance targets, SLAs, and monitoring requirements.

---

## 2. Response Time SLAs

### API Endpoints

| Category | p50 | p95 | p99 | Max |
|----------|-----|-----|-----|-----|
| Read (GET) | 50ms | 150ms | 300ms | 500ms |
| Write (POST/PUT) | 100ms | 300ms | 500ms | 1000ms |
| Search | 100ms | 500ms | 1000ms | 2000ms |
| Reports | 500ms | 2000ms | 5000ms | 10000ms |

### Frontend

| Metric | Target | Critical |
|--------|--------|----------|
| First Contentful Paint (FCP) | < 1.5s | < 2.5s |
| Largest Contentful Paint (LCP) | < 2.5s | < 4.0s |
| Time to Interactive (TTI) | < 3.0s | < 5.0s |
| Cumulative Layout Shift (CLS) | < 0.1 | < 0.25 |
| First Input Delay (FID) | < 100ms | < 300ms |

---

## 3. Availability SLAs

### Service Levels

| Environment | Availability | Downtime/Month |
|-------------|--------------|----------------|
| Production | 99.9% | < 43 min |
| Staging | 99.0% | < 7.3 hours |
| Development | 95.0% | < 36 hours |

### Maintenance Windows

- Scheduled: [Day] [Time] UTC (announced 48h ahead)
- Emergency: Any time (post-mortem within 24h)

---

## 4. Throughput Targets

### Concurrent Users

| Load Level | Users | Description |
|------------|-------|-------------|
| Normal | [N] | Typical daily load |
| Peak | [N x 2] | Peak hours |
| Stress | [N x 5] | Marketing events |
| Max | [N x 10] | System limit |

### Requests Per Second

| Endpoint | Normal | Peak | Max |
|----------|--------|------|-----|
| API total | 500 RPS | 1000 RPS | 2000 RPS |
| Auth endpoints | 100 RPS | 200 RPS | 500 RPS |
| Search | 50 RPS | 100 RPS | 200 RPS |

---

## 5. Database Performance

### Query Performance

| Query Type | Target | Max |
|------------|--------|-----|
| Simple SELECT | < 10ms | 50ms |
| JOIN (2-3 tables) | < 50ms | 200ms |
| Complex aggregation | < 200ms | 1000ms |
| Full-text search | < 100ms | 500ms |

### Connection Pool

| Setting | Value |
|---------|-------|
| Min connections | 5 |
| Max connections | 50 |
| Idle timeout | 30s |
| Connection timeout | 5s |

---

## 6. Caching Strategy

### Cache Tiers

```mermaid
flowchart LR
    Client[Client] --> CDN[CDN Cache<br/>Static Assets]
    CDN --> App[App Server]
    App --> Redis[Redis Cache<br/>Session, API]
    App --> DB[(Database)]
```

### Cache TTLs

| Data Type | Cache | TTL |
|-----------|-------|-----|
| Static assets | CDN | 1 year |
| API responses | Redis | 5 min |
| User session | Redis | 24 hours |
| Config | Memory | 1 hour |
| Search results | Redis | 10 min |

### Cache Hit Rate Targets

| Cache | Target | Alert |
|-------|--------|-------|
| CDN | > 90% | < 80% |
| Redis | > 80% | < 70% |

---

## 7. Resource Limits

### Memory

| Component | Limit | Alert At |
|-----------|-------|----------|
| API Server | 1 GB | 80% |
| Worker | 2 GB | 80% |
| Database | 8 GB | 75% |
| Redis | 512 MB | 80% |

### CPU

| Component | Limit | Alert At |
|-----------|-------|----------|
| API Server | 2 cores | 70% |
| Worker | 4 cores | 80% |
| Database | 4 cores | 60% |

### Disk

| Component | Size | Alert At |
|-----------|------|----------|
| Database | 100 GB | 80% |
| Logs | 50 GB | 80% |
| Uploads | 500 GB | 85% |

---

## 8. Error Budgets

### Error Rate Targets

| Metric | Target | Alert | Critical |
|--------|--------|-------|----------|
| HTTP 5xx rate | < 0.1% | > 0.5% | > 1.0% |
| HTTP 4xx rate | < 2.0% | > 5.0% | > 10.0% |
| Timeout rate | < 0.1% | > 0.5% | > 1.0% |

### Error Budget Calculation

```
Monthly error budget = 100% - SLA target
Example: 99.9% SLA = 0.1% error budget = 43 minutes/month

If budget exhausted:
- Freeze non-critical deploys
- Focus on reliability work
```

---

## 9. Monitoring & Alerting

### Key Metrics

| Metric | Tool | Dashboard |
|--------|------|-----------|
| Response time | [Datadog/Prometheus] | API Performance |
| Error rate | [Datadog/Sentry] | Error Tracking |
| Throughput | [Datadog/Grafana] | Traffic |
| CPU/Memory | [CloudWatch/Prometheus] | Infrastructure |
| Database | [pg_stat/CloudWatch] | Database |

### Alert Thresholds

| Alert | Condition | Severity | Response |
|-------|-----------|----------|----------|
| High latency | p95 > 500ms for 5min | Warning | Investigate |
| Very high latency | p95 > 1000ms for 5min | Critical | Page on-call |
| Error spike | 5xx > 1% for 2min | Critical | Page on-call |
| Low availability | < 99.5% for 10min | Critical | All hands |

---

## 10. Degradation Strategy

### Graceful Degradation

| Scenario | Action |
|----------|--------|
| Database slow | Serve cached data |
| Search unavailable | Disable search, show browse |
| Payment gateway down | Queue orders |
| Third-party API timeout | Use fallback |

### Circuit Breaker

```
Open threshold: 5 failures in 30s
Half-open: After 60s
Close: 3 successes
```

---

## 11. Open Questions

| # | Question | Impact | Status |
|---|----------|--------|--------|
| 1 | [Performance decision] | [Impact] | Open |

---

## 12. Changelog

### YYMMDD - v1.0.0 - Initial Draft
- Defined response time SLAs
- Set availability targets
- Established monitoring requirements
```

---

## Validation Rules

- [ ] Version header present
- [ ] Response time SLAs defined
- [ ] Availability targets set
- [ ] Error budgets calculated
- [ ] Monitoring requirements documented

================
File: .claude/skills/spec-governance/references/system-core-templates/README.md
================
# System-Core Templates

Templates for all system-core documentation files with required depth and diagram specifications.

## Template Index (13 Files)

| # | File | Template | Required Diagram |
|---|------|----------|------------------|
| 1 | master-map.md | `master-map-template.md` | System architecture (flowchart) |
| 2 | tech-stack.md | `tech-stack-template.md` | Stack diagram (flowchart) |
| 3 | data-architecture.md | `data-architecture-template.md` | ERD (erDiagram) |
| 4 | infrastructure.md | `infrastructure-template.md` | Deployment topology (flowchart) |
| 5 | coding-standards.md | `coding-standards-template.md` | None |
| 6 | api-standards.md | `api-standards-template.md` | None |
| 7 | testing-strategy.md | `testing-strategy-template.md` | Testing pyramid (flowchart) |
| 8 | performance-slas.md | `performance-slas-template.md` | Cache tiers (flowchart) |
| 9 | ui-ux-design-system.md | `ui-ux-design-system-template.md` | Color palette (flowchart) |
| 10 | component-library.md | `component-library-template.md` | Component hierarchy (flowchart) |
| 11 | security-policy.md | `security-policy-template.md` | Security architecture (flowchart) |
| 12 | decision-log.md | `decision-log-template.md` | Decision process (flowchart) |
| 13 | glossary.md | `glossary-template.md` | None |

---

## Diagram Requirements Summary

| Document | Diagram Type | Required? |
|----------|--------------|-----------|
| master-map.md | System architecture (flowchart) | **YES** |
| data-architecture.md | ERD (erDiagram) | **YES** |
| infrastructure.md | Deployment topology (flowchart) | **YES** |
| Domain specs | ERD (erDiagram) | **YES** |
| Feature specs | User flow (flowchart) | **YES** |

---

## Standard Template Structure

All system-core files MUST include these sections:

```markdown
# [Document Name]

> **Version:** 1.0.0
> **Status:** Draft | Review | Approved
> **Last Updated:** YYMMDD

## 1. Overview
[Brief description]

## 2. Visual Diagram (if required)
[Mermaid diagram]

## 3. Detailed Specifications
[Deep technical content]

## 4. Rules & Constraints
[Business rules, technical constraints]

## 5. Dependencies
[Links to related docs]

## 6. Open Questions
[Items needing clarification]

## 7. Changelog
| Version | Date | Changes |
|---------|------|---------|
| 1.0.0 | YYMMDD | Initial draft |
```

---

## Usage

Each template file contains:
1. Template metadata and usage instructions
2. Complete markdown template with all required sections
3. Validation rules checklist

To use a template:
1. Copy the markdown code block from the template file
2. Replace placeholder values with project-specific content
3. Run through validation checklist before finalizing

---

## Validation Checklist

Before finalizing any system-core file:

- [ ] Version header present (v1.0.0 format)
- [ ] Status field present (Draft/Review/Approved)
- [ ] Last Updated date set
- [ ] Required mermaid diagram included (if applicable)
- [ ] All sections populated with meaningful content
- [ ] Rules & constraints documented
- [ ] Dependencies linked
- [ ] Open questions listed
- [ ] Changelog has initial entry

================
File: .claude/skills/spec-governance/references/system-core-templates/security-policy-template.md
================
# Security Policy Template

Use this template for `04-governance/security-policy.md`.

---

```markdown
# Security Policy

> **Version:** 1.0.0
> **Status:** Draft | Review | Approved
> **Last Updated:** YYMMDD

---

## 1. Overview

This document defines security requirements, policies, and practices.

---

## 2. Security Architecture

```mermaid
flowchart TB
    subgraph Public["Public Zone"]
        CDN[CDN]
        WAF[WAF]
    end

    subgraph DMZ["DMZ"]
        LB[Load Balancer]
        API[API Gateway]
    end

    subgraph Private["Private Zone"]
        App[App Servers]
        DB[(Database)]
        Cache[(Cache)]
    end

    subgraph Security["Security Services"]
        IAM[IAM]
        KMS[Key Management]
        Logs[Security Logs]
    end

    CDN --> WAF --> LB --> API --> App
    App --> DB
    App --> Cache
    App --> Security
```

---

## 3. Authentication

### 3.1 User Authentication

| Method | Use Case | Implementation |
|--------|----------|----------------|
| Email/Password | Primary login | bcrypt hash, min 12 chars |
| OAuth 2.0 | Social login | Google, GitHub, Microsoft |
| Magic Link | Passwordless | Email with signed token |
| MFA/2FA | High-security | TOTP (Google Authenticator) |

### 3.2 Token Strategy

| Token | Type | Lifetime | Storage |
|-------|------|----------|---------|
| Access Token | JWT | 15 minutes | Memory only |
| Refresh Token | Opaque | 7 days | httpOnly cookie |
| API Key | Opaque | Until revoked | Server-side |

### 3.3 Password Requirements

```
Minimum length:     12 characters
Complexity:         1 uppercase, 1 lowercase, 1 number
Common passwords:   Blocked (haveibeenpwned check)
Password history:   Last 5 passwords blocked
Expiration:         Optional (90 days for admin)
```

---

## 4. Authorization

### 4.1 RBAC Model

| Role | Description | Permissions |
|------|-------------|-------------|
| Super Admin | System owner | All permissions |
| Admin | Organization admin | Manage users, settings |
| Manager | Team lead | Manage team, view reports |
| Member | Regular user | CRUD own resources |
| Viewer | Read-only | View only |

### 4.2 Permission Matrix

| Resource | Create | Read | Update | Delete |
|----------|--------|------|--------|--------|
| Users | Admin+ | Member+ | Self/Admin+ | Admin+ |
| Projects | Manager+ | Member+ | Owner/Admin | Owner/Admin |
| Settings | Admin+ | Admin+ | Admin+ | Admin+ |

### 4.3 Resource-Level Authorization

```typescript
// Always verify ownership
if (resource.ownerId !== user.id && !user.isAdmin) {
  throw new ForbiddenError();
}
```

---

## 5. Data Protection

### 5.1 Encryption

| Layer | Algorithm | Key Size |
|-------|-----------|----------|
| In Transit | TLS 1.3 | 256-bit |
| At Rest (DB) | AES-256-GCM | 256-bit |
| At Rest (Files) | AES-256-GCM | 256-bit |
| Passwords | bcrypt | Cost factor 12 |
| PII Fields | AES-256-GCM | Per-field encryption |

### 5.2 Sensitive Data Handling

| Data Type | Storage | Logging | Display |
|-----------|---------|---------|---------|
| Passwords | Hashed only | Never | Masked |
| API Keys | Encrypted | Last 4 chars | Last 4 chars |
| Credit Cards | Tokenized (Stripe) | Never | Last 4 digits |
| SSN/ID Numbers | Encrypted | Never | Last 4 digits |
| Email | Plain | Masked | Full |

### 5.3 Data Retention

| Data Type | Retention | After Deletion |
|-----------|-----------|----------------|
| User data | Until account deletion | 30 days soft delete |
| Audit logs | 2 years | Archived |
| Session data | 30 days | Hard delete |
| Backups | 90 days | Rotated |

---

## 6. API Security

### 6.1 Rate Limiting

| Endpoint Type | Limit | Window |
|---------------|-------|--------|
| Public | 20 req | 1 minute |
| Authenticated | 100 req | 1 minute |
| Auth endpoints | 5 req | 1 minute |
| Admin | 200 req | 1 minute |

### 6.2 Input Validation

```typescript
// Always validate and sanitize
- Use parameterized queries (prevent SQL injection)
- Sanitize HTML output (prevent XSS)
- Validate file uploads (type, size, content)
- Validate URL parameters and query strings
- Use strict Content-Type checking
```

### 6.3 CORS Configuration

```typescript
cors({
  origin: ['https://app.example.com'],
  methods: ['GET', 'POST', 'PUT', 'DELETE'],
  credentials: true,
  maxAge: 86400,
});
```

### 6.4 Security Headers

```http
Strict-Transport-Security: max-age=31536000; includeSubDomains
Content-Security-Policy: default-src 'self'
X-Content-Type-Options: nosniff
X-Frame-Options: DENY
X-XSS-Protection: 1; mode=block
Referrer-Policy: strict-origin-when-cross-origin
```

---

## 7. Infrastructure Security

### 7.1 Network Security

- VPC with private subnets
- Security groups (least privilege)
- Network ACLs
- DDoS protection (CloudFlare/AWS Shield)

### 7.2 Server Hardening

- Minimal OS installation
- Regular patching (automated)
- Disabled unused ports/services
- SSH key-only access
- No root login

### 7.3 Container Security

- Base images from trusted sources
- Regular vulnerability scanning
- Non-root container execution
- Read-only file systems where possible
- Resource limits enforced

---

## 8. Monitoring & Audit

### 8.1 Security Logging

| Event | Log Level | Retention |
|-------|-----------|-----------|
| Login success | Info | 90 days |
| Login failure | Warning | 1 year |
| Permission denied | Warning | 1 year |
| Admin actions | Info | 2 years |
| Data export | Info | 2 years |
| API key usage | Info | 90 days |

### 8.2 Alerts

| Event | Threshold | Response |
|-------|-----------|----------|
| Failed logins | 5 in 5 min | Account lock |
| Rate limit hit | 3x limit | Temporary block |
| Suspicious IP | Blacklist match | Block + alert |
| Admin action | Any | Log + notify |

### 8.3 Audit Trail

```typescript
interface AuditLog {
  timestamp: Date;
  userId: string;
  action: string;
  resource: string;
  resourceId: string;
  ipAddress: string;
  userAgent: string;
  changes?: object;
  result: 'success' | 'failure';
}
```

---

## 9. Incident Response

### 9.1 Severity Levels

| Level | Description | Response Time |
|-------|-------------|---------------|
| P1 | Data breach, system down | 15 minutes |
| P2 | Security vulnerability | 1 hour |
| P3 | Suspicious activity | 4 hours |
| P4 | Policy violation | 24 hours |

### 9.2 Response Procedure

1. **Detect** â€” Identify and confirm incident
2. **Contain** â€” Isolate affected systems
3. **Investigate** â€” Determine scope and impact
4. **Remediate** â€” Fix vulnerability/issue
5. **Recover** â€” Restore normal operations
6. **Document** â€” Post-mortem and lessons learned

---

## 10. Compliance

### 10.1 Standards

| Standard | Status | Notes |
|----------|--------|-------|
| GDPR | Required | EU data subjects |
| SOC 2 | Planned | Type II |
| HIPAA | If applicable | Healthcare data |
| PCI DSS | Via Stripe | Payment data |

### 10.2 Data Subject Rights (GDPR)

- Right to access
- Right to rectification
- Right to erasure
- Right to portability
- Right to restriction
- Right to object

---

## 11. Open Questions

| # | Question | Impact | Status |
|---|----------|--------|--------|
| 1 | [Security decision] | [Impact] | Open |

---

## 12. Changelog

### YYMMDD - v1.0.0 - Initial Draft
- Defined authentication requirements
- Set authorization model
- Established data protection policies
```

---

## Validation Rules

- [ ] Version header present
- [ ] Security architecture diagram included
- [ ] Authentication methods defined
- [ ] Authorization model (RBAC) documented
- [ ] Data protection policies set
- [ ] Incident response procedures defined

================
File: .claude/skills/spec-governance/references/system-core-templates/tech-stack-template.md
================
# Tech Stack Template

Use this template for `01-architecture/tech-stack.md`.

---

```markdown
# Tech Stack

> **Version:** 1.0.0
> **Status:** Draft | Review | Approved
> **Last Updated:** YYMMDD

---

## 1. Overview

This document defines all technology choices for the project with rationale.

---

## 2. Technology Stack Diagram (REQUIRED)

```mermaid
flowchart LR
    subgraph Frontend
        FE1[React/Vue/Angular]
        FE2[State: Redux/Zustand]
        FE3[Styling: Tailwind/MUI]
    end

    subgraph Backend
        BE1[Node.js/Python/Go]
        BE2[Framework: NestJS/FastAPI]
        BE3[ORM: Prisma/TypeORM]
    end

    subgraph Data
        DB1[(PostgreSQL)]
        DB2[(Redis)]
        DB3[(Elasticsearch)]
    end

    subgraph Infrastructure
        INF1[Docker]
        INF2[Kubernetes]
        INF3[AWS/GCP]
    end

    Frontend --> Backend
    Backend --> Data
    Backend --> Infrastructure
```

---

## 3. Frontend Stack

| Category | Technology | Version | Rationale |
|----------|------------|---------|-----------|
| Framework | [React/Vue/Next.js] | [version] | [Why chosen] |
| Language | TypeScript | [version] | Type safety |
| State | [Redux/Zustand/Jotai] | [version] | [Why chosen] |
| Styling | [Tailwind/MUI/Chakra] | [version] | [Why chosen] |
| Forms | [React Hook Form/Formik] | [version] | [Why chosen] |
| Data Fetching | [TanStack Query/SWR] | [version] | [Why chosen] |
| Routing | [React Router/TanStack Router] | [version] | [Why chosen] |
| Testing | [Vitest/Jest/Playwright] | [version] | [Why chosen] |

---

## 4. Backend Stack

| Category | Technology | Version | Rationale |
|----------|------------|---------|-----------|
| Runtime | [Node.js/Python/Go] | [version] | [Why chosen] |
| Framework | [NestJS/FastAPI/Gin] | [version] | [Why chosen] |
| Language | TypeScript/Python/Go | [version] | [Why chosen] |
| ORM | [Prisma/TypeORM/SQLAlchemy] | [version] | [Why chosen] |
| Validation | [class-validator/Zod/Pydantic] | [version] | [Why chosen] |
| Auth | [JWT/Passport/OAuth] | [version] | [Why chosen] |
| Queue | [BullMQ/Celery/RabbitMQ] | [version] | [Why chosen] |
| Testing | [Jest/pytest/go test] | [version] | [Why chosen] |

---

## 5. Data Layer

| Category | Technology | Version | Use Case |
|----------|------------|---------|----------|
| Primary DB | [PostgreSQL/MySQL] | [version] | Relational data |
| Cache | [Redis/Memcached] | [version] | Session, caching |
| Search | [Elasticsearch/Meilisearch] | [version] | Full-text search |
| File Storage | [S3/GCS/Cloudflare R2] | - | Media storage |
| Message Queue | [RabbitMQ/Kafka/SQS] | [version] | Async messaging |

---

## 6. Infrastructure

| Category | Technology | Version | Rationale |
|----------|------------|---------|-----------|
| Container | Docker | [version] | Containerization |
| Orchestration | [K8s/ECS/Cloud Run] | [version] | [Why chosen] |
| Cloud | [AWS/GCP/Azure] | - | [Why chosen] |
| CI/CD | [GitHub Actions/GitLab CI] | - | [Why chosen] |
| Monitoring | [Datadog/Grafana/New Relic] | - | [Why chosen] |
| Logging | [ELK/CloudWatch/Loki] | - | [Why chosen] |

---

## 7. Development Tools

| Category | Tool | Purpose |
|----------|------|---------|
| Package Manager | [pnpm/npm/yarn] | Dependency management |
| Linting | ESLint + Prettier | Code quality |
| Git Hooks | Husky + lint-staged | Pre-commit checks |
| API Docs | [Swagger/OpenAPI] | API documentation |
| Local Dev | Docker Compose | Local environment |

---

## 8. Third-Party Services

| Service | Purpose | Fallback |
|---------|---------|----------|
| [Auth0/Clerk] | Authentication | [Backup option] |
| [Stripe/SePay] | Payments | [Backup option] |
| [SendGrid/Resend] | Email | [Backup option] |
| [Twilio/MessageBird] | SMS | [Backup option] |
| [OpenAI/Anthropic] | AI/LLM | [Backup option] |

---

## 9. Version Compatibility Matrix

| Component | Min Version | Recommended | Max Version |
|-----------|-------------|-------------|-------------|
| Node.js | 18.x | 20.x | 22.x |
| PostgreSQL | 14 | 16 | 16 |
| Docker | 24.x | 25.x | - |

---

## 10. Open Questions

| # | Question | Impact | Status |
|---|----------|--------|--------|
| 1 | [Technology decision pending] | [Impact] | Open |

---

## 11. Changelog

### YYMMDD - v1.0.0 - Initial Draft
- Defined technology stack
- Added rationale for each choice
```

---

## Validation Rules

- [ ] Version header present
- [ ] Stack diagram (mermaid) included
- [ ] All technologies have version numbers
- [ ] All choices have rationale documented
- [ ] Third-party services listed with fallbacks
- [ ] Compatibility matrix defined

================
File: .claude/skills/spec-governance/references/system-core-templates/testing-strategy-template.md
================
# Testing Strategy Template

Use this template for `02-standards/testing-strategy.md`.

---

```markdown
# Testing Strategy

> **Version:** 1.0.0
> **Status:** Draft | Review | Approved
> **Last Updated:** YYMMDD

---

## 1. Overview

This document defines the testing strategy, coverage requirements, and tooling.

---

## 2. Testing Pyramid

```mermaid
flowchart TB
    subgraph Pyramid["Testing Pyramid"]
        E2E["E2E Tests<br/>~10%<br/>Slow, Expensive"]
        INT["Integration Tests<br/>~20%<br/>Medium Speed"]
        UNIT["Unit Tests<br/>~70%<br/>Fast, Cheap"]
    end

    E2E --> INT --> UNIT

    style UNIT fill:#10B981
    style INT fill:#F59E0B
    style E2E fill:#F43F5E
```

---

## 3. Test Types

### 3.1 Unit Tests

**Purpose:** Test individual functions, classes, components in isolation.

**Coverage Target:** 80%+ line coverage

**Tools:**
- Backend: [Jest/Vitest/pytest]
- Frontend: [Vitest/Jest/React Testing Library]

**Scope:**
- Pure functions
- Business logic
- Utility functions
- Component rendering

**Example:**
```typescript
describe('calculateTotal', () => {
  it('should sum items correctly', () => {
    const items = [{ price: 10 }, { price: 20 }];
    expect(calculateTotal(items)).toBe(30);
  });

  it('should return 0 for empty array', () => {
    expect(calculateTotal([])).toBe(0);
  });
});
```

---

### 3.2 Integration Tests

**Purpose:** Test module interactions, API endpoints, database operations.

**Coverage Target:** Critical paths covered

**Tools:**
- Backend: [Supertest/httpx]
- Database: [Test containers/in-memory DB]

**Scope:**
- API endpoints
- Database queries
- Service interactions
- External service mocks

**Example:**
```typescript
describe('POST /users', () => {
  it('should create user and return 201', async () => {
    const response = await request(app)
      .post('/users')
      .send({ email: 'test@example.com', password: 'secure123' });

    expect(response.status).toBe(201);
    expect(response.body.data.email).toBe('test@example.com');
  });
});
```

---

### 3.3 End-to-End Tests

**Purpose:** Test complete user flows through the application.

**Coverage Target:** Critical user journeys

**Tools:**
- [Playwright/Cypress]

**Scope:**
- User registration flow
- Login flow
- Core business flows
- Payment flows

**Example:**
```typescript
test('user can complete checkout', async ({ page }) => {
  await page.goto('/products');
  await page.click('[data-testid="add-to-cart"]');
  await page.click('[data-testid="checkout"]');
  await page.fill('#email', 'test@example.com');
  await page.click('[data-testid="place-order"]');
  await expect(page.locator('.order-confirmation')).toBeVisible();
});
```

---

## 4. Coverage Requirements

| Test Type | Minimum | Target | Critical |
|-----------|---------|--------|----------|
| Unit Tests | 70% | 80% | 90% |
| Integration | - | Key paths | 100% |
| E2E | - | User journeys | 100% |

### Coverage Enforcement

```yaml
# In CI pipeline
coverage:
  lines: 70
  branches: 60
  functions: 70
  statements: 70
```

---

## 5. Test Organization

### Directory Structure

```
tests/
â”œâ”€â”€ unit/
â”‚   â”œâ”€â”€ services/
â”‚   â””â”€â”€ utils/
â”œâ”€â”€ integration/
â”‚   â”œâ”€â”€ api/
â”‚   â””â”€â”€ database/
â”œâ”€â”€ e2e/
â”‚   â”œâ”€â”€ auth.spec.ts
â”‚   â””â”€â”€ checkout.spec.ts
â””â”€â”€ fixtures/
    â”œâ”€â”€ users.json
    â””â”€â”€ products.json
```

### Naming Conventions

| Type | Pattern | Example |
|------|---------|---------|
| Unit | `*.test.ts` | `user.service.test.ts` |
| Integration | `*.spec.ts` | `users.api.spec.ts` |
| E2E | `*.e2e-spec.ts` | `checkout.e2e-spec.ts` |

---

## 6. Test Data

### Fixtures

```typescript
// fixtures/users.ts
export const validUser = {
  email: 'test@example.com',
  password: 'SecurePass123!',
};

export const adminUser = {
  ...validUser,
  role: 'admin',
};
```

### Factories

```typescript
// factories/user.factory.ts
export function createUser(overrides = {}) {
  return {
    id: faker.string.uuid(),
    email: faker.internet.email(),
    createdAt: new Date(),
    ...overrides,
  };
}
```

### Database Seeding

```typescript
beforeEach(async () => {
  await prisma.user.deleteMany();
  await prisma.user.createMany({ data: testUsers });
});

afterAll(async () => {
  await prisma.$disconnect();
});
```

---

## 7. Mocking Strategy

### External Services

```typescript
// Mock Stripe
jest.mock('@/lib/stripe', () => ({
  createPaymentIntent: jest.fn().mockResolvedValue({
    id: 'pi_test',
    status: 'succeeded',
  }),
}));
```

### Database (Integration)

```typescript
// Use test database
beforeAll(async () => {
  await setupTestDatabase();
});

afterAll(async () => {
  await teardownTestDatabase();
});
```

### When to Mock

| Mock | Don't Mock |
|------|------------|
| External APIs | Internal services (integration) |
| Payment gateways | Database (integration) |
| Email services | Business logic |
| Time-sensitive operations | Pure functions |

---

## 8. CI/CD Integration

### Pipeline Stages

```yaml
test:
  stages:
    - lint
    - unit-tests
    - integration-tests
    - e2e-tests

  unit-tests:
    script: npm run test:unit
    coverage: true

  integration-tests:
    script: npm run test:integration
    services:
      - postgres:15
      - redis:7

  e2e-tests:
    script: npm run test:e2e
    environment: staging
```

### Test Reports

- JUnit XML for CI integration
- HTML coverage reports
- Slack notifications for failures

---

## 9. Performance Testing

### Load Testing

**Tools:** [k6/Artillery/JMeter]

**Targets:**
| Endpoint | Users | Response Time | Error Rate |
|----------|-------|---------------|------------|
| GET /products | 100 | < 200ms | < 1% |
| POST /orders | 50 | < 500ms | < 0.1% |

### Stress Testing

Run before major releases to identify breaking points.

---

## 10. Security Testing

### SAST (Static Analysis)

- Tool: [SonarQube/Snyk]
- Run: Every PR

### DAST (Dynamic Analysis)

- Tool: [OWASP ZAP]
- Run: Weekly

### Dependency Scanning

- Tool: [Dependabot/Snyk]
- Run: Daily

---

## 11. Open Questions

| # | Question | Impact | Status |
|---|----------|--------|--------|
| 1 | [Testing tool decision] | [Impact] | Open |

---

## 12. Changelog

### YYMMDD - v1.0.0 - Initial Draft
- Defined testing pyramid
- Set coverage requirements
- Established test organization
```

---

## Validation Rules

- [ ] Version header present
- [ ] Testing pyramid diagram included
- [ ] Coverage requirements defined
- [ ] Test organization documented
- [ ] CI/CD integration defined

================
File: .claude/skills/spec-governance/references/system-core-templates/ui-ux-design-system-template.md
================
# UI/UX Design System Template

Use this template for `03-design/ui-ux-design-system.md`.

---

```markdown
# UI/UX Design System

> **Version:** 1.0.0
> **Status:** Draft | Review | Approved
> **Last Updated:** YYMMDD

---

## 1. Overview

This document defines the visual design system and UX guidelines.

---

## 2. Design Principles

| Principle | Description |
|-----------|-------------|
| **Clarity** | Clear hierarchy, obvious actions |
| **Consistency** | Same patterns everywhere |
| **Efficiency** | Minimize clicks, maximize productivity |
| **Accessibility** | WCAG 2.1 AA compliance |
| **Responsiveness** | Mobile-first, works everywhere |

---

## 3. Color Palette

### Primary Colors

```mermaid
flowchart LR
    subgraph Primary
        P500["Primary-500<br/>#6366F1"]
        P600["Primary-600<br/>#4F46E5"]
    end

    subgraph Secondary
        S500["Secondary-500<br/>#8B5CF6"]
    end

    subgraph Semantic
        Success["Success<br/>#10B981"]
        Warning["Warning<br/>#F59E0B"]
        Error["Error<br/>#EF4444"]
    end
```

### Color Usage Table

| Role | Color | Hex | Tailwind | Usage |
|------|-------|-----|----------|-------|
| Primary | Indigo | #6366F1 | `indigo-500` | CTAs, links, focus |
| Primary Hover | Indigo | #4F46E5 | `indigo-600` | Hover states |
| Secondary | Violet | #8B5CF6 | `violet-500` | Secondary actions |
| Success | Emerald | #10B981 | `emerald-500` | Success states, positive |
| Warning | Amber | #F59E0B | `amber-500` | Warnings, caution |
| Error | Red | #EF4444 | `red-500` | Errors, destructive |
| Background | Slate | #F8FAFC | `slate-50` | Page background |
| Surface | White | #FFFFFF | `white` | Cards, modals |
| Text | Slate | #1E293B | `slate-800` | Primary text |
| Text Muted | Slate | #64748B | `slate-500` | Secondary text |
| Border | Slate | #E2E8F0 | `slate-200` | Borders, dividers |

### Dark Mode

| Light | Dark |
|-------|------|
| `slate-50` bg | `slate-900` bg |
| `white` surface | `slate-800` surface |
| `slate-800` text | `slate-100` text |

---

## 4. Typography

### Font Stack

```css
--font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
--font-mono: 'JetBrains Mono', 'Fira Code', monospace;
```

### Type Scale

| Level | Size | Line Height | Weight | Usage |
|-------|------|-------------|--------|-------|
| Display | 48px | 56px | 700 | Hero headlines |
| H1 | 32px | 40px | 600 | Page titles |
| H2 | 24px | 32px | 600 | Section headers |
| H3 | 20px | 28px | 500 | Card headers |
| H4 | 16px | 24px | 500 | Subsections |
| Body | 16px | 24px | 400 | Paragraphs |
| Body Small | 14px | 20px | 400 | Secondary text |
| Caption | 12px | 16px | 400 | Labels, metadata |

### Font Weights

```
Light:     300
Regular:   400
Medium:    500
Semibold:  600
Bold:      700
```

---

## 5. Spacing

### Spacing Scale

| Token | Value | Usage |
|-------|-------|-------|
| xs | 4px | Icon padding |
| sm | 8px | Tight spacing |
| md | 16px | Default spacing |
| lg | 24px | Section spacing |
| xl | 32px | Large gaps |
| 2xl | 48px | Page sections |
| 3xl | 64px | Hero sections |

### Layout Grid

```
Columns:     12
Gutter:      24px
Margin:      16px (mobile), 32px (tablet), 64px (desktop)
Max Width:   1280px
```

---

## 6. Layout Structure

### Application Shell

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    HEADER (64px, sticky)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          â”‚                                                  â”‚
â”‚ SIDEBAR  â”‚              MAIN CONTENT                        â”‚
â”‚ (256px)  â”‚              (padding: 24px)                     â”‚
â”‚          â”‚                                                  â”‚
â”‚ - Logo   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ - Nav    â”‚  â”‚  Page Header                             â”‚   â”‚
â”‚ - Quick  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚   Action â”‚  â”‚                                          â”‚   â”‚
â”‚ - User   â”‚  â”‚  Content Area                            â”‚   â”‚
â”‚          â”‚  â”‚                                          â”‚   â”‚
â”‚          â”‚  â”‚  (Cards, Tables, Forms)                  â”‚   â”‚
â”‚          â”‚  â”‚                                          â”‚   â”‚
â”‚          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚          â”‚                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Responsive Breakpoints

| Breakpoint | Width | Sidebar |
|------------|-------|---------|
| Mobile | < 768px | Drawer (hidden) |
| Tablet | 768-1023px | Collapsed (icons) |
| Desktop | â‰¥ 1024px | Full (256px) |

---

## 7. Components

### Buttons

| Variant | Classes | Usage |
|---------|---------|-------|
| Primary | `bg-indigo-500 text-white hover:bg-indigo-600` | Main actions |
| Secondary | `bg-slate-100 text-slate-700 hover:bg-slate-200` | Secondary |
| Outline | `border border-slate-300 hover:bg-slate-50` | Tertiary |
| Ghost | `hover:bg-slate-100` | Minimal |
| Destructive | `bg-red-500 text-white hover:bg-red-600` | Dangerous |

### Button Sizes

| Size | Padding | Font |
|------|---------|------|
| sm | `px-3 py-1.5` | 14px |
| md | `px-4 py-2` | 14px |
| lg | `px-6 py-3` | 16px |

### Cards

```css
.card {
  @apply bg-white rounded-xl border border-slate-200 shadow-sm;
  @apply p-6;
}

.card-header {
  @apply text-lg font-semibold text-slate-800 mb-4;
}
```

### Form Inputs

```css
.input {
  @apply w-full px-4 py-2.5;
  @apply border border-slate-300 rounded-lg;
  @apply focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500;
  @apply placeholder:text-slate-400;
}

.input-error {
  @apply border-red-500 focus:ring-red-500;
}

.label {
  @apply block text-sm font-medium text-slate-700 mb-1.5;
}
```

### Badges

| Variant | Classes |
|---------|---------|
| Default | `bg-slate-100 text-slate-700` |
| Success | `bg-emerald-100 text-emerald-700` |
| Warning | `bg-amber-100 text-amber-700` |
| Error | `bg-red-100 text-red-700` |
| Info | `bg-blue-100 text-blue-700` |

---

## 8. Icons

**Library:** [Lucide Icons / Heroicons / Phosphor]

### Sizes

| Size | Pixels | Usage |
|------|--------|-------|
| sm | 16px | Inline with text |
| md | 20px | Buttons, default |
| lg | 24px | Headers, emphasis |
| xl | 32px | Empty states |

### Usage

```tsx
import { ChevronRight, Check, X } from 'lucide-react';

<ChevronRight className="w-5 h-5 text-slate-400" />
```

---

## 9. Feedback States

### Loading

- **Skeleton:** Initial page/component load
- **Spinner:** Button actions, inline loading
- **Progress:** File uploads, multi-step

### Empty States

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    â”‚
â”‚         [Illustration]             â”‚
â”‚                                    â”‚
â”‚     No items found                 â”‚
â”‚     Add your first item            â”‚
â”‚                                    â”‚
â”‚        [Primary CTA]               â”‚
â”‚                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Error States

- Inline: Red text below input
- Toast: Top-right notification
- Full page: Error illustration + retry

### Success States

- Toast: Green notification
- Inline: Green checkmark
- Modal: Success confirmation

---

## 10. Accessibility (WCAG 2.1 AA)

### Requirements

| Requirement | Standard | Implementation |
|-------------|----------|----------------|
| Color Contrast | 4.5:1 text, 3:1 UI | Test with axe |
| Focus Visible | Must be visible | `ring-2 ring-indigo-500` |
| Keyboard | Full keyboard nav | Tab order, shortcuts |
| Screen Reader | aria-* attributes | Labels, live regions |
| Motion | Reduce motion option | `prefers-reduced-motion` |

### Focus Styles

```css
*:focus-visible {
  @apply outline-none ring-2 ring-indigo-500 ring-offset-2;
}
```

---

## 11. Animation

### Transitions

```css
/* Default transition */
transition: all 150ms ease-in-out;

/* Hover states */
transition: background-color 150ms, color 150ms;

/* Modal/Drawer */
transition: transform 200ms ease-out, opacity 200ms;
```

### Motion Principles

- Subtle, purposeful animations
- < 300ms for micro-interactions
- Respect `prefers-reduced-motion`

---

## 12. Open Questions

| # | Question | Impact | Status |
|---|----------|--------|--------|
| 1 | Dark mode priority? | UX | Open |
| 2 | Custom illustrations? | Brand | Open |

---

## 13. Changelog

### YYMMDD - v1.0.0 - Initial Draft
- Defined color palette
- Set typography scale
- Documented component patterns
```

---

## Validation Rules

- [ ] Version header present
- [ ] Color palette documented with hex values
- [ ] Typography scale defined
- [ ] Spacing system documented
- [ ] Component patterns defined
- [ ] Accessibility requirements listed

================
File: .claude/skills/spec-governance/references/claude-md-template.md
================
# CLAUDE.md Template for ASDF Projects

This template is used by `/asdf:init` to generate the project's `CLAUDE.md` file.

---

## Template Variables

| Variable | Source | Description |
|----------|--------|-------------|
| `{{PROJECT_NAME}}` | Init conversation | Name of the project |
| `{{TECH_FRONTEND}}` | tech-stack.md | Frontend framework |
| `{{TECH_BACKEND}}` | tech-stack.md | Backend framework |
| `{{TECH_DATABASE}}` | tech-stack.md | Database system |
| `{{TECH_TESTING}}` | tech-stack.md | Testing framework |
| `{{DOMAINS_LIST}}` | 02-domains/ scan | Comma-separated domain names |
| `{{INIT_DATE}}` | Generation time | YYMMDD format |

---

## Full Template

```markdown
# CLAUDE.md - {{PROJECT_NAME}}

This project uses **ASDF (Astraler Spec-Driven Framework)** for spec-driven development.

## Core Philosophy

```
Specs â†’ Code â†’ Reverse Sync â†’ Specs
```

You execute code based on specifications, and automatically update documentation when implementation deviates.

## Role

You are a **Coder AI** operating under the direction of a **Product Architect**. Your responsibilities:
1. Read and understand specifications before coding
2. Execute implementations precisely according to specs
3. Detect improvements/changes during implementation
4. Automatically update specs via Reverse Sync protocol

## Agent

Use: `.claude/agents/asdf-coder.md`

## Commands

| Command | Purpose |
|---------|---------|
| `/asdf` | Show all commands and help |
| `/asdf:init` | Initialize ASDF structure |
| `/asdf:spec [feature]` | Create feature specification |
| `/asdf:code [path]` | Implement from specification |
| `/asdf:sync` | Reverse sync code â†’ docs |
| `/asdf:test [feature]` | Generate test cases |
| `/asdf:pr [feature]` | Create PR package |
| `/asdf:review [path]` | AI code review |
| `/asdf:status` | Update project status |
| `/asdf:roadmap` | Manage project phases |
| `/asdf:report [target]` | Progress report |
| `/asdf:audit` | Check spec health |
| `/asdf:cleanup` | Remove unused specs |
| `/asdf:handoff` | Session handoff notes |
| `/asdf:onboard` | Quick project tour |
| `/asdf:update [component]` | Update documentation |
| `/asdf:unlock [name]` | Release stuck lock |

## Documentation Structure

```
astraler-docs/
â”œâ”€â”€ 01-system-core/    # Architecture, standards, design, governance
â”œâ”€â”€ 02-domains/        # Business logic by domain
â”œâ”€â”€ 03-features/       # Actionable feature specs (YYMMDD-name/)
â””â”€â”€ 04-operations/     # Execution state, session memory
```

## Tech Stack

- **Frontend:** {{TECH_FRONTEND}}
- **Backend:** {{TECH_BACKEND}}
- **Database:** {{TECH_DATABASE}}
- **Testing:** {{TECH_TESTING}}

## Domains

{{DOMAINS_LIST}}

## Critical Rules

**MANDATORY:**
1. **ALWAYS** read specs before implementing
2. **NEVER** implement without understanding context hierarchy
3. **ALWAYS** run `/asdf:handoff` at end of session
4. **ALWAYS** trigger `/asdf:sync` after implementation deviations

**IMPORTANT:**
- Activate `spec-governance` skill for all spec-related operations
- Activate `context-loading` skill when starting new tasks
- Activate `impact-analysis` skill before `/asdf:code` for dependency checks
- Activate `testing` skill for test generation from specs
- Activate `maintenance` skill for audit/cleanup operations

## Context Loading Order

When starting any task, load context in this order:
1. `astraler-docs/01-system-core/` (global rules)
2. `astraler-docs/02-domains/` (relevant domain)
3. `astraler-docs/03-features/` (specific feature)
4. `astraler-docs/04-operations/session-handoff.md` (last session state)

## Quality Gates

Before marking any task complete:
- [ ] Spec read and understood
- [ ] Dependencies checked
- [ ] Impact analysis completed
- [ ] Code matches spec intent
- [ ] Tests passing
- [ ] `implementation-active.md` updated
- [ ] Lock released (if held)

## Skills

Activate these skills as needed:

| Skill | When to Use |
|-------|-------------|
| `spec-governance` | Template compliance, validation |
| `refinement-loop` | Iterative spec creation |
| `context-loading` | Starting any task |
| `reverse-sync` | Code-spec reconciliation |
| `testing` | Test generation with matrix |
| `pr-review` | PR and code review |
| `impact-analysis` | Breaking change detection |
| `maintenance` | Audit, cleanup, tech debt |

---

*Generated by ASDF on {{INIT_DATE}}*
```

---

## Merge Sections (for Brownfield)

When merging into existing CLAUDE.md, add these sections:

### Section: ASDF Framework
```markdown
## ASDF Framework

This project uses ASDF for spec-driven development.

- **Agent:** `.claude/agents/asdf-coder.md`
- **Documentation:** `astraler-docs/`
- **Commands:** `/asdf:*` (run `/asdf` for full list)
```

### Section: ASDF Commands (append to existing commands)
```markdown
### ASDF Commands

| Command | Purpose |
|---------|---------|
| `/asdf` | Show all ASDF commands |
| `/asdf:spec [name]` | Create feature spec |
| `/asdf:code [path]` | Implement from spec |
| `/asdf:sync` | Sync code â†’ docs |
| `/asdf:test [feature]` | Generate tests |
| `/asdf:handoff` | Session notes |
```

### Section: ASDF Rules (append to existing rules)
```markdown
### ASDF Rules

- Read specs before implementing
- Run `/asdf:handoff` at session end
- Trigger `/asdf:sync` after deviations
- Load context hierarchy before tasks
```

---

## Detection Patterns

### Check if CLAUDE.md has ASDF

Look for these markers:
- "ASDF" or "astraler-docs"
- ".claude/agents/asdf-coder.md"
- "/asdf:" commands
- "Spec-Driven" methodology reference

### Existing ASDF Version Detection

```bash
grep -E "(ASDF|asdf-coder|astraler-docs)" CLAUDE.md
```

If found â†’ ASDF already configured â†’ offer update option

================
File: .claude/skills/spec-governance/references/domain-template.md
================
# Domain Spec Template

Use this template when creating domain specifications.

**IMPORTANT:** All domain specs MUST include an Entity Relationship Diagram (ERD).

---

```markdown
# [Domain Name] Domain

> **Version:** 1.0.0
> **Status:** Draft | Review | Approved
> **Last Updated:** YYMMDD

---

## 1. Overview

[2-3 sentences describing this domain's purpose and scope]

### Responsibilities
- [What this domain owns]
- [What decisions it makes]
- [What data it manages]

### Boundaries
- [What this domain does NOT handle]
- [What belongs to other domains]

---

## 2. Entity Relationship Diagram (REQUIRED)

```mermaid
erDiagram
    ENTITY_A ||--o{ ENTITY_B : "has many"
    ENTITY_A {
        uuid id PK
        string name
        timestamp created_at
        timestamp updated_at
    }
    ENTITY_B ||--|{ ENTITY_C : "contains"
    ENTITY_B {
        uuid id PK
        uuid entity_a_id FK
        enum status
        decimal amount
        timestamp created_at
    }
    ENTITY_C {
        uuid id PK
        uuid entity_b_id FK
        string description
        int quantity
    }
```

---

## 3. Entities

### [Entity A]

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | UUID | PK | Unique identifier |
| name | VARCHAR(255) | NOT NULL | Display name |
| status | ENUM | NOT NULL | active, inactive, archived |
| created_at | TIMESTAMP | NOT NULL | Creation time |
| updated_at | TIMESTAMP | NOT NULL | Last update time |

**Business Rules:**
- [Rule 1]
- [Rule 2]

### [Entity B]

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | UUID | PK | Unique identifier |
| entity_a_id | UUID | FK, NOT NULL | Reference to Entity A |
| amount | DECIMAL(10,2) | NOT NULL | Monetary amount |

**Business Rules:**
- [Rule 1]
- [Rule 2]

---

## 4. State Machine

### [Entity] Lifecycle

```mermaid
stateDiagram-v2
    [*] --> Pending: Create
    Pending --> Active: Approve
    Pending --> Rejected: Reject
    Active --> Suspended: Suspend
    Active --> Archived: Archive
    Suspended --> Active: Reactivate
    Archived --> [*]
```

| Transition | From | To | Trigger | Validation |
|------------|------|-----|---------|------------|
| create | - | Pending | User action | [rules] |
| approve | Pending | Active | Admin approval | [rules] |
| reject | Pending | Rejected | Admin decision | [rules] |

---

## 5. Domain Events

| Event | Trigger | Payload | Consumers |
|-------|---------|---------|-----------|
| [entity].created | New entity added | { id, ...fields } | [Other domains] |
| [entity].updated | Entity modified | { id, changes } | [Other domains] |
| [entity].deleted | Entity removed | { id } | [Other domains] |

---

## 6. API Contracts

### Public Endpoints

#### GET /api/v1/[domain]/[resource]

**Query Parameters:**
| Param | Type | Required | Description |
|-------|------|----------|-------------|
| page | int | No | Page number (default: 1) |
| limit | int | No | Items per page (default: 20) |
| status | string | No | Filter by status |

**Response (200):**
```json
{
  "data": [...],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 100
  }
}
```

#### POST /api/v1/[domain]/[resource]

**Request:**
```json
{
  "field": "value"
}
```

**Response (201):**
```json
{
  "id": "uuid",
  "field": "value",
  "created_at": "timestamp"
}
```

---

## 7. Business Rules & Constraints

### Validation Rules

| Rule | Description | Error Code |
|------|-------------|------------|
| [RULE-001] | [Description] | [ERROR_CODE] |
| [RULE-002] | [Description] | [ERROR_CODE] |

### Constraints

| Constraint | Type | Description |
|------------|------|-------------|
| [Name] | Unique | [Description] |
| [Name] | Foreign Key | [Description] |
| [Name] | Check | [Description] |

---

## 8. Error Codes

| Code | Name | Description | Resolution |
|------|------|-------------|------------|
| [DOMAIN]_001 | [ErrorName] | [When this occurs] | [How to fix] |
| [DOMAIN]_002 | [ErrorName] | [When this occurs] | [How to fix] |

---

## 9. Dependencies

### Depends On
- [Domain A] â€” [Why/What data]
- [Domain B] â€” [Why/What data]

### Depended By
- [Domain C] â€” [Why/What data]
- [Domain D] â€” [Why/What data]

### External Services
- [Service Name] â€” [Purpose]

---

## 10. Open Questions

| # | Question | Impact | Status |
|---|----------|--------|--------|
| 1 | [Unresolved question] | [How it affects domain] | Open |

---

## 11. Related Features

- [YYMMDD-feature-name](../03-features/YYMMDD-feature-name/spec.md)

---

## 12. Changelog

### YYMMDD - v1.0.0 - Initial Draft
- Created domain spec
- Defined entities and relationships
- Added ERD diagram
```

---

## ERD Requirements

The ERD MUST show:
- All entities in the domain
- Primary keys (PK)
- Foreign keys (FK)
- Relationships with cardinality:
  - `||--||` one-to-one
  - `||--o{` one-to-many
  - `}o--o{` many-to-many
- Key fields with types

---

## Validation Rules

Before finalizing any domain spec, verify:

- [ ] Version header present
- [ ] ERD mermaid diagram included
- [ ] All entities documented with field types
- [ ] State machine for stateful entities
- [ ] Business rules listed
- [ ] API contracts defined
- [ ] Dependencies mapped (incoming and outgoing)
- [ ] Domain events documented
- [ ] Error codes defined
- [ ] Open questions listed
- [ ] Changelog has initial entry

================
File: .claude/skills/spec-governance/references/feature-template.md
================
# Feature Spec Template

Use this template when creating new feature specifications.

**IMPORTANT:** All features MUST include a mermaid user flow diagram.

---

```markdown
# [Feature Name]

> **Version:** 1.0.0
> **Status:** Draft | Review | Approved
> **Feature ID:** YYMMDD-feature-name
> **Domain:** [Link to domain spec]
> **Created:** YYMMDD
> **Last Updated:** YYMMDD

---

## 1. Overview

[2-3 sentences describing what this feature does]

### Business Value
- [Why this feature matters]
- [What problem it solves]
- [Who benefits]

---

## 2. User Flow Diagram (REQUIRED)

```mermaid
flowchart TD
    A[User Action] --> B{Decision Point}
    B -->|Option 1| C[Process 1]
    B -->|Option 2| D[Process 2]
    C --> E[API Call]
    D --> E
    E --> F{Success?}
    F -->|Yes| G[Success State]
    F -->|No| H[Error State]
    H --> I[Retry or Exit]
```

**Flow Description:**
1. [Step 1 description]
2. [Step 2 description]
3. [Step 3 description]

---

## 3. Requirements

### 3.1 Functional Requirements (MUST)

| ID | Requirement | Priority |
|----|-------------|----------|
| FR-001 | [Requirement description] | High |
| FR-002 | [Requirement description] | Medium |

### 3.2 Non-Functional Requirements (SHOULD)

| ID | Requirement | Target |
|----|-------------|--------|
| NFR-001 | Performance | [e.g., < 200ms response] |
| NFR-002 | Availability | [e.g., 99.9% uptime] |

### 3.3 Out of Scope

- [Explicitly state what this feature does NOT include]
- [Prevents scope creep]

---

## 4. Technical Design

### Architecture

[Describe how this feature fits into the system]

### Data Flow Diagram

```mermaid
sequenceDiagram
    participant U as User
    participant F as Frontend
    participant A as API
    participant S as Service
    participant D as Database

    U->>F: Action
    F->>A: Request
    A->>S: Process
    S->>D: Query
    D-->>S: Result
    S-->>A: Response
    A-->>F: Data
    F-->>U: Display
```

### Key Files
- `path/to/file.ts` â€” [Purpose]
- `path/to/component.tsx` â€” [Purpose]

### Dependencies
- [Internal: other features/domains this depends on]
- [External: third-party services/libraries]

---

## 5. UI/UX

### Wireframe

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Header / Navigation                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Main Content Area               â”‚    â”‚
â”‚  â”‚                                  â”‚    â”‚
â”‚  â”‚  [Form/List/Dashboard]           â”‚    â”‚
â”‚  â”‚                                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                          â”‚
â”‚  [Primary Action Button]                 â”‚
â”‚                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### States
- **Loading:** [Description]
- **Empty:** [Description]
- **Error:** [Description]
- **Success:** [Description]

---

## 6. API Contract

### Endpoints

#### POST /api/v1/[resource]

**Request:**
```json
{
  "field": "type"
}
```

**Response (200):**
```json
{
  "id": "string",
  "created": "timestamp"
}
```

**Errors:**
| Code | Message | When |
|------|---------|------|
| 400 | Invalid input | [condition] |
| 401 | Unauthorized | [condition] |
| 404 | Not found | [condition] |

---

## 7. Acceptance Criteria

| ID | Criteria | Testable? |
|----|----------|-----------|
| AC-001 | Given [context], when [action], then [result] | Yes |
| AC-002 | Given [context], when [action], then [result] | Yes |

---

## 8. Testing

### Unit Tests
- [ ] [Component/function to test]

### Integration Tests
- [ ] [API endpoint to test]

### E2E Tests
- [ ] [User flow to test]

---

## 9. Open Questions

| # | Question | Impact | Status |
|---|----------|--------|--------|
| 1 | [Unresolved question] | [How it affects implementation] | Open |
| 2 | [Unresolved question] | [How it affects implementation] | Resolved |

---

## 10. Blockers

| Blocker | Status | Owner |
|---------|--------|-------|
| [Description] | Open/Resolved | [Name] |

---

## 11. Implementation Progress

| Task | Status | Notes |
|------|--------|-------|
| [Task 1] | Done/In Progress/Pending | |
| [Task 2] | Done/In Progress/Pending | |

---

## 12. Changelog

### YYMMDD - v1.0.0 - Initial Draft
- Created spec
- Defined requirements
- Added user flow diagram

### YYMMDD - v1.1.0 - [Update Title]
- [What changed]
- Reason: [Why]
```

---

## Diagram Requirements

| Diagram Type | When Required | Purpose |
|--------------|---------------|---------|
| User Flow (flowchart) | ALWAYS | Shows user journey through feature |
| Data Flow (sequence) | Complex features | Shows component interactions |
| State Machine | Stateful features | Shows state transitions |

---

## Validation Rules

Before finalizing any feature spec, verify:

- [ ] Version header present (v1.0.0 format)
- [ ] Status field present (Draft/Review/Approved)
- [ ] User flow mermaid diagram included
- [ ] All FRs have priority
- [ ] All NFRs have measurable targets
- [ ] API contracts have request/response examples
- [ ] Acceptance criteria are testable (Given/When/Then)
- [ ] Open questions listed
- [ ] Changelog has initial entry

================
File: .claude/skills/spec-governance/references/validation-rules.md
================
# Spec Validation Rules

Rules for validating ASDF specifications. **v2.0** â€” Includes version management, mermaid diagrams, and open questions requirements.

---

## Universal Requirements (ALL Specs)

### 1. Version Header (CRITICAL)

Every spec MUST have version header at top:
```markdown
> **Version:** 1.0.0
> **Status:** Draft | Review | Approved
> **Last Updated:** YYMMDD
```

**Validation:**
- Version format: `X.Y.Z` (semantic versioning)
- Status: One of `Draft`, `Review`, `Approved`
- Date: `YYMMDD` format

### 2. Open Questions Section (CRITICAL)

Every spec MUST include:
```markdown
## Open Questions

| # | Question | Impact | Status |
|---|----------|--------|--------|
| 1 | [Question text] | [Impact description] | Open/Resolved |
```

**Validation:**
- Section must exist (can be empty table)
- Status: `Open` or `Resolved`

### 3. Changelog Section (CRITICAL)

Every spec MUST include:
```markdown
## Changelog

### YYMMDD - v1.0.0 - Initial Draft
- Created spec
- [Additional items]
```

**Validation:**
- At least one changelog entry
- Version matches header version
- Date in `YYMMDD` format

---

## Mermaid Diagram Requirements (CRITICAL)

### Required Diagrams by Document Type

| Document | Diagram Type | Mermaid Syntax |
|----------|--------------|----------------|
| master-map.md | System architecture | `flowchart TB` |
| data-architecture.md | ERD | `erDiagram` |
| infrastructure.md | Deployment topology | `flowchart TB` |
| Domain specs | Entity relationships | `erDiagram` |
| Feature specs | User flow | `flowchart TD` |

**Validation:**
- Document type must have corresponding mermaid block
- Diagram must be meaningful (not placeholder)

### Diagram Validation Checks

```javascript
// Required diagram patterns
const diagramRequirements = {
  'master-map.md': /```mermaid\s*flowchart/,
  'data-architecture.md': /```mermaid\s*erDiagram/,
  'infrastructure.md': /```mermaid\s*flowchart/,
  'domain.md': /```mermaid\s*erDiagram/,
  'spec.md': /```mermaid\s*flowchart/
};
```

---

## Feature Spec Validation

### Required Sections (MUST have)
- [ ] Version header with version, status, last updated
- [ ] Overview with business value
- [ ] **User Flow Diagram (mermaid flowchart)** â† NEW v2
- [ ] At least one Functional Requirement (FR-XXX)
- [ ] At least one Acceptance Criterion (AC-XXX)
- [ ] **Open Questions section** â† NEW v2
- [ ] **Changelog section** â† NEW v2
- [ ] Implementation Progress section

### Conditional Sections
- [ ] UI/UX section â€” Required if feature has user interface
- [ ] API Contract section â€” Required if feature has API endpoints
- [ ] Technical Design â€” Required for features touching >2 files
- [ ] Data Flow Diagram â€” Required for complex features

### ID Formats
| ID Type | Format | Example |
|---------|--------|---------|
| Feature ID | YYMMDD-kebab-case | 251224-user-auth |
| Functional Req | FR-XXX | FR-001 |
| Non-Functional | NFR-XXX | NFR-001 |
| Acceptance | AC-XXX | AC-001 |

### Quality Checks
- [ ] No orphan requirements (every FR has related AC)
- [ ] Acceptance criteria are testable (Given/When/Then format)
- [ ] Out of Scope explicitly defined
- [ ] Status reflects actual state
- [ ] NFRs have measurable targets

---

## Domain Spec Validation

### Required Sections (MUST have)
- [ ] Version header with version, status, last updated
- [ ] Overview with responsibilities and boundaries
- [ ] **ERD Diagram (mermaid erDiagram)** â† NEW v2
- [ ] At least one Entity definition with field types
- [ ] At least one Business Rule with ID
- [ ] Domain Events section
- [ ] API Contracts section
- [ ] Error Codes section
- [ ] **Open Questions section** â† NEW v2
- [ ] **Changelog section** â† NEW v2

### ID Formats
| ID Type | Format | Example |
|---------|--------|---------|
| Business Rule | [DOMAIN]-XXX | AUTH-001 |
| Error Code | [DOMAIN]_XXX | AUTH_001 |

### ERD Requirements
The ERD must show:
- [ ] All entities in domain
- [ ] Primary keys marked (PK)
- [ ] Foreign keys marked (FK)
- [ ] Relationship cardinality
- [ ] Key field types

### Quality Checks
- [ ] Business rules have enforcement description
- [ ] Entities have complete field definitions
- [ ] Integration points document inbound AND outbound
- [ ] Related features linked
- [ ] State machine for stateful entities

---

## System-Core Validation

### Required Diagrams

| File | Diagram | What to Show |
|------|---------|--------------|
| master-map.md | System architecture | All services, communication flows |
| data-architecture.md | Full ERD | All core entities, relationships |
| infrastructure.md | Deployment topology | Compute, storage, networking |

### Required Depth
- [ ] Not placeholder content
- [ ] Technical details present
- [ ] Rules & constraints documented
- [ ] Dependencies linked
- [ ] Rationale for decisions

---

## Valid Statuses

| Spec Type | Valid Statuses |
|-----------|----------------|
| All specs | `Draft`, `Review`, `Approved` |
| Feature (legacy) | `Planned`, `In Progress (X%)`, `Implemented`, `Deprecated` |
| Domain (legacy) | `Active`, `Planned`, `Deprecated` |

---

## Validation Error Levels

### CRITICAL (Block finalization)
- Missing version header
- Missing required mermaid diagram
- Missing Open Questions section
- Missing Changelog section
- Missing required sections
- Invalid ID format
- No acceptance criteria

### WARNING (Flag but allow)
- Missing optional sections
- Incomplete changelog
- Missing cross-references
- NFRs without measurable targets

### INFO (Suggestions)
- Long sections that could be split
- Missing diagrams for complex flows
- Empty Open Questions table

---

## Automated Validation

```javascript
function validateSpec(content, type) {
  const errors = [];
  const warnings = [];

  // CRITICAL: Version header
  if (!content.match(/>\s*\*\*Version:\*\*\s*\d+\.\d+\.\d+/)) {
    errors.push('CRITICAL: Missing or invalid Version header');
  }

  // CRITICAL: Status
  if (!content.match(/>\s*\*\*Status:\*\*\s*(Draft|Review|Approved)/)) {
    errors.push('CRITICAL: Missing or invalid Status');
  }

  // CRITICAL: Open Questions
  if (!content.includes('## Open Questions') &&
      !content.includes('## 9. Open Questions') &&
      !content.includes('## 10. Open Questions')) {
    errors.push('CRITICAL: Missing Open Questions section');
  }

  // CRITICAL: Changelog
  if (!content.includes('## Changelog') &&
      !content.includes('## 10. Changelog') &&
      !content.includes('## 12. Changelog')) {
    errors.push('CRITICAL: Missing Changelog section');
  }

  // Type-specific: Mermaid diagrams
  if (type === 'feature' && !content.includes('```mermaid')) {
    errors.push('CRITICAL: Missing user flow diagram');
  }
  if (type === 'domain' && !content.includes('erDiagram')) {
    errors.push('CRITICAL: Missing ERD diagram');
  }

  return { errors, warnings };
}
```

---

## Cross-Reference Rules

- Domain specs MUST link to related features
- Feature specs MUST link to parent domain
- System-core docs MUST link to each other where relevant
- Use relative paths: `../02-domains/auth/auth-domain.md`

================
File: .claude/skills/spec-governance/SKILL.md
================
---
name: spec-governance
description: Validate specs, enforce standards, provide templates for ASDF specifications.
---

# Spec Governance

Ensure all specifications follow ASDF standards, include required diagrams, and are properly versioned.

## When to Use

- Creating new feature specs (`/asdf:spec`)
- Creating domain specs (`/asdf:init`)
- Creating system-core docs (`/asdf:init`)
- Validating existing specs
- Reviewing spec quality

## Templates

### Feature Spec Template
Load: `references/feature-template.md`

### Domain Spec Template
Load: `references/domain-template.md`

### System-Core Templates
Load: `references/system-core-templates/README.md`

Individual templates:
- `references/system-core-templates/master-map-template.md`
- `references/system-core-templates/data-architecture-template.md`
- `references/system-core-templates/infrastructure-template.md`

## Validation Rules
Load: `references/validation-rules.md`

---

## Mandatory Requirements

### 1. Version Header (ALL specs)

Every spec file MUST start with:
```markdown
> **Version:** 1.0.0
> **Status:** Draft | Review | Approved
> **Last Updated:** YYMMDD
```

### 2. Mermaid Diagrams (REQUIRED)

| Document Type | Required Diagram | Mermaid Type |
|---------------|------------------|--------------|
| master-map.md | System architecture | flowchart |
| data-architecture.md | ERD | erDiagram |
| infrastructure.md | Deployment topology | flowchart |
| Domain specs | Entity relationships | erDiagram |
| Feature specs | User flow | flowchart |

**Never create these documents without their required diagrams.**

### 3. Open Questions Section

All specs MUST include:
```markdown
## Open Questions

| # | Question | Impact | Status |
|---|----------|--------|--------|
| 1 | [Unresolved item] | [How it affects work] | Open |
```

### 4. Changelog Section

All specs MUST include:
```markdown
## Changelog

### YYMMDD - v1.0.0 - Initial Draft
- Created spec
- [What was defined]
```

---

## Quick Reference

### Feature Spec Required Sections
1. Overview + Business Value
2. **User Flow Diagram (mermaid)** â† REQUIRED
3. Requirements (FR/NFR/Out of Scope)
4. Technical Design + Data Flow Diagram
5. UI/UX (wireframes)
6. API Contract
7. Acceptance Criteria
8. Testing
9. **Open Questions** â† REQUIRED
10. Implementation Progress
11. **Changelog** â† REQUIRED

### Domain Spec Required Sections
1. Overview + Responsibilities
2. **ERD Diagram (mermaid)** â† REQUIRED
3. Entities (with field types)
4. State Machines (if applicable)
5. Domain Events
6. API Contracts
7. Business Rules
8. Error Codes
9. Dependencies
10. **Open Questions** â† REQUIRED
11. **Changelog** â† REQUIRED

### System-Core Required Diagrams
| File | Diagram |
|------|---------|
| master-map.md | System architecture flowchart |
| data-architecture.md | Full ERD |
| infrastructure.md | Deployment topology |

---

## Naming Conventions

| Type | Convention | Example |
|------|------------|---------|
| Feature folders | YYMMDD-feature-name | 251224-user-auth |
| Domain folders | domain-name | auth, payments |
| Requirement IDs | FR-001, NFR-001 | FR-001 |
| Acceptance Criteria | AC-001 | AC-001 |
| Business Rule IDs | [DOMAIN]-001 | AUTH-001 |
| Version | Semantic | 1.0.0, 1.1.0, 2.0.0 |

---

## Quality Checklist

Before finalizing any spec:

### Universal (All Specs)
- [ ] Version header present (v1.0.0 format)
- [ ] Status field present (Draft/Review/Approved)
- [ ] Last Updated date set
- [ ] Open Questions section present
- [ ] Changelog section present

### Feature Specs
- [ ] User flow mermaid diagram included
- [ ] All FRs have priority
- [ ] All NFRs have measurable targets
- [ ] API contracts have request/response examples
- [ ] Acceptance criteria are testable (Given/When/Then)

### Domain Specs
- [ ] ERD mermaid diagram included
- [ ] All entities documented with field types
- [ ] Business rules have unique IDs
- [ ] Dependencies mapped (incoming and outgoing)

### System-Core Docs
- [ ] Required diagram included (master-map, data-architecture, infrastructure)
- [ ] Deep technical content (not placeholders)
- [ ] Rules & constraints documented

---

## Diagram Examples

### User Flow (Feature Specs)
```mermaid
flowchart TD
    A[User Action] --> B{Decision}
    B -->|Yes| C[Process]
    B -->|No| D[Alternative]
    C --> E[Result]
    D --> E
```

### ERD (Domain Specs)
```mermaid
erDiagram
    USER ||--o{ ORDER : places
    USER {
        uuid id PK
        string email UK
    }
    ORDER {
        uuid id PK
        uuid user_id FK
    }
```

### System Architecture (master-map.md)
```mermaid
flowchart TB
    subgraph Client
        Web[Web App]
    end
    subgraph API
        Gateway[API Gateway]
    end
    subgraph Services
        Auth[Auth Service]
    end
    Web --> Gateway
    Gateway --> Auth
```

### Deployment Topology (infrastructure.md)
```mermaid
flowchart TB
    subgraph Cloud
        LB[Load Balancer]
        App[App Servers]
        DB[(Database)]
    end
    Users --> LB
    LB --> App
    App --> DB
```

================
File: .claude/skills/testing/SKILL.md
================
---
name: testing
description: Generate test cases from spec acceptance criteria and testing section.
---

# Testing Skill

Generate comprehensive test suites from feature specifications.

## When to Use

- `/asdf:test` command
- When spec Testing section needs population
- After implementation to verify coverage
- Creating new feature specs (generate initial test plan)

---

## Test Generation Protocol

### Step 1: Extract Test Sources

From spec, extract:

| Spec Section | Test Type | Priority |
|--------------|-----------|----------|
| Acceptance Criteria (AC-XXX) | Direct test cases | P0 |
| Functional Requirements (FR-XXX) | Unit tests | P0-P1 |
| Non-Functional Requirements (NFR-XXX) | Performance tests | P1 |
| Error Codes | Error handling tests | P0 |
| API Contracts | Integration tests | P0 |
| State Machines | State transition tests | P0 |
| Edge Cases (from Open Questions) | Edge case tests | P1-P2 |

### Step 2: Generate Test Plan

Present for review:

```markdown
**Test Plan for [Feature]**

Spec: `03-features/YYMMDD-[feature]/spec.md`
Version: [X.Y.Z]

---

### Unit Tests

| Test ID | AC/FR | Description | Input | Expected Output |
|---------|-------|-------------|-------|-----------------|
| UT-001 | AC-001 | Valid login with correct credentials | valid email/password | JWT token returned |
| UT-002 | AC-001 | Invalid password rejected | valid email, wrong password | 401 Unauthorized |
| UT-003 | AC-001 | Non-existent user rejected | unknown email | 404 Not Found |
| UT-004 | FR-002 | Password hashed before storage | plain password | bcrypt hash stored |

### Integration Tests

| Test ID | AC/FR | Description | Preconditions | Steps | Expected Result |
|---------|-------|-------------|---------------|-------|-----------------|
| IT-001 | AC-003 | Complete login flow | User exists | 1. POST /auth/login 2. Verify token | 200 + valid JWT |
| IT-002 | AC-004 | Token refresh | Valid refresh token | 1. POST /auth/refresh | New access token |

### Edge Cases

| Case ID | Scenario | Description | How to Handle |
|---------|----------|-------------|---------------|
| EC-001 | Rate limit | 10+ login attempts | Return 429, block 5 min |
| EC-002 | Concurrent sessions | Same user, multiple devices | Allow up to 5 sessions |
| EC-003 | Token expiry | Access token expired | 401, use refresh token |

---

**Summary:**
- Unit Tests: [N] cases
- Integration Tests: [M] cases
- Edge Cases: [O] cases

Proceed with test generation? (yes/feedback)
```

### Step 3: Update Spec Testing Section

After confirmation, update spec's `## Testing` section:

```markdown
## Testing

> **Generated:** YYMMDD
> **Coverage Target:** 80%

### Unit Tests

| Test ID | Description | Input | Expected Output | Status |
|---------|-------------|-------|-----------------|--------|
| UT-001 | Valid login | valid email/password | JWT token returned | Pending |
| UT-002 | Invalid password | valid email, wrong pass | 401 Unauthorized | Pending |
| UT-003 | Non-existent user | unknown email | 404 Not Found | Pending |

### Integration Tests

| Test ID | Description | Preconditions | Steps | Expected Result | Status |
|---------|-------------|---------------|-------|-----------------|--------|
| IT-001 | Complete login flow | User exists | 1. POST /auth/login | 200 + JWT | Pending |

### Edge Cases

| Case ID | Description | How to Handle | Status |
|---------|-------------|---------------|--------|
| EC-001 | Rate limit (10+ attempts) | 429, block 5 min | Pending |
| EC-002 | Concurrent sessions | Allow up to 5 | Pending |
```

---

## Test File Generation

When user confirms "generate test files", create:

### Unit Test Template

```typescript
// __tests__/[feature]/[component].test.ts

describe('[Feature]: [Component]', () => {
  describe('AC-001: [Acceptance Criteria]', () => {
    it('UT-001: should [expected behavior]', () => {
      // Arrange
      const input = { /* from spec examples */ };

      // Act
      const result = functionUnderTest(input);

      // Assert
      expect(result).toEqual(/* expected */);
    });

    it('UT-002: should handle edge case: [case]', () => {
      // Test edge case from EC-XXX
    });
  });
});
```

### Integration Test Template

```typescript
// __tests__/[feature]/[endpoint].integration.test.ts

describe('[Feature] API', () => {
  describe('POST /api/[endpoint]', () => {
    it('IT-001: should return 200 with valid input (AC-002)', async () => {
      // Arrange
      const request = { /* from spec API examples */ };

      // Act
      const response = await api.post('/endpoint', request);

      // Assert
      expect(response.status).toBe(200);
      expect(response.body).toMatchObject(/* expected */);
    });

    it('IT-002: should return 400 with invalid input', async () => {
      // Test validation
    });

    it('IT-003: should return 401 without auth', async () => {
      // Test auth requirement
    });
  });
});
```

### Fixtures Template

```typescript
// __tests__/[feature]/fixtures.ts

// From spec examples
export const validInput = {
  email: 'user@example.com',
  password: 'SecurePass123!',
};

// Edge cases
export const invalidInputs = {
  emptyEmail: { email: '', password: 'pass' },
  malformedEmail: { email: 'not-an-email', password: 'pass' },
  shortPassword: { email: 'user@example.com', password: '123' },
};

// Mock responses
export const mockResponses = {
  successfulLogin: {
    token: 'eyJ...',
    expiresIn: 3600,
  },
};
```

---

## Test Naming Convention

| Type | File Pattern | Test ID Pattern |
|------|--------------|-----------------|
| Unit | `[component].test.ts` | UT-001, UT-002, ... |
| Integration | `[endpoint].integration.test.ts` | IT-001, IT-002, ... |
| E2E | `[flow].e2e.test.ts` | E2E-001, E2E-002, ... |
| Edge Case | (within unit/integration) | EC-001, EC-002, ... |

---

## Test Report Template

After test generation:

```markdown
**Test Generation Complete**

Feature: [feature-name]
Spec Version: [X.Y.Z]

**Summary:**
| Type | Count | Files |
|------|-------|-------|
| Unit | [N] | [M] |
| Integration | [N] | [M] |
| Edge Cases | [N] | - |
| **Total** | [T] | [F] |

**Files Created:**
- `__tests__/[feature]/[component].test.ts`
- `__tests__/[feature]/[endpoint].integration.test.ts`
- `__tests__/[feature]/fixtures.ts`

**Spec Updated:**
- `03-features/YYMMDD-[feature]/spec.md` â€” Testing section populated

**Next Steps:**
1. Run tests: `npm test -- --grep "[feature]"`
2. Check coverage: `npm run coverage`
3. Mark tests as Passing/Failing in spec

**Coverage Target:** 80%
```

---

## Rules

| Rule | Description |
|------|-------------|
| AC-First | Every acceptance criterion must have at least one test |
| Traceable | Test names include AC/FR reference |
| Complete | Happy path + error cases + edge cases |
| Prioritized | P0 tests block release, P1 should have, P2 nice to have |
| Isolated | Tests must be independent |
| Deterministic | No flaky tests |
| Fixtures | Use spec examples as test data |

---

## Test Types by Spec Section

| Spec Section | Test Type |
|--------------|-----------|
| Acceptance Criteria | Unit + Integration |
| Functional Requirements | Unit |
| Non-Functional Requirements | Performance + Load |
| API Contract | Integration + API |
| UI/UX | E2E (Playwright) + Visual regression |
| Error Codes | Unit + Integration |
| State Machine | Unit (state transitions) |

---

## Test Matrix Format (v4)

Present test coverage as a matrix before generating:

```markdown
**Test Matrix: [feature-name]**

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AC     â”‚ Test Types                                                    â”‚
â”‚        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        â”‚ Unit       â”‚ Integration â”‚ API        â”‚ E2E (Playwright)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ AC-001 â”‚ [x] P1     â”‚ [ ]         â”‚ [ ]        â”‚ [ ]                   â”‚
â”‚ AC-002 â”‚ [ ]        â”‚ [x] P1      â”‚ [x] P1     â”‚ [ ]                   â”‚
â”‚ AC-003 â”‚ [ ]        â”‚ [ ]         â”‚ [ ]        â”‚ [x] P2                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Priority Legend:**
- P0: Critical path, blocks release
- P1: Core functionality
- P2: Important edge cases
- P3: Nice to have

---

## E2E Tests (Optional)

> **Note:** E2E tests are optional and add complexity. Prioritize Unit + Integration tests first.
> Only add E2E for critical user journeys that can't be tested otherwise.

### When to Use E2E

| Use E2E | Skip E2E |
|---------|----------|
| Critical checkout/payment flows | CRUD operations |
| Complex multi-step wizards | API-only features |
| Cross-browser compatibility required | Backend services |

---

### E2E File Structure

```
e2e/
â”œâ”€â”€ [feature].spec.ts        # Test specs (one per feature)
â”œâ”€â”€ pages/                   # Page Object Model (optional)
â”‚   â””â”€â”€ [page-name].page.ts
â”œâ”€â”€ fixtures/                # Test data and setup
â”‚   â””â”€â”€ [feature].fixtures.ts
â””â”€â”€ playwright.config.ts     # Config (generated by init)
```

---

### Basic E2E Template (Playwright)

```typescript
// e2e/[feature].spec.ts
import { test, expect } from '@playwright/test';

test.describe('[Feature] - [User Journey]', () => {
  test('AC-XXX: [description from spec]', async ({ page }) => {
    // 1. Navigate
    await page.goto('/[url]');

    // 2. Interact (use accessible locators)
    await page.getByRole('button', { name: '[button-text]' }).click();
    await page.getByLabel('[label-text]').fill('[value]');

    // 3. Assert outcome
    await expect(page).toHaveURL('/[expected-url]');
    await expect(page.getByText('[expected-text]')).toBeVisible();
  });
});
```

---

### Page Object Pattern (Optional)

Use for complex, reusable page interactions:

```typescript
// e2e/pages/[page-name].page.ts
import { Page, Locator } from '@playwright/test';

export class [PageName]Page {
  readonly page: Page;
  readonly [element]: Locator;

  constructor(page: Page) {
    this.page = page;
    this.[element] = page.getByRole('[role]', { name: '[name]' });
  }

  async [action]() {
    await this.[element].click();
  }
}
```

Usage:
```typescript
// e2e/[feature].spec.ts
import { [PageName]Page } from './pages/[page-name].page';

test('AC-XXX: [description]', async ({ page }) => {
  const [pageName] = new [PageName]Page(page);
  await [pageName].[action]();
});
```

---

### Locator Best Practices

| Priority | Locator | Example |
|----------|---------|---------|
| 1st | `getByRole()` | `page.getByRole('button', { name: 'Submit' })` |
| 2nd | `getByLabel()` | `page.getByLabel('Email')` |
| 3rd | `getByText()` | `page.getByText('Welcome')` |
| 4th | `getByTestId()` | `page.getByTestId('submit-btn')` |
| Last | CSS/XPath | Avoid unless necessary |

---

### Setup Reference

For Playwright setup and configuration:
- **Install:** `npm init playwright@latest`
- **Docs:** https://playwright.dev/docs/intro
- **Best practices:** https://playwright.dev/docs/best-practices
- **Locators:** https://playwright.dev/docs/locators

================
File: .claude/settings.json
================
{
  "includeCoAuthoredBy": false
}

================
File: case-studies/diagrams/command-flow.md
================
# Command Flow Diagram

**Purpose:** Help users know which command to use when.

---

## Decision Flowchart

```mermaid
flowchart TD
    Start([What do you need?]) --> Q1{Starting a project?}

    Q1 -->|Yes| Init["/asdf:init"]
    Q1 -->|No| Q2{Need a new feature?}

    Q2 -->|Yes| Spec["/asdf:spec [name]"]
    Q2 -->|No| Q3{Ready to implement?}

    Q3 -->|Yes| Code["/asdf:code [spec-path]"]
    Q3 -->|No| Q4{Code differs from spec?}

    Q4 -->|Yes| Sync["/asdf:sync"]
    Q4 -->|No| Q5{Need to update docs?}

    Q5 -->|Yes| Update["/asdf:update [component]"]
    Q5 -->|No| Q6{Need tests?}

    Q6 -->|Yes| Test["/asdf:test [feature]"]
    Q6 -->|No| Q7{Ready for review?}

    Q7 -->|Yes| PR["/asdf:pr [feature]"]
    Q7 -->|No| Q8{Check project health?}

    Q8 -->|Yes| Q8a{What kind?}
    Q8a -->|Status| Report["/asdf:report"]
    Q8a -->|Issues| Audit["/asdf:audit"]
    Q8a -->|Cleanup| Cleanup["/asdf:cleanup"]

    Q8 -->|No| Q9{End of session?}

    Q9 -->|Yes| Handoff["/asdf:handoff"]
    Q9 -->|No| Q10{New to project?}

    Q10 -->|Yes| Onboard["/asdf:onboard"]
    Q10 -->|No| Help["/asdf --help"]
```

---

## Quick Reference

### By Situation

| Situation | Command |
|-----------|---------|
| Starting new project | `/asdf:init` |
| Adding ASDF to existing code | `/asdf:init` (option B) |
| Planning new feature | `/asdf:spec [name]` |
| Implementing feature | `/asdf:code [spec-path]` |
| Generating tests | `/asdf:test [feature]` |
| Code changed, spec outdated | `/asdf:sync` |
| Updating documentation | `/asdf:update [component]` |
| Creating pull request | `/asdf:pr [feature]` |
| Getting code reviewed | `/asdf:review [path]` |
| Checking project status | `/asdf:report [feature\|all]` |
| Finding spec issues | `/asdf:audit` |
| Removing unused specs | `/asdf:cleanup` |
| Ending work session | `/asdf:handoff` |
| Starting work session | `/asdf:onboard` |
| Lock stuck | `/asdf:unlock [name]` |
| Need help | `/asdf` |

---

## By Development Phase

```mermaid
flowchart LR
    subgraph Plan["Planning"]
        A["/asdf:init"]
        B["/asdf:spec"]
        C["/asdf:update"]
    end

    subgraph Build["Building"]
        D["/asdf:code"]
        E["/asdf:test"]
    end

    subgraph Review["Reviewing"]
        F["/asdf:pr"]
        G["/asdf:review"]
        H["/asdf:sync"]
    end

    subgraph Maintain["Maintaining"]
        I["/asdf:report"]
        J["/asdf:audit"]
        K["/asdf:cleanup"]
    end

    subgraph Session["Session"]
        L["/asdf:onboard"]
        M["/asdf:handoff"]
        N["/asdf:unlock"]
    end

    Plan --> Build --> Review --> Maintain
    Session -.-> Plan
    Session -.-> Build
```

---

## Command Categories

### Spec Creation
| Command | Purpose |
|---------|---------|
| `/asdf:init` | Initialize project structure |
| `/asdf:spec [name]` | Create feature specification |
| `/asdf:update [path]` | Update existing documentation |

### Implementation
| Command | Purpose |
|---------|---------|
| `/asdf:code [spec]` | Implement from specification |
| `/asdf:test [feature]` | Generate test suites |
| `/asdf:sync` | Sync spec with code changes |

### Review
| Command | Purpose |
|---------|---------|
| `/asdf:pr [feature]` | Create PR package |
| `/asdf:review [path]` | AI code review |

### Project Management
| Command | Purpose |
|---------|---------|
| `/asdf:report [target]` | Progress reports |
| `/asdf:audit` | Spec health check |
| `/asdf:cleanup` | Remove unused specs |
| `/asdf:roadmap` | Phase management |
| `/asdf:status` | Project heartbeat |

### Session
| Command | Purpose |
|---------|---------|
| `/asdf:onboard` | Quick project tour |
| `/asdf:handoff` | Session notes |
| `/asdf:unlock [name]` | Release stuck locks |

---

## Common Workflows

### New Feature (Full Cycle)
```
/asdf:spec â†’ /asdf:code â†’ /asdf:test â†’ /asdf:pr â†’ /asdf:review â†’ /asdf:sync
```

### Quick Bug Fix
```
/asdf:code â†’ /asdf:test â†’ /asdf:sync
```

### Weekly Maintenance
```
/asdf:report all â†’ /asdf:audit â†’ /asdf:cleanup
```

### Daily Start/End
```
Start: /asdf:onboard
End: /asdf:handoff
```

================
File: case-studies/diagrams/context-loading.md
================
# Context Loading Diagram

**Purpose:** Visualize the hierarchy of context loading in ASDF.

---

## Loading Hierarchy

```mermaid
flowchart TD
    subgraph Tier1["Tier 1: System Core (Always First)"]
        A1["01-system-core/"]
        A2["01-architecture/"]
        A3["02-standards/"]
        A4["03-design/"]
        A5["project-status.md"]
    end

    subgraph Tier2["Tier 2: Domains (Load Relevant)"]
        B1["02-domains/"]
        B2["auth/domain.md"]
        B3["payments/domain.md"]
        B4["orders/domain.md"]
    end

    subgraph Tier3["Tier 3: Features (Load Specific)"]
        C1["03-features/"]
        C2["251224-checkout/spec.md"]
        C3["251224-user-profile/spec.md"]
    end

    subgraph Tier4["Tier 4: Operations (Check State)"]
        D1["04-operations/"]
        D2["session-handoff.md"]
        D3["implementation-active.md"]
        D4["tech-debt.md"]
    end

    Tier1 --> Tier2 --> Tier3 --> Tier4
```

---

## Loading Order

```mermaid
sequenceDiagram
    participant AI as Claude Instance
    participant T1 as 01-system-core
    participant T2 as 02-domains
    participant T3 as 03-features
    participant T4 as 04-operations

    AI->>T1: 1. Load global rules
    T1-->>AI: Architecture, standards, design

    AI->>T2: 2. Load relevant domain
    T2-->>AI: Business rules, entities

    AI->>T3: 3. Load specific feature
    T3-->>AI: Requirements, API contracts

    AI->>T4: 4. Check session state
    T4-->>AI: Last handoff, active work

    Note over AI: Context fully loaded âœ“
```

---

## What Gets Loaded Per Command

### `/asdf:init`
```mermaid
flowchart LR
    A[Check existing] --> B[01-system-core templates]
    B --> C[02-domains structure]
    C --> D[03-features structure]
    D --> E[04-operations structure]
```
**Loads:** Templates and structure references

### `/asdf:spec [feature]`
```mermaid
flowchart LR
    A[01-system-core] --> B[02-domains relevant]
    B --> C[03-features existing]
    C --> D[04-operations/session-handoff.md]
```
**Loads:** Full hierarchy to understand context

### `/asdf:code [spec]`
```mermaid
flowchart LR
    A[01-system-core/02-standards] --> B[02-domains dependencies]
    B --> C[03-features/spec.md]
    C --> D[04-operations/locks/]
    D --> E[04-operations/implementation-active.md]
```
**Loads:** Standards + dependencies + spec + lock state

### `/asdf:sync`
```mermaid
flowchart LR
    A[03-features/spec.md] --> B[Codebase scan]
    B --> C[Compare diff]
```
**Loads:** Spec only, then scans code

### `/asdf:test [feature]`
```mermaid
flowchart LR
    A[03-features/spec.md] --> B[01-system-core/02-standards/testing-strategy.md]
    B --> C[Existing test patterns]
```
**Loads:** Spec + testing standards

### `/asdf:report`
```mermaid
flowchart LR
    A[All 03-features/] --> B[04-operations/implementation-active.md]
    B --> C[04-operations/tech-debt.md]
    C --> D[project-status.md]
```
**Loads:** All features + operations for aggregation

### `/asdf:onboard`
```mermaid
flowchart LR
    A[project-status.md] --> B[04-operations/session-handoff.md]
    B --> C[04-operations/locks/]
    C --> D[03-features/ status]
```
**Loads:** Status + handoff + active locks

---

## Context by Tier

### Tier 1: System Core
**What it contains:**
- Architecture decisions (ADRs)
- Tech stack definitions
- Coding standards
- Design system
- Project status

**When to load:** Always first, for any command

### Tier 2: Domains
**What it contains:**
- Entity definitions
- Business rules
- Domain-specific APIs
- Cross-feature logic

**When to load:** When working on features that use the domain

### Tier 3: Features
**What it contains:**
- Acceptance criteria
- User flows
- API contracts
- UI/UX requirements
- Dependencies

**When to load:** When implementing specific feature

### Tier 4: Operations
**What it contains:**
- Session handoff notes
- Active implementations
- Tech debt register
- Lock files
- Changelogs

**When to load:** For state awareness and continuity

---

## Dependency Resolution

```mermaid
flowchart TD
    A[Feature Spec] --> B{Has dependencies?}
    B -->|Yes| C[Load each dependency]
    B -->|No| D[Ready to implement]

    C --> E{Domain dependency?}
    E -->|Yes| F[Load 02-domains/X/]
    E -->|No| G{Feature dependency?}

    G -->|Yes| H[Load 03-features/Y/]
    G -->|No| I{External?}

    I -->|Yes| J[Check availability]
    I -->|No| D

    F --> D
    H --> D
    J --> D
```

---

## Example: Loading for Checkout Feature

```mermaid
flowchart TD
    subgraph Step1["Step 1: System Core"]
        A1["master-map.md"]
        A2["code-standards.md"]
        A3["design-system.md"]
    end

    subgraph Step2["Step 2: Domains"]
        B1["cart/domain.md"]
        B2["payments/domain.md"]
        B3["orders/domain.md"]
    end

    subgraph Step3["Step 3: Feature"]
        C1["251224-checkout/spec.md"]
    end

    subgraph Step4["Step 4: State"]
        D1["session-handoff.md"]
        D2["locks/251224-checkout.lock"]
    end

    Step1 --> Step2 --> Step3 --> Step4

    style C1 fill:#90EE90
```

---

## Loading Performance Tips

| Tip | Benefit |
|-----|---------|
| Load relevant domains only | Faster context |
| Check session-handoff first | Know prior state |
| Skip unchanged system-core | Efficiency |
| Cache frequently used specs | Speed |

---

## Context Freshness

| Source | Freshness Check |
|--------|-----------------|
| System Core | Rarely changes |
| Domains | Check on dependency load |
| Features | Always load latest |
| Operations | Always load latest |

================
File: case-studies/diagrams/mode-transitions.md
================
# Mode Transitions Diagram

**Purpose:** Show how ASDF operating modes connect and transition.

---

## Mode State Diagram

```mermaid
stateDiagram-v2
    [*] --> HELP: /asdf

    HELP --> DESIGN: /asdf:init, /asdf:spec
    HELP --> EXECUTE: /asdf:code
    HELP --> SYNC: /asdf:sync
    HELP --> TEST: /asdf:test
    HELP --> REVIEW: /asdf:pr, /asdf:review
    HELP --> REPORT: /asdf:report, /asdf:audit
    HELP --> MAINTENANCE: /asdf:cleanup, /asdf:onboard
    HELP --> SESSION: /asdf:handoff, /asdf:unlock

    DESIGN --> EXECUTE: Spec approved
    EXECUTE --> TEST: Code complete
    EXECUTE --> SYNC: Deviation detected
    TEST --> REVIEW: Tests passing
    REVIEW --> SYNC: Review complete
    SYNC --> DESIGN: Spec updated

    REPORT --> MAINTENANCE: Issues found
    MAINTENANCE --> DESIGN: Cleanup done

    SESSION --> DESIGN: Start work
    SESSION --> [*]: End session
```

---

## Mode Details

### DESIGN MODE
**Commands:** `/asdf:init`, `/asdf:spec`, `/asdf:update`

**Purpose:** Create and refine specifications

**Flow:**
```mermaid
flowchart LR
    A[Collect References] --> B[Draft Spec]
    B --> C{Review}
    C -->|Feedback| B
    C -->|Confirm| D[Finalize]
```

**Transitions:**
- â†’ EXECUTE: After spec approved
- â†’ DESIGN: On feedback loop

---

### EXECUTE MODE
**Commands:** `/asdf:code`

**Purpose:** Implement code from specifications

**Flow:**
```mermaid
flowchart LR
    A[Load Spec] --> B[Check Dependencies]
    B --> C[Impact Analysis]
    C --> D[Acquire Lock]
    D --> E[Implement]
    E --> F{Deviation?}
    F -->|No| G[Complete]
    F -->|Yes| H[Handle A/B/C]
    H --> E
    G --> I[Release Lock]
```

**Transitions:**
- â†’ TEST: After implementation complete
- â†’ SYNC: If deviation option B chosen

---

### SYNC MODE
**Commands:** `/asdf:sync`

**Purpose:** Reconcile code reality with spec documentation

**Flow:**
```mermaid
flowchart LR
    A[Compare Code vs Spec] --> B[Identify Deviations]
    B --> C[Preview Changes]
    C --> D{Confirm?}
    D -->|Yes| E[Update Spec]
    D -->|No| F[Abort]
    E --> G[Version Bump]
```

**Transitions:**
- â†’ DESIGN: Spec now reflects code
- â†’ EXECUTE: Continue with aligned spec

---

### TEST MODE
**Commands:** `/asdf:test`

**Purpose:** Generate test suites from specifications

**Flow:**
```mermaid
flowchart LR
    A[Load Spec] --> B[Extract AC]
    B --> C[Build Test Matrix]
    C --> D{Options}
    D -->|skip-e2e| E[Generate Unit+Integration]
    D -->|yes| F[Generate All]
    E --> G[Run Tests]
    F --> G
```

**Transitions:**
- â†’ REVIEW: After tests passing
- â†’ EXECUTE: If tests fail, fix code

---

### REVIEW MODE
**Commands:** `/asdf:pr`, `/asdf:review`

**Purpose:** Create PR packages and perform code review

**Flow:**
```mermaid
flowchart LR
    A[Bundle Changes] --> B[Generate PR Summary]
    B --> C[AI Review]
    C --> D{Issues?}
    D -->|Yes| E[Apply Fixes]
    D -->|No| F[Approved]
    E --> C
```

**Transitions:**
- â†’ SYNC: After review complete
- â†’ EXECUTE: If fixes needed

---

### REPORT MODE
**Commands:** `/asdf:report`, `/asdf:audit`

**Purpose:** Generate progress reports and detect issues

**Flow:**
```mermaid
flowchart LR
    A[Scan Project] --> B[Calculate Metrics]
    B --> C[Generate Report]
    C --> D{Issues Found?}
    D -->|Yes| E[Recommendations]
    D -->|No| F[Healthy Status]
```

**Transitions:**
- â†’ MAINTENANCE: If issues found
- â†’ EXECUTE: Continue normal work

---

### MAINTENANCE MODE
**Commands:** `/asdf:cleanup`, `/asdf:onboard`

**Purpose:** Project health maintenance and onboarding

**Flow:**
```mermaid
flowchart LR
    subgraph Cleanup
        A1[Identify Orphaned] --> B1[Archive/Delete]
    end
    subgraph Onboard
        A2[Load Context] --> B2[Show Status]
        B2 --> C2[Ready to Work]
    end
```

**Transitions:**
- â†’ DESIGN: After onboarding
- â†’ EXECUTE: Ready to work

---

### SESSION MODE
**Commands:** `/asdf:handoff`, `/asdf:unlock`

**Purpose:** Session management and lock handling

**Flow:**
```mermaid
flowchart LR
    subgraph Handoff
        A1[Summarize Work] --> B1[Save Context]
    end
    subgraph Unlock
        A2[Find Lock] --> B2[Verify Stale]
        B2 --> C2[Release + Log]
    end
```

**Transitions:**
- â†’ End: Session complete
- â†’ Any Mode: After unlock

---

## Typical Mode Sequences

### Feature Development
```
DESIGN â†’ EXECUTE â†’ TEST â†’ REVIEW â†’ SYNC â†’ DONE
```

### Maintenance Sprint
```
REPORT â†’ MAINTENANCE â†’ SYNC â†’ REPORT
```

### Bug Fix
```
EXECUTE â†’ TEST â†’ SYNC
```

### Team Handoff
```
SESSION(handoff) â†’ ... â†’ SESSION(onboard) â†’ EXECUTE
```

---

## Mode Compatibility

| From Mode | Can Transition To |
|-----------|-------------------|
| DESIGN | EXECUTE, DESIGN (loop) |
| EXECUTE | TEST, SYNC, EXECUTE (loop) |
| SYNC | DESIGN, EXECUTE |
| TEST | REVIEW, EXECUTE |
| REVIEW | SYNC, EXECUTE |
| REPORT | MAINTENANCE, Any |
| MAINTENANCE | DESIGN, EXECUTE |
| SESSION | Any, End |

================
File: case-studies/diagrams/multi-instance.md
================
# Multi-Instance Diagram

**Purpose:** Visualize the lock mechanism for parallel work.

---

## Lock Sequence Diagram

```mermaid
sequenceDiagram
    participant I1 as Instance 1 (Alice)
    participant LS as Lock System
    participant I2 as Instance 2 (Bob)

    Note over I1,I2: Normal Lock Flow

    I1->>LS: /asdf:code checkout
    LS-->>I1: âœ“ Lock acquired

    I2->>LS: /asdf:code checkout
    LS-->>I2: âŒ LOCKED by Instance 1

    I2->>LS: /asdf:code user-profile
    LS-->>I2: âœ“ Lock acquired

    Note over I1,I2: Working in parallel...

    I1->>LS: Implementation complete
    LS-->>I1: âœ“ Lock released

    I2->>LS: Implementation complete
    LS-->>I2: âœ“ Lock released

    Note over I1,I2: Stale Lock Scenario

    I1->>LS: /asdf:code inventory
    LS-->>I1: âœ“ Lock acquired
    Note over I1: Instance crashes/disconnects

    I2->>LS: /asdf:code inventory (next day)
    LS-->>I2: âš ï¸ STALE LOCK (18h old)

    I2->>LS: Force override
    LS-->>I2: âœ“ Lock transferred (logged)
```

---

## Lock File Structure

```mermaid
flowchart TD
    subgraph Locks["04-operations/locks/"]
        L1["251224-checkout.lock"]
        L2["251224-user-profile.lock"]
        L3["251224-inventory.lock"]
    end

    subgraph SpecLocks["04-operations/spec-locks/"]
        S1["auth.lock"]
        S2["payments.lock"]
    end

    subgraph ConflictLog["04-operations/conflict-log.md"]
        C1["Override history"]
    end

    L1 --> ConflictLog
    L2 --> ConflictLog
    S1 --> ConflictLog
```

---

## Lock Types

### Code Lock
**Location:** `04-operations/locks/[feature].lock`
**Created by:** `/asdf:code`
**Released by:** Completion or `/asdf:handoff`

```yaml
# Example: 04-operations/locks/251224-checkout.lock
instance_id: claude-alice-001
locked_at: 2024-12-24T09:15:00Z
task: "Implementing FR-001 to FR-005"
estimated_duration: 2h
contact: "Session #42"
```

### Spec Lock
**Location:** `04-operations/spec-locks/[name].lock`
**Created by:** `/asdf:spec`, `/asdf:update`
**Released by:** Confirmation or cancel

```yaml
# Example: 04-operations/spec-locks/auth.lock
instance_id: claude-bob-002
locked_at: 2024-12-24T14:30:00Z
task: "Updating User entity"
operation: UPDATE
```

---

## Lock States

```mermaid
stateDiagram-v2
    [*] --> Available: No lock exists

    Available --> Active: Lock acquired
    Active --> Available: Lock released

    Active --> Stale: >4 hours elapsed
    Stale --> Available: Force override

    Active --> Blocked: Another instance tries
    Blocked --> Waiting: Choose to wait
    Blocked --> Available: Choose other feature
    Waiting --> Active: Original lock released
```

---

## Conflict Resolution Flow

```mermaid
flowchart TD
    A[Try to acquire lock] --> B{Lock exists?}
    B -->|No| C[Create lock file]
    B -->|Yes| D{Lock age?}

    D -->|<1 hour| E[Active - Wait or pick other]
    D -->|1-4 hours| F[Aging - Warn before override]
    D -->|>4 hours| G[Stale - Safe to override]

    E --> H{User choice}
    H -->|wait| I[Check again in 5 min]
    H -->|other| J[Pick different feature]
    H -->|force| K[Override with confirmation]

    F --> H
    G --> L[Override without warning]

    K --> M[Log to conflict-log.md]
    L --> M
    M --> C
```

---

## Parallel Work Patterns

### Pattern 1: Different Features
```mermaid
gantt
    title Parallel Work - Different Features
    dateFormat HH:mm
    axisFormat %H:%M

    section Instance 1
    checkout (locked)     :active, 09:00, 2h
    handoff               :milestone, 11:00, 0h

    section Instance 2
    user-profile (locked) :active, 09:30, 1.5h
    handoff               :milestone, 11:00, 0h
```

### Pattern 2: Sequential on Same Feature
```mermaid
gantt
    title Sequential Work - Same Feature
    dateFormat HH:mm
    axisFormat %H:%M

    section Instance 1
    checkout (locked)     :active, 09:00, 2h
    handoff               :milestone, 11:00, 0h

    section Instance 2
    blocked               :crit, 09:30, 0.5h
    checkout (locked)     :active, 11:00, 2h
    handoff               :milestone, 13:00, 0h
```

### Pattern 3: Stale Lock Override
```mermaid
gantt
    title Stale Lock Override
    dateFormat HH:mm
    axisFormat %H:%M

    section Instance 1 (crashed)
    inventory (locked)    :active, 09:00, 1h
    CRASH                 :crit, 10:00, 18h

    section Instance 2 (next day)
    detect stale          :milestone, 04:00, 0h
    override + continue   :active, 04:00, 2h
```

---

## Best Practices

| Practice | Reason |
|----------|--------|
| Work on different features | Avoid blocking |
| Small features | Shorter lock times |
| Frequent handoffs | Release locks regularly |
| Check locks first | Don't start blocked work |
| Use `/asdf:onboard` | See active locks |

---

## Lock Commands

| Command | Action |
|---------|--------|
| `/asdf:code` | Acquires code lock |
| `/asdf:spec` | Acquires spec lock |
| `/asdf:update` | Acquires spec lock |
| `/asdf:handoff` | Releases held locks |
| `/asdf:unlock [name]` | Admin force release |

---

## Conflict Log Format

```markdown
# Conflict Log

| Date | Lock | Original Instance | Released By | Reason |
|------|------|-------------------|-------------|--------|
| 251225 | inventory | claude-alice-001 | claude-bob-002 | Stale (18h) |
| 251224 | checkout | claude-x-003 | claude-y-004 | Force override |
```

================
File: case-studies/diagrams/refinement-loop.md
================
# Refinement Loop Diagram

**Purpose:** Visualize the draft â†’ feedback â†’ confirm cycle in ASDF.

---

## Core Loop

```mermaid
flowchart TD
    A[AI Drafts v1.0.0] --> B{User Reviews}

    B -->|"Feedback"| C[Parse Changes]
    C --> D[Update Spec]
    D --> E[Increment Version]
    E --> F[Re-present Draft]
    F --> B

    B -->|"Reference"| G[Collect Documents]
    G --> H[Extract Info]
    H --> D

    B -->|"Confirm"| I[Finalize Spec]
    I --> J[Save to Filesystem]
    J --> K[Release Lock]
    K --> L[Done âœ“]
```

---

## Version Increment Rules

```mermaid
flowchart LR
    subgraph Patch["Patch +0.0.1"]
        A1["Typo fixes"]
        A2["Wording changes"]
        A3["Minor clarifications"]
    end

    subgraph Minor["Minor +0.1.0"]
        B1["New sections added"]
        B2["Structure changes"]
        B3["New requirements"]
    end

    subgraph Major["Major +1.0.0"]
        C1["Fundamental approach change"]
        C2["Breaking changes"]
        C3["Complete rewrite"]
    end
```

---

## Refinement Sequence

```mermaid
sequenceDiagram
    participant U as User
    participant AI as Claude
    participant S as Spec File

    AI->>U: Draft v1.0.0 ready for review
    Note over U: Reviews draft

    U->>AI: "Add rate limiting to AC-003"
    AI->>AI: Parse feedback
    AI->>AI: Update spec
    AI->>U: Updated to v1.1.0

    U->>AI: "reference designs/checkout.fig"
    AI->>AI: Extract from file
    AI->>AI: Update spec
    AI->>U: Updated to v1.2.0

    U->>AI: "confirm"
    AI->>S: Save spec.md
    AI->>S: Save changelog.md
    AI->>U: Finalized v1.2.0 âœ“
```

---

## User Options

```mermaid
flowchart TD
    A[Draft Presented] --> B{User Choice}

    B -->|Type changes| C["Feedback"]
    B -->|Type 'reference'| D["Reference"]
    B -->|Type 'confirm'| E["Confirm"]

    C --> F["AI updates spec based on feedback"]
    F --> G["Version: X.Y.+1 or X.+1.0"]
    G --> A

    D --> H["AI asks for file paths"]
    H --> I["AI extracts relevant info"]
    I --> J["Version: X.+1.0"]
    J --> A

    E --> K["Spec finalized and saved"]
    K --> L["Ready for /asdf:code"]
```

---

## Example Refinement Session

### Initial Draft (v1.0.0)
```
You: /asdf:spec checkout
AI: Draft checkout spec v1.0.0 ready for review.

## Acceptance Criteria
- AC-001: User can checkout with cart items
- AC-002: User can enter shipping address
- AC-003: User can pay with credit card

Please choose:
- Feedback â€” Type your changes
- Reference â€” Type `reference` to add source documents
- Confirm â€” Type `confirm` to finalize
```

### Feedback 1 â†’ v1.1.0
```
You: Add guest checkout option and Apple Pay support
AI: Updated to v1.1.0

Changes made:
- AC-001: Updated to include guest checkout
- AC-004: Added Apple Pay payment option
- Updated user flow diagram

Please choose: ...
```

### Reference â†’ v1.2.0
```
You: reference
AI: Provide file path(s) to reference documents.

You: docs/payment-requirements.pdf
AI: Extracted from payment-requirements.pdf:
- Stripe integration required
- 3D Secure for EU customers
- Refund policy details

Updated to v1.2.0

Changes made:
- Added Stripe as payment processor
- Added 3D Secure requirement (NFR-001)
- Added refund section

Please choose: ...
```

### Feedback 2 â†’ v1.3.0
```
You: The refund window should be 30 days, not 14
AI: Updated to v1.3.0

Changes made:
- Refund policy: Updated window from 14 to 30 days

Please choose: ...
```

### Confirm
```
You: confirm
AI: Spec Finalized

Feature: checkout
Version: 1.3.0
Status: Approved
Location: astraler-docs/03-features/251224-checkout/spec.md
```

---

## Changelog Generation

Each refinement creates a changelog entry:

```markdown
# Changelog: checkout

## v1.3.0 (251224)
- Refund policy: 30 days (was 14)

## v1.2.0 (251224)
- Added Stripe integration (from payment-requirements.pdf)
- Added 3D Secure requirement
- Added refund section

## v1.1.0 (251224)
- Added guest checkout option
- Added Apple Pay payment

## v1.0.0 (251224)
- Initial draft
```

---

## Refinement Best Practices

| Practice | Benefit |
|----------|---------|
| Be specific in feedback | Clearer updates |
| Reference early | Incorporate docs upfront |
| Review before confirm | Catch issues early |
| Small iterations | Track changes easily |
| Check open questions | Resolve before confirm |

---

## Common Refinement Patterns

### Adding Requirements
```
"Add AC-005 for email notification after purchase"
```

### Modifying Existing
```
"Change AC-002 to require real-time address validation"
```

### Removing Scope
```
"Remove AC-004, we'll do that in Phase 2"
```

### Adding Constraints
```
"Add NFR: Page load must be under 2 seconds"
```

### Clarifying Details
```
"AC-001 should specify that guest email is required"
```

---

## Loop Termination

The loop ends when:

1. User types `confirm`
2. AI saves spec to filesystem
3. Lock is released (if held)
4. Next command available

```mermaid
flowchart LR
    A[confirm] --> B[Save spec.md]
    B --> C[Save changelog.md]
    C --> D[Release lock]
    D --> E[Report location]
    E --> F[Ready for /asdf:code]
```

================
File: case-studies/01-new-project.md
================
# Case Study 1: New Project (Greenfield)

**Scenario:** Starting a new e-commerce platform called "ShopFast" from scratch.

**Goal:** Go from idea to first working feature using ASDF methodology.

---

## Timeline Overview

```mermaid
flowchart LR
    subgraph Day1["Day 1: Foundation"]
        A["/asdf:init"] --> B["System Core"]
        B --> C["First Domain"]
    end

    subgraph Day2["Day 2: First Feature"]
        D["/asdf:spec"] --> E["Refinement"]
        E --> F["Approved Spec"]
    end

    subgraph Day3["Day 3: Implementation"]
        G["/asdf:code"] --> H["Working Code"]
        H --> I["/asdf:test"]
    end

    subgraph Day4["Day 4: Handoff"]
        J["/asdf:handoff"] --> K["Ready for Next Dev"]
    end

    Day1 --> Day2 --> Day3 --> Day4
```

---

## Phase 1: Project Initialization

### Step 1: Run `/asdf:init`

```
You: /asdf:init ShopFast
```

**AI Response:**
```
Initializing ASDF for: ShopFast

Do you have existing documents to reference?

Categories:
- Business â€” PRD, BRD, requirements
- Technical â€” API specs, architecture docs
- Data â€” ERD, schemas
- Design â€” Wireframes, mockups
- External â€” Third-party API docs

Provide file path(s) or type "no" to continue.
```

### Step 2: Provide References

```
You: docs/shopfast-prd.pdf, designs/wireframes.fig
```

**AI Response:**
```
Extracted from shopfast-prd.pdf:
- Project: E-commerce platform for small businesses
- Target users: SMB owners, consumers
- Core features: Product catalog, cart, checkout, payments
- Tech preference: Node.js, React, PostgreSQL

Extracted from wireframes.fig:
- 12 screens identified
- Design system: Tailwind-based
- Mobile-first approach

Any additional references? (type "no" to continue)
```

```
You: no
```

### Step 3: AI Generates System Core

**AI Response:**
```
Draft ShopFast system-core v1.0.0 ready for review.

Generated:
â”œâ”€â”€ 01-system-core/
â”‚   â”œâ”€â”€ 01-architecture/
â”‚   â”‚   â”œâ”€â”€ master-map.md (with mermaid diagram)
â”‚   â”‚   â”œâ”€â”€ tech-stack.md
â”‚   â”‚   â”œâ”€â”€ data-architecture.md (with ERD)
â”‚   â”‚   â””â”€â”€ infrastructure.md
â”‚   â”œâ”€â”€ 02-standards/
â”‚   â”‚   â””â”€â”€ code-standards.md
â”‚   â”œâ”€â”€ 03-design/
â”‚   â”‚   â””â”€â”€ design-system.md
â”‚   â””â”€â”€ project-status.md

Please choose:
- Feedback â€” Type your changes
- Reference â€” Type `reference` to add source documents
- Confirm â€” Type `confirm` to finalize
```

### Step 4: Review and Confirm

```
You: The tech stack looks good, but we need Redis for caching. Also add Stripe for payments.
```

**AI Response:**
```
Updated to v1.1.0

Changes made:
- tech-stack.md: Added Redis for session/cache layer
- tech-stack.md: Added Stripe SDK for payments
- master-map.md: Updated architecture diagram with Redis + Stripe

Please choose:
- Feedback â€” Type your changes
- Reference â€” Type `reference` to add source documents
- Confirm â€” Type `confirm` to finalize
```

```
You: confirm
```

**AI Response:**
```
System Core Finalized

Project: ShopFast
Version: 1.1.0
Status: Approved
Location: astraler-docs/01-system-core/

Files created:
- master-map.md (architecture diagram)
- tech-stack.md (Node.js, React, PostgreSQL, Redis, Stripe)
- data-architecture.md (initial ERD)
- infrastructure.md (deployment topology)
- code-standards.md
- design-system.md
- project-status.md

Proceeding to CLAUDE.md setup...
```

### Step 5: CLAUDE.md Generation

**AI Response:**
```
Generating CLAUDE.md...

No existing CLAUDE.md found. Creating new file.

âœ“ CLAUDE.md created

Contents:
- Project name: ShopFast
- Agent: asdf-coder.md
- Commands: 17 ASDF commands
- Tech stack: Node.js, React, PostgreSQL, Redis, Stripe
- Domains: (pending creation)
- Critical rules: 4 items

ASDF Initialization Complete

Next steps:
1. Create domain specs: /asdf:spec [domain]
2. Or create first feature: /asdf:spec [feature-name]
```

> **Note:** CLAUDE.md is the entry point for Claude Code. It tells Claude this project uses ASDF methodology and provides the command reference.

---

## Phase 2: First Domain Spec

### Step 1: Create Product Domain

```
You: /asdf:spec products
```

**AI Response:**
```
Do you have existing documents to reference for the products domain?

Categories:
- Business â€” Product requirements, catalog structure
- Technical â€” Existing product APIs
- Data â€” Product schemas
- Design â€” Product page wireframes

Provide file path(s) or type "no" to continue.
```

```
You: The PRD section 3.2 covers products. Also designs/product-page.fig
```

**AI Response:**
```
Extracted from PRD section 3.2:
- Products have: name, description, price, images, variants
- Categories: hierarchical, up to 3 levels
- Inventory tracking required
- Search with filters

Extracted from product-page.fig:
- Product detail layout
- Image gallery component
- Variant selector UI

Draft Products domain spec v1.0.0 ready for review.

Sections:
- Overview: Product catalog management
- Entities: Product, Category, Variant, Inventory
- Business Rules: 5 rules defined
- API Contract: 8 endpoints
- ERD: Entity relationship diagram

Please choose:
- Feedback â€” Type your changes
- Reference â€” Type `reference` to add source documents
- Confirm â€” Type `confirm` to finalize
```

```
You: confirm
```

**AI Response:**
```
Domain Spec Finalized

Domain: products
Version: 1.0.0
Status: Approved
Location: astraler-docs/02-domains/products/domain.md

Next: Create feature specs that use this domain
Example: /asdf:spec product-listing
```

---

## Phase 3: First Feature Spec

### Step 1: Create Product Listing Feature

```
You: /asdf:spec product-listing
```

**AI Response:**
```
Do you have existing documents to reference?
...
```

```
You: no, use the products domain we just created
```

**AI Response:**
```
Loading context:
- 01-system-core/ (architecture, standards)
- 02-domains/products/ (entities, business rules)

Draft Product Listing feature spec v1.0.0 ready for review.

## Overview
Display paginated, filterable product catalog.

## User Flow
[Mermaid flowchart showing: Browse â†’ Filter â†’ Sort â†’ View Details]

## Acceptance Criteria
- AC-001: User can view paginated product list (20 per page)
- AC-002: User can filter by category
- AC-003: User can sort by price, name, date
- AC-004: User can search by keyword

## API Contract
- GET /api/products (with query params)
- Response schema defined

## Dependencies
- Domain: products (required)

Please choose:
- Feedback â€” Type your changes
- Reference â€” Type `reference` to add source documents
- Confirm â€” Type `confirm` to finalize
```

```
You: Add AC-005 for mobile responsive grid. Also need infinite scroll option.
```

**AI Response:**
```
Updated to v1.1.0

Changes made:
- AC-005: Product grid is responsive (4 cols desktop, 2 cols mobile)
- AC-006: User can enable infinite scroll (optional, default pagination)
- Updated UI/UX section with responsive breakpoints
- Updated NFR: Page load <2s with lazy image loading

Please choose:
- Feedback â€” Type your changes
- Reference â€” Type `reference` to add source documents
- Confirm â€” Type `confirm` to finalize
```

```
You: confirm
```

**AI Response:**
```
Feature Spec Finalized

Feature: product-listing
Version: 1.1.0
Status: Approved
Location: astraler-docs/03-features/251224-product-listing/spec.md

Next: Implement with /asdf:code astraler-docs/03-features/251224-product-listing/
```

---

## Phase 4: Implementation

### Step 1: Run `/asdf:code`

```
You: /asdf:code astraler-docs/03-features/251224-product-listing/
```

**AI Response:**
```
EXECUTE MODE: Product Listing

Loading spec: 251224-product-listing v1.1.0
Status: Approved âœ“

Dependency Check:
âœ“ Domain: products â€” Available

Impact Analysis:
No existing features affected (first feature)

Acquiring lock... âœ“
Lock: 251224-product-listing.lock

Implementation Plan:
1. Create Product model (from domain spec)
2. Create ProductController with GET /api/products
3. Create ProductService with filtering/sorting
4. Create React ProductList component
5. Create React ProductCard component
6. Add pagination/infinite scroll logic

Proceeding with implementation...
```

### Step 2: Handle Deviation

During implementation, AI discovers an issue:

```
Deviation Detected

Spec says: Sort by "date" (AC-003)
Implementation needs: Sort by "createdAt" (database field name)
Reason: PostgreSQL convention uses createdAt timestamp

Options:
A) Update spec now â€” Minor clarification
B) Continue + sync later â€” Tracked deviation
C) Wait for decision â€” Blocking issue
```

```
You: A
```

**AI Response:**
```
Spec updated: AC-003 now reads "sort by createdAt"
Continuing implementation...
```

### Step 3: Implementation Complete

```
Implementation Complete

Feature: product-listing
Files created:
- backend/src/models/Product.ts
- backend/src/controllers/ProductController.ts
- backend/src/services/ProductService.ts
- frontend/src/components/ProductList.tsx
- frontend/src/components/ProductCard.tsx
- frontend/src/hooks/useProducts.ts

Acceptance Criteria Verification:
âœ“ AC-001: Pagination implemented (20 per page)
âœ“ AC-002: Category filter implemented
âœ“ AC-003: Sort by price, name, createdAt implemented
âœ“ AC-004: Keyword search implemented
âœ“ AC-005: Responsive grid (4/2 cols)
âœ“ AC-006: Infinite scroll option added

Lock released: 251224-product-listing.lock

Next: Run tests with /asdf:test product-listing
```

---

## Phase 5: Testing

```
You: /asdf:test product-listing
```

**AI Response:**
```
TEST MODE: Product Listing

Loading spec: 251224-product-listing v1.1.0

Test Matrix:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AC     â”‚ Unit       â”‚ Integration â”‚ E2E        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ AC-001 â”‚ [x] P1     â”‚ [x] P1      â”‚ [ ]        â”‚
â”‚ AC-002 â”‚ [x] P1     â”‚ [x] P1      â”‚ [ ]        â”‚
â”‚ AC-003 â”‚ [x] P1     â”‚ [x] P1      â”‚ [ ]        â”‚
â”‚ AC-004 â”‚ [x] P1     â”‚ [x] P1      â”‚ [ ]        â”‚
â”‚ AC-005 â”‚ [ ]        â”‚ [ ]         â”‚ [x] P2     â”‚
â”‚ AC-006 â”‚ [x] P1     â”‚ [ ]         â”‚ [ ]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Options:
- [skip-e2e] Generate Unit + Integration only (recommended)
- [yes] Generate all tests including E2E
- [feedback] Adjust test plan
```

```
You: skip-e2e
```

**AI Response:**
```
Test Generation Complete

Feature: product-listing
Tests Generated: 18 total

Files Created:
- __tests__/product-listing/ProductService.test.ts (8 tests)
- __tests__/product-listing/ProductController.integration.test.ts (6 tests)
- __tests__/product-listing/fixtures.ts

Next Steps:
1. Run tests: npm test -- --grep "product-listing"
2. Check coverage: npm run coverage
```

---

## Phase 6: Session Handoff

End of day, hand off to next developer:

```
You: /asdf:handoff
```

**AI Response:**
```
Session Handoff Created

## Session Summary

**Date:** 251224
**Duration:** ~4 hours
**Instance:** claude-abc123

### Completed
- [x] Project initialization (ShopFast)
- [x] System-core with architecture diagrams
- [x] Products domain spec
- [x] Product-listing feature spec (v1.1.0)
- [x] Product-listing implementation
- [x] Test suite generated (18 tests)

### In Progress
None

### Blockers
None

### Next Steps
1. Run test suite and fix any failures
2. Create next feature: /asdf:spec shopping-cart
3. Consider: user-auth feature before checkout

### Mental Context
- Using createdAt instead of date for sorting (spec updated)
- Infinite scroll is optional, pagination is default
- Mobile breakpoint at 768px

### Technical Context
- Products domain is foundation for cart/checkout
- Redis not yet configured (needed for cart sessions)

Saved to: astraler-docs/04-operations/session-handoff.md
```

---

## Summary

| Phase | Command | Output |
|-------|---------|--------|
| 1. Init | `/asdf:init ShopFast` | System-core structure + CLAUDE.md |
| 2. Domain | `/asdf:spec products` | Domain spec |
| 3. Feature | `/asdf:spec product-listing` | Feature spec v1.1.0 |
| 4. Code | `/asdf:code ...` | Working implementation |
| 5. Test | `/asdf:test product-listing` | 18 test cases |
| 6. Handoff | `/asdf:handoff` | Session notes |

**Total time:** ~4 hours from idea to working feature with tests.

---

## Key Takeaways

1. **Reference collection matters** â€” PRD and wireframes accelerated spec creation
2. **CLAUDE.md auto-generated** â€” Entry point for Claude Code created automatically
3. **Refinement loop** â€” 2 iterations refined the feature spec
4. **Deviation handling** â€” Option A kept spec and code aligned
5. **Test matrix** â€” Skipping E2E for non-critical features saves time
6. **Handoff** â€” Mental context helps next developer continue smoothly

================
File: case-studies/02-existing-codebase.md
================
# Case Study 2: Existing Codebase (Brownfield)

**Scenario:** Adding ASDF to "TaskFlow" â€” an existing Node.js project with 50+ files and no documentation.

**Goal:** Retrofit ASDF methodology to bring order and documentation to undocumented code.

---

## Before & After

```mermaid
flowchart LR
    subgraph Before["Before ASDF"]
        A[50+ Files] --> B[No Docs]
        B --> C[Tribal Knowledge]
        C --> D[Onboarding: 2 weeks]
    end

    subgraph After["After ASDF"]
        E[Same 50+ Files] --> F[Structured Docs]
        F --> G[Self-Documenting]
        G --> H[Onboarding: 2 days]
    end

    Before -->|"/asdf:init B"| After
```

---

## Initial State

```
taskflow/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ controllers/
â”‚   â”‚   â”œâ”€â”€ AuthController.js
â”‚   â”‚   â”œâ”€â”€ TaskController.js
â”‚   â”‚   â”œâ”€â”€ ProjectController.js
â”‚   â”‚   â””â”€â”€ UserController.js
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ User.js
â”‚   â”‚   â”œâ”€â”€ Task.js
â”‚   â”‚   â”œâ”€â”€ Project.js
â”‚   â”‚   â””â”€â”€ Comment.js
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ AuthService.js
â”‚   â”‚   â”œâ”€â”€ EmailService.js
â”‚   â”‚   â””â”€â”€ NotificationService.js
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â””â”€â”€ index.js
â”‚   â””â”€â”€ app.js
â”œâ”€â”€ package.json
â”œâ”€â”€ .env.example
â””â”€â”€ (no documentation)
```

**Problems:**
- No architecture documentation
- No API documentation
- New developers take 2 weeks to understand the codebase
- Features added ad-hoc without specs
- Technical debt accumulating

---

## Phase 1: Initialize with Option B

### Step 1: Run `/asdf:init`

```
You: /asdf:init TaskFlow
```

**AI Response:**
```
Detected existing codebase in current directory.

Files found:
- 50+ source files
- package.json (Node.js project)
- No existing documentation folder

Please choose initialization mode:
- [A] New project â€” Start fresh, ignore existing code
- [B] Existing codebase â€” Scan code, generate docs from analysis
- [C] Requirements doc â€” Start from PRD/requirements file

Recommended: [B] for existing projects
```

```
You: B
```

### Step 2: AI Scans Codebase

**AI Response:**
```
Scanning codebase...

Discovered:
â”œâ”€â”€ Tech Stack
â”‚   â”œâ”€â”€ Runtime: Node.js (from package.json)
â”‚   â”œâ”€â”€ Framework: Express.js
â”‚   â”œâ”€â”€ Database: MongoDB (mongoose)
â”‚   â”œâ”€â”€ Auth: JWT + bcrypt
â”‚   â””â”€â”€ Email: Nodemailer
â”‚
â”œâ”€â”€ Domains (inferred from models/)
â”‚   â”œâ”€â”€ auth â€” User authentication, sessions
â”‚   â”œâ”€â”€ tasks â€” Task management, assignments
â”‚   â”œâ”€â”€ projects â€” Project organization
â”‚   â””â”€â”€ notifications â€” Email, in-app alerts
â”‚
â”œâ”€â”€ Features (inferred from controllers/)
â”‚   â”œâ”€â”€ User registration/login
â”‚   â”œâ”€â”€ Task CRUD
â”‚   â”œâ”€â”€ Project management
â”‚   â”œâ”€â”€ Task comments
â”‚   â””â”€â”€ Email notifications
â”‚
â””â”€â”€ API Endpoints (inferred from routes/)
    â”œâ”€â”€ POST /auth/login
    â”œâ”€â”€ POST /auth/register
    â”œâ”€â”€ GET/POST/PUT/DELETE /tasks
    â”œâ”€â”€ GET/POST/PUT/DELETE /projects
    â””â”€â”€ ... (12 more endpoints)

Continue with documentation generation? (yes/feedback)
```

```
You: yes
```

### Step 3: AI Generates Initial Structure

**AI Response:**
```
Generating ASDF structure from code analysis...

Created:
â”œâ”€â”€ astraler-docs/
â”‚   â”œâ”€â”€ 01-system-core/
â”‚   â”‚   â”œâ”€â”€ 01-architecture/
â”‚   â”‚   â”‚   â”œâ”€â”€ master-map.md (generated from code structure)
â”‚   â”‚   â”‚   â”œâ”€â”€ tech-stack.md (from package.json)
â”‚   â”‚   â”‚   â””â”€â”€ data-architecture.md (from mongoose models)
â”‚   â”‚   â”œâ”€â”€ 02-standards/
â”‚   â”‚   â”‚   â””â”€â”€ code-standards.md (inferred patterns)
â”‚   â”‚   â””â”€â”€ project-status.md
â”‚   â”‚
â”‚   â”œâ”€â”€ 02-domains/
â”‚   â”‚   â”œâ”€â”€ auth/domain.md (from AuthService, User model)
â”‚   â”‚   â”œâ”€â”€ tasks/domain.md (from TaskController, Task model)
â”‚   â”‚   â”œâ”€â”€ projects/domain.md (from ProjectController, Project model)
â”‚   â”‚   â””â”€â”€ notifications/domain.md (from NotificationService)
â”‚   â”‚
â”‚   â”œâ”€â”€ 03-features/
â”‚   â”‚   â””â”€â”€ (empty â€” features need manual spec creation)
â”‚   â”‚
â”‚   â””â”€â”€ 04-operations/
â”‚       â”œâ”€â”€ implementation-active.md
â”‚       â””â”€â”€ session-handoff.md

Status: 70% complete (system-core + domains generated)

Gaps identified:
- Feature specs not generated (need manual creation or sync)
- Some business rules inferred but may need verification
- API documentation needs review

Please choose:
- Feedback â€” Adjust generated docs
- Confirm â€” Accept and continue
```

```
You: confirm
```

### Step 4: CLAUDE.md Generation

**AI Response:**
```
Generating CLAUDE.md...

Existing CLAUDE.md detected. Checking for ASDF configuration...
No ASDF markers found.

**CLAUDE.md Merge Preview**

Existing content detected:
- No agent configured
- No commands section
- Basic project description only

Will add (merged, not replaced):
- ASDF Framework section
- Agent reference: .claude/agents/asdf-coder.md
- Commands: 17 ASDF commands
- Documentation reference: astraler-docs/
- ASDF critical rules

Choose:
- [merge] Apply changes
- [view] Show full merged file
- [skip] Don't modify CLAUDE.md
```

```
You: merge
```

**AI Response:**
```
âœ“ CLAUDE.md updated (merged)

Added:
- ASDF Framework section
- Agent: asdf-coder.md
- Commands: 17 ASDF commands
- Documentation: astraler-docs/
- Critical rules: 4 items

Existing content preserved.

ASDF Initialization Complete
```

> **Note:** For brownfield projects, ASDF configuration is merged into existing CLAUDE.md without replacing custom content.

---

## Phase 2: Reconcile Generated Specs

### Step 1: Review Generated Domain Spec

The AI generated a domain spec, but it needs verification:

```
You: Show me the auth domain spec
```

**AI Response:**
```markdown
# Auth Domain

> **Version:** 1.0.0 (auto-generated)
> **Status:** Review
> **Generated from:** src/services/AuthService.js, src/models/User.js

## Entities

### User
| Field | Type | Constraints |
|-------|------|-------------|
| _id | ObjectId | Primary key |
| email | String | Unique, required |
| password | String | Hashed (bcrypt) |
| name | String | Required |
| role | String | enum: ['user', 'admin'] |
| createdAt | Date | Auto |

## Business Rules
- BR-001: Passwords hashed with bcrypt (10 rounds) [inferred]
- BR-002: JWT tokens expire in 24h [inferred from code]
- BR-003: Email must be unique [from model validation]

## API Endpoints (discovered)
| Method | Path | Description |
|--------|------|-------------|
| POST | /auth/register | Create new user |
| POST | /auth/login | Authenticate, return JWT |
| GET | /auth/me | Get current user |
| POST | /auth/refresh | Refresh token |

âš ï¸ REVIEW NEEDED: Some rules inferred from code patterns.
```

### Step 2: Provide Corrections

```
You: BR-002 is wrong - tokens expire in 7 days, not 24h. Also add BR-004: Password must be 8+ chars.
```

**AI Response:**
```
Updated auth domain to v1.1.0

Changes:
- BR-002: JWT tokens expire in 7 days
- BR-004: Password minimum 8 characters (added)
- Status: Review â†’ Approved

Saved to: astraler-docs/02-domains/auth/domain.md
```

---

## Phase 3: Create Feature Specs from Code

### Step 1: Use `/asdf:sync` to Generate Feature Spec

```
You: /asdf:sync tasks
```

**AI Response:**
```
SYNC MODE: Tasks

Analyzing code:
- src/controllers/TaskController.js
- src/models/Task.js
- src/routes/index.js (task routes)

No existing spec found. Generate feature spec from code? (yes/no)
```

```
You: yes
```

**AI Response:**
```
Generated: 251224-task-management

## Task Management Feature

> **Version:** 1.0.0 (reverse-synced from code)
> **Status:** Implemented
> **Generated from:** TaskController.js, Task.js

### Acceptance Criteria (inferred)
- AC-001: User can create tasks with title, description, dueDate
- AC-002: User can assign tasks to other users
- AC-003: User can mark tasks complete
- AC-004: User can filter tasks by status, assignee
- AC-005: User can add comments to tasks

### API Contract (discovered)
| Method | Path | Description |
|--------|------|-------------|
| GET | /tasks | List tasks (with filters) |
| POST | /tasks | Create task |
| GET | /tasks/:id | Get task details |
| PUT | /tasks/:id | Update task |
| DELETE | /tasks/:id | Delete task |
| POST | /tasks/:id/comments | Add comment |

âš ï¸ This spec was generated from existing code.
Please review and confirm accuracy.

Options:
- [confirm] Accept generated spec
- [feedback] Make corrections
```

```
You: confirm
```

---

## Phase 4: Gradual Adoption Strategy

### Recommended Approach

```mermaid
flowchart TD
    subgraph Week1["Week 1: Foundation"]
        A["/asdf:init B"] --> B["Review generated docs"]
        B --> C["Fix inaccuracies"]
    end

    subgraph Week2["Week 2: Sync Existing"]
        D["/asdf:sync"] --> E["Generate feature specs"]
        E --> F["One feature at a time"]
    end

    subgraph Week3["Week 3: New Work"]
        G["New features"] --> H["/asdf:spec first"]
        H --> I["/asdf:code follows"]
    end

    subgraph Ongoing["Ongoing"]
        J["Weekly /asdf:audit"]
        K["Maintain spec-code alignment"]
    end

    Week1 --> Week2 --> Week3 --> Ongoing
```

### Priority Order

1. **Critical domains first** â€” Auth, core business logic
2. **Frequently changed features** â€” Areas with active development
3. **Undocumented APIs** â€” External-facing endpoints
4. **Legacy code last** â€” Stable, rarely touched code

---

## Phase 5: Verify Alignment

After syncing all features, run audit:

```
You: /asdf:audit
```

**AI Response:**
```
Spec Audit Report

Project: TaskFlow
Scan Date: 251224

Summary:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Category    â”‚ Count â”‚ Status â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Outdated    â”‚ 0     â”‚ ğŸŸ¢     â”‚
â”‚ Missing     â”‚ 2     â”‚ ğŸŸ¡     â”‚
â”‚ Orphaned    â”‚ 0     â”‚ ğŸŸ¢     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Missing Specs:
| Code Location | Suggested Action |
|---------------|------------------|
| src/services/EmailService.js | Create notifications domain |
| src/middleware/rateLimit.js | Add to system-core/standards |

Options:
- [fix-all] Create missing specs
- [details] Show detailed analysis
- [cancel] Exit
```

```
You: fix-all
```

---

## Final State

```
taskflow/
â”œâ”€â”€ src/
â”‚   â””â”€â”€ (existing 50+ files - unchanged)
â”‚
â””â”€â”€ astraler-docs/
    â”œâ”€â”€ 01-system-core/
    â”‚   â”œâ”€â”€ 01-architecture/
    â”‚   â”‚   â”œâ”€â”€ master-map.md âœ“
    â”‚   â”‚   â”œâ”€â”€ tech-stack.md âœ“
    â”‚   â”‚   â””â”€â”€ data-architecture.md âœ“
    â”‚   â”œâ”€â”€ 02-standards/
    â”‚   â”‚   â””â”€â”€ code-standards.md âœ“
    â”‚   â””â”€â”€ project-status.md âœ“
    â”‚
    â”œâ”€â”€ 02-domains/
    â”‚   â”œâ”€â”€ auth/domain.md âœ“
    â”‚   â”œâ”€â”€ tasks/domain.md âœ“
    â”‚   â”œâ”€â”€ projects/domain.md âœ“
    â”‚   â””â”€â”€ notifications/domain.md âœ“
    â”‚
    â”œâ”€â”€ 03-features/
    â”‚   â”œâ”€â”€ 251224-user-auth/spec.md âœ“
    â”‚   â”œâ”€â”€ 251224-task-management/spec.md âœ“
    â”‚   â”œâ”€â”€ 251224-project-management/spec.md âœ“
    â”‚   â””â”€â”€ 251224-task-comments/spec.md âœ“
    â”‚
    â””â”€â”€ 04-operations/
        â”œâ”€â”€ implementation-active.md âœ“
        â””â”€â”€ session-handoff.md âœ“
```

---

## Before vs After Metrics

| Metric | Before | After |
|--------|--------|-------|
| Documentation | None | Complete |
| Onboarding time | 2 weeks | 2 days |
| API documentation | None | 100% coverage |
| Architecture diagram | None | Mermaid diagrams |
| Feature tracking | Ad-hoc | Spec-driven |

---

## Key Takeaways

1. **Option B is powerful** â€” AI can infer structure from code
2. **CLAUDE.md merge** â€” ASDF config merged into existing CLAUDE.md without replacing content
3. **Review is essential** â€” Auto-generated specs need human verification
4. **Gradual adoption works** â€” Don't try to document everything at once
5. **Sync before spec** â€” For existing code, generate from reality first
6. **Audit regularly** â€” Keep code and specs aligned

---

## Common Brownfield Challenges

| Challenge | Solution |
|-----------|----------|
| Generated spec is wrong | Use feedback loop to correct |
| Code doesn't match any pattern | Create custom domain/feature spec manually |
| Legacy code nobody understands | Generate spec, mark as "needs review" |
| Mixed tech stacks | Document each separately in tech-stack.md |
| No tests exist | Use `/asdf:test` to generate test suites |

---

## Next Steps After Adoption

1. **New features** â€” Always `/asdf:spec` first
2. **Bug fixes** â€” Check spec, fix code, `/asdf:sync` if needed
3. **Refactoring** â€” Update spec first, then refactor
4. **Code reviews** â€” Reference specs in PR reviews
5. **Weekly audit** â€” Run `/asdf:audit` to catch drift

================
File: case-studies/03-team-collaboration.md
================
# Case Study 3: Team Collaboration

**Scenario:** 2 developers (Alice and Bob) using 2 Claude instances working on the same project simultaneously.

**Goal:** Demonstrate multi-instance coordination with locks, handoffs, and conflict resolution.

---

## Timeline Sequence

```mermaid
sequenceDiagram
    participant A as Alice (Instance 1)
    participant L as Lock System
    participant B as Bob (Instance 2)

    Note over A,B: Morning - Both start work

    A->>L: /asdf:code checkout
    L-->>A: Lock acquired âœ“

    B->>L: /asdf:code checkout
    L-->>B: âŒ LOCKED by Alice

    B->>L: /asdf:code user-profile
    L-->>B: Lock acquired âœ“

    Note over A,B: Working in parallel...

    A->>L: Complete + release lock
    L-->>A: Lock released âœ“

    B->>L: Needs shared domain update
    Note over B: Impact analysis triggered

    B->>L: Complete + release lock
    L-->>B: Lock released âœ“

    Note over A,B: End of day

    A->>L: /asdf:handoff
    B->>L: /asdf:handoff

    Note over A,B: Next day - New developer

    participant C as Charlie (Instance 3)
    C->>L: /asdf:onboard
    L-->>C: Project context loaded
```

---

## Phase 1: Morning Standup

Both developers check the project status:

```
Alice: /asdf:onboard
```

**AI Response:**
```
Welcome to ShopFast!

## Project Overview
E-commerce platform | Phase 1 MVP

## Current Status
- Phase: 1 (MVP)
- Progress: 40% complete
- Features: 4/10 implemented

## Active Work
No features currently locked.

## How to Start
- Continue: /asdf:code [feature-path]
- New feature: /asdf:spec [name]
- Check roadmap: /asdf:roadmap

Ready to work? [status] [roadmap] [start]
```

```
Alice: I'll work on checkout today
Bob: I'll take user-profile
```

---

## Phase 2: Alice Starts Checkout

### Step 1: Acquire Lock

```
Alice: /asdf:code astraler-docs/03-features/251220-checkout/
```

**AI Response (Instance 1):**
```
EXECUTE MODE: Checkout

Loading spec: 251220-checkout v1.2.0
Status: Approved âœ“

Dependency Check:
âœ“ Domain: cart â€” Implemented
âœ“ Domain: payments â€” Implemented
âœ“ Feature: shopping-cart â€” Implemented

Impact Analysis:
No breaking changes detected.

Acquiring lock...
âœ“ Lock acquired: 251220-checkout.lock
Instance: claude-alice-001
Task: Implementing FR-001 to FR-005

Proceeding with implementation...
```

Alice is now working on checkout with an exclusive lock.

---

## Phase 3: Bob Tries Same Feature

### Step 1: Lock Blocked

```
Bob: /asdf:code astraler-docs/03-features/251220-checkout/
```

**AI Response (Instance 2):**
```
ğŸ”’ FEATURE LOCKED

Feature: 251220-checkout
Locked by: claude-alice-001
Since: 251224 09:15
Working on: Implementing FR-001 to FR-005
Age: 12 minutes

Options:
- [wait] Check again in 5 minutes
- [force] Override lock (DANGER: may cause conflicts)
- [other] Work on different feature

What would you like to do?
```

```
Bob: other
```

### Step 2: Pick Different Feature

```
Bob: /asdf:code astraler-docs/03-features/251221-user-profile/
```

**AI Response (Instance 2):**
```
EXECUTE MODE: User Profile

Loading spec: 251221-user-profile v1.0.0
Status: Approved âœ“

Dependency Check:
âœ“ Domain: auth â€” Implemented

Impact Analysis:
No breaking changes detected.

Acquiring lock...
âœ“ Lock acquired: 251221-user-profile.lock
Instance: claude-bob-002
Task: Implementing user profile feature

Proceeding with implementation...
```

Now both are working in parallel on different features.

---

## Phase 4: Parallel Work

### Current Lock State

```
04-operations/locks/
â”œâ”€â”€ 251220-checkout.lock        # Alice
â””â”€â”€ 251221-user-profile.lock    # Bob
```

### Alice's Progress

```
Alice is implementing:
- CheckoutController
- PaymentService integration
- Order confirmation flow
```

### Bob's Progress

```
Bob is implementing:
- ProfileController
- Avatar upload
- Account settings
```

---

## Phase 5: Alice Completes First

### Step 1: Implementation Done

```
Implementation Complete

Feature: 251220-checkout
Files created: 8
Tests: 12 generated

Acceptance Criteria Verification:
âœ“ AC-001: Guest checkout supported
âœ“ AC-002: Payment via Stripe
âœ“ AC-003: Order confirmation email
âœ“ AC-004: Receipt generation

Lock released: 251220-checkout.lock

Next: Run tests or start next feature
```

### Step 2: Alice Hands Off

```
Alice: /asdf:handoff
```

**AI Response:**
```
Session Handoff Created

## Session Summary
**Date:** 251224
**Instance:** claude-alice-001
**Duration:** 3 hours

### Completed
- [x] Checkout feature (251220-checkout) â€” DONE
- [x] 8 files created, 12 tests generated

### Technical Context
- Stripe webhook endpoint at /api/webhooks/stripe
- Order confirmation uses SendGrid template "order-confirm-v2"
- Guest checkout stores email in session, not User table

### Notes for Next Developer
- Payment retry logic not implemented (deferred to Phase 2)
- Consider rate limiting on checkout endpoint

Saved to: astraler-docs/04-operations/session-handoff.md
```

---

## Phase 6: Bob Needs Shared Update

### Step 1: Impact Analysis Triggered

Bob discovers he needs to update the shared `auth` domain:

```
Bob: I need to add "avatarUrl" to the User model
```

**AI Response:**
```
âš ï¸ IMPACT ANALYSIS

Change: Add avatarUrl to User entity (auth domain)

Breaking Changes Detected:

| Affected | Type | Impact | Severity |
|----------|------|--------|----------|
| 251220-checkout | Entity | User schema changed | LOW |
| 251222-notifications | Entity | User reference updated | LOW |

This change affects 2 other features.

Options:
- [review] Show detailed impact for each
- [proceed] Continue (update affected specs later)
- [abort] Cancel change

What would you like to do?
```

```
Bob: proceed
```

### Step 2: Update Domain with Lock

```
Acquiring spec lock for auth domain...
âœ“ Lock acquired: spec-locks/auth.lock

Updating auth domain to v1.2.0:
- Added: avatarUrl (String, optional) to User entity

Affected features flagged for sync:
- 251220-checkout (mark for review)
- 251222-notifications (mark for review)

Lock released: spec-locks/auth.lock
```

---

## Phase 7: Stale Lock Scenario

### Scenario: Alice's Instance Crashed

Next day, Charlie tries to work on checkout:

```
Charlie: /asdf:code astraler-docs/03-features/251220-checkout/
```

**AI Response:**
```
ğŸ”’ FEATURE LOCKED

Feature: 251220-checkout
Locked by: claude-alice-001
Since: 251224 09:15
Age: 18 hours âš ï¸ STALE

This lock is older than 4 hours and may be abandoned.

Options:
- [wait] Check again in 5 minutes
- [force] Override lock (safe for stale locks)
- [other] Work on different feature

What would you like to do?
```

```
Charlie: force
```

**AI Response:**
```
Force override confirmed.

Logging to conflict-log.md:
| 251225 | 251220-checkout | claude-alice-001 | claude-charlie-003 | Stale lock (18h) |

Previous lock released.
New lock acquired: 251220-checkout.lock

âš ï¸ Check session-handoff.md for context from previous work.

Proceeding...
```

---

## Phase 8: Admin Unlock

### Alternative: Use `/asdf:unlock`

```
Charlie: /asdf:unlock 251220-checkout
```

**AI Response:**
```
Lock Found

| Field | Value |
|-------|-------|
| Lock | 251220-checkout |
| Type | Code |
| Locked by | claude-alice-001 |
| Since | 251224 09:15 |
| Age | 18 hours |
| Task | Implementing FR-001 to FR-005 |

Status: Stale (>4h) âœ“

Options:
- [release] Force release this lock
- [cancel] Keep lock, exit
```

```
Charlie: release
```

**AI Response:**
```
Lock Released

Lock: 251220-checkout
Released: 251225 10:30
Logged to: conflict-log.md

âš ï¸ If the original instance is still active, they may encounter conflicts.
```

---

## Phase 9: End of Day Sync

Both developers run handoff:

### Bob's Handoff

```
Bob: /asdf:handoff
```

**AI Response:**
```
Session Handoff Created

## Session Summary
**Date:** 251224
**Instance:** claude-bob-002

### Completed
- [x] User profile feature (251221-user-profile) â€” DONE
- [x] Added avatarUrl to auth domain

### In Progress
None

### Impact Notes
- Auth domain updated to v1.2.0
- Checkout and notifications flagged for spec sync

### Technical Context
- Avatar uploads stored in S3 bucket "shopfast-avatars"
- Max file size: 5MB
- Supported formats: jpg, png, webp

Saved to: astraler-docs/04-operations/session-handoff.md
```

---

## Phase 10: Next Day Onboarding

### New Developer Joins

```
Dave: /asdf:onboard
```

**AI Response:**
```
Welcome to ShopFast!

## Project Overview
E-commerce platform for small businesses
Tech: Node.js, React, PostgreSQL, Stripe

## Current Status
- Phase: 1 (MVP)
- Progress: 60% complete
- Features: 6/10 implemented

## Recent Activity (from handoffs)
- 251224: Checkout feature completed (Alice)
- 251224: User profile completed (Bob)
- 251224: Auth domain updated (avatarUrl added)

## Active Work
| Feature | Status | Locked |
|---------|--------|--------|
| checkout | Implemented | No |
| user-profile | Implemented | No |
| notifications | In Progress | No |

## Pending Syncs
- 251220-checkout: Needs spec sync (auth domain changed)
- 251222-notifications: Needs spec sync (auth domain changed)

## How to Start
1. Fix pending syncs: /asdf:sync checkout
2. Continue next feature: /asdf:code notifications
3. Or start new: /asdf:spec [feature-name]

[status] [roadmap] [start]
```

---

## Lock File Examples

### Code Lock

```yaml
# 04-operations/locks/251220-checkout.lock
instance_id: claude-alice-001
locked_at: 2024-12-24T09:15:00Z
task: "Implementing FR-001 to FR-005"
estimated_duration: 2h
contact: "Session #42"
```

### Spec Lock

```yaml
# 04-operations/spec-locks/auth.lock
instance_id: claude-bob-002
locked_at: 2024-12-24T14:30:00Z
task: "Updating User entity"
operation: UPDATE
```

### Conflict Log

```markdown
# Conflict Log

| Date | Lock | Original Instance | Released By | Reason |
|------|------|-------------------|-------------|--------|
| 251225 | 251220-checkout | claude-alice-001 | claude-charlie-003 | Stale lock (18h) |
```

---

## Key Takeaways

1. **Locks prevent conflicts** â€” Only one instance per feature/spec
2. **Choose different work** â€” When blocked, pick another feature
3. **Stale locks are safe to override** â€” After 4 hours
4. **Impact analysis warns** â€” Before shared changes
5. **Handoffs preserve context** â€” Mental + technical notes
6. **Onboard catches you up** â€” Read recent handoffs automatically

---

## Best Practices for Teams

| Practice | Benefit |
|----------|---------|
| Small features | Shorter lock times |
| Frequent handoffs | Better context transfer |
| Check locks first | Avoid wasted work |
| Use `/asdf:onboard` daily | Stay updated |
| Document breaking changes | Help teammates |
| Review conflict log | Understand patterns |

================
File: case-studies/04-maintenance-workflow.md
================
# Case Study 4: Maintenance Workflow

**Scenario:** ShopFast has been running for 3 months. Specs have drifted, tech debt accumulated, and project health is degraded.

**Goal:** Use maintenance commands to restore project health from red to green.

---

## Health Transformation

```mermaid
flowchart LR
    subgraph Before["Before Maintenance"]
        A["ğŸ”´ Outdated: 5 specs"]
        B["ğŸ”´ Missing: 3 specs"]
        C["ğŸŸ¡ Tech Debt: 8 items"]
        D["ğŸ”´ Orphaned: 2 specs"]
    end

    subgraph Commands["Maintenance Commands"]
        E["/asdf:audit"]
        F["/asdf:sync"]
        G["/asdf:cleanup"]
        H["Tech Debt Review"]
    end

    subgraph After["After Maintenance"]
        I["ğŸŸ¢ Outdated: 0 specs"]
        J["ğŸŸ¢ Missing: 0 specs"]
        K["ğŸŸ¢ Tech Debt: 3 items"]
        L["ğŸŸ¢ Orphaned: 0 specs"]
    end

    Before --> Commands --> After
```

---

## Initial State: Project Health Check

### Step 1: Run `/asdf:report all`

```
You: /asdf:report all
```

**AI Response:**
```
PROJECT HEALTH REPORT: ShopFast

Generated: 251224
Phase: 2 (Growth)

## Overview
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Indicator       â”‚ Value â”‚ Status â”‚ Trend â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Specs up-to-dateâ”‚ 60%   â”‚ ğŸ”´     â”‚ â†“     â”‚
â”‚ Missing specs   â”‚ 3     â”‚ ğŸ”´     â”‚ â†‘     â”‚
â”‚ Orphaned specs  â”‚ 2     â”‚ ğŸ”´     â”‚ â†’     â”‚
â”‚ Tech debt       â”‚ 8     â”‚ ğŸŸ¡     â”‚ â†‘     â”‚
â”‚ Test coverage   â”‚ 65%   â”‚ ğŸŸ¡     â”‚ â†’     â”‚
â”‚ Active blockers â”‚ 1     â”‚ ğŸŸ¡     â”‚ â†’     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜

Overall: ğŸ”´ CRITICAL - Needs immediate attention

## Feature Status
| Feature | Progress | Last Updated | Status |
|---------|----------|--------------|--------|
| checkout | 100% | 60 days ago | âš ï¸ Stale |
| user-profile | 100% | 45 days ago | âš ï¸ Stale |
| notifications | 80% | 5 days ago | ğŸŸ¢ Active |
| inventory | 100% | 90 days ago | ğŸ”´ Very Stale |
| analytics | 30% | 30 days ago | ğŸŸ¡ Aging |

## Recommendations
1. Run /asdf:audit for detailed issues
2. Sync 5 outdated specs
3. Clean up 2 orphaned specs
4. Address P0 tech debt items
```

---

## Phase 1: Detailed Audit

### Step 1: Run `/asdf:audit`

```
You: /asdf:audit
```

**AI Response:**
```
SPEC AUDIT REPORT

Scanning codebase vs documentation...

## Outdated Specs (5)
Code changed but spec not updated

| Spec | Last Spec Update | Code Changes | Gap |
|------|------------------|--------------|-----|
| 251220-checkout | 60 days | 12 commits | ğŸ”´ |
| 251221-user-profile | 45 days | 8 commits | ğŸ”´ |
| 251015-inventory | 90 days | 23 commits | ğŸ”´ |
| auth domain | 30 days | 5 commits | ğŸŸ¡ |
| payments domain | 40 days | 7 commits | ğŸŸ¡ |

## Missing Specs (3)
Code exists but no spec

| Code Location | Type | Suggestion |
|---------------|------|------------|
| src/services/ReportService.js | Feature | Create 03-features/YYMMDD-reporting/ |
| src/controllers/WebhookController.js | Feature | Create 03-features/YYMMDD-webhooks/ |
| src/middleware/rateLimit.js | Standard | Add to 01-system-core/02-standards/ |

## Orphaned Specs (2)
Spec exists but code deleted

| Spec | Expected Code | Status |
|------|---------------|--------|
| 251101-legacy-auth | src/services/LegacyAuth.js | Deleted |
| 251105-temp-promotion | src/features/promotion/ | Deleted |

## Tech Debt Summary
- P0 (Critical): 1 item
- P1 (High): 3 items
- P2 (Medium): 4 items

Options:
- [fix-all] Address all issues (guided workflow)
- [fix-outdated] Sync outdated specs only
- [fix-missing] Create missing specs only
- [fix-orphaned] Clean up orphaned specs
- [details] Show detailed analysis
- [cancel] Exit
```

---

## Phase 2: Fix Outdated Specs

### Step 1: Sync Outdated Specs

```
You: fix-outdated
```

**AI Response:**
```
SYNC WORKFLOW: Outdated Specs

Starting with highest priority (oldest gap)...

---

## 1/5: 251015-inventory (90 days outdated)

Analyzing code changes...

Changes detected:
| File | Changes | Impact |
|------|---------|--------|
| InventoryService.js | +reserveStock(), +releaseStock() | New methods |
| Inventory.js model | +reservedQty field | Schema change |
| routes/inventory.js | +POST /reserve endpoint | New API |

Sync Preview:
- Add FR-008: Reserve stock for pending orders
- Add FR-009: Release stock on order cancel
- Update API contract with /reserve endpoint
- Update data model with reservedQty field

Options:
- [confirm] Apply sync, update spec to v1.3.0
- [feedback] Adjust sync preview
- [skip] Skip this spec, continue to next
```

```
You: confirm
```

**AI Response:**
```
âœ“ Synced 251015-inventory to v1.3.0

Changelog entry added:
- 251224: Reverse sync - Added stock reservation (FR-008, FR-009)

Continuing to next...

---

## 2/5: 251220-checkout (60 days outdated)
...
```

### Step 2: Complete All Syncs

After confirming all 5 syncs:

```
Outdated Specs: 5 â†’ 0 âœ“

All outdated specs have been synced.

Summary:
| Spec | Old Version | New Version |
|------|-------------|-------------|
| 251015-inventory | v1.2.0 | v1.3.0 |
| 251220-checkout | v1.2.0 | v1.4.0 |
| 251221-user-profile | v1.0.0 | v1.2.0 |
| auth domain | v1.1.0 | v1.2.0 |
| payments domain | v1.0.0 | v1.1.0 |

Next: Address missing specs? (yes/no)
```

---

## Phase 3: Create Missing Specs

### Step 1: Generate Missing Specs

```
You: yes
```

**AI Response:**
```
MISSING SPECS WORKFLOW

---

## 1/3: ReportService.js

Analyzing code to generate spec...

Discovered:
- Service: Report generation
- Methods: generateSalesReport(), generateInventoryReport()
- Output: PDF, CSV formats
- Schedule: Daily automated reports

Draft spec: 251224-reporting v1.0.0

| Section | Content |
|---------|---------|
| Overview | Automated report generation |
| FR-001 | Generate sales reports (daily) |
| FR-002 | Generate inventory reports (weekly) |
| FR-003 | Export to PDF/CSV |
| API | GET /reports/:type, POST /reports/schedule |

Options:
- [confirm] Create spec
- [feedback] Adjust draft
- [skip] Skip, create manually later
```

```
You: confirm
```

### Step 2: Complete All Missing

```
Missing Specs: 3 â†’ 0 âœ“

Created:
- 251224-reporting/spec.md (v1.0.0)
- 251224-webhooks/spec.md (v1.0.0)
- Updated code-standards.md with rate limiting docs

Next: Clean up orphaned specs? (yes/no)
```

---

## Phase 4: Clean Up Orphaned Specs

### Step 1: Review Orphaned Specs

```
You: yes
```

**AI Response:**
```
CLEANUP WORKFLOW: Orphaned Specs

---

## 1/2: 251101-legacy-auth

Spec: Authentication using legacy session system
Expected code: src/services/LegacyAuth.js
Status: Code deleted (migrated to JWT)

This spec is orphaned because:
- Legacy auth was replaced by JWT auth in commit abc123
- Code deleted 45 days ago
- No references in current codebase

Options:
- [archive] Move to 04-operations/archived/ (recommended)
- [delete] Permanently delete
- [keep] Keep spec (not recommended)
```

```
You: archive
```

**AI Response:**
```
Archived: 251101-legacy-auth

Created:
- 04-operations/archived/251101-legacy-auth/spec.md
- 04-operations/archived/251101-legacy-auth/tombstone.md

Tombstone contents:
| Field | Value |
|-------|-------|
| Archived | 251224 |
| Reason | Code deleted (migrated to JWT) |
| Replacement | 251220-user-auth |

Continuing to next...

---

## 2/2: 251105-temp-promotion
...
```

### Step 2: Cleanup Complete

```
Orphaned Specs: 2 â†’ 0 âœ“

Archived:
- 251101-legacy-auth â†’ archived/251101-legacy-auth/
- 251105-temp-promotion â†’ archived/251105-temp-promotion/

Cleanup log updated: 04-operations/cleanup-log.md
```

---

## Phase 5: Review Tech Debt

### Step 1: Open Tech Debt Register

```
You: Show me the tech debt register
```

**AI Response:**
```markdown
# Tech Debt Register

> **Last Updated:** 251224
> **Total Items:** 8
> **Critical (P0):** 1
> **High (P1):** 3
> **Medium (P2):** 4

---

## P0 - Critical

| ID | Description | Impact | Effort | Created |
|----|-------------|--------|--------|---------|
| TD-001 | No rate limiting on checkout API | Security risk | M | 251115 |

## P1 - High

| ID | Description | Impact | Effort | Created |
|----|-------------|--------|--------|---------|
| TD-002 | N+1 queries in product listing | 200ms latency | S | 251120 |
| TD-003 | No retry logic for Stripe payments | Payment failures | M | 251125 |
| TD-004 | Missing index on orders.userId | Slow queries | S | 251201 |

## P2 - Medium

| ID | Description | Impact | Effort | Created |
|----|-------------|--------|--------|---------|
| TD-005 | Deprecated bcrypt version | Future security | S | 251101 |
| TD-006 | No pagination on admin reports | Memory issues | M | 251110 |
| TD-007 | Hardcoded email templates | Maintenance | L | 251115 |
| TD-008 | Missing error boundaries in React | UX on errors | M | 251120 |
```

### Step 2: Address Critical Tech Debt

```
You: Let's fix TD-001 first - the rate limiting issue
```

**AI Response:**
```
TD-001: No rate limiting on checkout API

Impact: Security risk - API vulnerable to abuse
Effort: M (4-8 hours)

This was already documented during missing specs workflow.
Rate limiting patterns added to code-standards.md.

Implementation needed:
1. Add express-rate-limit middleware
2. Configure: 100 requests/15min for checkout
3. Return 429 Too Many Requests when exceeded

Would you like to:
- [spec] Create a tech-debt-fix spec
- [code] Implement directly (simple fix)
- [defer] Keep in backlog
```

```
You: code
```

**AI Response:**
```
Implementing rate limiting...

Files modified:
- src/middleware/rateLimit.js (created)
- src/routes/checkout.js (added middleware)
- src/app.js (global rate limit)

Rate limits configured:
| Endpoint | Limit | Window |
|----------|-------|--------|
| /api/checkout | 100 req | 15 min |
| /api/* (global) | 1000 req | 15 min |

Tests added:
- rateLimit.test.js (3 tests)

TD-001 resolved. Moving to "Resolved" section.

Updated tech-debt.md:
- P0 items: 1 â†’ 0 âœ“
- Total items: 8 â†’ 7
```

---

## Phase 6: Final Health Check

### Step 1: Run Report Again

```
You: /asdf:report all
```

**AI Response:**
```
PROJECT HEALTH REPORT: ShopFast

Generated: 251224 (post-maintenance)
Phase: 2 (Growth)

## Overview
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Indicator       â”‚ Value â”‚ Status â”‚ Trend â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Specs up-to-dateâ”‚ 100%  â”‚ ğŸŸ¢     â”‚ â†‘     â”‚
â”‚ Missing specs   â”‚ 0     â”‚ ğŸŸ¢     â”‚ â†“     â”‚
â”‚ Orphaned specs  â”‚ 0     â”‚ ğŸŸ¢     â”‚ â†“     â”‚
â”‚ Tech debt       â”‚ 7     â”‚ ğŸŸ¡     â”‚ â†“     â”‚
â”‚ Test coverage   â”‚ 68%   â”‚ ğŸŸ¡     â”‚ â†‘     â”‚
â”‚ Active blockers â”‚ 0     â”‚ ğŸŸ¢     â”‚ â†“     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜

Overall: ğŸŸ¢ HEALTHY

## Improvements This Session
| Metric | Before | After | Change |
|--------|--------|-------|--------|
| Outdated specs | 5 | 0 | -5 âœ“ |
| Missing specs | 3 | 0 | -3 âœ“ |
| Orphaned specs | 2 | 0 | -2 âœ“ |
| P0 tech debt | 1 | 0 | -1 âœ“ |
| Total tech debt | 8 | 7 | -1 |

## Recommendations
1. Continue addressing P1 tech debt (3 items)
2. Increase test coverage to 80%
3. Schedule weekly /asdf:audit
```

---

## Maintenance Schedule

### Recommended Cadence

| Task | Frequency | Command |
|------|-----------|---------|
| Health check | Weekly | `/asdf:report all` |
| Spec audit | Weekly | `/asdf:audit` |
| Tech debt review | Bi-weekly | Review tech-debt.md |
| Full cleanup | Monthly | `/asdf:cleanup` |
| Orphan check | Monthly | Part of audit |

---

## Before vs After Summary

```mermaid
flowchart TB
    subgraph Before["Before (ğŸ”´ Critical)"]
        A1[Outdated: 5]
        A2[Missing: 3]
        A3[Orphaned: 2]
        A4[P0 Debt: 1]
    end

    subgraph After["After (ğŸŸ¢ Healthy)"]
        B1[Outdated: 0]
        B2[Missing: 0]
        B3[Orphaned: 0]
        B4[P0 Debt: 0]
    end

    Before -->|"2 hour maintenance session"| After
```

---

## Key Takeaways

1. **Audit first** â€” Understand the full picture before fixing
2. **Prioritize by risk** â€” P0 tech debt and security issues first
3. **Archive, don't delete** â€” Preserve history for orphaned specs
4. **Automate checks** â€” Weekly audit prevents drift
5. **Track progress** â€” Before/after metrics show value

---

## Maintenance Commands Summary

| Command | Purpose | When to Use |
|---------|---------|-------------|
| `/asdf:report all` | Project health dashboard | Weekly check |
| `/asdf:audit` | Detailed spec health analysis | Weekly or after sprints |
| `/asdf:sync` | Update specs from code | After implementations |
| `/asdf:cleanup` | Remove orphaned specs | Monthly or after migrations |
| Tech debt review | Prioritize and fix debt | Bi-weekly |

================
File: case-studies/05-feature-lifecycle.md
================
# Case Study 5: Feature Lifecycle

**Scenario:** Complete lifecycle of "Guest Checkout" feature from idea to production.

**Goal:** Demonstrate end-to-end ASDF workflow through all 5 phases of feature development.

---

## Lifecycle Overview

```mermaid
flowchart LR
    subgraph Phase1["Phase 1: Design"]
        A["/asdf:spec"] --> B["Refinement"]
        B --> C["Approved v1.2.0"]
    end

    subgraph Phase2["Phase 2: Implement"]
        D["/asdf:code"] --> E["Deviation B"]
        E --> F["Code Complete"]
    end

    subgraph Phase3["Phase 3: Test"]
        G["/asdf:test"] --> H["18 Tests"]
        H --> I["All Pass"]
    end

    subgraph Phase4["Phase 4: Review"]
        J["/asdf:pr"] --> K["/asdf:review"]
        K --> L["Fixes Applied"]
    end

    subgraph Phase5["Phase 5: Complete"]
        M["/asdf:sync"] --> N["/asdf:report"]
        N --> O["Feature Done âœ“"]
    end

    Phase1 --> Phase2 --> Phase3 --> Phase4 --> Phase5
```

---

## Phase 1: Design

### Step 1: Start Feature Spec

```
You: /asdf:spec guest-checkout
```

**AI Response:**
```
DESIGN MODE: Guest Checkout

Checking for duplicates... None found.

Do you have existing documents to reference?

Categories:
- Business â€” PRD, user stories
- Technical â€” API specs, payment docs
- Data â€” Order schemas
- Design â€” Checkout wireframes

Provide file path(s) or type "no" to continue.
```

```
You: docs/checkout-prd.md, designs/checkout-flow.fig
```

**AI Response:**
```
Extracted from checkout-prd.md:
- Goal: Allow purchases without account creation
- Capture: email, shipping, payment
- Post-purchase: Optional account creation
- Constraint: Must work with existing cart system

Extracted from checkout-flow.fig:
- 3-step wizard: Shipping â†’ Payment â†’ Confirm
- Guest email capture on step 1
- Express checkout option (Apple Pay, Google Pay)

Loading context:
- 01-system-core/ (standards, architecture)
- 02-domains/cart/ (cart system)
- 02-domains/payments/ (Stripe integration)
- 02-domains/orders/ (order processing)

Drafting spec...
```

### Step 2: First Draft

**AI Response:**
```
Draft Guest Checkout spec v1.0.0 ready for review.

## Overview
Enable purchases without requiring user registration.

## User Flow
```mermaid
flowchart TD
    A[Cart Review] --> B{Has Account?}
    B -->|Yes| C[Login Prompt]
    B -->|No| D[Guest Email]
    C --> E[Checkout]
    D --> E
    E --> F[Shipping Address]
    F --> G[Payment Method]
    G --> H[Order Confirmation]
    H --> I{Create Account?}
    I -->|Yes| J[Account Created]
    I -->|No| K[Guest Order Complete]
```

## Acceptance Criteria
- AC-001: User can checkout without creating account
- AC-002: Guest must provide valid email
- AC-003: Shipping address validated in real-time
- AC-004: Payment via Stripe (card, Apple Pay, Google Pay)
- AC-005: Order confirmation sent to guest email
- AC-006: Post-purchase account creation option

## API Contract
- POST /api/checkout/guest/start
- PUT /api/checkout/guest/:sessionId/shipping
- PUT /api/checkout/guest/:sessionId/payment
- POST /api/checkout/guest/:sessionId/confirm

## Dependencies
- Domain: cart (required) âœ“
- Domain: payments (required) âœ“
- Domain: orders (required) âœ“
- Feature: shopping-cart (required) âœ“

Please choose:
- Feedback â€” Type your changes
- Reference â€” Type `reference` to add source documents
- Confirm â€” Type `confirm` to finalize
```

### Step 3: Refinement (Iteration 1)

```
You: Add AC-007 for order tracking without account. Also need rate limiting on guest checkout to prevent abuse.
```

**AI Response:**
```
Updated to v1.1.0

Changes made:
- AC-007: Guest can track order via email + order ID
- NFR-001: Rate limit 10 checkout attempts per IP per hour
- Added GET /api/orders/track?email=&orderId= endpoint
- Added security considerations section

Please choose:
- Feedback â€” Type your changes
- Reference â€” Type `reference` to add source documents
- Confirm â€” Type `confirm` to finalize
```

### Step 4: Refinement (Iteration 2)

```
You: The wireframes show a progress indicator. Add AC-008 for step progress UI. Also express checkout should be AC-009.
```

**AI Response:**
```
Updated to v1.2.0

Changes made:
- AC-008: Checkout wizard shows step progress (1/3, 2/3, 3/3)
- AC-009: Express checkout via Apple Pay / Google Pay
- Updated UI/UX section with progress indicator specs
- Added payment method priority (express > card)

Please choose:
- Feedback â€” Type your changes
- Reference â€” Type `reference` to add source documents
- Confirm â€” Type `confirm` to finalize
```

### Step 5: Finalize Spec

```
You: confirm
```

**AI Response:**
```
Spec Finalized

Feature: guest-checkout
Version: 1.2.0
Status: Approved
Location: astraler-docs/03-features/251224-guest-checkout/spec.md

Created:
- spec.md (with mermaid user flow)
- changelog.md

Spec Summary:
- 9 acceptance criteria
- 1 non-functional requirement
- 5 API endpoints
- 3 dependencies (all satisfied)

Next: Implement with /asdf:code astraler-docs/03-features/251224-guest-checkout/
```

---

## Phase 2: Implementation

### Step 1: Start Implementation

```
You: /asdf:code astraler-docs/03-features/251224-guest-checkout/
```

**AI Response:**
```
EXECUTE MODE: Guest Checkout

Loading spec: 251224-guest-checkout v1.2.0
Status: Approved âœ“

Dependency Check:
âœ“ Domain: cart â€” Implemented
âœ“ Domain: payments â€” Implemented
âœ“ Domain: orders â€” Implemented
âœ“ Feature: shopping-cart â€” Implemented

Impact Analysis:
| Affected | Type | Impact | Severity |
|----------|------|--------|----------|
| orders domain | Extension | New guest order type | LOW |
| cart domain | Reference | Cart â†’ Checkout flow | LOW |

No breaking changes. Proceeding.

Acquiring lock...
âœ“ Lock acquired: 251224-guest-checkout.lock

Implementation Plan:
1. Create GuestCheckoutService
2. Create GuestCheckoutController with 5 endpoints
3. Extend Order model for guest orders
4. Create checkout session management (Redis)
5. Integrate Stripe for express checkout
6. Create email templates for confirmation
7. Create React checkout wizard component

Proceeding with implementation...
```

### Step 2: Deviation Detected

During implementation:

```
Deviation Detected

Spec says: AC-004 "Payment via Stripe (card, Apple Pay, Google Pay)"
Implementation needs: Apple Pay requires merchant verification first
Reason: Apple Pay setup needs merchant ID and domain verification

Options:
A) Update spec now â€” Remove Apple Pay from MVP
B) Continue + sync later â€” Implement card + Google Pay, add Apple Pay later
C) Wait for decision â€” Blocking issue
```

```
You: B
```

**AI Response:**
```
Deviation tracked:
- AC-009 partial: Google Pay implemented, Apple Pay deferred
- Added to Open Questions: "Apple Pay merchant verification pending"

Continuing with card + Google Pay...
```

### Step 3: Progress Updates

```
Progress Update: 251224-guest-checkout

Completed:
âœ“ GuestCheckoutService (session management)
âœ“ GuestCheckoutController (5 endpoints)
âœ“ Order model extended (isGuest field)
âœ“ Redis session storage
âœ“ Stripe card payments
âœ“ Stripe Google Pay

In Progress:
â†’ Email templates

Remaining:
- React checkout wizard
- Order tracking page
```

### Step 4: Implementation Complete

```
Implementation Complete

Feature: guest-checkout
Files created: 15
Lines of code: ~1,200

Files:
- backend/src/services/GuestCheckoutService.js
- backend/src/controllers/GuestCheckoutController.js
- backend/src/models/GuestSession.js
- backend/src/routes/guestCheckout.js
- backend/src/templates/order-confirmation.html
- backend/src/templates/order-tracking.html
- frontend/src/components/GuestCheckout/
  - CheckoutWizard.tsx
  - ShippingStep.tsx
  - PaymentStep.tsx
  - ConfirmStep.tsx
  - ProgressIndicator.tsx
  - OrderTracking.tsx
- frontend/src/hooks/useGuestCheckout.ts

Acceptance Criteria Verification:
âœ“ AC-001: Guest checkout without account
âœ“ AC-002: Email validation
âœ“ AC-003: Real-time address validation
âœ“ AC-004: Stripe card payments
âœ“ AC-005: Confirmation email sent
âœ“ AC-006: Post-purchase account option
âœ“ AC-007: Order tracking via email+ID
âœ“ AC-008: Step progress indicator
âš ï¸ AC-009: Partial (Google Pay only, Apple Pay deferred)

Tracked Deviations:
- Apple Pay deferred (needs merchant verification)

Lock released: 251224-guest-checkout.lock

Updated: implementation-active.md

Next: Run tests with /asdf:test guest-checkout
```

---

## Phase 3: Testing

### Step 1: Generate Tests

```
You: /asdf:test guest-checkout
```

**AI Response:**
```
TEST MODE: Guest Checkout

Loading spec: 251224-guest-checkout v1.2.0

Analyzing acceptance criteria for test generation...

Test Matrix:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AC     â”‚ Unit       â”‚ Integration â”‚ API        â”‚ E2E           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ AC-001 â”‚ [x] P0     â”‚ [x] P0      â”‚ [x] P0     â”‚ [ ]           â”‚
â”‚ AC-002 â”‚ [x] P0     â”‚ [ ]         â”‚ [x] P1     â”‚ [ ]           â”‚
â”‚ AC-003 â”‚ [x] P1     â”‚ [ ]         â”‚ [x] P1     â”‚ [ ]           â”‚
â”‚ AC-004 â”‚ [ ]        â”‚ [x] P0      â”‚ [x] P0     â”‚ [ ]           â”‚
â”‚ AC-005 â”‚ [x] P1     â”‚ [x] P1      â”‚ [ ]        â”‚ [ ]           â”‚
â”‚ AC-006 â”‚ [x] P1     â”‚ [ ]         â”‚ [x] P1     â”‚ [ ]           â”‚
â”‚ AC-007 â”‚ [x] P1     â”‚ [ ]         â”‚ [x] P1     â”‚ [ ]           â”‚
â”‚ AC-008 â”‚ [ ]        â”‚ [ ]         â”‚ [ ]        â”‚ [x] P2        â”‚
â”‚ AC-009 â”‚ [ ]        â”‚ [x] P1      â”‚ [x] P1     â”‚ [ ]           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Summary:
- Unit Tests: 8 cases
- Integration Tests: 4 cases
- API Tests: 8 cases
- E2E Tests: 1 case (optional)

Options:
- [skip-e2e] Generate Unit + Integration + API only (recommended)
- [yes] Generate all tests including E2E
- [feedback] Adjust test plan
```

```
You: yes
```

### Step 2: Tests Generated

**AI Response:**
```
Test Generation Complete

Feature: guest-checkout
Tests Generated: 21 total

Files Created:
- __tests__/guest-checkout/GuestCheckoutService.test.ts (8 unit tests)
- __tests__/guest-checkout/GuestCheckoutController.integration.test.ts (4 integration tests)
- __tests__/guest-checkout/api.test.ts (8 API tests)
- __tests__/guest-checkout/fixtures.ts
- e2e/guest-checkout.spec.ts (1 E2E test)

Test Breakdown:
| Type | Count | Priority |
|------|-------|----------|
| Unit | 8 | P0: 2, P1: 6 |
| Integration | 4 | P0: 2, P1: 2 |
| API | 8 | P0: 2, P1: 6 |
| E2E | 1 | P2: 1 |

Spec Updated:
- Testing section populated with test mapping

Next Steps:
1. Run tests: npm test -- --grep "guest-checkout"
2. Run E2E: npx playwright test guest-checkout
```

### Step 3: Run Tests

```
You: Run the tests
```

**AI Response:**
```
Running test suite...

$ npm test -- --grep "guest-checkout"

PASS __tests__/guest-checkout/GuestCheckoutService.test.ts
  âœ“ AC-001: should create guest session without account (12ms)
  âœ“ AC-002: should validate email format (8ms)
  âœ“ AC-002: should reject invalid email (5ms)
  âœ“ AC-003: should validate shipping address (15ms)
  âœ“ AC-005: should send confirmation email (22ms)
  âœ“ AC-006: should create account from guest (18ms)
  âœ“ AC-007: should find order by email and ID (10ms)
  âœ“ AC-007: should reject invalid tracking lookup (6ms)

PASS __tests__/guest-checkout/GuestCheckoutController.integration.test.ts
  âœ“ AC-001: complete guest checkout flow (145ms)
  âœ“ AC-004: process card payment via Stripe (89ms)
  âœ“ AC-009: process Google Pay payment (78ms)
  âœ“ AC-005: send confirmation after payment (112ms)

PASS __tests__/guest-checkout/api.test.ts
  âœ“ POST /api/checkout/guest/start returns session (25ms)
  ... (8 tests)

Test Suites: 3 passed, 3 total
Tests:       20 passed, 20 total
Time:        4.2s

$ npx playwright test guest-checkout

Running 1 test using 1 worker

âœ“ guest-checkout.spec.ts:5:1 â€º AC-008: checkout wizard shows progress (8.2s)

1 passed (8.5s)

All tests passing âœ“
```

---

## Phase 4: Review

### Step 1: Create PR Package

```
You: /asdf:pr guest-checkout
```

**AI Response:**
```
PR PACKAGE: Guest Checkout

Generating PR bundle...

## Pull Request Summary

**Feature:** Guest Checkout
**Spec Version:** 1.2.0
**Branch:** feature/251224-guest-checkout

### Changes

**Files Changed:** 15 files (+1,247 lines, -12 lines)

| Category | Files | Lines |
|----------|-------|-------|
| Backend Services | 3 | +420 |
| Backend Controllers | 1 | +180 |
| Backend Models | 1 | +45 |
| Backend Routes | 1 | +35 |
| Email Templates | 2 | +120 |
| Frontend Components | 6 | +380 |
| Frontend Hooks | 1 | +67 |

### Acceptance Criteria Status

| AC | Description | Status |
|----|-------------|--------|
| AC-001 | Guest checkout | âœ… Implemented |
| AC-002 | Email validation | âœ… Implemented |
| AC-003 | Address validation | âœ… Implemented |
| AC-004 | Stripe payments | âœ… Implemented |
| AC-005 | Confirmation email | âœ… Implemented |
| AC-006 | Account creation option | âœ… Implemented |
| AC-007 | Order tracking | âœ… Implemented |
| AC-008 | Progress indicator | âœ… Implemented |
| AC-009 | Express checkout | âš ï¸ Partial (Google Pay only) |

### Known Deviations
- Apple Pay deferred (merchant verification pending)

### Test Results
- Unit: 8/8 passing
- Integration: 4/4 passing
- API: 8/8 passing
- E2E: 1/1 passing

### Review Checklist
- [ ] Code follows project standards
- [ ] All AC verified
- [ ] Tests cover critical paths
- [ ] No security vulnerabilities
- [ ] Documentation updated

PR Package saved to: 04-operations/pr-packages/251224-guest-checkout.md
```

### Step 2: AI Code Review

```
You: /asdf:review 04-operations/pr-packages/251224-guest-checkout.md
```

**AI Response:**
```
AI CODE REVIEW: Guest Checkout

Reviewing from fresh context...

## Summary
Overall: âœ… APPROVED with minor suggestions

## Security Review
âœ… Input validation on all endpoints
âœ… Rate limiting implemented
âœ… Email sanitization
âš ï¸ SUGGESTION: Add CSRF protection to checkout form

## Code Quality
âœ… Follows project coding standards
âœ… Proper error handling
âœ… TypeScript types defined
âš ï¸ SUGGESTION: Extract magic numbers to constants
  - Line 45: `3600` â†’ `SESSION_TTL_SECONDS`
  - Line 89: `10` â†’ `MAX_CHECKOUT_ATTEMPTS`

## Performance
âœ… Redis session caching
âœ… Async email sending
âš ï¸ SUGGESTION: Add database index on GuestSession.email

## Test Coverage
âœ… All P0 criteria tested
âœ… Integration tests cover main flows
âš ï¸ GAP: No test for session expiry handling

## Recommendations

### Must Fix (before merge)
None

### Should Fix (soon)
1. Add CSRF token to checkout form
2. Add test for session expiry

### Nice to Have
1. Extract magic numbers to constants
2. Add database index for performance

## Verdict
âœ… APPROVED - Ready for merge after addressing "Should Fix" items
```

### Step 3: Apply Fixes

```
You: Fix the CSRF and session expiry test issues
```

**AI Response:**
```
Applying fixes...

1. CSRF Protection:
   - Added csurf middleware to checkout routes
   - Updated frontend to include CSRF token

2. Session Expiry Test:
   - Added test: "should reject expired session"
   - Added test: "should cleanup expired sessions"

Files modified:
- backend/src/routes/guestCheckout.js (+8 lines)
- frontend/src/hooks/useGuestCheckout.ts (+5 lines)
- __tests__/guest-checkout/GuestCheckoutService.test.ts (+22 lines)

Re-running tests...
âœ“ All 22 tests passing

Fixes applied âœ“
```

---

## Phase 5: Completion

### Step 1: Sync Deviations

```
You: /asdf:sync guest-checkout
```

**AI Response:**
```
SYNC MODE: Guest Checkout

Comparing implementation to spec...

Deviations Found:

| Section | Spec | Implementation | Action |
|---------|------|----------------|--------|
| AC-009 | Apple Pay + Google Pay | Google Pay only | Update spec |
| Open Questions | None | Apple Pay merchant verification | Add to spec |

Sync Preview:
- AC-009: Update to "Google Pay (Apple Pay Phase 2)"
- Add Open Question: "Apple Pay requires merchant verification"
- Increment version to v1.3.0

Options:
- [confirm] Apply sync
- [feedback] Adjust
- [cancel] Abort
```

```
You: confirm
```

**AI Response:**
```
Sync Complete

Spec updated: 251224-guest-checkout v1.3.0

Changes:
- AC-009 updated to reflect partial implementation
- Open Questions section added
- Changelog entry: "v1.3.0 - Synced Apple Pay deferral"

Spec and code are now aligned âœ“
```

### Step 2: Final Report

```
You: /asdf:report guest-checkout
```

**AI Response:**
```
FEATURE REPORT: Guest Checkout

## Status: âœ… COMPLETE

| Metric | Value |
|--------|-------|
| Spec Version | v1.3.0 |
| Implementation | 100% |
| Test Coverage | 95% |
| Review Status | Approved |

## Acceptance Criteria

| AC | Description | Status |
|----|-------------|--------|
| AC-001 | Guest checkout | âœ… |
| AC-002 | Email validation | âœ… |
| AC-003 | Address validation | âœ… |
| AC-004 | Stripe payments | âœ… |
| AC-005 | Confirmation email | âœ… |
| AC-006 | Account creation | âœ… |
| AC-007 | Order tracking | âœ… |
| AC-008 | Progress indicator | âœ… |
| AC-009 | Express checkout | âš ï¸ Partial |

## Test Results
- Total Tests: 22
- Passing: 22
- Failing: 0
- Coverage: 95%

## Deliverables
- Spec: astraler-docs/03-features/251224-guest-checkout/spec.md
- Code: 15 files, ~1,250 lines
- Tests: 22 test cases
- PR: Ready for merge

## Phase 2 Items (Deferred)
- Apple Pay integration (needs merchant verification)

## Timeline
- Design: 1 hour (3 refinement iterations)
- Implementation: 4 hours
- Testing: 1 hour
- Review: 30 minutes
- Total: ~6.5 hours

Feature ready for production âœ“
```

---

## Complete Command Sequence

| Phase | Command | Output |
|-------|---------|--------|
| 1. Design | `/asdf:spec guest-checkout` | Spec v1.2.0 |
| 1. Design | (3 feedback iterations) | Refinements |
| 2. Implement | `/asdf:code ...` | 15 files created |
| 2. Implement | (Deviation B chosen) | Apple Pay deferred |
| 3. Test | `/asdf:test guest-checkout` | 21 tests generated |
| 3. Test | Run tests | All passing |
| 4. Review | `/asdf:pr guest-checkout` | PR package |
| 4. Review | `/asdf:review ...` | Approved + fixes |
| 5. Complete | `/asdf:sync guest-checkout` | Spec v1.3.0 |
| 5. Complete | `/asdf:report guest-checkout` | Feature complete |

---

## Key Takeaways

1. **Refinement is normal** â€” 3 iterations to get spec right
2. **Deviations happen** â€” Option B lets you continue without blocking
3. **Test matrix guides** â€” Know what to test at each level
4. **Review catches issues** â€” AI review found CSRF gap
5. **Sync maintains truth** â€” Spec reflects reality after implementation
6. **Reports show progress** â€” Clear status for stakeholders

---

## Lifecycle Duration

| Phase | Duration | % of Total |
|-------|----------|------------|
| Design | 1 hour | 15% |
| Implementation | 4 hours | 62% |
| Testing | 1 hour | 15% |
| Review + Fixes | 30 min | 8% |
| **Total** | **6.5 hours** | **100%** |

Spec-driven development: ~38% design/test/review, ~62% coding.

================
File: case-studies/README.md
================
# ASDF Case Studies & Visual Guides

Practical examples and visual diagrams to help you understand ASDF workflows.

---

## Case Studies

| # | Title | Scenario | Best For |
|---|-------|----------|----------|
| 01 | [New Project](01-new-project.md) | Starting e-commerce from scratch | First-time ASDF users |
| 02 | [Existing Codebase](02-existing-codebase.md) | Adding ASDF to 50+ file project | Brownfield adoption |
| 03 | [Team Collaboration](03-team-collaboration.md) | 2 developers working in parallel | Multi-instance setups |
| 04 | [Maintenance Workflow](04-maintenance-workflow.md) | Fixing drifted specs, tech debt | Project health |
| 05 | [Feature Lifecycle](05-feature-lifecycle.md) | Guest Checkout end-to-end | Complete workflow |

---

## Visual Diagrams

| Diagram | Purpose | When to Reference |
|---------|---------|-------------------|
| [Command Flow](diagrams/command-flow.md) | Which command to use | Unsure what to run next |
| [Mode Transitions](diagrams/mode-transitions.md) | How modes connect | Understanding the system |
| [Multi-Instance](diagrams/multi-instance.md) | Lock mechanism | Parallel development |
| [Context Loading](diagrams/context-loading.md) | Hierarchy visualization | Starting any task |
| [Refinement Loop](diagrams/refinement-loop.md) | Feedback cycle | During spec creation |

---

## Quick Start

**New to ASDF?**
1. Read [01-new-project.md](01-new-project.md) for a complete walkthrough
2. Reference [Command Flow](diagrams/command-flow.md) when stuck

**Adding ASDF to existing project?**
1. Read [02-existing-codebase.md](02-existing-codebase.md)
2. Focus on `/asdf:init` option B

**Working with a team?**
1. Read [03-team-collaboration.md](03-team-collaboration.md)
2. Reference [Multi-Instance](diagrams/multi-instance.md) for lock handling

**Project needs cleanup?**
1. Read [04-maintenance-workflow.md](04-maintenance-workflow.md)
2. Start with `/asdf:audit`

**Want the full picture?**
1. Read [05-feature-lifecycle.md](05-feature-lifecycle.md)
2. Reference [Mode Transitions](diagrams/mode-transitions.md)

---

## Related Documentation

- [ASDF-Framework.md](../ASDF-Framework.md) - Main framework documentation
- [Commands](../.claude/commands/asdf/) - All command references
- [Skills](../.claude/skills/) - Skill documentation
- [Agent](../.claude/agents/asdf-coder.md) - Agent behavior reference

---

## How to Use These Guides

1. **Case studies** are narrative walkthroughs with realistic scenarios
2. **Diagrams** are quick visual references
3. All examples use actual ASDF commands with expected outputs
4. Both happy path and edge cases are covered

Each case study is self-contained â€” read any one without reading others.

================
File: ASDF-Framework.md
================
# ASDF (Astraler Spec-Driven Framework)

> **Version**: 4.0.0
> **Last Updated**: 241224
> **Status**: Production Ready

### v4.0 Features (New)
- **Help System** â€” `/asdf` shows grouped command reference, all commands have `--help`
- **Component Update** â€” `/asdf:update [component]` with impact analysis
- **Progress Reports** â€” `/asdf:report [feature|all]` for feature/project health
- **Spec Audit** â€” `/asdf:audit` detects outdated/missing/orphaned specs
- **Cleanup Command** â€” `/asdf:cleanup` archives unused specs
- **Onboarding** â€” `/asdf:onboard` 5-minute guided tour for new devs
- **Incomplete Detection** â€” `/asdf:init` scans and resumes partial setups
- **Enhanced Handoff** â€” Mental context, decisions, environment state
- **Spec Locking** â€” Lock specs during editing (multi-instance)
- **Test Matrix** â€” Classify tests by type (Unit/Integration/API/E2E)

### v3.0 Features (Inherited)
- **Testing Strategy** â€” AI generates test cases from spec ACs (`/asdf:test`)
- **PR Protocol** â€” Structured code review with `/asdf:pr` and `/asdf:review`
- **Dependency Check** â€” Block implementation if prerequisites not met
- **Impact Analysis** â€” Detect breaking changes before implementation
- **Roadmap Management** â€” Phase-based feature planning (`/asdf:roadmap`)
- **Multi-Instance Support** â€” Lock mechanism for parallel Claude instances

### v2.x Features (Inherited)
- **Iterative Refinement Loop** â€” Feedback â†’ Reference â†’ Confirm cycle
- **Duplicate Detection** â€” Checks existing specs before creation
- **Reference Collection** â€” Progressive document gathering
- **Mermaid Diagrams** â€” Required for all architecture/domain/feature specs
- **13 System-Core Templates** â€” Complete template library
- **Version Management** â€” Semantic versioning (X.Y.Z) in all specs

---

## 1. Overview

ASDF is a **Spec-Driven Development** framework for AI-native software development. Specifications are the single source of truthâ€”code follows specs, and specs auto-update via Reverse Sync when implementation deviates.

### Core Philosophy

```
Specs â†’ Code â†’ Reverse Sync â†’ Specs
```

### Key Benefits

| Benefit | Description |
|---------|-------------|
| **Context Control** | Hierarchical docs prevent AI context drift |
| **Knowledge Preservation** | Reverse Sync keeps docs accurate |
| **Session Continuity** | Handoff notes enable seamless AI sessions |
| **Quality Enforcement** | Validation hooks ensure spec compliance |

---

## 2. Roles

### Product Architect (Human)

- Designs specifications
- Approves implementation plans
- Reviews Reverse Sync updates
- Resolves blockers

### Coder AI

- Reads specs before implementing
- Executes code following specs
- Triggers Reverse Sync on deviations
- Documents session state for handoff

---

## 3. Documentation Hierarchy

Four-tier structure with priority-based loading:

```
astraler-docs/
â”œâ”€â”€ 01-system-core/          # Tier 1: Global rules, project DNA
â”‚   â”œâ”€â”€ 01-architecture/     # System design
â”‚   â”‚   â”œâ”€â”€ master-map.md
â”‚   â”‚   â”œâ”€â”€ tech-stack.md
â”‚   â”‚   â”œâ”€â”€ data-architecture.md
â”‚   â”‚   â””â”€â”€ infrastructure.md
â”‚   â”œâ”€â”€ 02-standards/        # Development conventions
â”‚   â”‚   â”œâ”€â”€ coding-standards.md
â”‚   â”‚   â”œâ”€â”€ api-standards.md
â”‚   â”‚   â”œâ”€â”€ testing-strategy.md
â”‚   â”‚   â””â”€â”€ performance-slas.md
â”‚   â”œâ”€â”€ 03-design/           # UI/UX specifications
â”‚   â”‚   â”œâ”€â”€ ui-ux-design-system.md
â”‚   â”‚   â””â”€â”€ component-library.md
â”‚   â”œâ”€â”€ 04-governance/       # Policies & decisions
â”‚   â”‚   â”œâ”€â”€ security-policy.md
â”‚   â”‚   â”œâ”€â”€ decision-log.md
â”‚   â”‚   â””â”€â”€ glossary.md
â”‚   â””â”€â”€ project-status.md    # Live project heartbeat
â”‚
â”œâ”€â”€ 02-domains/              # Tier 2: Business logic modules
â”‚   â”œâ”€â”€ authentication/
â”‚   â”œâ”€â”€ payments/
â”‚   â”œâ”€â”€ orders/
â”‚   â””â”€â”€ notifications/
â”‚
â”œâ”€â”€ 03-features/             # Tier 3: Actionable feature specs
â”‚   â””â”€â”€ YYMMDD-feature-name/
â”‚       â”œâ”€â”€ spec.md
â”‚       â””â”€â”€ changelog.md
â”‚
â””â”€â”€ 04-operations/           # Tier 4: Execution state
    â”œâ”€â”€ implementation-active.md
    â”œâ”€â”€ session-handoff.md
    â”œâ”€â”€ roadmap.md           # Phase-based planning
    â”œâ”€â”€ tech-debt.md         # v4: Tech debt register
    â”œâ”€â”€ active/              # Per-feature execution files
    â”œâ”€â”€ completed/           # Archived completed features
    â”œâ”€â”€ locks/               # Multi-instance lock files
    â”œâ”€â”€ spec-locks/          # v4: Spec editing locks
    â”œâ”€â”€ archived/            # v4: Archived specs from cleanup
    â””â”€â”€ changelog/
```

### Context Loading Order

When starting any task, AI loads context in this sequence:

1. `01-system-core/` â†’ Global rules, architecture
2. `02-domains/` â†’ Relevant business logic
3. `03-features/` â†’ Specific feature spec
4. `04-operations/session-handoff.md` â†’ Last session state

---

## 4. Claude Code Integration

### 4.1 Directory Structure

```
.claude/
â”œâ”€â”€ settings.json
â”œâ”€â”€ commands/asdf/
â”‚   â”œâ”€â”€ asdf.md              # v4: Main help, command reference
â”‚   â”œâ”€â”€ init.md              # Initialize ASDF structure
â”‚   â”œâ”€â”€ spec.md              # Create feature specifications
â”‚   â”œâ”€â”€ code.md              # Execute implementation from spec
â”‚   â”œâ”€â”€ test.md              # Generate tests from spec
â”‚   â”œâ”€â”€ sync.md              # Trigger Reverse Sync
â”‚   â”œâ”€â”€ update.md            # v4: Update component with impact analysis
â”‚   â”œâ”€â”€ report.md            # v4: Progress reports
â”‚   â”œâ”€â”€ audit.md             # v4: Spec health audit
â”‚   â”œâ”€â”€ cleanup.md           # v4: Remove unused specs
â”‚   â”œâ”€â”€ onboard.md           # v4: Guided tour for new devs
â”‚   â”œâ”€â”€ pr.md                # Create PR package
â”‚   â”œâ”€â”€ review.md            # AI code review
â”‚   â”œâ”€â”€ roadmap.md           # Manage project phases
â”‚   â”œâ”€â”€ status.md            # Update project status
â”‚   â””â”€â”€ handoff.md           # Create session handoff notes
â”œâ”€â”€ skills/
â”‚   â”œâ”€â”€ spec-governance/     # Validate specs, templates
â”‚   â”œâ”€â”€ reverse-sync/        # Code-spec reconciliation
â”‚   â”œâ”€â”€ context-loading/     # Hierarchical context loading
â”‚   â”œâ”€â”€ refinement-loop/     # Feedback/reference/confirm cycle
â”‚   â”œâ”€â”€ impact-analysis/     # Dependency & breaking changes
â”‚   â”œâ”€â”€ testing/             # Test generation, test matrix
â”‚   â”œâ”€â”€ pr-review/           # PR & review protocols
â”‚   â””â”€â”€ maintenance/         # v4: Audit, cleanup, tech debt
â””â”€â”€ agents/
    â””â”€â”€ asdf-coder.md        # Single agent with multiple modes
```

### 4.2 Slash Commands

**Help & Discovery:**
| Command | Purpose | Mode |
|---------|---------|------|
| `/asdf` | Show all commands grouped by category | HELP |
| `/asdf:[cmd] --help` | Show help for specific command | HELP |

**Core Workflow:**
| Command | Purpose | Mode |
|---------|---------|------|
| `/asdf:init` | Initialize ASDF structure (with incomplete detection) | DESIGN |
| `/asdf:spec [feature]` | Create feature specification (with spec locking) | DESIGN |
| `/asdf:code [path]` | Execute implementation from specification | EXECUTE |
| `/asdf:test [feature]` | Generate test cases with test matrix | TEST |
| `/asdf:sync` | Trigger Reverse Sync (Code â†’ Docs) | SYNC |

**Updates & Maintenance:**
| Command | Purpose | Mode |
|---------|---------|------|
| `/asdf:update [component]` | Update component with impact analysis | UPDATE |
| `/asdf:audit` | Scan for outdated/missing/orphaned specs | AUDIT |
| `/asdf:cleanup` | Archive/remove unused specs | CLEANUP |

**Reporting:**
| Command | Purpose | Mode |
|---------|---------|------|
| `/asdf:report [feature\|all]` | Generate progress/health reports | REPORT |
| `/asdf:status` | Update project-level status heartbeat | OPS |

**Collaboration:**
| Command | Purpose | Mode |
|---------|---------|------|
| `/asdf:onboard` | 5-minute guided tour for new devs | ONBOARD |
| `/asdf:handoff` | Create enhanced session handoff notes | OPS |
| `/asdf:roadmap` | Manage project phases and priorities | OPS |

**Code Review:**
| Command | Purpose | Mode |
|---------|---------|------|
| `/asdf:pr [feature]` | Create PR package for code review | PR |
| `/asdf:review [path]` | AI code review from fresh context | REVIEW |

### 4.3 Skills

| Skill | Purpose | Version |
|-------|---------|---------|
| `spec-governance` | Validate specs, enforce standards, templates | v2.0 |
| `reverse-sync` | Detect deviations, update specs | v2.0 |
| `context-loading` | Load hierarchical context properly | v2.0 |
| `refinement-loop` | Collect references, iterate feedback/refine/confirm | v2.1 |
| `impact-analysis` | Dependency check + breaking change detection | v3.0 |
| `testing` | Test matrix, test generation (Unit/Integration/API/E2E) | v4.0 |
| `pr-review` | PR package creation + AI code review | v3.0 |
| `maintenance` | Audit, cleanup, tech debt tracking patterns | v4.0 |

### 4.4 Agent

| Agent | Mode | Purpose |
|-------|------|---------|
| `asdf-coder` | DESIGN | Create/refine specs (brainstorm, structure) |
| `asdf-coder` | EXECUTE | Implement code from specs (with lock, dependency, impact checks) |
| `asdf-coder` | SYNC | Validate code-spec alignment, reverse sync |
| `asdf-coder` | TEST | Generate test suites with test matrix |
| `asdf-coder` | UPDATE | Update components with impact analysis |
| `asdf-coder` | REPORT | Generate feature/project health reports |
| `asdf-coder` | AUDIT | Scan for spec health issues |
| `asdf-coder` | CLEANUP | Archive/remove unused specs |
| `asdf-coder` | ONBOARD | Guided tour for new developers |
| `asdf-coder` | HELP | Show command reference and help |
| `asdf-coder` | PR | Create PR packages for review |
| `asdf-coder` | REVIEW | AI code review from fresh context |
| `asdf-coder` | OPS | Roadmap, status, handoff management |

---

## 5. Spec Templates

### 5.1 Domain Spec Structure

```markdown
# [Domain] Domain

> **Version**: 1.0.0
> **Status**: Active | Planned | Deprecated

## 1. Domain Purpose
## 2. Business Rules (with IDs: XXX-001)
## 3. Entities (TypeScript interfaces)
## 4. State Machine (if applicable)
## 5. Integration Points (inbound/outbound)
## 6. API Contracts
## 7. Error Codes
## 8. Dependencies

**Related Features:** [links]
```

### 5.2 Feature Spec Structure

```markdown
# [Feature Name]

> **Feature ID**: YYMMDD-feature-name
> **Status**: Planned | In Progress (%) | Implemented

## 1. Overview + Business Value
## 2. Requirements
   - 2.1 Functional (MUST) - FR-001, FR-002...
   - 2.2 Non-Functional (SHOULD) - NFR-001...
   - 2.3 Out of Scope
## 3. Technical Design
   - Architecture diagram
   - Key files
## 4. UI/UX (wireframes)
## 5. API Contract
## 6. Acceptance Criteria (AC-001...)
## 7. Testing
## 8. Blockers (if any)
## 9. Implementation Progress
## 10. Changelog

**Domain:** [link]
```

---

## 6. Reverse Sync Protocol

### When to Trigger

- Implementation deviates from spec
- Better approach discovered during coding
- Requirements change during implementation
- Bug fix reveals spec inaccuracy

### Process

1. **Detect** - Identify deviation between code and spec
2. **Annotate** - Mark changed section with `[Reverse Synced: YYMMDD]`
3. **Document** - Explain what changed and why
4. **Update Changelog** - Add entry to feature changelog
5. **Verify** - Ensure spec reflects actual implementation

### Annotation Format

```markdown
<!-- Original: [what spec said] -->
[Actual implementation description]
[Reverse Synced: YYMMDD]
```

---

## 7. Session Handoff Protocol

### Before Ending Session

1. Update `implementation-active.md` with current state
2. Create/update `session-handoff.md` with:
   - What was completed
   - What's in progress
   - Blockers and their status
   - Pending actions for next session
   - Quick start commands
3. Verify all changes committed
4. Update feature changelogs if needed

### Starting New Session

1. Read `session-handoff.md` for last state
2. Check `implementation-active.md` for blockers
3. Load relevant context (system â†’ domain â†’ feature)
4. Continue from documented state

---

## 8. Quality Gates

### Before Implementation

- [ ] Spec exists and is approved
- [ ] Context loaded (system â†’ domain â†’ feature)
- [ ] Dependencies identified
- [ ] Acceptance criteria defined

### After Implementation

- [ ] Code matches spec intent
- [ ] Reverse Sync completed if deviations exist
- [ ] Tests pass
- [ ] `implementation-active.md` updated
- [ ] `session-handoff.md` updated (if ending session)

---

## 9. Workflow Summary

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ASDF WORKFLOW                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  1. INTENT        Product Architect issues command          â”‚
â”‚       â†“           (e.g., /asdf:spec checkout)               â”‚
â”‚                                                             â”‚
â”‚  2. ALIGNMENT     AI clarifies via questions                â”‚
â”‚       â†“           Loads context hierarchy                   â”‚
â”‚                                                             â”‚
â”‚  3. DOC FIRST     AI creates/reads Spec before coding       â”‚
â”‚       â†“           Uses spec-governance skill                â”‚
â”‚                                                             â”‚
â”‚  4. EXECUTE       AI implements from spec                   â”‚
â”‚       â†“           Uses asdf-coder (EXECUTE mode)            â”‚
â”‚                                                             â”‚
â”‚  5. REVERSE SYNC  AI updates Docs if code deviates          â”‚
â”‚       â†“           Uses reverse-sync skill                   â”‚
â”‚                                                             â”‚
â”‚  6. HANDOFF       AI logs session state                     â”‚
â”‚                   Updates implementation-active.md          â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 10. Case Studies

### Case Study 1: New Project Initialization

**Scenario:** Starting a new e-commerce project called "ShopFlow"

```
Architect: /asdf:init

AI: I'll initialize ASDF structure for your project.
    What reference documents do you have?

    A) Existing codebase to analyze
    B) Design documents (Figma, PRD, etc.)
    C) Requirements documents (BRD, SAD, TDD)
    D) Start from scratch

Architect: C - I have BRD and database schema docs

AI: [Collects references from provided documents]
    [Creates astraler-docs/ structure]

    Generated:
    â”œâ”€â”€ 01-system-core/
    â”‚   â”œâ”€â”€ 01-architecture/master-map.md      â† From BRD
    â”‚   â”œâ”€â”€ 01-architecture/data-architecture.md â† From DB schema
    â”‚   â””â”€â”€ 02-standards/code-standards.md
    â”œâ”€â”€ 02-domains/
    â”‚   â”œâ”€â”€ auth/domain.md
    â”‚   â”œâ”€â”€ products/domain.md
    â”‚   â”œâ”€â”€ cart/domain.md
    â”‚   â””â”€â”€ orders/domain.md
    â””â”€â”€ 04-operations/
        â””â”€â”€ session-handoff.md

    Ready for refinement. Any feedback?

Architect: Add payment domain, we're using Stripe

AI: [Updates structure, adds payments/domain.md with Stripe integration]
    Confirmed. 19 files created.
```

---

### Case Study 2: Feature Development Lifecycle

**Scenario:** Adding "Guest Checkout" feature to ShopFlow

```
Architect: /asdf:spec guest-checkout

AI: [Loads context: system-core â†’ cart domain â†’ orders domain]

    Brainstorming guest-checkout feature...

    Questions:
    1. Should guests convert to registered users post-purchase?
    2. Email required for order confirmation?
    3. Save address for future use (with consent)?

Architect: Yes to all three

AI: [Creates 03-features/251224-guest-checkout.md]

    Feature Spec Draft:
    - FR-001: Allow checkout without account
    - FR-002: Collect email for confirmation
    - FR-003: Optional account creation post-purchase
    - FR-004: Address save with GDPR consent

    Acceptance Criteria:
    - AC-001: Guest can complete purchase in <3 clicks
    - AC-002: Order confirmation sent within 30s

    Ready for refinement?

Architect: confirm

AI: Spec finalized. Ready to implement with /asdf:code
```

```
Architect: /asdf:code 03-features/251224-guest-checkout

AI: [Reads spec, loads domain context]

    Implementation Plan:
    1. Backend: GuestCheckoutService, OrderController updates
    2. Frontend: GuestCheckoutForm component
    3. Database: guest_orders table migration

    Proceeding...

    [Creates files, implements feature]

    Implementation complete. Tests passing.
    Updated implementation-active.md
```

---

### Case Study 3: Reverse Sync (Code Deviation)

**Scenario:** During implementation, discovered spec needs correction

```
Architect: /asdf:code 03-features/251224-guest-checkout

AI: [Implementing FR-003: Post-purchase account creation]

    âš ï¸ DEVIATION DETECTED

    Spec says: "Create account automatically after purchase"
    Reality: GDPR requires explicit opt-in, cannot auto-create

    Triggering Reverse Sync...

    Updated spec (251224-guest-checkout.md):

    - FR-003: ~~Auto-create account post-purchase~~
    + FR-003: Show account creation prompt post-purchase
            User must explicitly opt-in (GDPR compliance)
    [Reverse Synced: 251224]

    Changelog updated:
    - 251224: FR-003 modified for GDPR compliance

    Continue implementation with corrected approach?

Architect: yes

AI: [Implements opt-in flow instead of auto-creation]
    Done. Spec and code now aligned.
```

---

### Case Study 4: Session Continuity (Handoff)

**Scenario:** Ending work session, another AI will continue tomorrow

```
Architect: /asdf:handoff

AI: Creating session handoff notes...

    SESSION HANDOFF - 251224
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    âœ… COMPLETED:
    - Guest checkout backend (100%)
    - Database migrations applied
    - Unit tests passing (12/12)

    ğŸ”„ IN PROGRESS:
    - Frontend GuestCheckoutForm (60%)
    - Pending: validation, error states

    âŒ BLOCKED:
    - Email service config missing (needs SMTP credentials)

    ğŸ“‹ NEXT SESSION:
    1. Get SMTP credentials from DevOps
    2. Complete GuestCheckoutForm
    3. Integration tests
    4. /asdf:sync to verify alignment

    Quick Resume:
    cat astraler-docs/04-operations/session-handoff.md
    /asdf:code 03-features/251224-guest-checkout

    Saved to session-handoff.md
```

**Next day, new session:**

```
Architect: Continue where we left off

AI: [Reads session-handoff.md]

    Resuming from 251224 session:
    - Guest checkout frontend at 60%
    - Blocker: SMTP credentials

    Do you have the SMTP credentials now?

Architect: Yes, here they are...

AI: [Continues implementation seamlessly]
```

---

### Case Study 5: Test Generation (v3)

**Scenario:** Generating comprehensive tests from spec acceptance criteria

```
Architect: /asdf:test guest-checkout

AI: [Loads spec: 03-features/251224-guest-checkout/spec.md]
    [Analyzes acceptance criteria]

    **Test Plan for guest-checkout**

    Spec Version: v1.2.0

    ### Unit Tests

    | Test ID | AC | Description | Priority |
    |---------|-----|-------------|----------|
    | UT-001 | AC-001 | Guest can checkout without account | P0 |
    | UT-002 | AC-001 | Validates email format | P0 |
    | UT-003 | AC-002 | Order confirmation email sent | P0 |

    ### Integration Tests

    | Test ID | AC | Description | Priority |
    |---------|-----|-------------|----------|
    | IT-001 | AC-001 | POST /checkout/guest returns 201 | P0 |
    | IT-002 | AC-003 | Account creation prompt shown | P1 |

    ### Edge Cases

    | Case | Description | How to Handle |
    |------|-------------|---------------|
    | EC-001 | Cart empty | Return 400 with message |
    | EC-002 | Payment timeout | Retry 3x, then fail gracefully |

    Proceed with test generation? (yes/feedback)

Architect: yes

AI: [Creates test files]

    **Tests Generated:**
    - __tests__/guest-checkout/checkout.test.ts (6 tests)
    - __tests__/guest-checkout/checkout.integration.test.ts (4 tests)
    - __tests__/guest-checkout/fixtures.ts

    **Spec Updated:**
    - Testing section populated with test mapping

    Run: npm test -- --grep "guest-checkout"
```

---

### Case Study 6: Dependency Check & Impact Analysis (v3)

**Scenario:** Starting implementation with unmet dependencies

```
Architect: /asdf:code 03-features/251225-order-history

AI: [Acquires lock for order-history]
    [Reads spec, checks dependencies]

    **BLOCKED: Dependencies not satisfied**

    Feature: order-history

    | Dependency | Type | Status | Blocker? |
    |------------|------|--------|----------|
    | orders domain | Domain | Implemented | No |
    | 251224-guest-checkout | Feature | 60% | YES |

    This feature requires guest-checkout to be complete.

    Options:
    - [wait] Abort until dependencies ready
    - [stub] Create interface stubs
    - [override] Proceed anyway (RISK)

    What would you like to do?

Architect: wait

AI: [Releases lock]

    Lock released. Feature available for later.

    Recommendation:
    1. Complete guest-checkout first: /asdf:code 03-features/251224-guest-checkout
    2. Then return: /asdf:code 03-features/251225-order-history
```

**Later, with breaking changes detected:**

```
Architect: /asdf:code 03-features/251226-oauth-login

AI: [Acquires lock, passes dependency check]
    [Running impact analysis...]

    **Impact Analysis**

    Feature: oauth-login

    **Breaking Changes Detected:**

    | Affected | Type | Change | Severity |
    |----------|------|--------|----------|
    | 251224-guest-checkout | API | /auth/login signature | HIGH |
    | user-profile | Schema | User.authProvider field | MEDIUM |

    Total: 1 HIGH, 1 MEDIUM

    Options:
    - [review] Show detailed impact
    - [proceed] Continue (update specs later)
    - [abort] Cancel

Architect: review

AI: ### HIGH: guest-checkout

    Current: POST /auth/login accepts {email, password}
    After: POST /auth/login accepts {email, password, provider?}

    Impact: Existing login calls will still work (provider optional)
    Mitigation: None needed, backwards compatible

    Proceed? (yes/abort)

Architect: yes

AI: [Continues implementation with impact logged]
    Reminder: Run /asdf:sync for affected features after.
```

---

### Case Study 7: PR Protocol & AI Review (v3)

**Scenario:** Creating PR package and getting AI review

```
Architect: /asdf:pr guest-checkout

AI: [Gathering changes for guest-checkout...]

    **PR Package Created**

    Location: .pr-review/241224-guest-checkout/

    | File | Purpose |
    |------|---------|
    | summary.md | PR description |
    | changes.md | 12 files changed |
    | spec-diff.md | 1 deviation |
    | checklist.md | Review checklist |

    AC Coverage: 5/5 implemented

    Next: /asdf:review .pr-review/241224-guest-checkout/
```

**Getting AI review (ideally in fresh instance):**

```
Architect: /asdf:review .pr-review/241224-guest-checkout/

AI: [Loading PR package with FRESH context...]
    [Reading spec from scratch...]
    [Applying review checklist...]

    # AI Review: Guest Checkout

    **Verdict: REQUEST_CHANGES**

    ## Spec Compliance: 4/5 ACs Passing

    | AC | Status | Notes |
    |----|--------|-------|
    | AC-001 | PASS | |
    | AC-002 | PASS | |
    | AC-003 | FAIL | Missing GDPR consent checkbox |
    | AC-004 | PASS | |
    | AC-005 | PASS | |

    ## Issues Found

    ### Critical (1)
    | File | Line | Issue |
    |------|------|-------|
    | GuestCheckoutForm.tsx | 45 | Missing GDPR consent before address save |

    ### Major (1)
    | File | Line | Issue |
    |------|------|-------|
    | checkout.service.ts | 78 | No retry for payment API timeout |

    ## Required Actions
    1. Add GDPR consent checkbox (AC-003)
    2. Add payment retry logic

    After fixes: /asdf:review .pr-review/241224-guest-checkout/
```

---

### Case Study 8: Multi-Instance & Roadmap (v3)

**Scenario:** Two Claude instances working in parallel

**Instance 1:**
```
Architect: /asdf:code guest-checkout

AI: [Checking locks...]
    [No lock exists, acquiring...]

    Lock acquired for guest-checkout.
    Created: 04-operations/active/guest-checkout.md

    Proceeding with implementation...
```

**Instance 2 (simultaneous):**
```
Architect: /asdf:code guest-checkout

AI: **FEATURE LOCKED**

    Feature: guest-checkout
    Locked by: Instance-1
    Since: 5 minutes ago
    Task: "Implementing FR-001 to FR-003"

    Options:
    - [wait] Check again later
    - [force] Override (DANGER)
    - [other] Work on different feature

Architect: other

AI: Available features without locks:
    - order-management
    - push-notifications

    Which would you like to work on?
```

**Managing project roadmap:**
```
Architect: /asdf:roadmap

AI: **Project Roadmap v1.0**

    Current Phase: Phase 1 - MVP Auth (60%)

    | Phase | Status | Progress |
    |-------|--------|----------|
    | Phase 1: MVP Auth | Active | 60% |
    | Phase 2: Payments | Planned | 0% |
    | Phase 3: Scale | Planned | 0% |

    Phase 1 Features:
    | Priority | Feature | Status |
    |----------|---------|--------|
    | P0 | user-auth | Done |
    | P0 | guest-checkout | 60% |
    | P0 | push-notifications | Blocked |

    Commands:
    - /asdf:roadmap add [feature] [phase] [priority]
    - /asdf:roadmap reorder [feature] [target]
    - /asdf:roadmap phase close
```

---

## 11. Quick Start

### For New Projects

```bash
# 1. Copy framework to your project
cp -r asdf-framework/.claude your-project/
cp asdf-framework/CLAUDE.md your-project/

# 2. Initialize documentation structure
/asdf:init

# 3. Create first feature spec
/asdf:spec user-authentication

# 4. Implement from spec
/asdf:code astraler-docs/03-features/YYMMDD-user-authentication/
```

### For New Team Members

```bash
# Quick 5-minute orientation
/asdf:onboard
```

### For Existing Sessions

```bash
# 1. Check last session state
cat astraler-docs/04-operations/session-handoff.md

# 2. Check active work and blockers
cat astraler-docs/04-operations/implementation-active.md

# 3. Continue implementation
/asdf:code [spec-path]

# 4. End session properly
/asdf:handoff
```

### For Maintenance

```bash
# Check spec health
/asdf:audit

# View project health report
/asdf:report all

# Cleanup unused specs
/asdf:cleanup

# Get help on any command
/asdf
/asdf:spec --help
```

---

## 12. Reference Implementation

A complete sample project demonstrating ASDF patterns is available at:

```
astraler-docs/
â”œâ”€â”€ 01-system-core/    # 13 files - architecture, standards, design, governance
â”œâ”€â”€ 02-domains/        # 4 domains - auth, payments, orders, notifications
â”œâ”€â”€ 03-features/       # 3 features - showing full lifecycle
â””â”€â”€ 04-operations/     # Session continuity examples
```

---

**Cross-References:**
- Claude Code Config: `.claude/`
- Sample Specs: `astraler-docs/`
- Entry Point: `CLAUDE.md`

================
File: CLAUDE.md
================
# CLAUDE.md - ASDF (Astraler Spec-Driven Framework)

This file configures Claude Code to operate as a **Spec-Driven Coder AI**, enforcing the ASDF methodology where technical specifications are the single source of truth.

## Core Philosophy

**Specs â†’ Code â†’ Reverse Sync â†’ Specs**

You execute code based on specifications, and automatically update documentation when implementation deviates or improves upon the original spec.

## Role

You are a **Coder AI** operating under the direction of a **Product Architect**. Your responsibilities:
1. Read and understand specifications before coding
2. Execute implementations precisely according to specs
3. Detect improvements/changes during implementation
4. Automatically update specs via Reverse Sync protocol

## Workflows

- Primary workflow: `./.claude/workflows/primary-workflow.md`
- Development rules: `./.claude/workflows/development-rules.md`
- Spec governance: `./.claude/workflows/spec-governance.md`
- Reverse sync protocol: `./.claude/workflows/reverse-sync-protocol.md`

## Commands (Slash Commands)

| Command | Purpose |
|---------|---------|
| `/asdf:init` | Initialize ASDF folder structure for new project |
| `/asdf:spec [feature]` | Brainstorm and create feature specification |
| `/asdf:code [spec-path]` | Execute implementation from specification |
| `/asdf:test [feature]` | Generate test cases from spec acceptance criteria |
| `/asdf:sync` | Trigger Reverse Sync (Code â†’ Docs) |
| `/asdf:pr [feature]` | Create PR package for code review |
| `/asdf:review [path]` | AI code review from fresh context |
| `/asdf:roadmap` | Manage project phases and priorities |
| `/asdf:status` | Update project-level status heartbeat |
| `/asdf:handoff` | Create session handoff notes |

## Documentation Structure

```
astraler-docs/
â”œâ”€â”€ 01-system-core/          # Tier 1: Global rules, project DNA
â”‚   â”œâ”€â”€ 01-architecture/
â”‚   â”œâ”€â”€ 02-standards/
â”‚   â”œâ”€â”€ 03-design/
â”‚   â”œâ”€â”€ 04-governance/
â”‚   â””â”€â”€ project-status.md
â”œâ”€â”€ 02-domains/              # Tier 2: Module-level business logic
â”œâ”€â”€ 03-features/             # Tier 3: Actionable feature specs
â”‚   â””â”€â”€ YYMMDD-feature-name/
â””â”€â”€ 04-operations/           # Tier 4: Execution state, session memory
    â”œâ”€â”€ implementation-active.md
    â”œâ”€â”€ session-handoff.md
    â”œâ”€â”€ roadmap.md           # Phase-based feature management
    â”œâ”€â”€ active/              # Per-feature execution files
    â”œâ”€â”€ completed/           # Archived completed features
    â”œâ”€â”€ locks/               # Multi-instance lock files
    â””â”€â”€ changelog/
```

## Critical Rules

**MANDATORY:**
- ALWAYS read specs before implementing
- NEVER implement without understanding context hierarchy (system-core â†’ domains â†’ features)
- ALWAYS trigger Reverse Sync after implementation changes
- ALWAYS update `session-handoff.md` at end of session

**IMPORTANT:** Activate `spec-governance` skill for all spec-related operations.
**IMPORTANT:** Activate `reverse-sync` skill after any implementation that deviates from specs.
**IMPORTANT:** Activate `context-loading` skill when starting new tasks to load proper context hierarchy.
**IMPORTANT:** Activate `impact-analysis` skill before `/asdf:code` for dependency and breaking change checks.
**IMPORTANT:** Activate `testing` skill for test generation from specs.
**IMPORTANT:** Activate `pr-review` skill for PR packages and AI code review.

## Context Loading Order

When starting any task:
1. Load `asdf-docs/01-system-core/` (global rules)
2. Load relevant `asdf-docs/02-domains/` (business logic)
3. Load specific `asdf-docs/03-features/` (actionable specs)
4. Check `asdf-docs/04-operations/session-handoff.md` (last session state)

## Standard Operating Loop

```
1. Driver Intent    â†’ Architect issues command (e.g., /asdf:spec Checkout)
2. AI Alignment     â†’ AI clarifies context via questions
3. Doc First        â†’ AI creates/reads Spec before coding
4. Action           â†’ AI executes implementation
5. Reverse Sync     â†’ AI updates Docs to match Code
6. Handoff          â†’ AI logs session state for continuity
```

## Quality Gates

Before marking any task complete:
- [ ] Lock acquired (if multi-instance)
- [ ] Dependency check passed
- [ ] Impact analysis completed (breaking changes acknowledged)
- [ ] Code matches spec intent (or spec has been updated)
- [ ] Reverse sync completed if any deviations
- [ ] `implementation-active.md` updated with current state
- [ ] Lock released on completion
- [ ] No orphaned changes (all changes documented)



================================================================
End of Codebase
================================================================
